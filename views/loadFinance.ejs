<%- include('partials/header') %>
<div class="container py-4">
  <div class="d-flex flex-column flex-md-row gap-3 justify-content-between align-items-start align-items-md-center mb-4">
    <div>
      <h2 class="fw-semibold mb-1 d-flex align-items-center gap-2">
        <i class="bi bi-pie-chart text-primary"></i> <%= title %>
      </h2>
      <p class="text-muted small mb-0">ไฟล์สรุปงบการเงิน แยกตามสถาบัน | เรียงตามปีล่าสุด</p>
    </div>
    <% if(user && user.mClass=='kts'){ %>
      <a href="/finance/upload" class="btn btn-primary shadow-sm">
        <i class="bi bi-cloud-upload"></i> อัปโหลดไฟล์
      </a>
    <% } %>
  </div>

  <!-- Toolbar -->
  <div class="row g-3 mb-4">
    <div class="col-lg-6">
      <div class="position-relative">
        <input type="text" id="searchInput" class="form-control form-control-lg ps-5" placeholder="พิมพ์เพื่อค้นหา: ชื่อสถาบัน / ปี / วันที่" autocomplete="off">
        <span class="position-absolute top-50 translate-middle-y ms-3 text-secondary">
          <i class="bi bi-search"></i>
        </span>
        <button class="btn btn-light position-absolute top-50 end-0 translate-middle-y me-2 d-none" id="clearBtn" type="button" aria-label="ล้างคำค้น"><i class="bi bi-x-circle"></i></button>
      </div>
    </div>
    <div class="col-lg-6 d-flex flex-wrap gap-2 justify-content-lg-end align-items-center">
      <div class="small text-muted" id="resultMeta">กำลังโหลด...</div>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="collapseAllToggle" checked>
        <label class="form-check-label small" for="collapseAllToggle">ย่ออัตโนมัติ</label>
      </div>
    </div>
  </div>

  <% 
    const grouped = {};
    fileAll.forEach(file => {
      const name = file.c_name || 'ไม่ระบุชื่อสถาบัน';
      if (!grouped[name]) grouped[name] = [];
      grouped[name].push(file);
    });

    function groupRank(name){
      if(/สหกรณ์/.test(name)) return 0;           // Cooperatives first
      if(/กลุ่มเกษตรกร/.test(name)) return 1;    // Farmer groups second
      return 2;                                    // Others last
    }

    const sortedGroups = Object.entries(grouped).sort((a, b) => {
      const rankA = groupRank(a[0]);
      const rankB = groupRank(b[0]);
      if(rankA !== rankB) return rankA - rankB; // category priority
      const maxYearA = Math.max(...a[1].map(f => f.end_year));
      const maxYearB = Math.max(...b[1].map(f => f.end_year));
      return maxYearB - maxYearA; // then by latest year desc
    });

    const totalInstitutes = sortedGroups.length;
    let totalFiles = 0; sortedGroups.forEach(g => totalFiles += g[1].length);
  %>

  <div class="alert alert-info py-2 px-3 small rounded-3 mb-3 shadow-sm">
    <i class="bi bi-info-circle"></i> รวม <strong><%= totalFiles %></strong> ไฟล์ จาก <strong><%= totalInstitutes %></strong> สถาบัน
  </div>

  <!-- Accordion Groups -->
  <div class="accordion" id="financeAccordion">
    <% sortedGroups.forEach(([cName, files], idx) => { 
        const years = files.map(f => f.end_year).sort();
        const latest = Math.max(...years);
        const oldest = Math.min(...years);
        const rangeLabel = latest === oldest ? latest : oldest + ' - ' + latest;
    %>
      <div class="accordion-item shadow-sm mb-3 rounded-3 border-0 group-wrapper" data-group-name="<%= cName.toLowerCase() %>">
        <h2 class="accordion-header" id="heading-<%= idx %>">
          <button class="accordion-button collapsed d-flex gap-3 py-3" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-<%= idx %>" aria-expanded="false" aria-controls="collapse-<%= idx %>">
            <span class="fw-semibold group-title"><%= cName %></span>
            <span class="badge bg-primary-subtle text-primary border border-primary-subtle rounded-pill align-self-center"><i class="bi bi-files"></i> <%= files.length %></span>
            <span class="badge bg-light text-secondary border rounded-pill align-self-center"><i class="bi bi-calendar-range"></i> <%= rangeLabel %></span>
          </button>
        </h2>
        <div id="collapse-<%= idx %>" class="accordion-collapse collapse" aria-labelledby="heading-<%= idx %>" data-bs-parent="#financeAccordion">
          <div class="accordion-body p-0">
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0 table-hover finance-table">
                <thead class="table-light">
                  <tr>
                    <th style="width:40%">งวด (วันที่ - ปี)</th>
                    <th style="width:20%" class="text-center">ปี</th>
                    <th style="width:20%" class="text-center">ดาวน์โหลด</th>
                    <th style="width:20%" class="text-end pe-3">&nbsp;</th>
                  </tr>
                </thead>
                <tbody>
                  <% files.sort((a,b)=> b.end_year - a.end_year).forEach(file => { %>
                  <tr class="file-row" data-file-text="<%= (file.end_date + ' ' + file.end_year + ' ' + (file.c_name||'')).toLowerCase() %>">
                    <td><span class="date-label"><i class="bi bi-clock-history text-secondary"></i> <%= file.end_date %></span></td>
                    <td class="text-center"><span class="fw-semibold"><%= file.end_year %></span></td>
                    <td class="text-center">
                      <% if(!user){ %>
                        <a href="/auth/login" class="btn btn-outline-primary btn-sm"><i class="bi bi-box-arrow-in-right"></i></a>
                      <% } else { %>
                        <a href="/finance/download/<%= file.id %>" class="btn btn-outline-primary btn-sm" target="_blank" title="ดาวน์โหลด"><i class="bi bi-download"></i></a>
                      <% } %>
                    </td>
                    <td class="text-end pe-3 small text-muted"><%= (file.c_name||'') %></td>
                  </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    <% }) %>
  </div>

  <!-- Pagination -->
  <nav class="mt-4">
    <ul class="pagination pagination-sm justify-content-center flex-wrap gap-1">
      <% for (let i = 1; i <= totalPages; i++) { %>
        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
          <a class="page-link rounded-3" href="/finance?page=<%= i %>"><%= i %></a>
        </li>
      <% } %>
    </ul>
  </nav>

  <div class="text-center mt-5">
    <button class="btn btn-outline-secondary btn-sm" id="scrollTopBtn" type="button"><i class="bi bi-arrow-up-circle"></i> กลับด้านบน</button>
  </div>
</div>

<style>
  .accordion-button:not(.collapsed){ background: linear-gradient(90deg,#f0f7ff,#ffffff); box-shadow: inset 0 -1px 0 rgba(0,0,0,.05);} 
  .accordion-item {transition: box-shadow .25s, transform .25s;} 
  .accordion-item:hover {box-shadow: 0 .25rem .75rem rgba(0,0,0,.07);}
  .finance-table tbody tr {transition: background .15s;} 
  .finance-table tbody tr:hover {background: #f8fbff;} 
  mark.search-highlight {background:#ffe58f;padding:0 .25em;border-radius:.25rem;} 
  #searchInput {transition: box-shadow .25s;} 
  #searchInput:focus {box-shadow:0 0 0 .25rem rgba(13,110,253,.25);} 
  #scrollTopBtn {opacity:0;transition:opacity .3s;} 
  #scrollTopBtn.show {opacity:1;} 
  .badge.bg-primary-subtle {background:#e7f1ff!important;} 
  .date-label {font-weight:500;} 
  .group-wrapper.hide-filter {display:none!important;} 
</style>

<script>
(() => {
  const searchInput = document.getElementById('searchInput');
  const clearBtn = document.getElementById('clearBtn');
  const resultMeta = document.getElementById('resultMeta');
  const collapseAllToggle = document.getElementById('collapseAllToggle');
  const accordion = document.getElementById('financeAccordion');
  const scrollTopBtn = document.getElementById('scrollTopBtn');
  let debounceTimer;

  // Initial meta
  updateMeta();

  function normalize(str){return str.toLowerCase();}

  function highlight(text, keyword){
    if(!keyword) return text;
    const safe = keyword.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    return text.replace(new RegExp('('+safe+')','gi'),'<mark class="search-highlight">$1</mark>');
  }

  function clearHighlights(root){
    root.querySelectorAll('mark.search-highlight').forEach(m => { m.replaceWith(document.createTextNode(m.textContent)); });
  }

  function filter(){
    const kw = normalize(searchInput.value.trim());
    const groups = accordion.querySelectorAll('.group-wrapper');
    let visibleGroups = 0; let visibleFiles = 0;
    groups.forEach(group => {
      const btn = group.querySelector('.accordion-button');
      const titleEl = group.querySelector('.group-title');
      const collapse = group.querySelector('.accordion-collapse');
      clearHighlights(titleEl);
      let groupText = titleEl.textContent.toLowerCase();
      const rows = group.querySelectorAll('tbody tr');
      let rowMatchCount = 0;
      if(!kw){
        group.classList.remove('hide-filter');
        rows.forEach(r => r.classList.remove('d-none'));
      } else {
        rows.forEach(r => {
          const t = r.dataset.fileText;
            if(t.includes(kw)) { r.classList.remove('d-none'); rowMatchCount++; }
            else r.classList.add('d-none');
        });
        if(groupText.includes(kw) || rowMatchCount>0){
          group.classList.remove('hide-filter');
        } else {
          group.classList.add('hide-filter');
        }
      }
      if(!group.classList.contains('hide-filter')){
        visibleGroups++;
        rows.forEach(r => { if(!r.classList.contains('d-none')) visibleFiles++; });
        if(kw && groupText.includes(kw)) {
          titleEl.innerHTML = highlight(titleEl.textContent, kw);
        }
        if(kw){
          // auto expand if matching rows collapsed
          if(!collapse.classList.contains('show')) new bootstrap.Collapse(collapse, {show: true});
        } else if(collapseAllToggle.checked){
          if(collapse.classList.contains('show')) new bootstrap.Collapse(collapse, {toggle:true});
        }
      }
    });
    updateMeta(visibleFiles, visibleGroups, kw);
    clearBtn.classList.toggle('d-none', !kw);
  }

  function updateMeta(files, groups, kw){
    if(files==null){
      const totalGroups = accordion.querySelectorAll('.group-wrapper').length;
      let totalFiles = 0; accordion.querySelectorAll('tbody tr').forEach(()=> totalFiles++);
      resultMeta.textContent = `ทั้งหมด ${totalFiles} ไฟล์ | ${totalGroups} สถาบัน`;
    } else {
      if(kw){
        resultMeta.textContent = `ผลลัพธ์ "${kw}" : ${files} ไฟล์ ใน ${groups} สถาบัน`;
      } else {
        resultMeta.textContent = `ทั้งหมด ${files} ไฟล์ | ${groups} สถาบัน`;
      }
    }
  }

  searchInput.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(filter, 250);
  });

  clearBtn.addEventListener('click', () => {
    searchInput.value='';
    filter();
    searchInput.focus();
  });

  collapseAllToggle.addEventListener('change', () => {
    const groups = accordion.querySelectorAll('.accordion-collapse');
    groups.forEach(c => {
      const isShown = c.classList.contains('show');
      if(collapseAllToggle.checked && isShown){ new bootstrap.Collapse(c, {toggle:true}); }
      if(!collapseAllToggle.checked && !isShown){ new bootstrap.Collapse(c, {show:true}); }
    });
  });

  window.addEventListener('scroll', () => {
    if(window.scrollY > 300) scrollTopBtn.classList.add('show');
    else scrollTopBtn.classList.remove('show');
  });
  scrollTopBtn.addEventListener('click', () => window.scrollTo({top:0, behavior:'smooth'}));
})();
</script>
<%- include('partials/footer') %>
