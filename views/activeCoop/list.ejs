<%- include('../partials/header') %>
<div class="container py-4">
  <h2 class="mb-4 text-primary">
    <i class="bi bi-archive me-2"></i> สรุปสหกรณ์ / กลุ่มเกษตรกร แยกตามปีสิ้นสุด (end_date)
  </h2>

  <% const years = Object.keys(groups).sort((a,b)=> b - a); if (years.length === 0) { %>
    <div class="alert alert-info">ไม่มีข้อมูล end_date</div>
  <% } %>

  <% 
    // แยกเป็น 2 กลุ่มตาม coop_group
    const coopByYear = {};
    const farmerByYear = {};
    years.forEach(y => {
      groups[y].forEach(r => {
        if (r.coop_group === 'สหกรณ์') {
          (coopByYear[y] ||= []).push(r);
        } else if (r.coop_group === 'กลุ่มเกษตรกร') {
          (farmerByYear[y] ||= []).push(r);
        }
      });
    });
  %>

  <!-- ตาราง: สหกรณ์ -->
  <div class="mb-4">
    <h4 class="mb-3 text-success"><i class="bi bi-collection me-2"></i> สหกรณ์</h4>
    <% Object.keys(coopByYear).sort((a,b)=> b - a).forEach(year => { const list = coopByYear[year]; if(!list.length)return; %>
      <div class="card shadow-sm border-0 mb-3">
        <div class="card-header bg-success text-white">
          ปี <strong><%= year %></strong> (ทั้งหมด <%= list.length %> แห่ง)
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm table-hover mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th>#</th>
                  <th>รหัส</th>
                  <th>ชื่อ</th>
                  <th>กลุ่ม (c_group)</th>
                  <th>สถานะ</th>
                  <th>End Date</th>
                </tr>
              </thead>
              <tbody>
                <% list.forEach((row, idx)=> { %>
                  <tr>
                    <td><%= idx + 1 %></td>
                    <td><%= row.c_code %></td>
                    <td><%= row.c_name %></td>
                    <td><%= row.c_group %></td>
                    <td>
                      <span class="badge <%= row.c_status === 'ดำเนินการ' ? 'bg-primary' : 'bg-secondary' %>">
                        <%= row.c_status %>
                      </span>
                    </td>
                    <td><%= row.end_date || '-' %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    <% }) %>
    <% if (Object.keys(coopByYear).length === 0) { %>
      <div class="alert alert-light border">ไม่มีข้อมูลสหกรณ์</div>
    <% } %>
  </div>

  <!-- ตาราง: กลุ่มเกษตรกร -->
  <div class="mb-4">
    <h4 class="mb-3 text-info"><i class="bi bi-collection me-2"></i> กลุ่มเกษตรกร</h4>
    <% Object.keys(farmerByYear).sort((a,b)=> b - a).forEach(year => { const list = farmerByYear[year]; if(!list.length)return; %>
      <div class="card shadow-sm border-0 mb-3">
        <div class="card-header bg-info text-white">
          ปี <strong><%= year %></strong> (ทั้งหมด <%= list.length %> แห่ง)
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm table-hover mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th>#</th>
                  <th>รหัส</th>
                  <th>ชื่อ</th>
                  <th>กลุ่ม (c_group)</th>
                  <th>สถานะ</th>
                  <th>End Date</th>
                </tr>
              </thead>
              <tbody>
                <% list.forEach((row, idx)=> { %>
                  <tr>
                    <td><%= idx + 1 %></td>
                    <td><%= row.c_code %></td>
                    <td><%= row.c_name %></td>
                    <td><%= row.c_group %></td>
                    <td>
                      <span class="badge <%= row.c_status === 'ดำเนินการ' ? 'bg-primary' : 'bg-secondary' %>">
                        <%= row.c_status %>
                      </span>
                    </td>
                    <td><%= row.end_date || '-' %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    <% }) %>
    <% if (Object.keys(farmerByYear).length === 0) { %>
      <div class="alert alert-light border">ไม่มีข้อมูลกลุ่มเกษตรกร</div>
    <% } %>
  </div>

  <div class="text-end">
    <a href="/" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-arrow-left"></i> กลับหน้าแรก
    </a>
  </div>
</div>
<%- include('../partials/footer') %>