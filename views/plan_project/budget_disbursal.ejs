<%- include('../partials/header') %>

<div class="py-3 py-md-4">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-3 mb-4">
    <div>
      <p class="text-uppercase text-muted small mb-1">รายงานการเบิกเงิน</p>
      <h1 class="h4 mb-2"><%= project.pro_subject %></h1>
      <p class="mb-1 text-muted">โครงการ: <span class="fw-semibold text-dark"><%= project.pro_code %></span></p>
      <p class="mb-0 text-muted">งบประมาณทั้งหมด: <span class="fw-semibold text-success"><%= Number(project.pro_budget || 0).toLocaleString('th-TH') %> บาท</span></p>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a href="/planproject/summary/<%= encodeURIComponent(project.pro_code) %>" class="btn btn-outline-secondary btn-sm rounded-pill px-3">
        <i class="bi bi-arrow-left me-1"></i>กลับไป
      </a>
      <a href="/planproject/budget_disbursal/export?pro_code=<%= encodeURIComponent(project.pro_code) %>" class="btn btn-outline-info btn-sm rounded-pill px-3">
        <i class="bi bi-download me-1"></i>ส่งออก CSV
      </a>
      <button type="button" class="btn btn-primary btn-sm rounded-pill px-3" data-bs-toggle="modal" data-bs-target="#addDisbursalModal">
        <i class="bi bi-plus-circle me-1"></i>บันทึกการเบิก
      </button>
    </div>
  </div>

  <!-- สรุปงบประมาณ -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <p class="text-muted small mb-1">งบประมาณทั้งหมด</p>
          <h2 class="h5 mb-0 text-primary">
            <%= Number(project.pro_budget || 0).toLocaleString('th-TH') %>
            <small class="text-muted">บาท</small>
          </h2>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <p class="text-muted small mb-1">รวมเบิกไปทั้งสิ้น</p>
          <h2 class="h5 mb-0 text-warning">
            <%= Number(monthlyWithBalance.length > 0 ? monthlyWithBalance[monthlyWithBalance.length - 1].cumulative_spent : 0).toLocaleString('th-TH') %>
            <small class="text-muted">บาท</small>
          </h2>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <p class="text-muted small mb-1">คงเหลือ</p>
          <h2 class="h5 mb-0 text-success">
            <%= Number(monthlyWithBalance.length > 0 ? monthlyWithBalance[monthlyWithBalance.length - 1].remaining_budget : project.pro_budget).toLocaleString('th-TH') %>
            <small class="text-muted">บาท</small>
          </h2>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-6 col-lg-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body">
          <p class="text-muted small mb-1">จำนวนครั้งการเบิก</p>
          <h2 class="h5 mb-0 text-info">
            <%= disbursals.length %>
            <small class="text-muted">ครั้ง</small>
          </h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab navigation -->
  <ul class="nav nav-tabs mb-4" id="budgetTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="monthly-tab" data-bs-toggle="tab" data-bs-target="#monthly" type="button" role="tab" aria-controls="monthly" aria-selected="true">
        <i class="bi bi-calendar-month me-2"></i>สรุปรายเดือน
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="detail-tab" data-bs-toggle="tab" data-bs-target="#detail" type="button" role="tab" aria-controls="detail" aria-selected="false">
        <i class="bi bi-list-ul me-2"></i>รายละเอียดทั้งหมด
      </button>
    </li>
  </ul>

  <!-- Tab content -->
  <div class="tab-content" id="budgetTabContent">
    <!-- สรุปการเบิกตามเดือน -->
    <div class="tab-pane fade show active" id="monthly" role="tabpanel" aria-labelledby="monthly-tab">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-4">
          <h2 class="h5 mb-3 d-flex align-items-center gap-2">
            <i class="bi bi-bar-chart text-primary"></i>
            สรุปการเบิกเงินตามเดือน
          </h2>
          
          <% if (monthlyWithBalance.length === 0) { %>
            <div class="alert alert-light border text-center">
              <i class="bi bi-inbox"></i> ยังไม่มีการเบิกเงิน
            </div>
          <% } else { %>
            <div class="table-responsive">
              <table class="table align-middle table-hover">
                <thead class="table-light">
                  <tr>
                    <th style="width: 20%;">เดือน</th>
                    <th class="text-end" style="width: 20%;">เบิกในเดือนนี้</th>
                    <th class="text-end" style="width: 20%;">สะสมจนถึง</th>
                    <th class="text-end" style="width: 20%;">คงเหลือ</th>
                    <th class="text-center" style="width: 20%;">ความก้าวหน้า</th>
                  </tr>
                </thead>
                <tbody>
                  <% monthlyWithBalance.forEach((item) => { 
                    const percentUsed = Math.round((item.cumulative_spent / project.pro_budget) * 100);
                  %>
                    <tr>
                      <td>
                        <span class="badge bg-light text-dark fw-semibold">
                          <%= item.month_label %>
                        </span>
                      </td>
                      <td class="text-end">
                        <span class="fw-semibold text-warning">
                          <%= item.total_amount_formatted %>
                        </span>
                      </td>
                      <td class="text-end">
                        <span class="fw-semibold text-info">
                          <%= item.cumulative_spent_formatted %>
                        </span>
                      </td>
                      <td class="text-end">
                        <span class="fw-semibold <%= item.remaining_budget < 0 ? 'text-danger' : 'text-success' %>">
                          <%= item.remaining_budget_formatted %>
                        </span>
                      </td>
                      <td class="text-center">
                        <div class="progress" style="height: 24px;">
                          <div class="progress-bar <%= percentUsed > 100 ? 'bg-danger' : percentUsed > 80 ? 'bg-warning' : 'bg-success' %>" 
                               role="progressbar" 
                               style="width: <%= Math.min(percentUsed, 100) %>%;"
                               aria-valuenow="<%= percentUsed %>" 
                               aria-valuemin="0" 
                               aria-valuemax="100">
                            <%= percentUsed %>%
                          </div>
                        </div>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } %>
        </div>
      </div>
    </div>

    <!-- รายละเอียดการเบิก -->
    <div class="tab-pane fade" id="detail" role="tabpanel" aria-labelledby="detail-tab">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <h2 class="h5 mb-3 d-flex align-items-center gap-2">
            <i class="bi bi-list-ul text-primary"></i>
            รายละเอียดการเบิกเงิน
          </h2>
          
          <% if (disbursals.length === 0) { %>
            <div class="alert alert-light border text-center">
              <i class="bi bi-inbox"></i> ยังไม่มีการเบิกเงิน
            </div>
          <% } else { %>
            <div class="table-responsive">
              <table class="table align-middle table-hover">
                <thead class="table-light">
                  <tr>
                    <th style="width: 10%;">ลำดับ</th>
                    <th style="width: 15%;">วันที่เบิก</th>
                    <th style="width: 15%;">หมวดหมู่</th>
                    <th style="width: 30%;">รายละเอียด</th>
                    <th class="text-end" style="width: 15%;">จำนวนเงิน</th>
                    <th class="text-center" style="width: 15%;">การจัดการ</th>
                  </tr>
                </thead>
                <tbody>
                  <% disbursals.forEach((item, index) => { %>
                    <tr>
                      <td>
                        <span class="badge bg-secondary"><%= index + 1 %></span>
                      </td>
                      <td>
                        <small class="text-muted"><%= item.disbursal_date_formatted %></small>
                      </td>
                      <td>
                        <span class="badge bg-info">
                          <%= item.disbursal_type_label %>
                        </span>
                      </td>
                      <td>
                        <div class="fw-semibold"><%= item.description %></div>
                        <% if (item.reference_no) { %>
                          <small class="text-muted">อ้างอิง: <%= item.reference_no %></small>
                        <% } %>
                      </td>
                      <td class="text-end">
                        <span class="fw-semibold text-primary">
                          <%= Number(item.amount).toLocaleString('th-TH', { maximumFractionDigits: 2 }) %>
                        </span>
                      </td>
                      <td class="text-center">
                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                onclick="deleteDisbursal('<%= item.id %>', '<%= encodeURIComponent(project.pro_code) %>')">
                          <i class="bi bi-trash"></i>
                        </button>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal สำหรับบันทึกการเบิก -->
<div class="modal fade" id="addDisbursalModal" tabindex="-1" aria-labelledby="addDisbursalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="addDisbursalLabel">บันทึกการเบิกเงิน</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="addDisbursalForm">
        <div class="modal-body">
          <input type="hidden" name="pro_code" value="<%= project.pro_code %>">
          
          <div class="mb-3">
            <label for="disbursal_date" class="form-label">วันที่เบิก *</label>
            <input type="date" class="form-control" id="disbursal_date" name="disbursal_date" required>
          </div>

          <div class="mb-3">
            <label for="amount" class="form-label">จำนวนเงิน (บาท) *</label>
            <input type="number" class="form-control" id="amount" name="amount" step="0.01" min="0" required>
          </div>

          <div class="mb-3">
            <label for="disbursal_type" class="form-label">หมวดหมู่ *</label>
            <select class="form-select" id="disbursal_type" name="disbursal_type" required>
              <option value="">-- เลือกหมวดหมู่ --</option>
              <% Object.entries(disbursal_types).forEach(([key, label]) => { %>
                <option value="<%= key %>"><%= label %></option>
              <% }) %>
            </select>
          </div>

          <div class="mb-3">
            <label for="description" class="form-label">รายละเอียด *</label>
            <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
          </div>

          <div class="mb-3">
            <label for="reference_no" class="form-label">เลขอ้างอิง</label>
            <input type="text" class="form-control" id="reference_no" name="reference_no" placeholder="เช่น ใบเสร็จ, เลขที่ PO">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
          <button type="submit" class="btn btn-primary">บันทึก</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.getElementById('addDisbursalForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const formData = new FormData(e.target);
  
  try {
    const response = await fetch('/planproject/budget_disbursal', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(Object.fromEntries(formData))
    });
    
    const result = await response.json();
    
    if (result.success) {
      window.location.href = result.redirect;
    } else {
      alert('เกิดข้อผิดพลาด: ' + result.message);
    }
  } catch (error) {
    console.error('Error:', error);
    alert('เกิดข้อผิดพลาดในการบันทึก');
  }
});

function deleteDisbursal(id, proCode) {
  if (confirm('คุณแน่ใจหรือว่าต้องการลบรายการนี้?')) {
    fetch(`/planproject/budget_disbursal/${id}?pro_code=${encodeURIComponent(proCode)}`, {
      method: 'DELETE'
    })
    .then(response => response.json())
    .then(result => {
      if (result.success) {
        window.location.href = result.redirect;
      } else {
        alert('เกิดข้อผิดพลาด: ' + result.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('เกิดข้อผิดพลาดในการลบ');
    });
  }
}

// Set today as default date
document.getElementById('disbursal_date').valueAsDate = new Date();
</script>

<style>
  .table-hover tbody tr:hover {
    background-color: rgba(0, 0, 0, 0.02);
  }
  
  .progress {
    border-radius: 0.375rem;
  }
</style>

<%- include('../partials/footer') %>
