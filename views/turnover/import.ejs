<%- include('../partials/header') %>

<%
  const monthMap = {
    '1': 'มกราคม',
    '2': 'กุมภาพันธ์',
    '3': 'มีนาคม',
    '4': 'เมษายน',
    '5': 'พฤษภาคม',
    '6': 'มิถุนายน',
    '7': 'กรกฎาคม',
    '8': 'สิงหาคม',
    '9': 'กันยายน',
    '10': 'ตุลาคม',
    '11': 'พฤศจิกายน',
    '12': 'ธันวาคม'
  };
  const toThaiMonth = (val) => {
    const key = val == null ? '' : String(val).trim();
    return monthMap[key] || key;
  };
  const toThaiYear = (val) => {
    const num = Number(val);
    if (Number.isFinite(num) && num > 0 && num < 2400) return num + 543;
    return val || '';
  };
%>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <div>
      <h1 class="h4 mb-1"><i class="bi bi-file-earmark-spreadsheet me-2"></i>นำเข้าไฟล์ปริมาณธุรกิจ</h1>
      <div class="text-muted small">ตาราง: tbl_turnover</div>
    </div>
  </div>

  <% if (summary && summary.length) { %>
    <div class="card shadow-sm border-0 mt-4">
      <div class="card-header bg-white">
        <h6 class="mb-0">สรุปประจำเดือน</h6>
      </div>
      <div class="table-responsive">
        <table class="table table-sm table-bordered table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>ปี</th>
              <th>เดือน</th>
              <th class="text-end">จำนวนแห่ง</th>
              <th class="text-end">ปริมาณธุรกิจรวม</th>
            </tr>
          </thead>
          <tbody>
            <% summary.forEach(row => { %>
              <tr>
                <td><%= toThaiYear(row.tur_year) %></td>
                <td><%= toThaiMonth(row.tur_month) %></td>
                <td class="text-end"><%= Number(row.coop_count || 0).toLocaleString() %></td>
                <td class="text-end"><%= Number(row.total_amount || 0).toLocaleString() %></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  <% } %>

  <% if (msg) { %>
    <div class="alert alert-info py-2"><%= msg %></div>
  <% } %>

  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
      <form action="/turnover/import" method="POST" enctype="multipart/form-data">
        <div class="mb-3">
          <label class="form-label">ไฟล์ Excel (.xlsx หรือ .xls)</label>
          <input type="file" name="file" accept=".xls,.xlsx" class="form-control" required>
          <div class="form-text">ลำดับคอลัมน์: รหัสสหกรณ์, ชื่อสหกรณ์, ปี, เดือน, ยอดเงิน</div>
        </div>
        <button class="btn btn-primary">นำเข้า</button>
      </form>
    </div>
  </div>

  <div class="card shadow-sm border-0">
    <div class="card-header bg-white">
      <h6 class="mb-0">ข้อมูลล่าสุด (<%= rows.length %> แถว)</h6>
    </div>
    <div class="table-responsive">
      <table class="table table-sm table-bordered table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>รหัสสหกรณ์</th>
            <th>ชื่อสหกรณ์</th>
            <th>ปี</th>
            <th>เดือน</th>
            <th class="text-end">ยอดเงิน</th>
          </tr>
        </thead>
        <tbody>
          <% if (!rows.length) { %>
            <tr>
              <td colspan="5" class="text-center text-muted">ยังไม่มีข้อมูล</td>
            </tr>
          <% } else { %>
            <% rows.forEach(r => { %>
              <tr>
                <td><%= r.tur_code %></td>
                <td><%= r.tur_name %></td>
                <td><%= toThaiYear(r.tur_year) %></td>
                <td><%= toThaiMonth(r.tur_month) %></td>
                <td class="text-end"><%= Number(r.tur_amount || 0).toLocaleString() %></td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>

  <div class="mt-3">
    <details>
      <summary class="fw-bold">ตัวอย่างข้อมูลใน Excel</summary>
      <pre class="small bg-light p-2 border">รหัสสหกรณ์,ชื่อสหกรณ์,ปี,เดือน,ยอดเงิน
CP001,สหกรณ์ A,2567,มกราคม,120000</pre>
    </details>
  </div>
</div>

<%- include('../partials/footer') %>
