<%- include('../partials/header') %>

<%
  function formatThaiDate(dateStr) {
    if (
      !dateStr ||
      dateStr === '0000-00-00' ||
      dateStr === '0000-00-00 00:00:00' ||
      dateStr === 'Invalid date'
    ) return '-';
    const d = new Date(dateStr);
    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏µ 1899 ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    if (isNaN(d.getTime()) || d.getFullYear() < 1950) return '-';
    const months = [
      '', '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
      '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
    ];
    const day = d.getDate();
    const month = months[d.getMonth() + 1];
    const year = d.getFullYear() + 543;
    return `${day} ${month} ${year}`;
  }
%>

<div class="container mt-4">
  <h2 class="mb-4">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Chamra</h2>
  <a href="/chamra/add" class="btn btn-success mb-3">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° Chamra</a>
  <a href="/chamra/poblem" class="btn btn-warning mb-3">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Chamra</a>

  <table class="table table-bordered table-striped">
    <thead class="table-dark">
      <tr>
        <th>#</th>
        <th>‡∏£‡∏´‡∏±‡∏™</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠</th>
       
        <th>‡∏ú‡∏π‡πâ‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£</th>
        <% if(user && user.mClass === 'kjs'){  %>

        <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        <% } %>
      </tr>
    </thead>
    
    <tbody>
      <% data.forEach((c, index) => { %>
        <tr>
          <td><%= index + 1 %></td>
          <td><%= c.c_code %></td>
          <td>
            <%= c.c_name %>
            <% if(c.c_status === '‡∏ñ‡∏≠‡∏ô‡∏ä‡∏∑‡πà‡∏≠'){ %>
              <button class="btn btn-sm btn-outline-success">‡∏ñ‡∏≠‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß</button>
            <% }else{ %>
              <button class="btn btn-sm btn-outline-danger">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
            <% } %>

          </td>
          
          <td><%= c.de_person %></td>
          <td class="text-nowrap">
            <%
              function showStep(label, value) {
                if (!value || value === '0000-00-00' || value === '' || value === null) {
                  return `${label}: -`;
                }
                const formatted = formatThaiDate(value);
                return `${label}: ${formatted}`;
              }
              const steps = [];
              steps.push(showStep('S1', c.pr_s1));
              steps.push(showStep('S2', c.pr_s2));
              steps.push(showStep('S3', c.pr_s3));
              steps.push(showStep('S4', c.pr_s4));
              steps.push(showStep('S5', c.pr_s5));
              steps.push(showStep('S6', c.pr_s6));
              steps.push(showStep('S7', c.pr_s7));
              steps.push(showStep('S8', c.pr_s8));
              steps.push(showStep('S9', c.pr_s9));
              steps.push(showStep('S10', c.pr_s10));
            %>
            <%- steps.join('<br>') %>
          </td>
          <% if(user && user.mClass === 'kjs'){  %>
          <td>
            <a href="/chamra/edit/<%= c.c_code %>" class="btn btn-primary btn-sm">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</a>
            <form action="/chamra/delete/<%= c.c_code %>" method="POST" style="display:inline;" onsubmit="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö Chamra?');">
              <button type="submit" class="btn btn-danger btn-sm">üóëÔ∏è ‡∏•‡∏ö</button>
            </form>
          </td>
          <% } %>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>

<%- include('../partials/footer') %>
