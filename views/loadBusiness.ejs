<%- include('./partials/header') %>

<div class="container mt-2 shadow-lg p-4 bg-white rounded">
  <h3 class="mb-4">üìã ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>

  <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ + ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î -->
  <div class="row mb-3 align-items-center">
    <div class="col-md-6">
      <form method="GET" action="/business">
        <div class="input-group">

          <input type="text" name="search" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå" value="<%= search %>">
          <button class="btn btn-outline-secondary" type="submit">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
          <a href="/business" class="btn btn-outline-danger">‡∏•‡πâ‡∏≤‡∏á</a>
        </div>
      </form>
    </div>
    <div class="col-md-6 text-end">
      <% if(user && (user.mClass === 'kts' || user.mClass === 'admin')) { %>
        <a href="/business/upload" class="btn btn-success">
          <i class="bi bi-plus-circle"></i> ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£
        </a>
      <% } %>
    </div>
  </div>

  <!-- Updated styles for grouped display -->
  <style>
    .business-group-title {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: .35rem;
      display: flex;
      align-items: center;
      gap: .4rem;
    }
    .business-card p {
      font-size: 1rem;
      text-align: center; /* Centering the text */
    }
    .business-card .btn {
      font-size: .65rem;
      padding: .25rem .45rem;
    }
  </style>

  <!-- Replaced flat grid with grouped sections -->
  <% if(fileGrouped && Object.keys(fileGrouped).length > 0) { %>
    <% Object.keys(fileGrouped).forEach(buName => { %>
      <div class="mb-4">
        <div class="business-group-title">
          <i class="bi bi-building"></i> <span><%= buName %></span>
        </div>
        <div class="row g-3">
          <% fileGrouped[buName].forEach(file => { %>
            <div class="col-6 col-sm-4 col-md-3 col-lg-2">
              <div class="card business-card h-100 shadow-sm">
                <div class="card-body p-2 d-flex flex-column">
                  <p class="mb-2 text-center">
                   
                    <%= file.end_date %> <%= file.bu_endyear %>
                  </p>
                  <div class="mt-auto">
                    <% if(!user){ %>
                      <a href="/auth/login" class="btn btn-outline-primary w-100 mb-1">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>
                    <% } else { %>
                      <div class="d-flex flex-wrap gap-1">
                        <a href="/business/download/<%= file.bu_id %>" class="btn btn-outline-primary flex-grow-1">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</a>
                        <% if(user && (user.mClass === 'admin' || user.mClass === 'kbs')) { %>
                          <a href="/business/delete/<%= file.bu_id %>" class="btn btn-outline-danger" onclick="return confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ?')">‡∏•‡∏ö</a>
                        <% } %>
                      </div>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      </div>
    <% }) %>
  <% } else { %>
    <div class="alert alert-warning text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
  <% } %>

  <!-- Pagination -->
  <% if(totalPages > 1) { %>
    <nav class="mt-4">
      <ul class="pagination justify-content-center">
        <% for (let i = 1; i <= totalPages; i++) { %>
          <li class="page-item <%= currentPage === i ? 'active' : '' %>">
            <a class="page-link" href="/business?page=<%= i %><%= search ? '&search=' + encodeURIComponent(search) : '' %>">
              <%= i %>
            </a>
          </li>
        <% } %>
      </ul>
    </nav>
  <% } %>
</div>

<%- include('./partials/footer') %>
