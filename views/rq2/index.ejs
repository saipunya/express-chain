<%- include('../partials/header', { title: 'RQ2' }) %>
<div class="container py-3">
  <!-- Toolbar -->
  <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3 mb-4">
    <div>
      <h3 class="m-0 fw-bold d-flex align-items-center gap-2">
        <i class="bi bi-file-text-fill text-primary"></i>
        รายงาน RQ2
        <span class="badge bg-gradient-info text-uppercase" style="font-size:.65rem; letter-spacing:.5px;">Beta</span>
      </h3>
      <small class="text-muted">รายการเอกสาร RQ2 ทั้งหมด <span class="fw-semibold"><%= (pagination && pagination.total) || items.length %></span> รายการ</small>
    </div>
    <form class="d-flex flex-wrap gap-2" method="GET" action="">
      <input type="hidden" name="page" value="1">
      <div class="input-group shadow-sm" style="min-width:260px;">
        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
        <input type="text" class="form-control" name="search" placeholder="ค้นหาชื่อ (rq_name)" value="<%= search || '' %>">
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-primary" type="submit"><i class="bi bi-filter"></i> ค้นหา</button>
        <a href="/rq2" class="btn btn-outline-secondary"><i class="bi bi-x-circle"></i> ล้าง</a>
        <% if(user && user.mClass=='kjs'){ %>
          <a href="/rq2/create" class="btn btn-success"><i class="bi bi-plus-circle"></i> Add</a>
        <% } %>
      </div>
      <div>
        <select name="pageSize" class="form-select form-select-sm ms-lg-2" onchange="this.form.submit()">
          <% [10,20,30,50].forEach(sz => { %>
            <option value="<%= sz %>" <%= (pagination && pagination.pageSize==sz)?'selected':'' %>><%= sz %>/หน้า</option>
          <% }) %>
        </select>
      </div>
    </form>
  </div>
  <!-- Card Wrapper -->
  <div class="card border-0 shadow-sm rounded-4">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:45%">ชื่อ (RQ Name)</th>
              <th class="text-center" style="width:12%">ปี (Year)</th>
              <th class="text-center" style="width:12%">ไฟล์</th>
              <% if(user && user.mClass=='kjs'){ %>
                <th class="text-center" style="width:15%">จัดการ</th>
              <% } %>
            </tr>
          </thead>
          <tbody>
            <% if(items.length === 0){ %>
              <tr>
                <td colspan="4" class="text-center py-5 text-muted">
                  <i class="bi bi-inbox" style="font-size:2rem;"></i>
                  <div class="mt-2">ไม่พบข้อมูล</div>
                </td>
              </tr>
            <% } %>
            <% items.forEach(p => { %>
              <tr class="rq2-row">
                <td class="fw-semibold">
                  <div class="d-flex flex-column flex-sm-row align-items-start align-items-sm-center gap-2">
                    <span><i class="bi bi-file-earmark-text text-secondary me-1"></i><%= p.rq_name %></span>
                    <% const pSavedDate = new Date(p.rq_savedate); const currentDate = new Date(); const diffDays = Math.ceil((currentDate - pSavedDate) / (1000 * 60 * 60 * 24)); %>
                    <% if (diffDays <= 7) { %>
                      <span class="badge new-badge bg-danger d-inline-flex align-items-center gap-1">
                        <i class="bi bi-stars"></i> NEW
                      </span>
                    <% } %>
                  </div>
                  <div class="small text-muted mt-1">
                    บันทึกเมื่อ: <%= new Date(p.rq_savedate).toLocaleDateString('th-TH') %>
                  </div>
                </td>
                <td class="text-center"><span class="badge rounded-pill bg-gradient-info px-3 py-2"><%= p.rq_year %></span></td>
                <td class="text-center">
                  <% if (user) { %>
                    <a href="/rq2/download/<%= p.rq_id %>" target="_blank" class="btn btn-sm btn-outline-primary rounded-pill px-3"><i class="bi bi-cloud-arrow-down"></i> file</a>
                  <% } else { %>
                    <a href="/auth/login" class="btn btn-sm btn-outline-primary rounded-pill px-3"><i class="bi bi-box-arrow-in-right"></i> เข้าสู่ระบบ</a>
                  <% } %>
                </td>
                <% if(user && user.mClass=='kjs'){ %>
                  <td class="text-center text-nowrap">
                    <div class="btn-group btn-group-sm" role="group">
                      <a href="/rq2/edit/<%= p.rq_id %>" class="btn btn-warning"><i class="bi bi-pencil-square"></i></a>
                      <form action="/rq2/delete/<%= p.rq_id %>" method="POST" onsubmit="return confirm('Delete?')">
                        <button class="btn btn-danger" type="submit"><i class="bi bi-trash"></i></button>
                      </form>
                    </div>
                  </td>
                <% } %>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- Legend -->
  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mt-3 gap-3">
    <div class="d-flex align-items-center gap-2 small text-muted">
      <span class="badge new-badge bg-danger d-inline-flex align-items-center gap-1" style="font-size:.6rem;"><i class="bi bi-stars"></i> NEW</span>
      <span>= เพิ่มภายใน 7 วัน</span>
    </div>
    <!-- Pagination -->
    <% if (pagination && pagination.totalPages > 1) { %>
      <nav aria-label="RQ2 pagination" class="ms-auto">
        <ul class="pagination pagination-sm mb-0 flex-wrap">
          <% const baseQuery = (extra={}) => {
               const params = new URLSearchParams();
               if (search) params.set('search', search);
               if (pagination.pageSize) params.set('pageSize', pagination.pageSize);
               Object.keys(extra).forEach(k=>params.set(k, extra[k]));
               return '?' + params.toString();
             } %>
          <!-- First page button -->
          <li class="page-item <%= pagination.page === 1 ? 'disabled':'' %>">
            <a class="page-link" href="<%= pagination.page === 1 ? '#' : baseQuery({page:1}) %>">&laquo;&laquo;</a>
          </li>
          <!-- Prev page button -->
          <li class="page-item <%= !pagination.hasPrev ? 'disabled':'' %>">
            <a class="page-link" href="<%= pagination.hasPrev ? baseQuery({page: pagination.page - 1}) : '#' %>">&laquo;</a>
          </li>
          <% // window of pages
             const windowSize = 5;
             let start = Math.max(1, pagination.page - Math.floor(windowSize/2));
             let end = start + windowSize - 1;
             if (end > pagination.totalPages) { end = pagination.totalPages; start = Math.max(1, end - windowSize + 1); }
             if (start > 1) { %>
               <li class="page-item"><a class="page-link" href="<%= baseQuery({page:1}) %>">1</a></li>
               <% if (start > 2) { %><li class="page-item disabled"><span class="page-link">...</span></li><% } %>
          <% } %>
          <% for (let p = start; p <= end; p++) { %>
            <li class="page-item <%= p === pagination.page ? 'active':'' %>"><a class="page-link" href="<%= baseQuery({page:p}) %>"><%= p %></a></li>
          <% } %>
          <% if (end < pagination.totalPages) { %>
            <% if (end < pagination.totalPages - 1) { %><li class="page-item disabled"><span class="page-link">...</span></li><% } %>
            <li class="page-item"><a class="page-link" href="<%= baseQuery({page:pagination.totalPages}) %>"><%= pagination.totalPages %></a></li>
          <% } %>
          <!-- Next page button -->
          <li class="page-item <%= !pagination.hasNext ? 'disabled':'' %>">
            <a class="page-link" href="<%= pagination.hasNext ? baseQuery({page: pagination.page + 1}) : '#' %>">&raquo;</a>
          </li>
          <!-- Last page button -->
          <li class="page-item <%= pagination.page === pagination.totalPages ? 'disabled':'' %>">
            <a class="page-link" href="<%= pagination.page === pagination.totalPages ? '#' : baseQuery({page: pagination.totalPages}) %>">&raquo;&raquo;</a>
          </li>
        </ul>
        <div class="text-end small text-muted mt-1">หน้า <%= pagination.page %> / <%= pagination.totalPages %> (แถว <%= items.length %> จาก <%= pagination.total %>)</div>
      </nav>
    <% } %>
  </div>
</div>
<%- include('../partials/footer') %>
