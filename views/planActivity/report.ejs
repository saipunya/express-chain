<%- include('../partials/header') %>

<%
  const kpiList = Array.isArray(typeof kpiMetrics !== 'undefined' ? kpiMetrics : []) ? (kpiMetrics || []) : [];
  const hasProject = Boolean(selectedProject);
  const monthInput = (selectedMonth || '').slice(0, 7);
  const monthDisplay = (typeof monthLabel !== 'undefined' && monthLabel) ? monthLabel : monthInput;
  const hasActivities = Array.isArray(activities) && activities.length > 0;
  const hasKpis = kpiList.length > 0;
  const isoMonthValue = monthInput || new Date().toISOString().slice(0, 7);
  let selectedGregorianYear = Number.parseInt(isoMonthValue.slice(0, 4), 10);
  let selectedMonthNumber = Number.parseInt(isoMonthValue.slice(5, 7), 10);
  if (Number.isNaN(selectedGregorianYear)) {
    selectedGregorianYear = new Date().getFullYear();
  }
  if (Number.isNaN(selectedMonthNumber)) {
    selectedMonthNumber = new Date().getMonth() + 1;
  }
  const monthOptions = [
    { value: 1, label: 'มกราคม' },
    { value: 2, label: 'กุมภาพันธ์' },
    { value: 3, label: 'มีนาคม' },
    { value: 4, label: 'เมษายน' },
    { value: 5, label: 'พฤษภาคม' },
    { value: 6, label: 'มิถุนายน' },
    { value: 7, label: 'กรกฎาคม' },
    { value: 8, label: 'สิงหาคม' },
    { value: 9, label: 'กันยายน' },
    { value: 10, label: 'ตุลาคม' },
    { value: 11, label: 'พฤศจิกายน' },
    { value: 12, label: 'ธันวาคม' }
  ];
  const thaiYearOptions = [];
  for (let diff = -2; diff <= 2; diff += 1) {
    thaiYearOptions.push(selectedGregorianYear + diff);
  }
  const safeAttachments = Array.isArray(typeof attachments !== 'undefined' ? attachments : []) ? (attachments || []) : [];
  const attachmentErrorMessage = typeof attachmentUploadError === 'string' ? attachmentUploadError : null;
%>

<div class="py-4">
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
    <div>
      <h1 class="h3 mb-1"><i class="bi bi-calendar2-check me-2"></i>รายงานสถานะกิจกรรมรายเดือน</h1>
      <p class="text-muted small mb-0">เลือกโครงการและเดือนที่ต้องการสรุปรายงาน พร้อมกำหนดสถานะกิจกรรมย่อย</p>
    </div>
    <div>
      <!-- back to main page -->
      <div class="d-flex gap-2">
        <a href="/plan" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left me-2"></i>กลับหน้าหลัก</a>
        <a href="/planproject/activities-overview" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left me-2"></i>ย้อนกลับโครงการทั้งหมด</a>
      </div>
    </div>
  </div>

  <form id="monthly-filter-form" class="card border-0 shadow-sm mb-4" method="get" action="/planactivity/report">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-6">
          <label for="pro_code" class="form-label">เลือกโครงการ</label>
          <select class="form-select" id="pro_code" name="pro_code" required>
            <option value="">-- เลือกโครงการ --</option>
            <!-- choose thai name of project -->
            <% projects.forEach(project => { %>
              <option value="<%= project.pro_code %>" <%= project.pro_code === selectedProject ? 'selected' : '' %>>
                <!-- display thai name of project-->
                <%= project.pro_subject || '' %>

              </option>
            <% }) %>

          </select>
        </div>
        <div class="col-md-3">
          <label for="month" class="form-label">เดือนที่รายงาน</label>
          <input type="hidden" id="month-hidden" name="month" value="<%= isoMonthValue %>">
          <div class="row g-2">
            <div class="col-6">
              <select class="form-select" id="month-select" aria-label="เลือกเดือน" required>
                <% monthOptions.forEach((option) => { %>
                  <option value="<%= option.value %>" <%= option.value === selectedMonthNumber ? 'selected' : '' %>><%= option.label %></option>
                <% }) %>
              </select>
            </div>
            <div class="col-6">
              <select class="form-select" id="year-select" aria-label="เลือกปี พ.ศ." required>
                <% thaiYearOptions.forEach((year) => { const thaiYear = year + 543; %>
                  <option value="<%= thaiYear %>" <%= year === selectedGregorianYear ? 'selected' : '' %>><%= thaiYear %></option>
                <% }) %>
              </select>
            </div>
          </div>
        </div>
        <div class="col-md-3 d-grid">
          <button type="submit" class="btn btn-primary"><i class="bi bi-search me-2"></i>แสดงรายการ</button>
        </div>
      </div>
    </div>
  </form>

  <% if (!hasProject) { %>
    <div class="alert alert-info shadow-sm">กรุณาเลือกโครงการเพื่อเริ่มบันทึกสถานะรายเดือน</div>
  <% } else { %>
    <% if (!hasActivities) { %>
      <div class="alert alert-warning shadow-sm">โครงการนี้ยังไม่มีกิจกรรมย่อย กรุณาเพิ่มกิจกรรมก่อน</div>
    <% } else { %>
      <% 
        const totalActivitiesCount = Number(totalActivities) || 0;
        const completedCount = Number(summary.completed || 0);
        const inProgressCount = Number(summary.inProgress || 0);
        const pendingCount = Number(summary.notStarted || 0) + Number(summary.pending || 0);
        const completionPercent = totalActivitiesCount ? (completedCount / totalActivitiesCount) * 100 : 0;
        const inProgressPercent = totalActivitiesCount ? (inProgressCount / totalActivitiesCount) * 100 : 0;
        const pendingPercent = totalActivitiesCount ? (pendingCount / totalActivitiesCount) * 100 : 0;
        const statusBadge = completionPercent >= 80 ? 'success' : completionPercent >= 50 ? 'info' : 'warning';
        const completionBarWidth = Math.min(completionPercent, 100).toFixed(1);
        const completionBarStyle = `width: ${completionBarWidth}%;`;
      %>
      <div class="row g-3 mb-4">
        <div class="col-lg-4">
          <div class="card shadow-sm h-100 border-<%= statusBadge %>">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                  <p class="text-uppercase text-muted small mb-1">ภาพรวมความก้าวหน้า</p>
                  <h3 class="mb-0"><%= completionPercent.toFixed(1) %>%</h3>
                </div>
                <span class="badge bg-<%= statusBadge %>">
                  <%= completionPercent >= 80 ? 'สำเร็จดี' : completionPercent >= 50 ? 'กำลังเดินหน้า' : 'ต้องเร่งรัด' %>
                </span>
              </div>
              <div class="progress" style="height: 16px;">
                <div class="progress-bar bg-<%= statusBadge %>" role="progressbar" style="<%= completionBarStyle %>" aria-valuenow="<%= completionPercent.toFixed(1) %>" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <small class="text-muted d-block mt-2">จากกิจกรรมทั้งหมด <strong><%= totalActivitiesCount %></strong> รายการ</small>
            </div>
          </div>
        </div>
        <div class="col-lg-8">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="card shadow-sm h-100 border-success-subtle">
                <div class="card-body">
                  <p class="text-uppercase text-muted small mb-1">ดำเนินการเรียบร้อย</p>
                  <h4 class="text-success mb-0"><%= completedCount %> รายการ</h4>
                  <small class="text-muted">คิดเป็น <strong><%= completionPercent.toFixed(1) %>%</strong></small>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card shadow-sm h-100 border-warning-subtle">
                <div class="card-body">
                  <p class="text-uppercase text-muted small mb-1">อยู่ระหว่างดำเนินการ</p>
                  <h4 class="text-warning mb-0"><%= inProgressCount %> รายการ</h4>
                  <small class="text-muted">คิดเป็น <strong><%= inProgressPercent.toFixed(1) %>%</strong></small>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card shadow-sm h-100 border-secondary-subtle">
                <div class="card-body">
                  <p class="text-uppercase text-muted small mb-1">ยังไม่ดำเนินการ/รอดำเนินการ</p>
                  <h4 class="text-muted mb-0"><%= pendingCount %> รายการ</h4>
                  <small class="text-muted">คิดเป็น <strong><%= pendingPercent.toFixed(1) %>%</strong></small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <form action="/planactivity/report" method="post" class="card border-0 shadow-sm">
        <input type="hidden" name="pro_code" value="<%= selectedProject %>">
        <input type="hidden" name="report_month" value="<%= monthInput %>">

        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <div>
            <h2 class="h5 mb-0">บันทึกสถานะกิจกรรม</h2>
            <p class="text-muted small mb-0">เดือน <span class="fw-semibold"><%= monthDisplay %></span></p>
          </div>
          <button type="submit" class="btn btn-success"><i class="bi bi-save me-2"></i>บันทึกทั้งหมด</button>
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width: 70px;">#</th>
                <th style="width: 90px;">ลำดับ</th>
                <th>ชื่อกิจกรรม</th>
                <th style="width: 360px;">สถานะรอบเดือนนี้</th>
                <th style="width: 220px;">หมายเหตุ</th>
              </tr>
            </thead>
            <tbody>
              <% activities.forEach(activity => { const monthlyRecord = statusesMap[activity.ac_id]; const currentStatusRaw = typeof monthlyRecord?.status !== 'undefined' ? monthlyRecord.status : activity.ac_status; const currentStatus = Number.isFinite(Number(currentStatusRaw)) ? Number(currentStatusRaw) : 0; const currentNote = monthlyRecord?.note || ''; %>
                <tr>
                  <td><%= activity.ac_id %></td>
                  <td><%= activity.ac_number %></td>
                  <td><%= activity.ac_subject %></td>
                  <td>
                    <div class="btn-group" role="group">
                      <% statusOptions.forEach((opt, idx) => { %>
                        <input type="radio" class="btn-check" name="status_<%= activity.ac_id %>" id="status-<%= activity.ac_id %>-<%= opt.value %>" value="<%= opt.value %>" <%= currentStatus === opt.value ? 'checked' : '' %> <%= idx === 0 ? 'required' : '' %>>
                        <label class="btn btn-outline-<%= opt.value === 2 ? 'success' : opt.value === 1 ? 'warning' : 'secondary' %>" for="status-<%= activity.ac_id %>-<%= opt.value %>">
                          <i class="bi bi-<%= opt.icon %> me-1"></i><%= opt.label %>
                        </label>
                      <% }) %>
                    </div>
                  </td>
                  <td>
                    <input type="text" class="form-control" name="note_<%= activity.ac_id %>" value="<%= currentNote %>" placeholder="หมายเหตุเพิ่มเติม">
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
        <div class="card-footer bg-light text-end">
          <button type="submit" class="btn btn-success"><i class="bi bi-save me-2"></i>บันทึกสถานะกิจกรรม</button>
        </div>
      </form>

      <div class="card border-0 shadow-sm mt-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
            <div>
              <h2 class="h5 mb-1">เอกสารแนบรายงาน</h2>
              <p class="text-muted small mb-0">แนบไฟล์ PDF/Word/Excel หรือรูปภาพที่อธิบายผลดำเนินงานเดือนนี้</p>
            </div>
          </div>
          <% if (attachmentErrorMessage) { %>
            <div class="alert alert-warning small mb-3"><%= attachmentErrorMessage %></div>
          <% } %>
          <% if (!safeAttachments.length) { %>
            <div class="alert alert-light border text-center">ยังไม่มีเอกสารแนบสำหรับเดือนนี้</div>
          <% } else { %>
            <div class="list-group attachments-list mb-3">
              <% safeAttachments.forEach((file) => { const fileUrl = '/uploads/' + file.relative_path; const fileSize = Number(file.size || 0).toLocaleString('th-TH'); const uploadedAt = new Date(file.uploaded_at); %>
                <div class="list-group-item list-group-item-action rounded-3 shadow-sm px-3 py-3 d-flex flex-column flex-md-row justify-content-between gap-3">
                  <div class="flex-grow-1">
                    <a href="<%= fileUrl %>" target="_blank" class="fw-semibold text-decoration-none">
                      <i class="bi bi-file-earmark-text me-2"></i><%= file.original_name %>
                    </a>
                    <div class="text-muted small">
                      อัปโหลดโดย <%= file.uploaded_by || 'ระบบ' %> | <%= uploadedAt.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' }) %> เวลา <%= uploadedAt.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }) %>
                    </div>
                    <div class="text-muted small">ขนาด <%= fileSize %> ไบต์</div>
                  </div>
                  <form class="d-inline-flex align-items-center" method="post" action="/planactivity/report/attachments/<%= file.id %>?pro_code=<%= encodeURIComponent(selectedProject) %>&month=<%= encodeURIComponent(isoMonthValue) %>&report_month=<%= encodeURIComponent(monthInput) %>">
                    <input type="hidden" name="_method" value="DELETE">
                    <button type="submit" class="btn btn-outline-danger btn-sm rounded-pill">
                      <i class="bi bi-trash me-1"></i>ลบ
                    </button>
                  </form>
                </div>
              <% }) %>
            </div>
          <% } %>
          <form class="row g-3" action="/planactivity/report/attachments/upload?pro_code=<%= encodeURIComponent(selectedProject) %>&month=<%= encodeURIComponent(isoMonthValue) %>&report_month=<%= encodeURIComponent(monthInput) %>" method="post" enctype="multipart/form-data">
            <div class="col-md-8">
              <label for="attachment-file" class="form-label">เลือกไฟล์</label>
              <input class="form-control" type="file" id="attachment-file" name="attachment" required>
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-upload me-2"></i>อัปโหลดเอกสาร
              </button>
            </div>
            <div class="col-12">
              <p class="text-muted small mb-0">รองรับ PDF, Word, Excel, JPG, PNG ขนาดไม่เกิน 20MB</p>
            </div>
          </form>
        </div>
      </div>
    <% } %>

    <div class="mt-5">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h2 class="h5 mb-1">รายงานผลตามตัวชี้วัด</h2>
          <p class="text-muted small mb-0">สะสมผลรายเดือนเพื่อเปรียบเทียบกับตัวชี้วัดหลักของโครงการ</p>
        </div>
        <% if (hasKpis) { %>
          <span class="badge bg-primary">ตัวชี้วัดทั้งหมด <%= kpiSummary.total %> รายการ</span>
        <% } %>
      </div>

      <% if (!hasKpis) { %>
        <div class="alert alert-secondary shadow-sm">โครงการนี้ยังไม่มีตัวชี้วัด กรุณาเพิ่มตัวชี้วัดก่อนที่เมนูตัวชี้วัด</div>
      <% } else { %>
        <div class="row g-3 mb-4">
          <div class="col-md-3">
            <div class="card shadow-sm h-100 border-primary">
              <div class="card-body">
                <p class="text-uppercase text-muted small mb-1">บรรลุเป้าหมายแล้ว</p>
                <h3 class="text-success mb-0"><%= kpiSummary.achieved %></h3>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card shadow-sm h-100 border-warning">
              <div class="card-body">
                <p class="text-uppercase text-muted small mb-1">มีแนวโน้มบรรลุ (≥70%)</p>
                <h3 class="text-warning mb-0"><%= kpiSummary.onTrack %></h3>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card shadow-sm h-100 border-danger">
              <div class="card-body">
                <p class="text-uppercase text-muted small mb-1">ต่ำกว่าเป้าหมาย</p>
                <h3 class="text-danger mb-0"><%= kpiSummary.behind %></h3>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card shadow-sm h-100 border-secondary">
              <div class="card-body">
                <p class="text-uppercase text-muted small mb-1">ยังไม่กำหนดเป้า</p>
                <h3 class="text-muted mb-0"><%= kpiSummary.noTarget %></h3>
              </div>
            </div>
          </div>
        </div>

        <form action="/planactivity/report/kpi" method="post" class="card border-0 shadow-sm">
          <input type="hidden" name="pro_code" value="<%= selectedProject %>">
         <input type="hidden" name="report_month" value="<%= monthInput %>-01">

          <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <div>
              <h3 class="h5 mb-0">บันทึกผลการดำเนินงานตามตัวชี้วัด</h3>
              <p class="text-muted small mb-0">เดือน <span class="fw-semibold"><%= monthDisplay %></span></p>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 60px;">#</th>
                  <th>ตัวชี้วัด</th>
                  <th style="width: 140px;">เป้าหมาย</th>
                  <th style="width: 160px;">ผลสะสม</th>
                  <th style="width: 140px;">% เทียบเป้า</th>
                  <th style="width: 180px;">ผลเดือนนี้</th>
                  <th style="width: 220px;">หมายเหตุ</th>
                </tr>
              </thead>
              <tbody>
                <% kpiList.forEach((kpi, index) => { const percent = kpi.achievement_percent; const monthlyRecord = kpi.monthly_record; const cumulative = Number(kpi.cumulative_total || 0); const targetValue = Number(kpi.kp_plan || 0); %>
                  <tr>
                    <td>
                      <span class="badge bg-light text-dark">ID <%= kpi.kp_id %></span>
                      <input type="hidden" name="kpi_rows[<%= index %>][kp_id]" value="<%= kpi.kp_id %>">
                    </td>
                    <td>
                      <div class="fw-semibold"><%= kpi.kp_subject %></div>
                      <small class="text-muted">ลำดับ <%= kpi.kp_number %> | โค้ด <%= kpi.kp_procode %></small>
                    </td>
                    <td>
                      <div class="fw-semibold"><%= targetValue.toLocaleString('th-TH') %></div>
                      <small class="text-muted"><%= kpi.kp_unit %></small>
                    </td>
                    <td>
                      <div class="fw-semibold text-primary"><%= cumulative.toLocaleString('th-TH', { maximumFractionDigits: 2 }) %></div>
                      <small class="text-muted">สะสมจนถึงเดือนนี้</small>
                    </td>
                    <td>
                      <% if (percent === null) { %>
                        <span class="text-muted">-</span>
                      <% } else { %>
                        <span class="fw-semibold <%= percent >= 100 ? 'text-success' : percent >= 70 ? 'text-warning' : 'text-danger' %>"><%= percent.toFixed(1) %>%</span>
                      <% } %>
                    </td>
                    <td>
                      <input type="number" step="0.01" min="0" class="form-control" name="kpi_rows[<%= index %>][actual_value]" value="<%= monthlyRecord ? Number(monthlyRecord.actual_value).toString() : '' %>" placeholder="เช่น 25.0">
                      <small class="text-muted">เว้นว่างหากไม่มีข้อมูล</small>
                    </td>
                    <td>
                      <input type="text" class="form-control" name="kpi_rows[<%= index %>][note]" value="<%= monthlyRecord && monthlyRecord.note ? monthlyRecord.note : '' %>" placeholder="สาระสำคัญ/ที่มาของข้อมูล">
                    </td>
                  </tr>
                  <tr class="table-secondary">
                    <td colspan="7" class="py-2">
                      <small class="text-muted">
                        <strong>ระยะเวลารายงาน:</strong> 1 ตุลาคม <%=  new Date().getFullYear() %> – 30 กันยายน <%= new Date().getFullYear() + 1 %>
                      </small>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
          <div class="card-footer bg-light text-end">
            <button type="submit" class="btn btn-primary"><i class="bi bi-save me-2"></i>อัปเดตผลตัวชี้วัด</button>
            <p class="text-muted small mb-0 mt-2">ระบบจะอัปเดตค่าของเดือนเดิมให้อัตโนมัติ หากมีการบันทึกซ้ำ</p>
          </div>
        </form>
      <% } %>
    </div>

    <!-- NEW: Historical Monthly Records Section -->
    <div class="mt-5">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h2 class="h5 mb-1">ประวัติการบันทึกรายเดือนที่ผ่านมา</h2>
          <p class="text-muted small mb-0">แสดงผลการบันทึกสถานะกิจกรรมของเดือนที่ผ่านมา (ย้อนหลัง 12 เดือน)</p>
        </div>
      </div>

      <% if (!selectedProject) { %>
        <div class="alert alert-secondary shadow-sm">กรุณาเลือกโครงการเพื่อดูประวัติการบันทึก</div>
      <% } else if (!Array.isArray(historicalRecords) || historicalRecords.length === 0) { %>
        <div class="alert alert-info shadow-sm">ยังไม่มีข้อมูลการบันทึกรายเดือนที่ผ่านมา</div>
      <% } else { %>
        <div class="card border-0 shadow-sm">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 140px;">เดือน-ปี</th>
                  <th style="width: 100px;">กิจกรรมทั้งหมด</th>
                  <th style="width: 120px;">
                    <span class="badge bg-success">ดำเนินการเรียบร้อย</span>
                  </th>
                  <th style="width: 120px;">
                    <span class="badge bg-warning">ในระหว่างดำเนิน</span>
                  </th>
                  <th style="width: 120px;">
                    <span class="badge bg-secondary">ยังไม่ดำเนิน</span>
                  </th>
                  <th style="width: 120px;">อัตราสำเร็จ</th>
                </tr>
              </thead>
              <tbody>
                <% historicalRecords.forEach((record) => { 
                  const completed = Number(record.completed || 0);
                  const inProgress = Number(record.in_progress || 0);
                  const notStarted = Number(record.not_started || 0);
                  const total = Number(record.total_activities || 1);
                  const successRate = ((completed / total) * 100).toFixed(1);
                  
                  // Parse ISO month to Thai display format
                  const [year, month] = (record.report_month || '').split('-');
                  const gregorianYear = Number.parseInt(year, 10);
                  const monthNum = Number.parseInt(month, 10);
                  const thaiYear = gregorianYear + 543;
                  
                  const monthNames = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 
                                      'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
                  const monthLabel = monthNames[monthNum - 1] || '-';
                %>
                  <tr>
                    <td>
                      <strong><%= monthLabel %> <%= thaiYear %></strong>
                      <br>
                      <small class="text-muted"><%= record.report_month %></small>
                    </td>
                    <td>
                      <span class="badge bg-light text-dark"><%= total %> รายการ</span>
                    </td>
                    <td>
                      <span class="badge bg-success"><%= completed %> ✓</span>
                    </td>
                    <td>
                      <span class="badge bg-warning text-dark"><%= inProgress %> ⧳</span>
                    </td>
                    <td>
                      <span class="badge bg-secondary"><%= notStarted %> ○</span>
                    </td>
                    <td>
                      <div class="progress" style="height: 24px;">
                        <div 
                          class="progress-bar <%= successRate >= 80 ? 'bg-success' : successRate >= 60 ? 'bg-info' : 'bg-warning' %>" 
                          role="progressbar" 
                          style="width: <%= Math.min(successRate, 100) %>%;" 
                          aria-valuenow="<%= successRate %>" 
                          aria-valuemin="0" 
                          aria-valuemax="100">
                          <%= successRate %>%
                        </div>
                      </div>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
          <div class="card-footer bg-light text-muted small">
            <i class="bi bi-info-circle me-2"></i>
            แสดงข้อมูลล่าสุด 12 เดือน เรียงลำดับจากเดือนล่าสุด
          </div>
        </div>
      <% } %>
    </div>

  <% } %>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('monthly-filter-form');
    const monthSelect = document.getElementById('month-select');
    const yearSelect = document.getElementById('year-select');
    const hiddenInput = document.getElementById('month-hidden');
    if (!form || !monthSelect || !yearSelect || !hiddenInput) {
      return;
    }

    const padMonth = (value) => {
      const numeric = Number.parseInt(value, 10);
      const safeNumber = Number.isNaN(numeric) ? 1 : numeric;
      return String(safeNumber).padStart(2, '0');
    };

    const syncMonthValue = () => {
      const beYear = Number.parseInt(yearSelect.value, 10);
      const adYear = Number.isNaN(beYear) ? new Date().getFullYear() : beYear - 543;
      hiddenInput.value = `${adYear}-${padMonth(monthSelect.value)}`;
    };

    monthSelect.addEventListener('change', syncMonthValue);
    yearSelect.addEventListener('change', syncMonthValue);
    form.addEventListener('submit', syncMonthValue);
  });
</script>

<style>
  .attachments-list .list-group-item {
    border: 1px solid rgba(13, 110, 253, 0.15);
    background: #ffffff;
  }
  .attachments-list .list-group-item a {
    color: inherit;
  }
</style>

<%- include('../partials/footer') %>
