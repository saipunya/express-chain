<%- include('partials/header') %>

<div class="container mt-4">
  <div class="mb-4 d-flex justify-content-between align-items-center">
    <h3><%= title %></h3>
    <% if(user && user.mClass=='kts'){ %>
    <a href="/finance/upload" class="btn btn-success mb-3">
      <i class="bi bi-plus-circle"></i> อัปโหลดไฟล์
    </a>
    <% } %>
  </div>

  <!-- ช่องค้นหา -->
  <div class="row mb-3">
    <div class="col-md-6">
      <div class="input-group">
        <input type="text" id="searchInput" class="form-control" placeholder="ระบุชื่อสถาบัน">
        <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">ล้าง</button>
      </div>
    </div>
  </div>

  <% 
    // Group by c_name
    const grouped = {};
    fileAll.forEach(file => {
      const name = file.c_name || 'ไม่ระบุชื่อสถาบัน';
      if (!grouped[name]) grouped[name] = [];
      grouped[name].push(file);
    });

    // Sort groups by max end_year DESC
    const sortedGroups = Object.entries(grouped).sort((a, b) => {
      const maxYearA = Math.max(...a[1].map(f => f.end_year));
      const maxYearB = Math.max(...b[1].map(f => f.end_year));
      return maxYearB - maxYearA;
    });

    sortedGroups.forEach(([cName, files]) => {
  %>
    <h5 class="mt-4 text-primary"><%= cName %></h5>
    <ul class="list-group mb-3">
      <% files
        .sort((a, b) => b.end_year - a.end_year) // Sort by end_year DESC
        .forEach(file => { 
      %>
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <span><%= file.end_date + " " + file.end_year %></span>
          <div>
            <% if(!user){ %>
              <a href="/auth/login" class="btn btn-sm btn-outline-primary">ดาวน์โหลด</a>
            <% } else { %>
              <a href="/finance/download/<%= file.id %>" class="btn btn-sm btn-outline-primary" target="_blank">ดาวน์โหลด</a>
            <% } %>
          </div>
        </li>
      <% }) %>
    </ul>
  <% }) %>

  <!-- Pagination -->
  <nav class="mt-4">
    <ul class="pagination justify-content-center">
      <% for (let i = 1; i <= totalPages; i++) { %>
        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
          <a class="page-link" href="/finance?page=<%= i %>"><%= i %></a>
        </li>
      <% } %>
    </ul>
  </nav>
</div>

<script>
  const searchInput = document.getElementById('searchInput');
  let searchTimeout;

  searchInput.addEventListener('keyup', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      const keyword = searchInput.value.toLowerCase();
      document.querySelectorAll('h5').forEach(title => {
        const group = title.nextElementSibling; // ul
        const groupName = title.innerText.toLowerCase();
        let hasMatch = groupName.includes(keyword);

        if (!hasMatch) {
          const items = group.querySelectorAll('li');
          items.forEach(li => {
            if (li.innerText.toLowerCase().includes(keyword)) hasMatch = true;
          });
        }

        title.style.display = hasMatch ? '' : 'none';
        group.style.display = hasMatch ? '' : 'none';
      });
    }, 300);
  });

  function clearSearch() {
    searchInput.value = '';
    document.querySelectorAll('h5, ul.list-group').forEach(el => el.style.display = '');
  }
</script>

<%- include('partials/footer') %>
