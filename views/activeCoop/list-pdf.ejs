<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<title>สรุปสหกรณ์ / กลุ่มเกษตรกร แยกตามปีสิ้นสุด</title>
<style>
  @page { size: A4; margin: 12mm; }
  body { font-family: "TH Sarabun New", "Tahoma", sans-serif; font-size: 14px; color:#222; }
  h1 { text-align:center; margin:0 0 12px; font-size: 20px; }
  h2 { margin:24px 0 6px; font-size:16px; }
  table { width:100%; border-collapse: collapse; margin-bottom: 10px; }
  th, td { border:1px solid #999; padding:4px 6px; }
  th { background:#f0f0f0; }
  .section-title { background:#444; color:#fff; padding:6px 8px; font-size:15px; }
  .badge { display:inline-block; padding:2px 6px; border-radius:4px; font-size:12px; }
  .b-green { background:#198754; color:#fff; }
  .b-blue { background:#0d6efd; color:#fff; }
  .b-gray { background:#6c757d; color:#fff; }
  .split-title { margin-top:18px; font-weight:bold; }
  .break { page-break-after: always; }
</style>
</head>
<body>
  <h1>สรุปสหกรณ์ / กลุ่มเกษตรกร แยกตามปีสิ้นสุด (end_date)</h1>

  <% 
    const years = Object.keys(groups).sort((a,b)=> b - a);
    const coopByYear = {};
    const farmerByYear = {};
    years.forEach(y => {
      groups[y].forEach(r => {
        if (r.coop_group === 'สหกรณ์') (coopByYear[y] ||= []).push(r);
        else if (r.coop_group === 'กลุ่มเกษตรกร') (farmerByYear[y] ||= []).push(r);
      });
    });
  %>

  <h2 class="split-title">ส่วนที่ 1: สหกรณ์</h2>
  <% Object.keys(coopByYear).sort((a,b)=> b - a).forEach(year => { const list = coopByYear[year]; if(!list.length)return; %>
    <div class="section-title">ปี <%= year %> (ทั้งหมด <%= list.length %> แห่ง)</div>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>รหัส</th>
          <th>ชื่อ</th>
          <th>c_group</th>
          <th>สถานะ</th>
          <th>End Date</th>
        </tr>
      </thead>
      <tbody>
        <% list.forEach((row, idx)=> { %>
          <tr>
            <td><%= idx + 1 %></td>
            <td><%= row.c_code %></td>
            <td><%= row.c_name %></td>
            <td> <% if(row.c_group ==='group1') {%>
                <span class="badge bg-success">กลุ่มส่งเสริมสหกรณ์ 1</span>
              <% } else if(row.c_group === 'group2') { %>
                <span class="badge bg-warning">กลุ่มส่งเสริมสหกรณ์ 2</span>
              <% } else if(row.c_group === 'group3') { %>
                <span class="badge bg-info">กลุ่มส่งเสริมสหกรณ์ 3</span>
              <% } else if(row.c_group === 'group4') { %>
                <span class="badge bg-danger">กลุ่มส่งเสริมสหกรณ์ 4</span>
              <% } else if(row.c_group === 'group5') { %>
                <span class="badge bg-primary">กลุ่มส่งเสริมสหกรณ์ 5</span>
              <% } else { %>
                <span class="badge bg-secondary">กลุ่มส่งเสริมสหกรณ์อื่น</span>
              <% } %>

            </td>
            <td>
              <span class="badge <%= row.c_status === 'ดำเนินการ' ? 'b-blue' : 'b-gray' %>">
                <%= row.c_status %>
              </span>
            </td>
            <td><%= row.end_date || '-' %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% }) %>

  <h2 class="split-title">ส่วนที่ 2: กลุ่มเกษตรกร</h2>
  <% Object.keys(farmerByYear).sort((a,b)=> b - a).forEach(year => { const list = farmerByYear[year]; if(!list.length)return; %>
    <div class="section-title">ปี <%= year %> (ทั้งหมด <%= list.length %> แห่ง)</div>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>รหัส</th>
          <th>ชื่อ</th>
          <th>c_group</th>
          <th>สถานะ</th>
          <th>End Date</th>
        </tr>
      </thead>
      <tbody>
        <% list.forEach((row, idx)=> { %>
          <tr>
            <td><%= idx + 1 %></td>
            <td><%= row.c_code %></td>
            <td><%= row.c_name %></td>
            <td>
                <% if(row.c_group ==='group1') {%>
                    <span class="badge bg-success">กลุ่มส่งเสริมสหกรณ์ 1</span>
                  <% } else if(row.c_group === 'group2') { %>
                    <span class="badge bg-warning">กลุ่มส่งเสริมสหกรณ์ 2</span>
                  <% } else if(row.c_group === 'group3') { %>
                    <span class="badge bg-info">กลุ่มส่งเสริมสหกรณ์ 3</span>
                  <% } else if(row.c_group === 'group4') { %>
                    <span class="badge bg-danger">กลุ่มส่งเสริมสหกรณ์ 4</span>
                  <% } else if(row.c_group === 'group5') { %>
                    <span class="badge bg-primary">กลุ่มส่งเสริมสหกรณ์ 5</span>
                  <% } else { %>
                    <span class="badge bg-secondary">กลุ่มส่งเสริมสหกรณ์อื่น</span>
                  <% } %>
            </td>
            <td>
              <span class="badge <%= row.c_status === 'ดำเนินการ' ? 'b-blue' : 'b-gray' %>">
                <%= row.c_status %>
              </span>
            </td>
            <td><%= row.end_date || '-' %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  <% }) %>
</body>
</html>