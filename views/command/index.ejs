<%- include('../partials/header', { title: 'คำสั่งสำนักงาน' }) %>
<% const hasActions = user && (user.mClass=='pbt' || user.mClass=='admin'); %>

<style>
  :root{
    --primary:#3b82f6;
    --text:#0f172a;
    --muted:#64748b;
    --border:#e2e8f0;
    --bg:#ffffff;
    --bg-soft:#f8fafc;
  }

  .page-header{
    background: var(--bg);
    border-bottom: 1px solid var(--border);
    padding: 1.25rem 0;
    margin-bottom: 1.25rem;
  }
  .page-header h1{ color:var(--text); font-weight:800; letter-spacing:-.5px; text-shadow:none; }
  .page-header p{ color:var(--muted); font-weight:500; text-shadow:none; }

  .search-card{
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: .75rem;
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: none;
  }
  .search-card:hover{ transform:none; box-shadow:none; }
  .search-card .form-control{
    border:1px solid var(--border);
    border-radius:.6rem;
    background: var(--bg);
    padding:.7rem .9rem;
  }
  .search-card .form-control:focus{
    border-color: rgba(59,130,246,.6);
    box-shadow: 0 0 0 .2rem rgba(59,130,246,.15);
    transform:none;
    animation:none;
  }

  .stats-bar{
    display:flex;
    align-items:center;
    gap:.75rem;
    padding:.85rem 1rem;
    background: var(--bg-soft);
    border: 1px solid var(--border);
    border-radius: .75rem;
    margin-bottom: 1rem;
    box-shadow:none;
  }
  .stats-bar::before{ display:none; }
  .stats-bar i{ font-size:1.25rem; color:var(--primary); filter:none; animation:none; }
  .stats-number{ font-size:1.25rem; color:var(--text); text-shadow:none; }
  .stats-text{ color:var(--muted); font-size:.9rem; font-weight:600; letter-spacing:0; text-transform:none; }

  /* list (single column) */
  .command-list{ display:flex; flex-direction:column; gap:.75rem; }
  .list-item{
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: .75rem;
    padding: 1rem;
  }
  .list-item:hover{ border-color: rgba(59,130,246,.45); }
  .list-item-top{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:1rem;
  }

  .command-no-badge{
    background: var(--bg-soft);
    color: var(--text);
    border: 1px solid var(--border);
    box-shadow:none;
    border-radius: 999px;
    padding: .35rem .65rem;
    font-weight:700;
    font-size:.85rem;
    display:inline-flex;
    align-items:center;
    gap:.45rem;
  }
  .command-no-badge:hover{ transform:none; }

  .command-title{
    margin:.6rem 0 .35rem 0;
    font-size:1.05rem;
    font-weight:750;
    color: var(--text);
  }

  .command-date{
    margin:.35rem 0 0 0;
    padding:0;
    background:transparent;
    border:none;
    color: var(--muted);
    font-size:.9rem;
    gap:.5rem;
  }
  .command-date i{ color: var(--muted); font-size:1rem; }

  .command-meta{
    margin:.75rem 0 0 0;
    padding-top:.75rem;
    border-top:1px solid var(--border);
    gap:.75rem;
    font-size:.9rem;
  }
  .meta-item{ gap:.5rem; }
  .meta-item:hover{ color:inherit; transform:none; }
  .meta-item i{ color: var(--muted); font-size:1rem; }

  .action-buttons{
    margin-top:.85rem;
    padding-top:.85rem;
    border-top:1px solid var(--border);
    display:flex;
    justify-content:flex-end;
    gap:.5rem;
  }

  .btn-action{
    flex:0 0 auto;
    min-width:auto;
    border-radius:.6rem;
    text-transform:none;
    letter-spacing:0;
    font-weight:600;
    border:1px solid rgba(59,130,246,.35);
    color: var(--primary);
    background: #fff;
  }
  .btn-action::before{ display:none; }
  .btn-action:hover{
    transform:none;
    box-shadow:none;
    border-color: rgba(59,130,246,.7);
    background: rgba(59,130,246,.06);
    color: var(--primary);
  }

  .dropdown-menu{ border-radius:.6rem; border:1px solid var(--border); box-shadow:none; }

  .empty-state{
    background: var(--bg);
    border: 1px dashed var(--border);
    border-radius:.75rem;
    padding: 2.5rem 1.25rem;
    animation:none;
  }
  .empty-state i{ animation:none; opacity:.55; }

  @media (max-width: 768px){
    .action-buttons{ justify-content:stretch; }
    .action-buttons .btn-action{ width:100%; }
  }
</style>

<!-- Header Section -->
<div class="page-header">
  <div class="container">
    <h1 class="h2 mb-1">คำสั่งสำนักงาน</h1>
    <p class="mb-0 small">ระบบบริหารจัดการเอกสารคำสั่งอย่างมีประสิทธิภาพ</p>
  </div>
</div>

<div class="container">
  <!-- Search & Filter -->
  <div class="row justify-content-center mb-3">
    <div class="col-lg-8">
      <div class="search-card">
        <form method="GET" action="" class="row g-2 align-items-end" id="commandSearchForm">
          <div class="col-12 col-md">
            <div class="position-relative">
              <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
              <input
                type="text"
                class="form-control ps-5"
                id="commandSearchInput"
                name="search"
                placeholder="ค้นหาเลขที่ หรือ เรื่อง..."
                value="<%= search || '' %>"
                autocomplete="off"
              >
            </div>
          </div>

          <!-- ปุ่มค้นหา: เอาออกเพราะค้นหาอัตโนมัติ -->
          <div class="col-auto d-flex gap-2">
            <% if(search) { %>
              <a href="/command" class="btn btn-outline-secondary" title="ล้างค่าค้นหา"><i class="bi bi-x-lg"></i></a>
            <% } %>
          </div>

          <% if(hasActions){ %>
            <div class="col-12 col-md-auto">
              <a href="/command/create" class="btn btn-success w-100 w-md-auto"><i class="bi bi-plus-lg me-2"></i>สร้างใหม่</a>
            </div>
          <% } %>
        </form>
      </div>
    </div>
  </div>

  <!-- Stats Bar -->
  <div class="stats-bar">
    <i class="bi bi-folder2-open"></i>
    <strong class="stats-number"><%= (commands && commands.length) ? commands.length : 0 %></strong>
    <span class="stats-text">รายการทั้งหมด</span>
  </div>

  <!-- Command List -->
  <div class="command-list">
    <% if (commands && commands.length) { %>
      <% commands.forEach(c => { %>
        <div class="list-item">
          <div class="list-item-top">
            <div class="flex-grow-1">
              <span class="command-no-badge"><i class="bi bi-hash"></i><%= c.com_no %></span>

              <h5 class="command-title"><%= c.com_story %></h5>

              <% const thaiDate = new Date(c.com_date).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' }); %>
              <div class="command-date"><i class="bi bi-calendar3"></i><%= thaiDate %></div>

              <div class="command-meta">
                <div class="meta-item">
                  <i class="bi bi-file-earmark-text"></i>
                  <span>คำสั่งสำนักงาน</span>
                </div>
              </div>
            </div>

            <% if(hasActions){ %>
              <div class="dropdown">
                <button class="btn btn-sm btn-light text-muted p-2" type="button" data-bs-toggle="dropdown" aria-label="เมนูการกระทำ">
                  <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item" href="/command/edit/<%= c.command_id %>"><i class="bi bi-pencil me-2"></i>แก้ไข</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <form action="/command/delete/<%= c.command_id %>" method="POST" onsubmit="return confirm('ยืนยันการลบ?')">
                      <button class="dropdown-item text-danger" type="submit"><i class="bi bi-trash me-2"></i>ลบ</button>
                    </form>
                  </li>
                </ul>
              </div>
            <% } %>
          </div>

          <div class="action-buttons">
            <% if (user) { %>
              <a href="/command/download/<%= c.command_id %>" class="btn btn-sm btn-action" target="_blank">
                <i class="bi bi-file-earmark-pdf-fill me-2"></i>เปิดอ่าน
              </a>
            <% } else { %>
              <a href="/auth/login" class="btn btn-sm btn-action">
                <i class="bi bi-lock-fill me-2"></i>เข้าสู่ระบบ
              </a>
            <% } %>
          </div>
        </div>
      <% }) %>
    <% } else { %>
      <div class="empty-state">
        <i class="bi bi-inbox"></i>
        <h5>ไม่พบข้อมูลคำสั่ง</h5>
        <p class="text-muted">ลองเปลี่ยนคำค้นหา หรือเพิ่มรายการใหม่</p>
        <% if(hasActions){ %>
          <a href="/command/create" class="btn btn-primary">
            <i class="bi bi-plus-lg me-2"></i>สร้างคำสั่งใหม่
          </a>
        <% } %>
      </div>
    <% } %>
  </div>
</div>

<script>
  // Auto-search with debounce (submit GET form)
  (function () {
    const form = document.getElementById('commandSearchForm');
    const input = document.getElementById('commandSearchInput');
    if (!form || !input) return;

    let t = null;
    let last = input.value || '';

    input.addEventListener('input', function () {
      const v = input.value || '';
      if (v === last) return;

      clearTimeout(t);
      t = setTimeout(function () {
        last = v;
        form.submit();
      }, 400);
    });

    // Enter => search immediately (no debounce)
    input.addEventListener('keydown', function (e) {
      if (e.key !== 'Enter') return;
      e.preventDefault();
      clearTimeout(t);
      last = input.value || '';
      form.submit();
    });
  })();
</script>

<%- include('../partials/footer') %>