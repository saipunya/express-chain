<%- include('partials/header',{title : 'ระบบสารสนเทศและเครือข่ายสหกรณ์ในจังหวัดภูมิ' }) %>

<!-- Added: Required Chart.js + plugin (fix graphs not showing) -->
<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<!-- Added: FullCalendar (for Activities calendar) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css" />
<script defer src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/locales-all.global.min.js"></script>

<!-- ================= Modern Global Styles (Refactored) ================ -->
<style>
  :root {
    --color-bg: #f5f7fa;
    --color-surface: #ffffff;
    --color-border: #e2e8f0;
    --color-text: #1e293b;
    --color-muted: #64748b;
    --color-accent: #0d9488;
    --color-accent-grad: linear-gradient(135deg,#0f766e,#0d9488,#0ea5e9);
    --color-focus: #2563eb;
    --radius-sm: .5rem;
    --radius: 1rem;
    --radius-lg: 1.5rem;
    --shadow-sm: 0 4px 10px -2px rgba(0,0,0,.08);
    --shadow: 0 8px 24px -6px rgba(0,0,0,.16);
    --shadow-hover: 0 14px 38px -8px rgba(0,0,0,.28);
    --glass: rgba(255,255,255,0.68);
    --grad-accent: linear-gradient(90deg,#2563eb,#6366f1,#8b5cf6);
    --transition: .4s cubic-bezier(.4,.2,.2,1);
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --color-bg: #0f172a;
      --color-surface: #1e293b;
      --color-border: #334155;
      --color-text: #e2e8f0;
      --color-muted: #94a3b8;
      --glass: rgba(30,41,59,0.75);
      --shadow-sm: 0 4px 10px -2px rgba(0,0,0,.55);
      --shadow: 0 8px 28px -6px rgba(0,0,0,.65);
      --shadow-hover: 0 16px 44px -10px rgba(0,0,0,.85);
    }
    .modern-card, .hero-shell { border:1px solid var(--color-border); }
    .quick-nav a { color: var(--color-muted); }
    .quick-nav a.active { color: #fff; }
  }

  body { background: var(--color-bg); color: var(--color-text); }

  /* Hero */
  .hero-shell {
    background: var(--color-accent-grad);
    border-radius: var(--radius-lg);
    overflow: hidden;
    position: relative;
    box-shadow: var(--shadow);
    min-height: 360px;
  }
  .hero-shell:before {
    content:"";
    position:absolute; inset:0;
    background:
      radial-gradient(circle at 22% 30%,rgba(255,255,255,.35),transparent 60%),
      radial-gradient(circle at 75% 70%,rgba(255,255,255,.25),transparent 65%);
    mix-blend-mode: overlay;
    pointer-events:none;
  }
  .hero-img-wrap {
    position:relative;
    height:100%;
  }
  .hero-img-wrap img {
    object-fit:cover;
    width:100%; height:100%;
    aspect-ratio: 4/3;
  }
  @media (min-width: 992px){
    .hero-img-wrap img { aspect-ratio: unset; }
  }
  .glass-pane {
    background: var(--glass);
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
    border-left: 1px solid var(--color-border);
  }

  /* Hero image full cover override (added) */
  .hero-img-wrap { min-height:360px; }
  .hero-img-wrap > img.hero-cover-img {
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
  }

  /* Cards / Sections */
  .modern-card {
    border:0;
    border-radius: var(--radius);
    background: var(--color-surface);
    box-shadow: var(--shadow-sm);
    transition: var(--transition);
    position:relative;
  }
  .modern-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-hover);
  }
  .card-gradient-bar {
    position:absolute; top:0; left:0; width:100%; height:4px;
    background:var(--grad-accent); opacity:.85;
    border-top-left-radius:inherit;
    border-top-right-radius:inherit;
  }

  /* Section layout */
  .section-block {
    padding-block: 2.2rem;
  }
  .section-block.compact { padding-block: 1.4rem; }
  .section-heading {
    font-weight:700;
    letter-spacing:.6px;
    display:inline-flex;
    align-items:center;
    gap:.55rem;
    position:relative;
    margin-bottom:1.25rem;
  }
  .section-heading:after {
    content:"";
    height:3px;
    width:60%;
    background: var(--grad-accent);
    position:absolute;
    left:50%; bottom:-6px;
    transform:translateX(-50%);
    border-radius:3px;
  }

  /* Lists */
  .list-group-item {
    border:0;
    border-bottom:1px solid var(--color-border);
    background:transparent;
  }
  .list-group-item:last-child { border-bottom:0; }

  /* Quick Nav */
  .quick-nav-wrapper {
    margin-top:-1rem;
    margin-bottom:1.5rem;
    position: sticky; /* make quick nav follow screen */
    top: 70px; /* below header */
    z-index: 1029;
  }
  .quick-nav {
    display:flex;
    gap:.5rem;
    overflow-x:auto;
    scrollbar-width:none;
    padding:.75rem 1rem;
    background: var(--color-surface);
    border:1px solid var(--color-border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-sm);
  }
  .quick-nav::-webkit-scrollbar { display:none; }
  .quick-nav a {
    white-space:nowrap;
    font-size:.85rem;
    padding:.55rem .95rem;
    border-radius: 2rem;
    text-decoration:none;
    background:linear-gradient(135deg,#f1f5f9,#e2e8f0);
    color:#334155;
    border:1px solid #dbe1e7;
    transition:.25s;
    display:inline-flex;
    align-items:center;
    gap:.35rem;
  }
  .quick-nav a:hover { background:#e2e8f0; }
  .quick-nav a.active {
    background:var(--color-accent-grad);
    color:#fff;
    border-color:transparent;
    box-shadow:0 4px 14px -4px rgba(13,148,136,.5);
  }

  /* Animations */
  .reveal {
    opacity:0;
    transform:translateY(22px);
    transition: .85s cubic-bezier(.16,.8,.28,.96);
  }
  .reveal.in {
    opacity:1;
    transform:none;
  }

  .soft-badge {
    background:linear-gradient(135deg,#f1f5f9,#e2e8f0);
    color:#334155;
    border:1px solid #cbd5e1;
    font-weight:500;
  }

  .activity-list li {
    position:relative;
    padding-left:1.4rem;
  }
  .activity-list li:before {
    content:"";
    position:absolute;
    left:.35rem;
    top:1.05rem;
    width:7px; height:7px;
    border-radius:50%;
    background:var(--color-accent);
    box-shadow:0 0 0 4px rgba(13,148,136,.15);
  }

  /* Utility */
  .text-gradient {
    background:var(--grad-accent);
    background-clip:text; /* added standard property */
    -webkit-background-clip:text;
    color:transparent;
  }
  .shadow-focus:focus-visible {
    outline:2px solid var(--color-focus);
    outline-offset:2px;
  }
  .divider {
    height:1px;
    background:var(--color-border);
    margin:1.5rem 0;
  }

  @media (max-width: 575.98px) {
    .hero-shell { min-height: auto; }
    .section-heading { font-size:1.15rem; }
  }

  /* Extra polish */
  .table-hover tbody tr:hover { background:#f1f5f9; }
  .modern-card .card-header { border-top-left-radius:inherit; border-top-right-radius:inherit; }
  .section-title { position:relative; }
  .section-title:after { content:""; position:absolute; left:50%; transform:translateX(-50%); bottom:-10px; width:72px; height:4px; background:var(--grad-accent); border-radius:2px; opacity:.9; }
  .back-to-top { position:fixed; right:1.25rem; bottom:1.25rem; z-index:1040; width:46px; height:46px; display:flex; align-items:center; justify-content:center; border-radius:50%; background:var(--grad-accent); color:#fff; box-shadow:0 6px 20px -4px rgba(0,0,0,.35); border:0; opacity:0; visibility:hidden; transition:.4s; }
  .back-to-top.show { opacity:1; visibility:visible; }
  .back-to-top:focus-visible { outline:3px solid #fff; outline-offset:2px; }
  .badge { letter-spacing:.3px; }
  .hp-badge { font-size:.65rem; }
  /* === Enhanced Modal Styling === */
  .modal-elevated .modal-content { border:0; border-radius:1.25rem; box-shadow:0 18px 48px -12px rgba(0,0,0,.35); overflow:hidden; }
  .modal-gradient { background:linear-gradient(135deg,#2563eb,#6366f1,#8b5cf6); color:#fff; }
  .modal-gradient .btn-close { filter:invert(1) contrast(200%); opacity:.85; }
  .modal-gradient .btn-close:hover { opacity:1; }
  .modal-body { background:var(--color-bg,#f5f7fa); }
  .modal-section-divider { height:1px; background:rgba(255,255,255,.15); margin:.35rem 0 0; }
  .table-modern thead th { position:sticky; top:0; background:#fff; z-index:5; font-weight:600; box-shadow:0 2px 0 0 #e2e8f0; }
  .table-modern tbody tr { transition:.25s; }
  .table-modern tbody tr:hover { background:#f1f5f9; }
  .loading-fade { animation:fadePulse 1.6s ease-in-out infinite; }
  @keyframes fadePulse { 0%,100% { opacity:.35;} 50% { opacity:1;} }
  .badge-soft { background:linear-gradient(135deg,#e0f2fe,#f0f9ff); color:#0369a1; border:1px solid #bae6fd; }
  .modal-search-bar { border-radius: 50px; padding:.55rem 1rem; border:1px solid #cbd5e1; background:#fff; }
  .fade-in-row { animation:fadeInUp .45s cubic-bezier(.4,.8,.2,1); }
  @keyframes fadeInUp { from { opacity:0; transform:translateY(8px);} to { opacity:1; transform:translateY(0);} }

  /* Chart sizing to prevent stretching */
  .chart-container { position: relative; height: 280px; }
  .chart-container--sm { height: 230px; }
  @media (max-width: 575.98px) {
    .chart-container { height: 240px; }
    .chart-container--sm { height: 200px; }
  }

  /* Calendar sizing */
  #activitiesCalendar { min-height: 520px; }
</style>

<!-- Added: Light theme & contrast fixes -->
<style>
  /* Force light theme to avoid unreadable dark auto-scheme */
  @media (prefers-color-scheme: dark) {
    :root {
      --color-bg:#ffffff !important;
      --color-surface:#ffffff !important;
      --color-text:#1e293b !important;
      --color-border:#e2e8f0 !important;
    }
    body { background:#ffffff !important; color:#1e293b !important; }
  }
  body { background:#ffffff !important; color:#1e293b !important; }

  /* Ensure primary containers stay light */
  .hero-shell,
  .modern-card,
  .quick-nav,
  .card,
  .table,
  .table thead th,
  .table tbody td {
    background:#ffffff !important;
  }

  /* Text visibility */
  .text-dark,
  .card .text-dark,
  .table,
  .table td,
  .table th { color:#1e293b !important; }

  /* Table borders / striping */
  .table-bordered> :not(caption)>* { border-color:#dbe3ea !important; }
  .table thead th { background:#f1f5f9 !important; font-weight:600; }
  .table-striped>tbody>tr:nth-of-type(odd){
    --bs-table-accent-bg:#f8fafc;
    background:#f8fafc;
  }

  /* Chamra status badges readability */
  .hp-badge { font-size:.7rem; letter-spacing:.3px; }

  /* Badges general contrast */
  .badge.bg-secondary { background:#64748b !important; }
  .badge.bg-success { background:#15803d !important; }
  .badge.bg-info { background:#0284c7 !important; }
  .badge.bg-warning { background:#d97706 !important; color:#fff !important; }

  /* Quick nav active clarity */
  .quick-nav a { color:#334155 !important; }
  .quick-nav a.active { color:#fff !important; }

  /* Remove any accidental dark backgrounds from Bootstrap utilities */
  [class*="bg-dark"] { background:#1e293b !important; }
</style>

<%
// Helper: map backend c_group codes to readable Thai names
function displayGroupName(code){
  switch(code){
    case 'group1': return 'กลุ่มส่งเสริมสหกรณ์ 1';
    case 'group2': return 'กลุ่มส่งเสริมสหกรณ์ 2';
    case 'group3': return 'กลุ่มส่งเสริมสหกรณ์ 3';
    case 'group4': return 'กลุ่มส่งเสริมสหกรณ์ 4';
    case 'group5': return 'กลุ่มส่งเสริมสหกรณ์ 5';
    default: return code || '-';
  }
}
%>

<!-- ================= Hero ================= -->
<div class="container my-2 mb-4 reveal in" id="top">
  <div class="hero-shell">
    <div class="row g-0 h-100 align-items-stretch">
       
      <div class="col-md-6 hero-img-wrap p-0 position-relative h-100">
        <img
          src="/images/banner.png"
          alt="Coop Image"
          class="w-100 h-100 object-fit-cover d-block"
          loading="lazy"
        />
      </div>
      <div class="col-md-6 glass-pane d-flex align-items-center p-md-4 h-100">
        <% if (!user) { %>
          <div class="w-100">

            <!-- Small screen toggle button (hidden on sm and up) -->
            <button type="button" id="showLoginBtn" class="btn btn-success w-100 d-sm-none" aria-expanded="false" aria-controls="loginFormCollapsible">
              🔐 เข้าระบบ
            </button>

            <!-- Wrapper gains d-none only on extra-small; visible on sm+ -->
            <div id="loginFormCollapsible" class="login-form-wrapper d-none d-sm-block">
              <h5 class="text-center p-2 d-none d-sm-block">🔐 เข้าระบบ</h5>
              <form action="/auth/login" method="POST">
                <div class="mb-1 p-2">
                  <label for="username" class="form-label">ชื่อผู้ใช้งาน</label>
                  <input type="text" class="form-control" id="username" name="username" required />
                </div>
                <div class="mb-1 p-2">
                  <label for="password" class="form-label">รหัสผ่าน</label>
                  <input type="password" class="form-control" id="password" name="password" required />
                </div>
                <div class="p-2">
                  <input type="checkbox" id="rememberMe" name="rememberMe">
                  <label for="rememberMe" class="form-label">จดจำฉัน</label>
                </div>
                <div class="p-2">
                  <button type="submit" class="btn btn-success w-100">เข้าระบบ</button>
                </div>
              </form>

              <p class="text-center">
                <i class="bi bi-person-add"></i> ยังไม่มีบัญชี ?
                <a href="/auth/register" class="text-success">สมัครสมาชิก</a>
              </p>
            </div>
          </div>
          <script>
            (function(){
              const btn = document.getElementById('showLoginBtn');
              const wrap = document.getElementById('loginFormCollapsible');
              if(!btn || !wrap) return;
              function toggle(){
                const isHidden = wrap.classList.contains('d-none');
                if(isHidden){
                  wrap.classList.remove('d-none');
                  btn.setAttribute('aria-expanded','true');
                  btn.textContent = '⬆️ ซ่อนแบบฟอร์ม';
                } else {
                  wrap.classList.add('d-none');
                  btn.setAttribute('aria-expanded','false');
                  btn.textContent = '🔐 เข้าระบบ';
                }
              }
              btn.addEventListener('click', toggle);
            })();
          </script>
        <% } else { %>
          <div class="w-100 text-center">
            <h1 class="display-6 mb-3 text-success">ยินดีต้อนรับ!</h1>
            <img src="<%= user.m_img %>" alt="User Image" class="rounded-circle mb-3" width="100">
            <p class="lead mb-4">
              <%= user.fullname %>
            </p>
            <a href="/dashboard" class="btn btn-success me-2">แดชบอร์ด</a>
            <% if(user && (user.mClass==='kjs' || user.mClass==='admin')) { %>
              <a href="/account/list" class="btn btn-outline-secondary me-2">เงินกลุ่ม กจส.</a>
              <a href="/chamra" class="btn btn-outline-secondary me-2">ชำระบัญชี</a>
            <% } %>
            <a href="/auth/logout" class="btn btn-outline-secondary">ออกจากระบบ</a>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- ================= Quick Navigation ================= -->
<div class="container quick-nav-wrapper reveal in" aria-label="Quick section navigation">
  <nav class="quick-nav" id="quickNav">
    <a href="#stats"><i class="bi bi-collection"></i>สถิติ</a>
    <a href="#charts"><i class="bi bi-bar-chart"></i>กราฟ</a>
    <a href="#groups"><i class="bi bi-diagram-3"></i>กลุ่ม</a>
    <a href="#strength"><i class="bi bi-speedometer2"></i>ความเข้มแข็ง</a>
    <a href="#members"><i class="bi bi-people"></i>สมาชิก</a>
    <a href="/activities"><i class="bi bi-calendar-event"></i>กิจกรรม</a>
    <a href="/finance"><i class="bi bi-cash-coin"></i>งบการเงิน</a>
    <a href="/business"><i class="bi bi-briefcase"></i>กิจการ</a>
    <a href="/rule"><i class="bi bi-file-earmark-text"></i>ข้อบังคับ</a>
    <a href="/rabiab"><i class="bi bi-file-earmark"></i>ระเบียบ</a>
    <a href="#projects"><i class="bi bi-file-earmark-pdf"></i>โครงการ</a>
    <a href="#commands"><i class="bi bi-megaphone"></i>คำสั่ง</a>
    <a href="#chamra"><i class="bi bi-activity"></i>ชำระบัญชี</a>
    <a href="#downloads"><i class="bi bi-download"></i>Top DL</a>
    <a href="#rq2"><i class="bi bi-file-earmark-ruled"></i>RQ2</a>
    <a href="#articles"><i class="bi bi-journal-text"></i>บทความ</a>
    <a href="#usecar"><i class="bi bi-car-front"></i>ใช้รถ</a>
    <a href="#online"><i class="bi bi-wifi"></i>ออนไลน์</a>
  </nav>
</div>

<!-- ================= Stats ================= -->
<section id="stats" class="section-block pt-0">
  <div class="container">
    <h2 class="my-3 text-center text-primary section-title">📊 ข้อมูลสหกรณ์</h2>
    <div class="row">
      <div class="col-md-4">
        <div class="card modern-card shadow-sm border-0">
          <div class="card-gradient-bar"></div>
          <div class="card-body text-center">
            <h5 class="card-title">จำนวนสหกรณ์</h5>
            <p class="card-text display-6 text-success">
              <%= stats.coop + ' แห่ง' %>
            </p>
            <span class="d-block">
              <a class="btn btn-sm btn-outline-success" data-bs-toggle="tooltip" data-bs-placement="top" href="/activeCoop/by-end-date" 
                title="สหกรณ์ที่จดทะเบียนกับกรมส่งเสริมสหกรณ์">
                <i class="bi bi-info-circle" style="cursor: pointer;"></i>
                รายละเอียด
              </a>
            </span>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card modern-card shadow-sm border-0">
          <div class="card-gradient-bar"></div>
          <div class="card-body text-center">
            <h5 class="card-title">จำนวนกลุ่มเกษตรกร</h5>
            <p class="card-text display-6 text-info">
              <%= stats.farmer + ' แห่ง' %>
            </p>
            <span class="d-block">
              <a class="btn btn-sm btn-outline-success" data-bs-toggle="tooltip" data-bs-placement="top" href="/activeCoop/by-end-date" 
                title="ข้อมูลเพิ่มเติมเกี่ยวกับกลุ่มเกษตรกร">
                <i class="bi bi-info-circle" style="cursor: pointer;"></i>
                รายละเอียด
              </a>
            </span>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card modern-card shadow-sm border-0">
          <div class="card-gradient-bar"></div>
          <div class="card-body text-center">
            <h5 class="card-title">อยู่ระหว่างชำระบัญชี</h5>
            <p class="card-text display-6 text-warning">
              <%= stats.closing + ' แห่ง' %>
            </p>
            <span class="d-block">
              <a href="/chamra"><button class="btn btn-sm btn-outline-warning" data-bs-toggle="tooltip" data-bs-placement="top"
                title="สหกรณ์/กลุ่มเกษตรกรที่อยู่ระหว่างการชำระบัญชี">
                <i class="bi bi-info-circle" style="cursor: pointer;"></i>
                รายละเอียด
              </button></a>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>



<!-- ================= Charts ================= -->
<section id="charts" class="section-block bg-white">
  <div class="container-lg">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="card modern-card shadow-sm border-0 mb-2">
          <div class="card-gradient-bar"></div>
          <div class="card-body">
            <h4 class="mb-4 text-center text-primary">
              <i class="bi bi-bar-chart-fill me-2"></i> กราฟแสดงจำนวนสหกรณ์/กลุ่มเกษตรกร
            </h4>
            <div class="chart-container">
              <canvas id="coopChart" height="120"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card modern-card shadow-sm border-0 mb-4">
          <div class="card-gradient-bar"></div>
          <div class="card-body">
            <h4 class="mb-4 text-center text-primary">
              <i class="bi bi-pie-chart-fill me-2"></i> สัดส่วนสหกรณ์/กลุ่มเกษตรกร
            </h4>
            <div class="chart-container chart-container--sm d-flex justify-content-center" >
              <canvas id="coopPieChart" height="120" ></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<% // Precompute chamra stage counts once (S1..S10)
  let __chamraCounts = null;
  if ((chamraAllProcesses||[]).length) {
    __chamraCounts = {};
    for (let i=1;i<=10;i++) __chamraCounts['S'+i] = 0;
    const __isEmptyChamra = (v) => {
      if (!v) return true;
      if (typeof v === 'string') {
        if (v === '0000-00-00') return true;
        if (/^1899-11-30/.test(v)) return true;
      }
      const d = new Date(v);
      return isNaN(d.getTime()) || d.getFullYear() < 1950;
    };
    // Count by highest achieved stage only, using all records from chamra_process
    (chamraAllProcesses||[]).forEach(p => {
      for (let i=10;i>=1;i--) {
        const raw = p['pr_s'+i];
        if (!__isEmptyChamra(raw)) { __chamraCounts['S'+i]++; break; }
      }
    });
  }
%>
<!-- chamra section -->
<section id="chamra" class="section-block">
  <% if ((chamraAllProcesses || []).length) { %>
    <!-- Chamra stages chart -->
    <div class="card modern-card shadow-sm border-0 mt-3">
      <div class="card-gradient-bar"></div>
      <div class="card-body">
        <h6 class="mb-3 text-primary">
          <i class="bi bi-graph-up-arrow me-2"></i> กราฟจำนวนสถาบันในแต่ละขั้นตอน (S1–S10)
        </h6>
        <div class="chart-container chart-container--sm">
          <canvas id="chamraStageChart" height="120" aria-label="Chamra stages chart"></canvas>
        </div>
        <small class="text-muted d-block mt-2">นับจำนวนสถาบันตามขั้นสูงสุด (ข้อมูลทั้งหมดใน chamra_process)</small>
      </div>
    </div>

    <!-- Use precomputed __chamraCounts -->
    <div id="chamra-stage-data" data-stages='<%- JSON.stringify(__chamraCounts) %>' hidden></div>
  <% } %>
  <div class="container">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h6 class="mb-0">
          <i class="bi bi-activity me-2"></i> สถานะการชำระบัญชีล่าสุด
        </h6>
        <% if(user) { %>
          <button id="exportChamraBtnHome" class="btn btn-secondary me-2">⬇️ ส่งออก pdf</button>
        <% } else { %>
          <button id="exportChamraBtnHome" class="btn btn-secondary">⬇️ Export PDF</button>
        <% } %>
      </div>

      <% if ((homeProcesses || []).length) { %>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm table-bordered table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th class="ps-3">สถาบัน</th>
                  <th class="text-center">S1</th>
                  <th class="text-center">S2</th>
                  <th class="text-center">S3</th>
                  <th class="text-center">S4</th>
                  <th class="text-center">S5</th>
                  <th class="text-center">S6</th>
                  <th class="text-center">S7</th>
                  <th class="text-center">S8</th>
                  <th class="text-center">S9</th>
                  <th class="text-center">S10</th>
                </tr>
              </thead>
              <tbody>
                <%
                  const isEmptyDate = (v) => {
                    if (!v) return true;
                    if (typeof v === 'string') {
                      if (v === '0000-00-00') return true;
                      if (/^1899-11-30/.test(v)) return true;
                    }
                    const d = new Date(v);
                    return isNaN(d.getTime()) || d.getFullYear() < 1950;
                  };
                  const formatThai = (v) => {
                    const d = new Date(v);
                    if (isNaN(d.getTime())) return '-';
                    const m = ['ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.','ต.ค.','พ.ย.','ธ.ค.'][d.getMonth()];
                    return `${d.getDate()} ${m} ${d.getFullYear()+543}`;
                  };
                %>
                <% homeProcesses.forEach(p => { %>
                  <tr>
                    <td class="ps-3 small fw-semibold text-dark">
                      <i class="bi bi-building me-1 text-primary"></i>
                      <%= p.c_name || p.pr_code %>
                    </td>
                    <% for (let i=1;i<=10;i++){ const key='pr_s'+i; const raw=p[key]; %>
                      <td class="text-center">
                        <% if (isEmptyDate(raw)) { %>
                          <span class="badge rounded-pill bg-secondary hp-badge px-2">-</span>
                        <% } else { %>
                          <span class="badge rounded-pill bg-success hp-badge px-2"><%= formatThai(raw) %></span>
                        <% } %>
                      </td>
                    <% } %>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card-footer bg-light d-flex justify-content-between align-items-center">
          <small class="text-muted">
            <i class="bi bi-info-circle me-1"></i>
            สีเขียว = มีวันที่ | สีเทา = ยังไม่มีข้อมูล
          </small>
          <a href="/chamra" class="btn btn-primary btn-sm">
            ดูเพิ่มเติม
          </a>
        </div>
      <% } else { %>
        <div class="card-body">
          <div class="text-center text-muted py-3">
            <i class="bi bi-inbox fs-3 d-block mb-2"></i>
            ไม่มีข้อมูลสำหรับแสดง
          </div>
        </div>
      <% } %>
    </div>

   
  </div>
</section>

<!-- ================= Coop Groups ================= -->
<section id="groups" class="section-block bg-white">
  <div class="container-lg">
    <div class="card modern-card mb-4">
      <div class="card-gradient-bar"></div>
      <div class="card-header bg-primary text-white">
        <i class="bi bi-diagram-3 me-2"></i> สรุปจำนวนสหกรณ์/กลุ่มเกษตรกรในแต่ละกลุ่มส่งเสริมสหกรณ์
      </div>
      <div class="card-body">
        <div class="row">
          <% coopGroupStats.forEach(group => { %>
            <div class="col-md-4 mb-3">
              <div class="card h-100 modern-card shadow-sm border-0">
                <div class="card-gradient-bar"></div>
                <div class="card-body text-center">
                  <h5 class="fw-bold mb-2 text-primary"><%= displayGroupName(group.c_group) %></h5>
                  <div class="mb-2">
                    <button type="button" class="badge bg-success fs-6 border-0 js-show-group-items shadow-focus" data-group="<%= group.c_group %>" data-group-label="<%= displayGroupName(group.c_group) %>" data-type="สหกรณ์" aria-label="ดูรายชื่อสหกรณ์ใน <%= displayGroupName(group.c_group) %>">
                      สหกรณ์: <%= group.coop %>
                    </button>
                  </div>
                  <div>
                    <button type="button" class="badge bg-info fs-6 border-0 js-show-group-items shadow-focus" data-group="<%= group.c_group %>" data-group-label="<%= displayGroupName(group.c_group) %>" data-type="กลุ่มเกษตรกร" aria-label="ดูรายชื่อกลุ่มเกษตรกรใน <%= displayGroupName(group.c_group) %>">
                      กลุ่มเกษตรกร: <%= group.farmer %>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Modal แสดงรายชื่อสหกรณ์/กลุ่มเกษตรกร ตาม group -->
<div class="modal fade modal-elevated" id="groupItemsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header modal-gradient py-2">
        <h5 class="modal-title mb-0 d-flex align-items-center gap-2" id="groupItemsModalLabel"><i class="bi bi-diagram-3"></i> รายชื่อ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="groupItemsLoading" class="text-center py-5">
          <div class="spinner-border text-light mb-3" role="status"></div>
          <div class="small text-muted">กำลังโหลดข้อมูล...</div>
        </div>
        <div id="groupItemsError" class="alert alert-danger d-none"></div>
        <ul id="groupItemsList" class="list-group d-none"></ul>
      </div>
    </div>
  </div>
</div>

<!-- ================= Featured Coops (New) ================= -->
<section id="featured-coops" class="section-block bg-light">
  <div class="container">
    <h2 class="text-center text-primary section-title mb-4">🏢 ข้อมูลรายสถาบัน</h2>
    <% if ((homeCoops||[]).length) { %>
      <% const _featuredCoops = (homeCoops||[]).slice().sort(()=> Math.random() - 0.5).slice(0,6); %>
      <div class="row g-3">
        <% _featuredCoops.forEach(c => { %>
          <div class="col-12 col-sm-6 col-lg-4">
            <div class="card modern-card h-100 shadow-sm border-0">
              <div class="card-gradient-bar"></div>
              <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <span class="badge <%= c.coop_group==='สหกรณ์' ? 'bg-success' : 'bg-info' %>"><%= c.coop_group %></span>
                  <span class="badge bg-secondary"><%= c.c_group || '-' %></span>
                </div>
                <h6 class="fw-semibold mb-1 text-truncate" title="<%= c.c_name %>"><i class="bi bi-building me-1 text-primary"></i><%= c.c_name %></h6>
                <div class="text-muted small mb-3">รหัส: <%= c.c_code %></div>
                <div class="mt-auto d-grid">
                  <!-- Changed: link -> button triggers modal -->
                  <a href="/allCoop/profile/<%= c.c_code %>" data-code="<%= c.c_code %>" class="btn btn-sm btn-outline-primary js-coop-detail" role="button" aria-label="รายละเอียด <%= c.c_name %>">
                    <i class="bi bi-box-arrow-up-right me-1"></i>รายละเอียด
                  </a>
                </div>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
      <div class="text-center mt-4">
        <a href="/allCoop/group" class="btn btn-primary px-4"><i class="bi bi-grid-3x3-gap me-1"></i> ดูทั้งหมด</a>
      <% } else { %>
      <div class="alert alert-light border text-center">ไม่มีข้อมูล</div>
    <% } %>
  </div>
</section>

<!-- Modal for Coop Detail (added) -->
<div class="modal fade modal-elevated" id="coopDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header modal-gradient py-2">
        <h5 class="modal-title d-flex align-items-center gap-2 mb-0" id="coopDetailModalLabel"><i class="bi bi-building"></i> รายละเอียด</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <div id="coopDetailLoading" class="text-center py-5">
          <div class="spinner-border text-primary mb-3" role="status"></div>
          <div class="small text-muted">กำลังโหลดข้อมูล...</div>
        </div>
        <div id="coopDetailError" class="alert alert-danger m-3 d-none"></div>
        <div id="coopDetailContent" class="p-3 d-none"></div>
      </div>
    </div>
  </div>
</div>

<!-- NEW Strength Summary Section -->
<section id="strength" class="section-block bg-light">
  <div class="container">
    <h3 class="text-center text-primary section-title mb-4">📌 สรุปผลประเมินความเข้มแข็งสหกรณ์และกลุ่มเกษตรกร </h3>
    <% const grades = (strengthGrades||[]); const sData = (strengthData||{});
       function rowTotal(group){ return grades.reduce((a,g)=> a + (sData[group] && sData[group][g] || 0),0); }
    %>
    <div class="text-center mb-3">
      <% if (strengthYear && strengthYear !== '-') { %>
        <span class="badge bg-secondary">ปีข้อมูล: <%= strengthYear %></span>
      <% } %>
    </div>
    <% if (!grades.length) { %>
      <div class="alert alert-warning text-center">ไม่มีข้อมูลความเข้มแข็ง</div>
    <% } else { %>
      <div class="row g-4">
        <div class="col-lg-6">
          <div class="card modern-card shadow-sm h-100">
            <div class="card-gradient-bar"></div>
            <div class="d-flex justify-content-between bg-success">
              <div class="card-header  text-white fw-semibold flex-grow-1">สหกรณ์</div>
              <button class="btn btn-sm btn-outline-light m-2 ms-auto js-strength-list" data-group="สหกรณ์" data-year="<%= strengthYear %>">ดูรายชื่อสหกรณ์</button>
            </div>
           
            <div class="card-body p-2">
              <div class="table-responsive">
                <table class="table table-sm table-bordered table-hover align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th class="text-center">ระดับ</th>
                      <% grades.forEach(g => { %><th class="text-center"><%= g %></th><% }); %>
                      <th class="text-center bg-secondary text-white">รวม</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td class="fw-semibold text-center">สหกรณ์</td>
                      <% grades.forEach(g => { const v=(sData['สหกรณ์']&&sData['สหกรณ์'][g])||0; %>
                        <td class="text-center"><%= v.toLocaleString() %></td>
                      <% }); %>
                      <td class="text-center fw-bold bg-secondary text-white"><%= rowTotal('สหกรณ์').toLocaleString() %></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card modern-card shadow-sm h-100">
            <div class="card-gradient-bar"></div>
            <div class="d-flex justify-content-between bg-info">
              <div class="card-header text-white fw-semibold flex-grow-1">กลุ่มเกษตรกร</div>
              <button class="btn btn-sm btn-outline-light m-2 ms-auto js-strength-list" data-group="กลุ่มเกษตรกร" data-year="<%= strengthYear %>">ดูรายชื่อกลุ่มเกษตรกร</button>
            </div>
            <div class="card-body p-2">
              <div class="table-responsive">
                <table class="table table-sm table-bordered table-hover align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th class="text-center">ระดับ</th>
                      <% grades.forEach(g => { %><th class="text-center"><%= g %></th><% }); %>
                      <th class="text-center bg-secondary text-white">รวม</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td class="fw-semibold text-center">กลุ่มเกษตรกร</td>
                      <% grades.forEach(g => { const v=(sData['กลุ่มเกษตรกร']&&sData['กลุ่มเกษตรกร'][g])||0; %>
                        <td class="text-center"><%= v.toLocaleString() %></td>
                      <% }); %>
                      <td class="text-center fw-bold bg-secondary text-white"><%= rowTotal('กลุ่มเกษตรกร').toLocaleString() %></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% } %>
  </div>
</section>

<!-- Strength Modal -->
<div class="modal fade modal-elevated" id="strengthModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header modal-gradient py-2">
        <h5 class="modal-title d-flex align-items-center gap-2 mb-0" id="strengthModalLabel">
          <i class="bi bi-speedometer2"></i> รายชื่อ
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="strengthLoading" class="text-center py-5">
          <div class="spinner-border text-primary mb-3" role="status"></div>
          <div class="small text-muted">กำลังโหลดข้อมูล...</div>
        </div>
        <div id="strengthError" class="alert alert-danger d-none"></div>
        <div class="d-flex justify-content-between align-items-center mb-2 d-none" id="strengthToolbar">
          <input type="text" class="modal-search-bar" id="strengthFilter" placeholder="🔍 ค้นหา..."/>
          <div class="small text-muted" id="strengthCount"></div>
        </div>
        <div class="table-responsive d-none" id="strengthTableWrap">
          <table class="table table-sm table-modern table-bordered table-hover align-middle mb-0">
            <thead>
              <tr class="text-center">
                <th style="width:56px;">#</th>
                <th class="text-start">ชื่อ</th>
                <th style="width:110px;">เกรด</th>
                <% if (user) { %><th style="width:120px;">คะแนน</th><% } %>
              </tr>
            </thead>
            <tbody id="strengthTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const STRENGTH_SHOW_POINT = document.getElementById('template-data')?.getAttribute('data-logged-in') === 'true';
(function(){
  document.addEventListener('click', async function(e){
    const btn = e.target.closest('.js-strength-list');
    if(!btn) return;
    const group = btn.getAttribute('data-group');
    const year = btn.getAttribute('data-year');
    const modalEl = document.getElementById('strengthModal');
    const titleEl = document.getElementById('strengthModalLabel');
    const loadingEl = document.getElementById('strengthLoading');
    const errorEl = document.getElementById('strengthError');
    const wrapEl = document.getElementById('strengthTableWrap');
    const tbody = document.getElementById('strengthTbody');
    const toolbar = document.getElementById('strengthToolbar');
    const countEl = document.getElementById('strengthCount');
    const filterInput = document.getElementById('strengthFilter');
    titleEl.innerHTML = '<i class="bi bi-speedometer2 me-1"></i> รายชื่อ '+group+' (ปี '+year+')';
    loadingEl.classList.remove('d-none');
    errorEl.classList.add('d-none');
    wrapEl.classList.add('d-none');
    tbody.innerHTML='';
    countEl.textContent='';
    if(filterInput){ filterInput.value=''; }
    try {
      const qs = new URLSearchParams({ group, year });
      const resp = await fetch('/strength/details?'+qs.toString());
      if(!resp.ok) throw new Error('network');
      const data = await resp.json();
      loadingEl.classList.add('d-none');
      if(!data.items || !data.items.length){
        errorEl.textContent = 'ไม่มีข้อมูล';
        errorEl.classList.remove('d-none');
      } else {
        tbody.innerHTML = data.items.map((it,i)=> {
          const base = `<tr class='fade-in-row' data-name='${(it.st_fullname||'').toLowerCase()} ${(it.st_code||'').toLowerCase()}'>
            <td class='text-center'>${i+1}</td>
            <td><a href='/strength/${it.st_code}' target='_blank' class='text-decoration-none fw-semibold'>${it.st_fullname}</a><br><small class='text-muted'>(${it.st_code})</small></td>
            <td class='text-center'><span class='badge 
              ${it.st_grade==='ชั้น1' ? 'bg-success' : it.st_grade==='ชั้น2' ? 'bg-warning' : 'bg-danger'} rounded-pill p-3'>${it.st_grade||'-'}</span></td>`;
          const point = STRENGTH_SHOW_POINT ? `<td class='text-end fw-medium'>${Number(it.st_point||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td>` : '';
          return base + point + '</tr>';
        }).join('');
        wrapEl.classList.remove('d-none');
        toolbar.classList.remove('d-none');
        if(countEl){ countEl.textContent = 'พบ '+ data.items.length.toLocaleString() +' รายการ'; }
        if(filterInput){ setTimeout(()=> filterInput.focus(), 150); }
      }
    } catch(err){
      loadingEl.classList.add('d-none');
      errorEl.textContent = 'เกิดข้อผิดพลาดในการโหลดข้อมูล';
      errorEl.classList.remove('d-none');
    }
    const bsModal = bootstrap && bootstrap.Modal ? new bootstrap.Modal(modalEl) : null;
    if(bsModal) bsModal.show();
  });
})();
</script>

<script>
// Strength modal client-side filter
(function(){
  const input = document.getElementById('strengthFilter');
  if(!input) return;
  const tbody = document.getElementById('strengthTbody');
  const countEl = document.getElementById('strengthCount');
  input.addEventListener('input', function(){
    const q = this.value.trim().toLowerCase();
    const rows = tbody ? Array.from(tbody.querySelectorAll('tr')) : [];
    let shown = 0;
    rows.forEach(r=>{
      const name = r.getAttribute('data-name')||'';
      const match = !q || name.includes(q);
      r.classList.toggle('d-none', !match);
      if(match) shown++;
    });
    if(countEl){
      const total = rows.length;
      countEl.textContent = q ? `พบ ${shown.toLocaleString()} / ${total.toLocaleString()} รายการ` : `พบ ${total.toLocaleString()} รายการ`;
    }
  });
})();
</script>

<!-- ================= Member Summary ================= -->
<section id="members" class="section-block bg-light">
  <div class="container">
    <div class="mb-3 text-center">
      <h2 class="text-primary section-title">📊 สรุปจำนวนสมาชิก (สหกรณ์)</h2>
    </div>

    <% const hasSummary = (typeof summaryByYear !== 'undefined' && summaryByYear); %>
    <% const hasTop = (typeof top !== 'undefined' && Array.isArray(top)); %>
    <% let yearEntries = hasSummary ? Object.entries(summaryByYear).sort((a,b)=> Number(b[0]) - Number(a[0])) : []; %>
    <% const targetYear = 2567; yearEntries = yearEntries.filter(([y]) => Number(y) === targetYear); %>

    <div class="row g-3">
      <div class="col-12">
        <div class="card modern-card h-100">
          <div class="card-gradient-bar"></div>
          <div class="card-body">
            <h5 class="card-title text-primary mb-3">
              <i class="bi bi-trophy me-2"></i> Top สหกรณ์ (ตามจำนวนสมาชิกรวม ปี <%= targetYear %>)
            </h5>
            <% const filteredTop = (hasTop && Array.isArray(top)) ? top.filter(t => Number(t.year) === targetYear) : []; %>
            <% if (filteredTop.length) { %>
              <div class="table-responsive">
                <table class="table table-sm table-bordered table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th class="text-center">อันดับ</th>
                      <th>ชื่อสหกรณ์</th>
                      <th class="d-none d-sm-table-cell">พ.ศ.</th>
                      <th class="d-none d-sm-table-cell">อำเภอ</th>
                      <th class="text-end">สมาชิกรวม(ราย)</th>
                      <th class="text-center">view</th>
                    </tr>
                  </thead>
                  <tbody>
                  <% filteredTop.forEach((t,i)=>{ %>
                    <tr>
                      <td class="text-center"><%= i+1 %></td>
                      <td><%= t.name %></td>
                      <td class="d-none d-sm-table-cell"><%= t.year || 'N/A' %></td>
                      <td class="d-none d-sm-table-cell"><%= t.อำเภอ %></td>
                      <td class="text-end"><%= Number(t.total).toLocaleString() %></td>
                      <td class="text-center">
                        <a href="/members/<%= t.idx %>" class="btn btn-sm btn-outline-info">รายละเอียด</a>
                      </td>
                    </tr>
                  <% }) %>
                  </tbody>
                </table>
              </div>
            <% } else { %>
              <div class="text-muted">ไม่มีข้อมูลรายการ Top สำหรับปี <%= targetYear %></div>
            <% } %>
          </div>
          <div class="card-footer bg-light text-end">
            <a href="/members" class="btn btn-sm btn-primary">รายการทั้งหมด / ค้นหา</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ================= Activities & Image (replaced image with calendar) ================= -->
<section id="activities" class="section-block">
  <div class="container-lg">
    <div class="row">
      <div class="col-12 mb-3 mb-md-0">
        <div class="card modern-card shadow-sm border-0 h-100">
          <div class="card-gradient-bar"></div>
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="text-primary mb-0"><i class="bi bi-calendar-event me-2 text-success"></i> ปฏิทินกิจกรรม</h5>
              <button id="openActivityListBtn" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-list-ul me-1"></i> แสดงข้อมูลรายละเอียด
              </button>
            </div>
            <div id="activitiesCalendar"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- List of activity -->
<section>
  <div class="container">
    <div class="col-12">
      <div class="card modern-card shadow-sm border-0">
        <div class="card-gradient-bar"></div>
        <div class="card-body">
          <h5 class="text-primary"><i class="bi bi-calendar-event me-2 text-success"></i> กิจกรรมล่าสุด</h5>
          <ul class="list-group list-group-flush">
            <% activity.forEach(acti => { %>
              <li class="list-group-item">
                <i class="bi bi-calendar-event me-2 text-success"></i>
                <% const today = new Date(); %>
                <% const actDate = new Date(acti.date_act); %>
                <%= actDate.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' }) %> - 
                <%= acti.activity %>
                <% if (actDate.toDateString() === today.toDateString()) { %>
                  <span class="badge bg-danger ms-2"><i class="bi bi-stars"></i> วันนี้</span>
                <% } %>
              </li>
            <% }) %>
          </ul>
        </div>
      </div>
      <div class="text-end mt-2">
        <a href="/activities" class="btn btn-primary btn-sm px-4 shadow-sm">
          ดูทั้งหมด
        </a>
      </div>
    </div>
  </div>
</section>

<!-- Activity single detail modal -->
<div class="modal fade modal-elevated" id="activityModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header modal-gradient py-2">
        <h5 class="modal-title mb-0"><i class="bi bi-info-circle me-1"></i> รายละเอียดกิจกรรม</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <dl class="row mb-0">
          <dt class="col-4">วันที่</dt><dd class="col-8" id="acDate">-</dd>
          <dt class="col-4">เวลา</dt><dd class="col-8" id="acTime">-</dd>
          <dt class="col-4">สถานที่</dt><dd class="col-8" id="acPlace">-</dd>
          <dt class="col-4">กิจกรรม</dt><dd class="col-8" id="acTitle">-</dd>
        </dl>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ปิด</button>
      </div>
    </div>
  </div>
</div>

<!-- Activity list modal -->
<div class="modal fade modal-elevated" id="activityListModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header modal-gradient py-2">
        <h5 class="modal-title mb-0"><i class="bi bi-list-ul me-1"></i> รายการกิจกรรม</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <input type="text" class="modal-search-bar" id="activityFilter" placeholder="🔍 ค้นหากิจกรรม..."/>
          <div class="small text-muted" id="activityCount"></div>
        </div>
        <div class="table-responsive">
          <table class="table table-sm table-modern table-bordered table-hover align-middle mb-0">
            <thead>
              <tr class="text-center">
                <th style="width:56px;">#</th>
                <th class="text-start">วันที่</th>
                <th class="text-start">กิจกรรม</th>
              </tr>
            </thead>
            <tbody id="activityTbody">
              <% (activity||[]).forEach((a,i)=>{ const d=new Date(a.date_act); %>
                <tr data-name="<%= (a.activity||'').toLowerCase() %> <%= d.toISOString().slice(0,10) %>">
                  <td class="text-center"><%= i+1 %></td>
                  <td><%= d.toLocaleDateString('th-TH', { year:'numeric', month:'long', day:'numeric'}) %></td>
                  <td><%= a.activity %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ปิด</button>
      </div>
    </div>
  </div>
</div>

<!-- ================= Latest Projects & Commands ================= -->
<section id="projects" class="section-block bg-light">
  <div class="container-lg">
    <div class="row">
      <div class="col-md-6">
        <h2 class="mb-4 text-center text-primary section-title">
          <i class="bi bi-file-earmark-pdf me-2"></i> โครงการล่าสุด
        </h2>
        <div class="card modern-card shadow-sm border-0">
          <div class="card-gradient-bar"></div>
          <div class="card-body">
            <ul class="list-group list-group-flush">
              <% (lastProjects || []).forEach((p, idx)=> { %>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span>
                    <strong>
                      <%= idx + 1 %>.
                    </strong>
                    <%= p.pro_story %>
                      <span class="badge bg-secondary ms-2">
                        <%= p.pro_no %>
                      </span>
                  </span>
                  <% if(user){ %>
                    <a href="/project/download/<%= p.pro_id %>" class="btn btn-sm btn-outline-primary"
                      target="_blank">
                      <i class="bi bi-file-pdf-fill"></i>
                    </a>
                  <% } %>
                </li>
              <% }) %>
            </ul>
            <div class="text-end mt-2">
              <a href="/project" class="btn btn-primary btn-sm px-4 shadow-sm">ดูทั้งหมด</a>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <h2 class="mb-4 text-center text-primary section-title">
          <i class="bi bi-megaphone-fill me-2"></i> คำสั่งล่าสุด
        </h2>
        <div class="card modern-card shadow-sm border-0">
          <div class="card-gradient-bar"></div>
          <div class="card-body">
            <ul class="list-group list-group-flush">
              <% (lastCommands || []).forEach((c, idx)=> { %>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span>
                    <strong>
                      <%= idx + 1 %>.
                    </strong>
                    <%= c.com_story %>
                      <span class="badge bg-secondary ms-2">
                        <%= c.com_no %>
                      </span>
                  </span>
                  <% if(user){ %>
                    <a href="/command/download/<%= c.command_id %>" class="btn btn-sm btn-outline-primary"
                      target="_blank">
                      <i class="bi bi-file-earmark-arrow-down"></i>
                    </a>
                  <% } %>
                </li>
              <% }) %>
            </ul>
            <div class="text-end mt-2">
              <a href="/command" class="btn btn-primary btn-sm px-4 shadow-sm">ดูทั้งหมด</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>



<%- include('home/vong-latest.ejs') %>


<section id="downloads" class="section-block bg-white">
  <div class="container-lg">
    <div class="card modern-card">
      <div class="card-gradient-bar"></div>
      <div class="card-header bg-success text-white">
        <i class="bi bi-trophy me-2"></i> Top 10 ดาวน์โหลดล่าสุด
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm table-bordered table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th style="width:56px;" class="d-none d-sm-table-cell">#</th>
                <th>เรื่อง</th>
                <th class="text-nowrap">ไฟล์</th>
                <th class="text-center">ลิงก์</th>
                <th class="text-nowrap">วันที่</th>
              </tr>
            </thead>
            <tbody id="topDownloadsTbody">
              <tr><td colspan="5" class="text-muted">กำลังโหลด...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-footer bg-light text-end">
        <a href="/down" class="btn btn-sm btn-outline-secondary">ดูทั้งหมด</a>
      </div>
    </div>
  </div>
</section>
<!-- ================= Articles (List View) ================= -->

<section id="articles" class="section-block bg-light">
  <div class="container">
    <div class="card modern-card shadow-sm border-0">
      <div class="card-gradient-bar"></div>
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="bi bi-journal-text me-2"></i> บทความ (แสดงแบบรายการ)</h6>
        <a href="/article" class="btn btn-sm btn-outline-light">ดูทั้งหมด</a>
      </div>
      <div class="card-body">
        <%- include('article/partials/list-body.ejs', { articles: (lastArticles || []) }) %>
      </div>
    </div>
  </div>
</section>


<section id="usecar" class="section-block">
  <div class="container-lg">
    <div class="row mt-4" id="usecarSection">
      <div class="col-12">
        <h2 class="mb-4 text-center text-primary section-title">
          <i class="bi bi-car-front-fill me-2"></i> รายการใช้รถ
        </h2>
        <div class="card modern-card shadow-sm border-0">
          <div class="card-gradient-bar"></div>
          <div class="card-body">
            <div class="row">
              <% usecars.forEach((usecar)=> { %>
                <div class="col-12 col-md-6 mb-3">
                  <div class="list-group">
                    <div class="list-group-item">
                      <div class="d-flex justify-content-between align-items-start">
                        <div class="ms-2 me-auto">
                          <% const date=new Date(usecar.date_car); const options={ year: 'numeric' , month: 'long' ,
                            day: 'numeric' }; const thaiDate=date.toLocaleDateString('th-TH', options); const
                            today=new Date(); const
                            isToday=today.toLocaleDateString('th-TH')===date.toLocaleDateString('th-TH'); %>
                            <div class="fw-bold text-success mb-1">
                              <i class="bi bi-calendar-event me-1"></i>
                              <%= thaiDate %>
                                <span class="text-muted">(<i class="bi bi-clock"></i>
                                  <%= usecar.time_car + ' น.' %>)
                                </span>
                                <% if (isToday) { %>
                                  <span class="badge bg-danger ms-2"><i class="bi bi-stars"></i> วันนี้</span>
                                <% } %>
                            </div>
                            <div class="text-dark mb-1">
                              <i class="bi bi-geo-alt-fill text-danger me-1"></i>
                              <%= usecar.place_car %>
                            </div>
                            <small class="text-muted d-block mb-2">
                              <i class="bi bi-clipboard2-check me-1"></i>
                              <%= usecar.act_car %>
                            </small>

                            <button
                              type="button"
                              class="btn btn-outline-primary btn-sm js-open-usecar"
                              data-bs-toggle="modal"
                              data-bs-target="#usecarModal"
                              data-id="<%= usecar.id_usecar %>"
                              data-date="<%= thaiDate %>"
                              data-time="<%= usecar.time_car %>"
                              data-place="<%= usecar.place_car %>"
                              data-act="<%= usecar.act_car %>"
                            >
                              <i class="bi bi-info-circle me-1"></i> ดูข้อมูลเพิ่ม
                            </button>
                        </div>

                        <% if(user && user.mClass==='admin' ){ %>
                          <div class="d-flex align-items-center ms-3">
                            <a href="/usecar/edit/<%= usecar.id_usecar %>"
                              class="btn btn-outline-warning btn-sm me-2">
                              <i class="bi bi-pencil-square"></i>
                            </a>
                            <form action="/usecar/delete/<%= usecar.id_usecar %>" method="POST"
                              style="display: inline;">
                              <button type="submit" class="btn btn-outline-danger btn-sm">
                                <i class="bi bi-trash3"></i>
                              </button>
                            </form>
                          </div>
                        <% } %>
                      </div>
                    </div>
                  </div>
                </div>
              <% }); %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Added: Usecar Detail Modal -->
<div class="modal fade" id="usecarModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header modal-gradient py-2">
        <h5 class="modal-title mb-0"><i class="bi bi-car-front-fill me-1"></i> รายละเอียดการใช้รถ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="usecarModalLoading" class="text-center d-none">
          <div class="spinner-border text-primary mb-3" role="status"></div>
          <div class="small text-muted">กำลังโหลด...</div>
        </div>
        <div id="usecarModalError" class="alert alert-danger d-none"></div>
        <dl class="row mb-0" id="usecarModalContent">
          <dt class="col-4">วันที่</dt><dd class="col-8" id="ucDate">-</dd>
          <dt class="col-4">เวลา</dt><dd class="col-8" id="ucTime">-</dd>
            <dt class="col-4">สถานที่</dt><dd class="col-8" id="ucPlace">-</dd>
          <dt class="col-4">กิจกรรม</dt><dd class="col-8" id="ucAct">-</dd>
        </dl>
      </div>
    </div>
  </div>
</div>

<script>
// Usecar modal populate (client-side only using data-* attributes)
(function(){
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.js-open-usecar');
    if(!btn) return;
    const date = btn.getAttribute('data-date') || '-';
    const time = btn.getAttribute('data-time') || '-';
    const place = btn.getAttribute('data-place') || '-';
    const act = btn.getAttribute('data-act') || '-';
    document.getElementById('ucDate').textContent = date;
    document.getElementById('ucTime').textContent = time + ' น.';
    document.getElementById('ucPlace').textContent = place;
    document.getElementById('ucAct').textContent = act;
    // If Bootstrap auto trigger fails for some reason, ensure show programmatically
    const modalEl = document.getElementById('usecarModal');
    if(modalEl){
      const instance = bootstrap && bootstrap.Modal ? bootstrap.Modal.getOrCreateInstance(modalEl) : null;
      if(instance) instance.show();
    }
  });
})();
</script>

<section id="online" class="section-block bg-light">
  <div class="container-lg">
    <div class="row">
      <div class="col-md-4">
        <div class="card modern-card shadow-sm border-0 h-100">
          <div class="card-gradient-bar"></div>
          <div class="card-body text-center">
            <h5 class="card-title">📈 ข้อมูลการใช้งาน</h5>
            <div class="mb-3">
              <div class="display-4 text-success" id="onlineCountValue" aria-live="polite" aria-label="บุคคลทั่วไปออนไลน์">
                <%= onlineCount %>
              </div>
              <small class="text-muted">บุคคลทั่วไปออนไลน์ขณะนี้</small>
            </div>
            <hr>
            <div class="row text-center">
              <h4 class="col-12 text-center">จำนวน</h4>
              <div class="col-md-4">
                <div class="h4 text-primary">
                  <%= stats.coop %>
                </div>
                <small>สหกรณ์</small>
              </div>
              <div class="col-md-4">
                <div class="h4 text-success">
                  <%= stats.farmer %>
                </div>
                <small>กลุ่มเกษตรกร</small>
              </div>
              <div class="col-md-4">
                <div class="h4 text-warning">
                  <%= stats.closing %>
                </div>
                <small>ชำระบัญชี</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-8 mt-md-0">
        <h2 class="mb-4 text-center text-success section-title">🟢 Members Online</h2>

        <div class="card modern-card shadow-sm border-0">
          <div class="card-gradient-bar"></div>
          <div class="card-body">
            <div class="row">
              <% onlineUsers.forEach((user, index)=> { %>
                <div class="col-md-6 mb-3">
                  <div class="d-flex align-items-center">
                    <img src="<%= user.m_img || '/images/default-avatar.png' %>" alt="Avatar"
                      class="rounded-circle me-3" style="width: 40px; height: 40px; object-fit: cover;">
                    <div>
                      <div class="fw-bold text-success">
                        <%= user.on_name %>
                      </div>
                      <small class="text-muted">
                        <%= user.m_position || '32ใช้' %>
                      </small>
                      <div class="badge bg-success ms-2">
                        <i class="bi bi-circle-fill" style="font-size: 8px;"></i> ออนไลน์
                      </div>
                    </div>
                  </div>
                </div>
              <% }); %>
            </div>

            <% if (onlineUsers.length===0) { %>
              <div class="text-center text-muted">
                <i class="bi bi-people-fill" style="font-size: 2rem;"></i>
                <p>ไม่มีสมาชิกออนไลน์ในขณะนี้</p>
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>


<div id="template-data"
  data-stats='{"coop": <%= JSON.stringify(stats.coop) %>, "farmer": <%= JSON.stringify(stats.farmer) %>, "closing": <%= JSON.stringify(stats.closing) %>}'
  data-coop-group-stats='<%- JSON.stringify(coopGroupStats) %>'
  data-online-count="<%= typeof onlineCount !== 'undefined' ? onlineCount : 0 %>"
  data-logged-in="<%= user ? 'true' : 'false' %>"
  <% if ((chamraAllProcesses||[]).length) { %> data-chamra-stages='<%- JSON.stringify(__chamraCounts) %>' <% } %>
  data-activities='<%- JSON.stringify(activity || []) %>'
>
</div>

<!-- Back To Top Button -->
<button type="button" id="backToTop" aria-label="กลับขึ้นบน" class="back-to-top">
  <i class="bi bi-arrow-up"></i>
</button>

<!-- ================= SCRIPTS (Enhancements added before existing scripts end) ================= -->
<!-- Load socket.io client for realtime online counter -->
<script src="/socket.io/socket.io.js"></script>

<script>
  // Socket: update onlineCount (ปรับให้ปลอดภัย + มี fallback)
  (function(){
    const el = document.getElementById('onlineCountValue');
    if(!el) return;
    let last = Number(el.textContent.trim()) || 0;
    let updated = false;

    try {
      const socket = io(); // ใช้ค่า default; ถ้ากำหนด path ให้ตรงกับ server
      socket.on('onlineUsers', (count) => {
        if(typeof count === 'number') {
          el.textContent = count;
          last = count;
          updated = true;
        }
      });
      socket.on('disconnect', () => {
        // ไม่เปลี่ยนค่า ให้ค้างไว้
      });
    } catch(e){
      console.warn('Socket init failed:', e);
    }

    // Fallback: ถ้า 15s ไม่เคยอัปเดต แสดงค่าเดิมชัดเจน (ไม่กระทบ UX)
    setTimeout(()=> {
      if(!updated) {
        el.textContent = last;
      }
    }, 15000);
  })();
</script>

<script>
  // Quick Nav Active State + Smooth Scroll
  (function(){
    const links=[...document.querySelectorAll('#quickNav a')];
    const sections=links.map(a=>document.querySelector(a.getAttribute('href'))).filter(Boolean);
    function activate(){
      const y=window.scrollY + 120;
      let cur=null;
      sections.forEach(sec=>{
        if(sec.offsetTop <= y) cur=sec;
      });
      if(!cur) return;
      links.forEach(l=>l.classList.toggle('active', l.getAttribute('href') === '#'+cur.id));
    }
    links.forEach(l=> {
      l.addEventListener('click', e=>{
        const target=document.querySelector(l.getAttribute('href'));
        if(target){
          e.preventDefault();
          window.scrollTo({ top: target.offsetTop - 70, behavior:'smooth' });
        }
      });
    });
    window.addEventListener('scroll', activate,{passive:true});
    activate();
  })();

  // Reveal on scroll (with fallback when IntersectionObserver is unavailable)
  (function(){
    const revealEls = document.querySelectorAll('.reveal');
    if (!('IntersectionObserver' in window)) {
      revealEls.forEach(el=> el.classList.add('in'));
      return;
    }
    const obs=new IntersectionObserver(entries=>{
      entries.forEach(e=>{
        if(e.isIntersecting){
          e.target.classList.add('in');
          obs.unobserve(e.target);
        }
      });
    },{threshold:.14});
    revealEls.forEach(el=>obs.observe(el));
    document.querySelectorAll('.section-block').forEach(el=>{
      el.classList.add('reveal');
      obs.observe(el);
    });
  })();
</script>

<script>
  (function() {
    const btn = document.getElementById('exportChamraBtnHome');
    if (!btn) return;
    btn.addEventListener('click', async () => {
      btn.disabled = true;
      const originalText = btn.textContent;
      btn.textContent = 'กำลังส่งออก...';
      try {
        const resp = await fetch('/chamra/export/pdf', { method: 'POST' });
        if (!resp.ok) throw new Error('Export failed');
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
        setTimeout(() => URL.revokeObjectURL(url), 60000);
      } catch (e){
        alert('ไม่สามารถส่งออกข้อมูลได้');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    });
  })();
</script>

<script>
  (function() {
    const loggedIn = document.getElementById('template-data').getAttribute('data-logged-in') === 'true';

    function escapeHtml(str) {
      return String(str ?? '').replace(/[&<>"']/g, s => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]
      ));
    }
    function fmtDate(d) {
      if (!d) return '-';
      const dt = new Date(d);
      if (isNaN(dt)) return escapeHtml(String(d));
      try {
        return dt.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' });
      } catch {
        const months = ['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'];
        return `${dt.getDate()} ${months[dt.getMonth()]} ${dt.getFullYear() + 543}`;
      }
    }

    fetch('/down/top10')
      .then(res => res.json())
      .then(data => {
        const tbody = document.getElementById('topDownloadsTbody');
        if (!Array.isArray(data) || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-muted">ไม่มีข้อมูล</td></tr>';
          return;
        }
        tbody.innerHTML = data.map((d, idx) => `
          <tr>
            <td class="d-none d-sm-table-cell">${idx + 1}</td>
            <td>${escapeHtml(d.down_subject || '-')}</td>
            <td class="text-nowrap">
              ${
                d.down_file && d.down_file !== '-' ? (
                  loggedIn
                    ? `<a href="/down/download/${d.down_id}" target="_blank" class="btn btn-sm btn-outline-success">
                         <i class="bi bi-file-earmark-arrow-down"></i> ไฟล์
                       </a>`
                    : `<a href="/auth/login" class="btn btn-sm btn-outline-secondary">
                         <i class="bi bi-lock"></i> เข้าสู่ระบบ
                       </a>`
                ) : '<span class="text-muted">-</span>'
              }
            </td>
            <td class="text-center">
              ${
                d.down_link && d.down_link !== '-'
                  ? `<a href="${escapeHtml(d.down_link)}" target="_blank" class="btn btn-sm btn-outline-info">
                       <i class="bi bi-link-45deg"></i> ลิงก์
                     </a>`
                  : '<span class="text-muted">-</span>'
              }
            </td>
            <td class="text-nowrap">${fmtDate(d.down_savedate)}</td>
          </tr>
        `).join('');
      })
      .catch(() => {
        const tbody = document.getElementById('topDownloadsTbody');
        tbody.innerHTML = '<tr><td colspan="5" class="text-danger">โหลดข้อมูลไม่สำเร็จ</td></tr>';
      });
  })();
</script>

<script>
  (function(){
    document.addEventListener('click', function(e){
      const btn = e.target.closest('.js-show-group-items');
      if(!btn) return;
      const group = btn.getAttribute('data-group');
      const type = btn.getAttribute('data-type');
      const label = btn.getAttribute('data-group-label');

      const modalEl = document.getElementById('groupItemsModal');
      const titleEl = document.getElementById('groupItemsModalLabel');
      const listEl = document.getElementById('groupItemsList');
      const loadingEl = document.getElementById('groupItemsLoading');
      const errorEl = document.getElementById('groupItemsError');

      titleEl.textContent = label + ' - ' + type;
      listEl.innerHTML = '';
      listEl.classList.add('d-none');
      errorEl.classList.add('d-none');
      loadingEl.classList.remove('d-none');

      fetch(`/activeCoop/group/${encodeURIComponent(group)}/items?type=${encodeURIComponent(type)}`)
        .then(r => { if(!r.ok) throw new Error('network'); return r.json(); })
        .then(data => {
          loadingEl.classList.add('d-none');
          if(!data.items || !data.items.length){
            errorEl.textContent = 'ไม่มีข้อมูล';
            errorEl.classList.remove('d-none');
            return;
          }
          listEl.innerHTML = data.items.map((it,i)=>`<li class="list-group-item d-flex justify-content-between align-items-start">
              <div>
                <span class="fw-semibold">${i+1}. ${it.c_name}</span>
                <small class="text-muted ms-1">(${it.c_code || '-'})</small>
              </div>
              <span class="badge bg-${it.coop_group==='สหกรณ์'?'success':'info'}">${it.coop_group}</span>
            </li>`).join('');
          listEl.classList.remove('d-none');
        })
        .catch(err => {
          loadingEl.classList.add('d-none');
          errorEl.textContent = 'เกิดข้อผิดพลาดในการโหลดข้อมูล';
          errorEl.classList.remove('d-none');
        });

      const bsModal = bootstrap && bootstrap.Modal ? new bootstrap.Modal(modalEl) : null;
      if(bsModal) bsModal.show();
    });
  })();
</script>


<script>
(function(){
  document.addEventListener('click', function(e){
    const link = e.target.closest('.js-coop-detail');
    if(!link) return;
    e.preventDefault();
    const code = link.getAttribute('data-code');
    const modalEl = document.getElementById('coopDetailModal');
    const labelEl = document.getElementById('coopDetailModalLabel');
    const loadingEl = document.getElementById('coopDetailLoading');
    const errorEl = document.getElementById('coopDetailError');
    const contentEl = document.getElementById('coopDetailContent');
    if(!modalEl) return;
    labelEl.innerHTML = '<i class="bi bi-building me-1"></i> รายละเอียดสถาบัน ('+ code +')';
    loadingEl.classList.remove('d-none');
    errorEl.classList.add('d-none');
    contentEl.classList.add('d-none');
    contentEl.innerHTML = '';

    // Fetch full HTML page then extract main/container if possible
    fetch('/allCoop/profile/' + encodeURIComponent(code))
      .then(r=>{ if(!r.ok) throw new Error('network'); return r.text(); })
      .then(html=>{
        loadingEl.classList.add('d-none');
        try {
          const parser = new DOMParser();
            const doc = parser.parseFromString(html,'text/html');
            let container = doc.querySelector('main') || doc.querySelector('.container') || doc.body;
            // Remove back buttons/links containing the text "ย้อนกลับ"
            container.querySelectorAll('a, button').forEach(el=>{
              if(/ย้อนกลับ/.test(el.textContent)) el.remove();
            });
            let extracted = container.innerHTML;
            extracted = extracted.replace(/<script[\s\S]*?<\/script>/gi,'');
            contentEl.innerHTML = '<div class="coop-modal-inner">' + extracted + '</div>';
        } catch(err){
          contentEl.innerHTML = '<div class="alert alert-warning">ไม่สามารถแสดงผลได้</div>';
        }
        contentEl.classList.remove('d-none');
      })
      .catch(err=>{
        loadingEl.classList.add('d-none');
        errorEl.textContent = 'เกิดข้อผิดพลาดในการโหลดข้อมูล';
        errorEl.classList.remove('d-none');
      });

    const bsModal = (window.bootstrap && bootstrap.Modal) ? new bootstrap.Modal(modalEl) : null;
    if(bsModal) bsModal.show();
  });
})();
</script>

<!-- Back To Top behavior -->
<script>
  (function(){
    const btn = document.getElementById('backToTop');
    if(!btn) return;
    const onScroll = ()=> {
      btn.classList.toggle('show', window.scrollY > 300);
    };
    window.addEventListener('scroll', onScroll, { passive: true });
    onScroll();
    btn.addEventListener('click', ()=> window.scrollTo({ top: 0, behavior: 'smooth' }));
  })();
</script>

<script>
  // Init Charts on home page (run after all deferred scripts loaded)
  window.addEventListener('load', function(){
    const barEl = document.getElementById('coopChart');
    const pieEl = document.getElementById('coopPieChart');
    const dataEl = document.getElementById('template-data');
    if(!barEl && !pieEl) return;
    if(!dataEl) return;

    // Parse stats from data-* attribute
    let stats = { coop: 0, farmer: 0, closing: 0 };
    try {
      const raw = dataEl.getAttribute('data-stats');
      stats = typeof raw === 'string' ? JSON.parse(raw) : (raw || stats);
    } catch(e) { /* ignore and use defaults */ }
    const coop = Number(stats.coop) || 0;
    const farmer = Number(stats.farmer) || 0;
    const closing = Number(stats.closing) || 0;

    // Ensure Chart.js exists
    if (typeof Chart === 'undefined') return;
    // Register plugin if available
    if (typeof ChartDataLabels !== 'undefined') {
      Chart.register(ChartDataLabels);
    }
    Chart.defaults.font.family = 'Sarabun, system-ui, -apple-system, Segoe UI, Roboto, sans-serif';

    // Bar chart
    if (barEl) {
      const ctx = barEl.getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['สหกรณ์','กลุ่มเกษตรกร','ชำระบัญชี'],
          datasets: [{
            label: 'จำนวน (แห่ง)',
            data: [coop, farmer, closing],
            backgroundColor: ['#16a34a','#0ea5e9','#f59e0b'],
            borderWidth: 0,
            borderRadius: 8,
            maxBarThickness: 46
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: { duration: 350, easing: 'easeOutQuart' },
          plugins: {
            legend: { display: false },
            tooltip: { enabled: true },
            datalabels: {
              anchor: 'end', align: 'top',
              color: '#0f172a',
              formatter: (v) => Number(v).toLocaleString(),
              font: { weight: '600' }
            }
          },
          scales: {
            y: { beginAtZero: true, ticks: { precision: 0 } },
            x: { grid: { display:false } }
          }
        }
      });
    }

    // Doughnut chart
    if (pieEl) {
      const ctxPie = pieEl.getContext('2d');
      new Chart(ctxPie, {
        type: 'doughnut',
        data: {
          labels: ['สหกรณ์','กลุ่มเกษตรกร'],
          datasets: [{
            data: [coop, farmer],
            backgroundColor: ['#16a34a','#0ea5e9'],
            borderWidth: 0
          }]
        },
        options: {
          cutout: '58%',
          animation: { duration: 350, easing: 'easeOutQuart' },
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { enabled: true },
            datalabels: {
              formatter: (v,ctx) => {
                try {
                  const ds = ctx.chart.data.datasets[0].data;
                  const total = ds.reduce((a,b)=> a + Number(b||0), 0) || 1;
                  const pct = Math.round((Number(v||0)/total)*100);
                  return pct + '%';
                } catch { return v; }
              },
              color: '#111827',
              font: { weight: '600' }
            }
          }
        }
      });
    }
  });
</script>

<!-- Init Chamra stages chart -->
<script>
  window.addEventListener('load', function(){
    const tdata = document.getElementById('template-data');
    const canvas = document.getElementById('chamraStageChart');
    if (!tdata || !canvas || typeof Chart === 'undefined') return;

    let stages = null;
    try {
      const raw = tdata.getAttribute('data-chamra-stages');
      stages = raw ? JSON.parse(raw) : null;
    } catch {}
    if (!stages) return;

    const labels = Array.from({length:10}, (_,i)=> 'S'+(i+1));
    const values = labels.map(k => Number(stages[k]||0));

    const ctx = canvas.getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'จำนวนสถาบัน (แห่ง)',
          data: values,
          backgroundColor: '#6366f1',
          borderWidth: 0,
          borderRadius: 8,
          maxBarThickness: 40
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 350, easing: 'easeOutQuart' },
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true },
          datalabels: typeof ChartDataLabels !== 'undefined' ? {
            anchor: 'end', align: 'top', color: '#0f172a', font: { weight: '600' },
            formatter: (v)=> Number(v).toLocaleString()
          } : undefined
        },
        scales: {
          y: { beginAtZero: true, ticks: { precision: 0 } },
          x: { grid: { display:false } }
        }
      }
    });
  });
</script>

<!-- Init Activities calendar + modals -->
<script>
  window.addEventListener('load', function(){
    const calEl = document.getElementById('activitiesCalendar');
    if (!calEl || typeof FullCalendar === 'undefined') return;

    function formatThaiDate(d){
      try {
        return d.toLocaleDateString('th-TH', { year:'numeric', month:'long', day:'numeric' });
      } catch {
        return d.toISOString().slice(0,10);
      }
    }

    const tDataEl = document.getElementById('template-data');
    let activities = [];
    try {
      const raw = tDataEl ? tDataEl.getAttribute('data-activities') : '[]';
      activities = raw ? JSON.parse(raw) : [];
    } catch { activities = []; }

    const events = (activities || []).map((a, idx) => ({
      id: String(idx+1),
      title: a.activity || '-',
      start: a.date_act,
      allDay: true,
      extendedProps: { raw: a }
    }));

    const calendar = new FullCalendar.Calendar(calEl, {
      initialView: 'dayGridMonth',
      locale: 'th',
      height: 'auto',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: ''
      },
      events,
      eventClick(info){
        const ev = info.event;
        const raw = ev.extendedProps?.raw || {};
        const d = ev.start ? new Date(ev.start) : null;
        const modalEl = document.getElementById('activityModal');
        if (!modalEl) return;
        document.getElementById('acDate').textContent = d ? formatThaiDate(d) : '-';
        document.getElementById('acTitle').textContent = raw.activity || ev.title || '-';
        document.getElementById('acTime').textContent = raw.act_time ? (raw.act_time + ' น.') : '-';
        document.getElementById('acPlace').textContent = raw.place || '-';
        const modal = bootstrap && bootstrap.Modal ? new bootstrap.Modal(modalEl) : null;
        if (modal) modal.show();
      }
    });
    calendar.render();

    // List modal open button
    const btnList = document.getElementById('openActivityListBtn');
    if (btnList) {
      btnList.addEventListener('click', function(){
        const el = document.getElementById('activityListModal');
        const m = bootstrap && bootstrap.Modal ? new bootstrap.Modal(el) : null;
        if (m) m.show();
        // Update count
        const countEl = document.getElementById('activityCount');
        const rows = document.querySelectorAll('#activityTbody tr');
        if (countEl) countEl.textContent = 'ทั้งหมด ' + rows.length + ' รายการ';
      });
    }

    // Filter in list modal
    (function(){
      const input = document.getElementById('activityFilter');
      const tbody = document.getElementById('activityTbody');
      const countEl = document.getElementById('activityCount');
      if(!input || !tbody) return;
      input.addEventListener('input', function(){
        const q = this.value.trim().toLowerCase();
        const rows = Array.from(tbody.querySelectorAll('tr'));
        let shown=0;
        rows.forEach(r => {
          const name = r.getAttribute('data-name')||'';
          const match = !q || name.includes(q);
          r.classList.toggle('d-none', !match);
          if(match) shown++;
        });
        if (countEl) {
          const total = rows.length;
          countEl.textContent = q ? `พบ ${shown} / ${total} รายการ` : `ทั้งหมด ${total} รายการ`;
        }
      });
    })();
  });
</script>

<%- include('partials/footer') %>