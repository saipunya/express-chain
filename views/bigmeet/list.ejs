<%- include('../partials/header') %>

<div class="container-fluid mt-4">
  <!-- Toast Notification -->
  <div id="toast" class="toast position-fixed top-0 end-0 m-3" style="z-index: 1050; display: none;">
    <div class="toast-body bg-success text-white">
      <span id="toastMessage"></span>
    </div>
  </div>

  <div class="card shadow mb-4">
    <div class="card-header py-3">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h5 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-users me-2"></i>การประชุมใหญ่สหกรณ์และกลุ่มเกษตรกร
          </h5>
        </div>
        <div class="col-md-6 text-end">
          <span class="me-3 text-muted">
            <!-- back to dashboard -->
            <a href="/dashboard" class="btn btn-secondary btn-sm">
              <i class="fas fa-arrow-left me-1"></i>กลับหน้าหลัก
            </a>
          </span>
          <a href="/bigmeet/new" class="btn btn-success btn-sm">
            <i class="fas fa-plus me-1"></i>เพิ่มข้อมูล
          </a>
        </div>
      </div>
    </div>
    <div class="card-body">
      <!-- Search and Filter -->
      <div class="row mb-3">ry -->
        <div class="col-md-4">n-items-end mb-3">
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" id="searchInput" class="form-control" placeholder="ค้นหาชื่อสหกรณ์...">
          </div> เติมด้วย JS -->
        </div>lect>
        <div class="col-md-3">
          <select id="yearFilter" class="form-select">
          <div class="border rounded p-2 bg-light">
            <div class="row text-center">
              <div class="col-md-4">
                <div class="text-muted small">จำนวนทั้งหมด (ในรายการนี้)</div>
                <div class="fw-bold" id="sumTotal">-</div>
              </div>
              <div class="col-md-4">
                <div class="text-muted small">ประชุมใหญ่แล้ว (ปีงบฯ ที่เลือก)</div>
                <div class="fw-bold text-success" id="sumMet">-</div>
              </div>
              <div class="col-md-4">
                <div class="text-muted small">ยังไม่ได้ประชุมใหญ่</div>
                <div class="fw-bold text-danger" id="sumNotMet">-</div>
              </div>
            </div>
            <div class="text-center small text-muted mt-1" id="sumRange"></div>
          </div>
        </div>
      </div>

      <!-- Search and Filter -->
      <div class="row mb-3">
        <div class="col-md-4">
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" id="searchInput" class="form-control" placeholder="ค้นหาชื่อสหกรณ์...">
          </div>
        </div>
        <div class="col-md-3">
          <select id="yearFilter" class="form-select">
            <option value="">ทุกปี</option>
          </select>
        </div>
        <div class="col-md-3">
          <select id="typeFilter" class="form-select">
            <option value="">ทุกประเภท</option>
            <option value="มีงบการเงิน">มีงบการเงิน</option>
            <option value="ไม่มีงบการเงิน">ไม่มีงบการเงิน</option>
          </select>
        </div>
        <div class="col-md-2">
          <button id="clearFilters" class="btn btn-outline-secondary btn-sm w-100">
            <i class="fas fa-times me-1"></i>ล้าง
          </button>
        </div>
      </div>

      <!-- Loading Spinner -->
      <div id="loadingSpinner" class="text-center py-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>

      <!-- Table -->
      <div class="table-responsive">
        <table class="table table-hover table-striped align-middle" width="100%" cellspacing="0">
          <thead class="table-light">
            <tr>
              <th class="text-center" style="width: 60px;">#</th>
              <th>ชื่อสหกรณ์</th>
              <th class="text-center" style="width: 100px;">ปีสิ้นสุด</th>
              <th class="text-center" style="width: 120px;">ประเภท</th>
              <th class="text-center" style="width: 120px;">วันที่ประชุม</th>
              <th class="text-center" style="width: 120px;">วันที่บันทึก</th>
                    <% if (user && (user.mClass === 'kbs' || user.mClass === 'admin')) { %>

              <th class="text-center" style="width: 80px;">แก้ไข</th>
              <th class="text-center" style="width: 80px;">ลบ</th>
                    <% } %> 
            </tr>
          </thead>
          <tbody id="dataTable">
            <% if (Array.isArray(items) && items.length) { %>
              <% items.forEach(function(item, index){ %>
                <tr data-id="<%= item.big_id %>">
                  <td class="text-center">
                    <span class="badge bg-primary rounded-pill"><%= index + 1 %></span>
                  </td>
                  <td>
                    <div class="fw-bold"><%= item.c_name || item.big_code %></div>
                    <small class="text-muted">รหัส: <%= item.big_code %></small>
                  </td>
                  <td class="text-center">
                    <!-- DEBUG: end_date="<%= item.end_date %>" big_endyear="<%= item.big_endyear %>" -->
                    <% 
                      let displayEndDateBE = item.big_endyear || '-';
                      const endDayVal = item.end_day ? String(item.end_day).trim() : '';
                      
                      if (item.big_endyear && endDayVal && endDayVal.includes('-')) {
                        try {
                          // big_endyear = "2569" (พ.ศ.) -> 2026 (ค.ศ.)
                          const ceYear = parseInt(item.big_endyear) - 543;
                          // end_day = "02-28" (MM-DD)
                          // รวมเป็น "2026-02-28"
                          const isoStr = ceYear + '-' + endDayVal;
                          const dateObj = new Date(isoStr + 'T00:00:00');
                          
                          if (!isNaN(dateObj.getTime())) {
                            displayEndDateBE = dateObj.toLocaleDateString('th-TH', { 
                              day: 'numeric', month: 'long', year: 'numeric' 
                            });
                          }
                        } catch(e) { /* keep default */ }
                      }
                    %>
                    <div class="text-nowrap"><%= displayEndDateBE %></div>
                  </td>
                  <td class="text-center">
                    <% if (item.big_type === 'มีงบการเงิน') { %>
                      <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i><%= item.big_type %></span>
                    <% } else { %>
                      <span class="badge bg-warning"><i class="fas fa-times-circle me-1"></i><%= item.big_type %></span>
                    <% } %>
                  </td>
                  <td class="text-center">
                    <% 
                      let validBigDate = '-';
                      if (item.big_date) {
                        const d = new Date(item.big_date);
                        if (!isNaN(d.getTime())) validBigDate = d.toLocaleDateString('th-TH');
                      }
                    %>
                    <div><%= validBigDate %></div>
                    <small class="text-muted"><%= item.big_saveby %></small>
                  </td>
                  <td class="text-center">
                    <% 
                      let validSaveDate = '-';
                      if (item.big_savedate) {
                        const d = new Date(item.big_savedate);
                        if (!isNaN(d.getTime())) validSaveDate = d.toLocaleDateString('th-TH');
                      }
                    %>
                    <%= validSaveDate %>
                  </td>
                    <% if (user && ['kbs', 'admin'].includes(user.mClass)) { %>
                    <td class="text-center">
                      <a href="/bigmeet/edit/<%= item.big_id %>" class="btn btn-outline-warning btn-sm" title="แก้ไข">
                      <i class="fas fa-edit"></i>แก้ไข
                      </a>
                    </td>
                    <td class="text-center">
                      <button class="btn btn-outline-danger btn-sm" onclick="confirmDelete(<%= item.big_id %>)" title="ลบ">
                      <i class="fas fa-trash"></i>ลบ
                      </button>
                    </td>
                    <% } %>
                </tr>
              <% }) %>
            <% } else { %>
              <tr>
                <td colspan="8" class="text-center py-5">
                  <div class="text-muted">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <div class="h5">ไม่พบข้อมูลการประชุม</div>
                    <div>คลิก "เพิ่มข้อมูล" เพื่อเริ่มบันทึกข้อมูล</div>
                  </div>
                </td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
ess message
      <!-- Pagination -->h);
      <nav aria-label="Page navigation" class="mt-3">f (urlParams.get('success')) {
        <ul class="pagination justify-content-center" id="pagination"> showToast(urlParams.get('success') || 'ดำเนินการสำเร็จ');
          <!-- Pagination will be generated by JavaScript -->  }
        </ul>
      </nav>
    </div>
  </div>et(allItems.map(item => item.big_endyear))].sort().reverse();
</div>lter');
{
<script>eateElement('option');
// Data management
let currentPage = 1;ption.textContent = year;
const itemsPerPage = 10;   yearFilter.appendChild(option);
let allItems = <%- JSON.stringify(items || []) %>;  });
let filteredItems = [...allItems];

// User permission
const userClass = '<%= user ? user.mClass : "" %>';// Search
const canEdit = (userClass === 'kbs' || userClass === 'admin');etElementById('searchInput').addEventListener('input', filterAndRender);

// Initialize
document.addEventListener('DOMContentLoaded', function() {document.getElementById('yearFilter').addEventListener('change', filterAndRender);
  populateYearFilter();entById('typeFilter').addEventListener('change', filterAndRender);
  renderTable();
  setupEventListeners();
  tener('click', function() {
  // Show toast if there's a success message;
  const urlParams = new URLSearchParams(window.location.search);tById('yearFilter').value = '';
  if (urlParams.get('success')) {ocument.getElementById('typeFilter').value = '';
    showToast(urlParams.get('success') || 'ดำเนินการสำเร็จ');   filterAndRender();
  }  });
});

function populateYearFilter() {
  const years = [...new Set(allItems.map(item => item.big_endyear))].sort().reverse();.toLowerCase();
  const yearFilter = document.getElementById('yearFilter');const yearFilter = document.getElementById('yearFilter').value;
  years.forEach(year => {d('typeFilter').value;
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    yearFilter.appendChild(option);  (item.c_name && item.c_name.toLowerCase().includes(searchTerm)) ||
  });));
}
const matchesYear = !yearFilter || item.big_endyear === yearFilter;
function setupEventListeners() {= typeFilter;
  // Search
  document.getElementById('searchInput').addEventListener('input', filterAndRender);  return matchesSearch && matchesYear && matchesType;
  
  // Filters
  document.getElementById('yearFilter').addEventListener('change', filterAndRender); currentPage = 1;
  document.getElementById('typeFilter').addEventListener('change', filterAndRender);  renderTable();
  
  // Clear filters
  document.getElementById('clearFilters').addEventListener('click', function() {
    document.getElementById('searchInput').value = '';Table');
    document.getElementById('yearFilter').value = '';
    document.getElementById('typeFilter').value = '';const endIndex = startIndex + itemsPerPage;
    filterAndRender();ms.slice(startIndex, endIndex);
  });
}Items.length === 0) {

function filterAndRender() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const yearFilter = document.getElementById('yearFilter').value;
  const typeFilter = document.getElementById('typeFilter').value;
   class="h5">ไม่พบข้อมูลที่ตรงกับเงื่อนไข</div>
  filteredItems = allItems.filter(item => {div>ลองปรับเปลี่ยนตัวกรองหรือคำค้นหา</div>
    const matchesSearch = !searchTerm || /div>
      (item.c_name && item.c_name.toLowerCase().includes(searchTerm)) ||  </td>
      (item.big_code && item.big_code.toLowerCase().includes(searchTerm));>
    
    const matchesYear = !yearFilter || item.big_endyear === yearFilter;
    const matchesType = !typeFilter || item.big_type === typeFilter;ody.innerHTML = pageItems.map((item, index) => {
    
    return matchesSearch && matchesYear && matchesType;
  });วันที่ไทย
  let displayEndDateBE = item.big_endyear || '';
  currentPage = 1;'';
  renderTable();
}des('-')) {

function renderTable() {;
  const tbody = document.getElementById('dataTable');const isoStr = ceYear + '-' + endDayVal;
  const startIndex = (currentPage - 1) * itemsPerPage;+ 'T00:00:00');
  const endIndex = startIndex + itemsPerPage;
  const pageItems = filteredItems.slice(startIndex, endIndex);
  playEndDateBE = dateObj.toLocaleDateString('th-TH', { 
  if (pageItems.length === 0) {   day: 'numeric', month: 'long', year: 'numeric' 
    tbody.innerHTML = `
      <tr>   }
        <td colspan="8" class="text-center py-5">        } catch(e) { /* keep default */ }
          <div class="text-muted">
            <i class="fas fa-search fa-3x mb-3"></i>
            <div class="h5">ไม่พบข้อมูลที่ตรงกับเงื่อนไข</div> safely
            <div>ลองปรับเปลี่ยนตัวกรองหรือคำค้นหา</div>=> {
          </div>
        </td>const d = new Date(dStr);
      </tr>        return isNaN(d.getTime()) ? '-' : d.toLocaleDateString('th-TH');
    `;
  } else {
    tbody.innerHTML = pageItems.map((item, index) => {
      const globalIndex = startIndex + index + 1;
      lass="text-center">
      // big_endyear (พ.ศ.) + end_day (MM-DD) -> "YYYY-MM-DD" (ค.ศ.) -> วันที่ไทยpan class="badge bg-primary rounded-pill">${globalIndex}</span>
      let displayEndDateBE = item.big_endyear || '';
      const endDayVal = item.end_day ? String(item.end_day).trim() : '';
      v class="fw-bold">${item.c_name || item.big_code}</div>
      if (item.big_endyear && endDayVal && endDayVal.includes('-')) {ed">รหัส: ${item.big_code}</small>
        try {
          const ceYear = parseInt(item.big_endyear) - 543;lass="text-center">
          const isoStr = ceYear + '-' + endDayVal;p">${displayEndDateBE}</div>
          const dateObj = new Date(isoStr + 'T00:00:00');
          
          if (!isNaN(dateObj.getTime())) {
            displayEndDateBE = dateObj.toLocaleDateString('th-TH', {  ? '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>' + item.big_type + '</span>'
              day: 'numeric', month: 'long', year: 'numeric'  '<span class="badge bg-warning"><i class="fas fa-times-circle me-1"></i>' + item.big_type + '</span>'
            });
          }
        } catch(e) { /* keep default */ }
      }v>${formatLocal(item.big_date)}</div>
ed">${item.big_saveby || ''}</small>
      // Format standard dates safely
      const formatLocal = (dStr) => {lass="text-center">
        if (!dStr) return '-';al(item.big_savedate)}
        const d = new Date(dStr);
        return isNaN(d.getTime()) ? '-' : d.toLocaleDateString('th-TH');
      };
ref="/bigmeet/edit/${item.big_id}" class="btn btn-outline-warning btn-sm" title="แก้ไข">
      return `i class="fas fa-edit"></i>แก้ไข
        <tr data-id="${item.big_id}">
          <td class="text-center">
            <span class="badge bg-primary rounded-pill">${globalIndex}</span>
          </td>lass="btn btn-outline-danger btn-sm" onclick="confirmDelete(${item.big_id})" title="ลบ">
          <td>i class="fas fa-trash"></i>ลบ
            <div class="fw-bold">${item.c_name || item.big_code}</div>ton>
            <small class="text-muted">รหัส: ${item.big_code}</small>d>
          </td>  ` : ''}
          <td class="text-center">
            <div class="text-nowrap">${displayEndDateBE}</div>   `;
          </td>  }).join('');
          <td class="text-center">
            ${item.big_type === 'มีงบการเงิน'  
              ? '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>' + item.big_type + '</span>'  renderPagination();
              : '<span class="badge bg-warning"><i class="fas fa-times-circle me-1"></i>' + item.big_type + '</span>'
            }
          </td>
          <td class="text-center">const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
            <div>${formatLocal(item.big_date)}</div>ument.getElementById('pagination');
            <small class="text-muted">${item.big_saveby || ''}</small>
          </td>Pages <= 1) {
          <td class="text-center"> pagination.innerHTML = '';
            ${formatLocal(item.big_savedate)}  return;
          </td>
          ${canEdit ? `
          <td class="text-center">'';
            <a href="/bigmeet/edit/${item.big_id}" class="btn btn-outline-warning btn-sm" title="แก้ไข">
              <i class="fas fa-edit"></i>แก้ไข
            </a>
          </td>lass="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <td class="text-center">  <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">ก่อนหน้า</a>
            <button class="btn btn-outline-danger btn-sm" onclick="confirmDelete(${item.big_id})" title="ลบ">  </li>
              <i class="fas fa-trash"></i>ลบ
            </button>
          </td>
          ` : ''}1; i <= totalPages; i++) {
        </tr>= currentPage + 2)) {
      `;
    }).join('');lass="page-item ${i === currentPage ? 'active' : ''}">
  }  <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
  
  renderPagination();
} else if (i === currentPage - 3 || i === currentPage + 3) {
   html += '<li class="page-item disabled"><a class="page-link">...</a></li>';
function renderPagination() {  }
  const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
  const pagination = document.getElementById('pagination');
  
  if (totalPages <= 1) {
    pagination.innerHTML = '';lass="page-item ${currentPage === totalPages ? 'disabled' : ''}">
    return;  <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">ถัดไป</a>
  }  </li>
  
  let html = ''; 
    pagination.innerHTML = html;
  // Previous
  html += `
    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">ก่อนหน้า</a>const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
    </li>e > totalPages) return;
  `;
  
  // Page numbers renderTable();
  for (let i = 1; i <= totalPages; i++) {  window.scrollTo({ top: 0, behavior: 'smooth' });
    if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
      html += `
        <li class="page-item ${i === currentPage ? 'active' : ''}">ete(id) {
          <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>f (confirm('คุณต้องการลบข้อมูลนี้ใช่หรือไม่?')) {
        </li>   deleteItem(id);
      `;  }
    } else if (i === currentPage - 3 || i === currentPage + 3) {
      html += '<li class="page-item disabled"><a class="page-link">...</a></li>';
    }ync function deleteItem(id) {
  }oading(true);
  
  // Next
  html += `se = await fetch(`/bigmeet/delete/${id}`, {
    <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">ถัดไป</a>eaders: {
    </li> 'Content-Type': 'application/json'
  `;  }
  
  pagination.innerHTML = html;
}

function changePage(page) {allItems = allItems.filter(item => item.big_id !== id);
  const totalPages = Math.ceil(filteredItems.length / itemsPerPage);= filteredItems.filter(item => item.big_id !== id);
  if (page < 1 || page > totalPages) return;
  Table();
  currentPage = page;
  renderTable(); else {
  window.scrollTo({ top: 0, behavior: 'smooth' });or('Delete failed');
}

function confirmDelete(id) {rror('Delete error:', error);
  if (confirm('คุณต้องการลบข้อมูลนี้ใช่หรือไม่?')) {ไม่สำเร็จ กรุณาลองใหม่', 'error');
    deleteItem(id); finally {
  }   showLoading(false);
}  }

async function deleteItem(id) {
  showLoading(true);
  
  try {const toastMessage = document.getElementById('toastMessage');
    const response = await fetch(`/bigmeet/delete/${id}`, {or('.toast-body');
      method: 'POST',
      headers: {toastMessage.textContent = message;
        'Content-Type': 'application/json'ody ${type === 'success' ? 'bg-success' : 'bg-danger'} text-white`;
      }
    });toast.style.display = 'block';
    d('show');
    if (response.ok) {
      // Remove from local data
      allItems = allItems.filter(item => item.big_id !== id);
      filteredItems = filteredItems.filter(item => item.big_id !== id);ut(() => {
      .style.display = 'none';
      renderTable();   }, 300);
      showToast('ลบข้อมูลสำเร็จ');  }, 3000);
    } else {
      throw new Error('Delete failed');
    }
  } catch (error) {const spinner = document.getElementById('loadingSpinner');
    console.error('Delete error:', error); = document.querySelector('.table-responsive');
    showToast('ลบข้อมูลไม่สำเร็จ กรุณาลองใหม่', 'error');
  } finally {
    showLoading(false);r.style.display = 'block';
  }
}
 spinner.style.display = 'none';
function showToast(message, type = 'success') {   table.style.opacity = '1';
  const toast = document.getElementById('toast');
  const toastMessage = document.getElementById('toastMessage');}
  const toastBody = toast.querySelector('.toast-body');
  function initFiscalYearSummary() {















































<%- include('../partials/footer') %></script>}  }    console.error('loadFiscalYearSummary:', e);    document.getElementById('sumRange').textContent = 'โหลดสรุปไม่สำเร็จ';    document.getElementById('sumNotMet').textContent = '-';    document.getElementById('sumMet').textContent = '-';    document.getElementById('sumTotal').textContent = '-';  } catch (e) {      `ช่วงวันที่: ${fmt(d.range.start)} - ${fmt(d.range.end)}`;    document.getElementById('sumRange').textContent =    };      return isNaN(dt.getTime()) ? iso : dt.toLocaleDateString('th-TH');      const dt = new Date(iso + 'T00:00:00');    const fmt = (iso) => {    // range เป็น ค.ศ. แปลงให้เป็นไทยแบบสั้น    document.getElementById('sumNotMet').textContent = d.notMetInFiscalYear;



<%- include('../partials/footer') %></script>}  }    table.style.opacity = '1';    spinner.style.display = 'none';  } else {    table.style.opacity = '0.5';    spinner.style.display = 'block';  if (show) {    const table = document.querySelector('.table-responsive');  const spinner = document.getElementById('loadingSpinner');function showLoading(show) {}  }, 3000);    }, 300);      toast.style.display = 'none';    setTimeout(() => {    toast.classList.remove('show');  setTimeout(() => {    toast.classList.add('show');  toast.style.display = 'block';    toastBody.className = `toast-body ${type === 'success' ? 'bg-success' : 'bg-danger'} text-white`;  toastMessage.textContent = message;  const fySelect = document.getElementById('fySelect');
  if (!fySelect) return;

  // เดา FY จาก "วันนี้" (ถ้าเดือน >= ก.ย. => FY = ปีปัจจุบัน+1 (พ.ศ.))
  const now = new Date();
  const nowBE = now.getFullYear() + 543;
  const guessFY = (now.getMonth() + 1) >= 9 ? nowBE + 1 : nowBE;

  const fys = [guessFY - 1, guessFY, guessFY + 1].filter((v, i, a) => a.indexOf(v) === i);

  fySelect.innerHTML = fys.map(fy => `<option value="${fy}">${fy}</option>`).join('');
  fySelect.value = String(guessFY);

  fySelect.addEventListener('change', () => loadFiscalYearSummary(fySelect.value));
  loadFiscalYearSummary(fySelect.value);
}

async function loadFiscalYearSummary(fy) {
  try {
    const res = await fetch(`/bigmeet/summary?fy=${encodeURIComponent(fy)}`);
    const json = await res.json();
    if (!json || !json.success) throw new Error(json?.error || 'Failed');

    const d = json.data;
    document.getElementById('sumTotal').textContent = d.totalCoopsInList;
    document.getElementById('sumMet').textContent = d.metInFiscalYear;