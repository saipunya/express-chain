<%- include('../partials/header') %>

<% const targetValue = Number(kpi.kp_plan || 0); const diff = totalActual - targetValue; %>

<div class="py-4">
  <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-4">
    <div>
      <h1 class="h3 mb-1"><i class="bi bi-calendar4-week me-2"></i>รายงานผลรายเดือน</h1>
      <p class="text-muted mb-0">ตัวชี้วัด: <span class="fw-semibold"><%= kpi.kp_subject %></span> | โครงการ: <span class="badge bg-info text-dark"><%= kpi.kp_procode %></span></p>
    </div>
    <div class="mt-3 mt-lg-0">
      <a href="/plankpi<%= kpi.kp_procode ? ('?pro_code=' + encodeURIComponent(kpi.kp_procode)) : '' %>" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>ย้อนกลับรายการตัวชี้วัด
      </a>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <p class="text-uppercase text-muted small mb-1">ค่าเป้าหมายทั้งปี</p>
          <h3 class="mb-0"><%= targetValue.toLocaleString('th-TH') %> <small class="text-muted"><%= kpi.kp_unit %></small></h3>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <p class="text-uppercase text-muted small mb-1">ผลสะสมรายเดือน</p>
          <h3 class="mb-0 text-primary"><%= totalActual.toLocaleString('th-TH', { maximumFractionDigits: 2 }) %> <small class="text-muted"><%= kpi.kp_unit %></small></h3>
          <% if (achievementPercent !== null) { %>
            <span class="badge <%= achievementPercent >= 100 ? 'bg-success' : 'bg-warning text-dark' %> mt-2">
              บรรลุแล้ว <%= achievementPercent.toFixed(1) %>%
            </span>
          <% } %>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <p class="text-uppercase text-muted small mb-1">ผลต่าง (สะสม - เป้าหมาย)</p>
          <h3 class="mb-0 <%= diff >= 0 ? 'text-success' : 'text-danger' %>">
            <%= diff.toLocaleString('th-TH', { maximumFractionDigits: 2 }) %> <small class="text-muted"><%= kpi.kp_unit %></small>
          </h3>
        </div>
      </div>
    </div>
  </div>

  <form action="/plankpi/<%= kpi.kp_id %>/report" method="post" class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-light">
      <h2 class="h5 mb-0">บันทึกผลรายเดือน</h2>
    </div>
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label for="report_month" class="form-label">เดือนที่รายงาน</label>
          <input type="month" class="form-control" name="report_month" id="report_month" value="<%= currentMonth %>" max="<%= currentMonth %>" required>
        </div>
        <div class="col-md-3">
          <label for="actual_value" class="form-label">ผลงานในเดือนนี้ (<%= kpi.kp_unit %>)</label>
          <input type="number" step="0.01" min="0" class="form-control" name="actual_value" id="actual_value" placeholder="เช่น 42.5" required>
        </div>
        <div class="col-md-4">
          <label for="note" class="form-label">หมายเหตุ</label>
          <input type="text" class="form-control" name="note" id="note" placeholder="สรุปสาระสำคัญหรือแหล่งข้อมูล">
        </div>
        <div class="col-md-2 d-grid">
          <button type="submit" class="btn btn-primary">บันทึก/อัปเดต</button>
        </div>
      </div>
      <p class="text-muted small mt-3 mb-0">ระบบจะอัปเดตค่าของเดือนเดิมให้อัตโนมัติ หากมีการบันทึกซ้ำ</p>
    </div>
  </form>

  <div class="card border-0 shadow-sm">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <h2 class="h5 mb-0">ตารางผลการดำเนินงานรายเดือน</h2>
      <span class="badge bg-secondary">ทั้งหมด <%= reports.length %> รายการ</span>
    </div>
    <div class="table-responsive">
      <table class="table table-hover table-sm align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>เดือน</th>
            <th class="text-end">ผลการดำเนินงาน</th>
            <th>หมายเหตุ</th>
            <th>บันทึกโดย</th>
            <th>บันทึกเมื่อ</th>
            <th>การจัดการ</th>
          </tr>
        </thead>
        <tbody>
          <% if (!reports.length) { %>
            <tr>
              <td colspan="6" class="text-center text-muted py-4">ยังไม่มีข้อมูลรายเดือน</td>
            </tr>
          <% } else { %>
            <% reports.forEach((report) => { %>
              <% const recordedAt = report.created_at instanceof Date ? report.created_at.toISOString().slice(0, 16).replace('T', ' ') : (report.created_at ? String(report.created_at).slice(0, 16).replace('T', ' ') : '-'); %>
              <tr>
                <td>
                  <span class="fw-semibold"><%= report.month_label %></span>
                  <div class="text-muted small"><%= report.iso_month %></div>
                </td>
                <td class="text-end">
                  <span class="fw-semibold"><%= Number(report.actual_value).toLocaleString('th-TH', { maximumFractionDigits: 2 }) %></span>
                  <div class="text-muted small"><%= kpi.kp_unit %></div>
                </td>
                <td><%= report.note || '-' %></td>
                <td><%= report.created_by || '-' %></td>
                <td><%= recordedAt %></td>
                <td>
                  <form action="/plankpi/<%= kpi.kp_id %>/report/<%= report.id %>/delete" method="post" onsubmit="return confirm('ลบข้อมูลเดือนนี้?');">
                    <button type="submit" class="btn btn-sm btn-outline-danger">ลบ</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<%- include('../partials/footer') %>
