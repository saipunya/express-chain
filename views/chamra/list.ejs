<%- include('../partials/header') %>

<%
  function formatThaiDate(dateStr) {
    if (
      !dateStr ||
      dateStr === '0000-00-00' ||
      dateStr === '0000-00-00 00:00:00' ||
      dateStr === 'Invalid date'
    ) return '-';
    const d = new Date(dateStr);
    if (isNaN(d.getTime()) || d.getFullYear() < 1950) return '-';
    const months = [
      '', '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
      '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
    ];
    const day = d.getDate();
    const month = months[d.getMonth() + 1];
    const year = d.getFullYear() + 543;
    return `${day} ${month} ${year}`;
  }
  function safeDate(dateStr) {
    if (!dateStr || dateStr === '0000-00-00' || dateStr === '0000-00-00 00:00:00' || dateStr === 'Invalid date') return '';
    return dateStr;
  }
%>

<style>
  /* Layout Enhancements */
  .page-title-icon { font-size:2rem; line-height:1; background:linear-gradient(135deg,#74ebd5,#ACB6E5); -webkit-background-clip:text; color:transparent; }
  .chamra-wrapper { animation:fadeIn .4s ease; }
  @keyframes fadeIn { from { opacity:0; transform:translateY(6px);} to { opacity:1; transform:none;} }

  /* Search card */
  .search-card { border:1px solid #e3e8ef; background:#ffffff; border-radius:14px; padding:1rem 1.25rem; box-shadow:0 2px 4px rgba(0,0,0,.04); }
  .search-card h6 { font-weight:600; letter-spacing:.5px; }
  .search-input-wrapper { position:relative; }
  .search-input-wrapper .search-icon { position:absolute; top:50%; left:.75rem; transform:translateY(-50%); color:#6c757d; }
  .search-input-wrapper input { padding-left:2rem; border-radius:10px; }

  /* Table styling */
  .table-responsive { border-radius:16px; background:#ffffff; box-shadow:0 4px 18px -4px rgba(31,45,61,.08),0 8px 32px -6px rgba(31,45,61,.06); overflow:hidden; }
  .chamra-table thead th { vertical-align:middle; font-size:.75rem; text-transform:uppercase; letter-spacing:.8px; font-weight:600; }
  .chamra-table thead { position:sticky; top:0; z-index:5; }
  .chamra-table tbody tr { transition:background .25s, box-shadow .25s; }
  .chamra-table tbody tr:hover { background:#f8fbff; box-shadow:inset 0 0 0 9999px rgba(116,235,213,.08); }
  tr[data-latest-step="10"] { background:#eefdf5; }

  /* Status & badges */
  .status-pill { font-size:.6rem; letter-spacing:.5px; padding:.35rem .55rem; border-radius:30px; font-weight:500; box-shadow:0 0 0 1px rgba(255,255,255,.3); }
  .status-pill.bg-success { background:linear-gradient(135deg,#38b980,#73d99a)!important; }
  .status-pill.bg-danger { background:linear-gradient(135deg,#ff5858,#f857a6)!important; }
  .latest-step-badge { background:linear-gradient(90deg,#fdfbfb,#ebedee); font-weight:600; border:1px solid #e1e5ea; color:#374151; box-shadow:0 1px 0 rgba(0,0,0,.05); }
  td .badge + .badge { margin-left:.25rem; }

  /* Progress */
  .progress.step-progress { height:7px; border-radius:5px; overflow:hidden; background:#eef2f5; }
  .progress.step-progress .progress-bar { background:linear-gradient(90deg,#4facfe,#00f2fe); box-shadow:0 0 0 1px rgba(255,255,255,.3); }
  .progress.step-progress[data-low] .progress-bar { background:linear-gradient(90deg,#f7971e,#ffd200); }
  .progress.step-progress[data-mid] .progress-bar { background:linear-gradient(90deg,#56ab2f,#a8e063); }
  .progress.step-progress[data-high] .progress-bar { background:linear-gradient(90deg,#4facfe,#00f2fe); }

  /* Steps modal */
  .steps-modal-line { font-size:.78rem; border-left:3px solid #5fa8d3; padding:.35rem .65rem; margin-bottom:.3rem; background:#f5faff; border-radius:0 6px 6px 0; position:relative; }
  .steps-modal-line:before { content:''; position:absolute; left:-6px; top:9px; width:10px; height:10px; background:#5fa8d3; border:2px solid #fff; border-radius:50%; box-shadow:0 0 0 3px rgba(95,168,211,.25); }

  /* Buttons */
  .btn-gradient { background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; border:none; }
  .btn-gradient:hover { filter:brightness(.92); color:#fff; }
  .btn-soft { background:#eef2f7; border:1px solid #e2e8f0; }
  .btn-soft:hover { background:#e2e8f0; }

  /* Utility */
  .small-muted { font-size:.7rem; color:#6b7280; }
  .fw-semibold { font-weight:600; }
  .chamra-meta { font-size:.65rem; letter-spacing:.5px; }

  /* Responsive tweaks */
  @media (max-width: 768px) {
    .table-responsive { box-shadow:none; border-radius:8px; }
    .chamra-table thead { display:none; }
    .chamra-table tbody tr { display:block; margin-bottom:1rem; border:1px solid #e5e7eb; border-radius:12px; padding:.75rem .9rem; }
    .chamra-table tbody td { display:block; width:100%; padding:.25rem 0; }
    .chamra-table tbody td:first-child { font-weight:600; }
  }
</style>

<div class="container mt-4 chamra-wrapper">
  <div class="d-flex align-items-center mb-3 flex-wrap gap-3">
    <div class="d-flex align-items-center gap-2">
      <span class="page-title-icon">üìã</span>
      <div>
        <h2 class="mb-0 fw-bold" style="letter-spacing:.5px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h2>
        <div class="small-muted">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div>
      </div>
    </div>
    <div class="ms-auto d-flex gap-2 flex-wrap">
      <% if(user && (user.mClass === 'admin' || user.mClass === 'kjs')) { %>
        <a href="/chamra/add" class="btn btn-gradient btn-sm shadow-sm">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° Chamra</a>
        <a href="/chamra/poblem" class="btn btn-soft btn-sm">üìã ‡∏õ‡∏±‡∏ç‡∏´‡∏≤</a>
        <a href="/chamra/process" class="btn btn-soft btn-sm">üìä ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£</a>
      <% } %>
      <button id="exportChamraBtn" class="btn btn-outline-primary btn-sm">‚¨áÔ∏è Export</button>
    </div>
  </div>

  <!-- Search Section -->
  <div class="search-card mb-4">
    <form id="searchForm" class="row g-2 align-items-center" method="get" action="">
      <div class="col-md-6">
        <div class="search-input-wrapper">
          <span class="search-icon"><i class="bi bi-search"></i></span>
          <input
            type="search"
            class="form-control form-control-sm"
            id="searchInput"
            name="q"
            value="<%= typeof q !== 'undefined' ? q : '' %>"
            placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤" />
        </div>
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary btn-sm">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </div>
      <div class="col-auto">
        <a href="" id="resetSearch" class="btn btn-outline-secondary btn-sm">‡∏•‡πâ‡∏≤‡∏á</a>
      </div>
      <div class="col-12">
        <small id="searchSummary" class="text-muted"></small>
      </div>
    </form>
  </div>

  <div class="table-responsive mb-5">
    <table class="table chamra-table table-hover align-middle mb-0">
      <thead class="table-dark">
        <tr>
          <th>#</th>
          <% if(user && (user.mClass === 'admin' || user.mClass === 'kjs')) { %>
          <th>‡∏£‡∏´‡∏±‡∏™</th>
          <% } %>
          <th>‡∏ä‡∏∑‡πà‡∏≠</th>
          <th>‡∏ú‡∏π‡πâ‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
          <% if(user && user.mClass === 'kjs'){  %>
          <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          <% } %>
        </tr>
      </thead>
      <tbody>
        <%
          const isValidProcessDate = (v) => {
            if(!v) return false; if(v === '0000-00-00') return false; if(/^1899-11-30/.test(v)) return false; const d = new Date(v); if(isNaN(d.getTime())) return false; if(d.getFullYear() < 1950) return false; return true; };
        %>
        <% data.forEach((c, index) => {
            const processDates = [ c.pr_s1, c.pr_s2, c.pr_s3, c.pr_s4, c.pr_s5, c.pr_s6, c.pr_s7, c.pr_s8, c.pr_s9, c.pr_s10 ];
            let latestStepNumber = 0; let latestStepDate = '';
            for (let i = processDates.length - 1; i >= 0; i--) {
              if (isValidProcessDate(processDates[i])) { latestStepNumber = i + 1; latestStepDate = safeDate(processDates[i]); break; }
            }
            const totalSteps = 10; const percent = Math.round((latestStepNumber / totalSteps) * 100);
            let latestBadgeHtml = '<span class="text-muted small">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô</span>';
            if(latestStepNumber > 0){
              latestBadgeHtml = `\n                <span class="badge latest-step-badge text-dark">üìà ‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà ${latestStepNumber} : ${formatThaiDate(latestStepDate)}</span>`;
            }
            function showStep(label, value) { if (!isValidProcessDate(value)) return `${label}: -`; return `${label}: ${formatThaiDate(safeDate(value))}`; }
            const stepLines = processDates.map((d,i)=>showStep('S'+(i+1), d));
            let progressAttr = percent < 30 ? 'data-low' : (percent < 70 ? 'data-mid' : 'data-high');
        %>
        <tr data-latest-step="<%= latestStepNumber %>" data-search="<%= [ (c.c_name||''), (c.active_name||c.ac_name||c.coop_name||c.a_name||'') ].join(' ').toLowerCase() %>">
          <td class="text-muted small"><%= index + 1 %></td>
          <% if(user && (user.mClass === 'admin' || user.mClass === 'kjs')) { %>
          <td><span class="badge bg-secondary-subtle text-dark border" style="font-size:.7rem;">#<%= c.c_code %></span></td>
          <% } %>
          <td>
            <div class="fw-semibold mb-1"><%= c.c_name %></div>
            <% if(c.c_status === '‡∏ñ‡∏≠‡∏ô‡∏ä‡∏∑‡πà‡∏≠'){ %>
              <span class="badge status-pill bg-success">‡∏ñ‡∏≠‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß</span>
            <% } else { %>
              <span class="badge status-pill bg-danger">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span>
            <% } %>
            <div class="mt-2"><%- latestBadgeHtml %></div>
            <div class="progress step-progress mt-2" <%= progressAttr %> title="Progress <%= percent %>%">
              <div class="progress-bar" role="progressbar" style="width:<%= percent %>%" aria-valuenow="<%= percent %>" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <small class="text-muted d-block">Progress: ‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà <%= latestStepNumber %>/<%= totalSteps %> (<%= percent %>%)</small>
            <a href="/chamra/detail/<%= c.c_code %>" class="btn btn-outline-secondary btn-sm mt-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô</a>
           
          </td>
          <td><span class="small"><%= c.de_person %></span></td>
          <% if(user && user.mClass === 'kjs'){  %>
          <td>
            <div class="d-flex gap-1 flex-wrap">
              <a href="/chamra/edit/<%= c.c_code %>" class="btn btn-primary btn-sm">‚úèÔ∏è</a>
              <form action="/chamra/delete/<%= c.c_code %>" method="POST" onsubmit="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö Chamra?');">
                <button type="submit" class="btn btn-danger btn-sm">üóëÔ∏è</button>
              </form>
            </div>
          </td>
          <% } %>
        </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="stepsModal" tabindex="-1" aria-labelledby="stepsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-md">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title mb-0" id="stepsModalLabel">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="‡∏õ‡∏¥‡∏î"></button>
      </div>
      <div class="modal-body" id="stepsModalBody"></div>
      <div class="modal-footer py-2">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('searchInput');
    const summary = document.getElementById('searchSummary');
    const rows = Array.from(document.querySelectorAll('.chamra-table tbody tr'));
    const urlQ = new URLSearchParams(location.search).get('q') || '';
    if (input && !input.value) input.value = urlQ;
    const applyFilter = () => {
      const q = (input?.value || '').toLowerCase().trim();
      let visible = 0;
      rows.forEach(row => {
        const hay = row.dataset.search || '';
        const show = !q || hay.includes(q);
        row.style.display = show ? '' : 'none';
        if (show) visible++;
      });
      if (summary) {
        summary.textContent = q ? `‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ "${q}" - ‡∏û‡∏ö ${visible} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£` : `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
      }
    };
    applyFilter();
    input?.addEventListener('input', applyFilter);
    document.getElementById('resetSearch')?.addEventListener('click', (e) => {
      e.preventDefault();
      if (input) input.value = '';
      history.replaceState(null, '', location.pathname);
      applyFilter();
    });
  });

  document.addEventListener('click', e => {
    const btn = e.target.closest('.btn-show-steps');
    if (!btn) return;
    let steps = [];
    try { steps = JSON.parse(btn.dataset.steps); } catch {}
    const body = document.getElementById('stepsModalBody');
    body.innerHTML = steps.map(s => `<div class="steps-modal-line">${s}</div>`).join('') || '<div class="text-muted small">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
    document.getElementById('stepsModalLabel').textContent = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô - ${btn.dataset.code} (${btn.dataset.name})`;
    const modal = new bootstrap.Modal(document.getElementById('stepsModal'));
    modal.show();
  });

  document.getElementById('exportChamraBtn')?.addEventListener('click', async () => {
    const btn = document.getElementById('exportChamraBtn');
    btn.disabled = true; const original = btn.textContent; btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å...';
    try {
      const resp = await fetch('/chamra/export/pdf', { method: 'POST' });
      if (!resp.ok) throw new Error('Export failed');
      const blob = await resp.blob();
      const url = URL.createObjectURL(blob);
      window.open(url, '_blank');
      setTimeout(() => URL.revokeObjectURL(url), 60000);
    } catch (e) { alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ'); }
    finally { btn.disabled = false; btn.textContent = original; }
  });
</script>

<%- include('../partials/footer') %>
