<%- include('partials/header') %>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center">
    <h3 class="mb-4">üìã ‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå/‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</h3>
    <% if(user && user.mClass=='kjs'){ %> 
      <a href="/rule/upload" class="btn btn-success mb-3">
        <i class="bi bi-plus-circle"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö
      </a>
    <% } %>
  </div>

  <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
  <div class="row mb-3">
    <div class="col-md-6">
      <div class="input-group">
        <input type="text" id="searchInput" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô" value="<%= search %>">
        <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">‡∏•‡πâ‡∏≤‡∏á</button>
      </div>
    </div>
  </div>

  <% 
    // Group by c_name
    const grouped = {};
    alls.forEach(item => {
      const name = item.c_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô';
      if (!grouped[name]) grouped[name] = [];
      grouped[name].push(item);
    });

    // Sort groups by max rule_id DESC
    const sortedGroups = Object.entries(grouped).sort((a, b) => {
      const maxIdA = Math.max(...a[1].map(r => r.rule_id));
      const maxIdB = Math.max(...b[1].map(r => r.rule_id));
      return maxIdB - maxIdA;
    });

    sortedGroups.forEach(([cName, rules]) => {
  %>
    <h5 class="mt-4 text-primary"><%= cName %></h5>
    <ul class="list-group mb-3">
      <% rules
        .sort((a, b) => {
          // ‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô
          if (a.rule_type !== b.rule_type) {
            return a.rule_type === 'ER' ? 1 : -1;
          }
          // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏µ
          return a.rule_year - b.rule_year;
        })
        .forEach(rule => { 
      %>
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <% if(rule.rule_type === 'ER'){ %>
            ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡∏â‡∏ö‡∏±‡∏ö‡∏ó‡∏µ‡πà <%= rule.er_no %> ‡∏û.‡∏®. <%= rule.rule_year %>
          <% } else { %>
            ‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å ‡∏õ‡∏µ ‡∏û.‡∏®. <%= rule.rule_year %>
          <% } %>
          <div>
            <% if(!user){ %>
              <a href="/auth/login" class="btn btn-sm btn-outline-primary">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</a>
            <% } else { %>
              <a href="/rule/<%= rule.rule_id %>" class="btn btn-sm btn-outline-primary" target="_blank">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</a>
              <% if(user && user.mClass=='admin'){ %>
                <a href="/rule/delete/<%= rule.rule_id %>" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure?')">‡∏•‡∏ö</a>
              <% } %>
            <% } %>
          </div>
        </li>
      <% }) %>
    </ul>
  <% }) %>

  <!-- Pagination -->
  <nav class="mt-4">
    <ul class="pagination justify-content-center">
      <% for (let i = 1; i <= totalPages; i++) { %>
        <li class="page-item <%= currentPage === i ? 'active' : '' %>">
          <a class="page-link" href="/rule?page=<%= i %><%= search ? '&search=' + search : '' %>"><%= i %></a>
        </li>
      <% } %>
    </ul>
  </nav>
</div>

<script>
  const searchInput = document.getElementById('searchInput');
  let searchTimeout;

  searchInput.addEventListener('keyup', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      const keyword = searchInput.value.toLowerCase();
      document.querySelectorAll('h5').forEach(title => {
        const group = title.nextElementSibling; // ul
        const groupName = title.innerText.toLowerCase();
        let hasMatch = groupName.includes(keyword);

        if (!hasMatch) {
          const items = group.querySelectorAll('li');
          items.forEach(li => {
            if (li.innerText.toLowerCase().includes(keyword)) hasMatch = true;
          });
        }

        title.style.display = hasMatch ? '' : 'none';
        group.style.display = hasMatch ? '' : 'none';
      });
    }, 300);
  });

  function clearSearch() {
    searchInput.value = '';
    document.querySelectorAll('h5, ul.list-group').forEach(el => el.style.display = '');
  }
</script>

<%- include('partials/footer') %>
