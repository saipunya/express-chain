<%- include('../partials/header') %>

<div class="container my-5">

  <!-- ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ç‡πà‡∏≤‡∏ß -->
  <div class="mb-3">
    <h1 class="fw-bold display-5 mb-3"><%= article.ar_subject %></h1>
    <div class="text-muted small">
      <i class="bi bi-calendar-event"></i> <%= new Date(article.ar_savedate).toLocaleDateString('th-TH') %>
      &nbsp; | &nbsp;
      <i class="bi bi-person-circle"></i> <%= article.ar_saveby %>
    </div>
  </div>

  <!-- Hero Image -->
  <% try {
    const imgs = JSON.parse(article.ar_img || '[]');
    if(imgs.length > 0) { %>
      <figure class="mb-4 text-center">
        <img src="/uploads/article/<%= imgs[0] %>" 
             class="img-fluid rounded shadow-sm w-100" 
             alt="cover"
             style="max-height:500px;object-fit:cover;">
        <figcaption class="text-muted small mt-2">‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ç‡πà‡∏≤‡∏ß</figcaption>
      </figure>
  <% } %> <% } catch(e) {} %>

  <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ -->
  <article class="mb-5 fs-5 lh-lg">
    <%- article.ar_detail.replace(/\n/g, '<br>') %>
  </article>

  <!-- ‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û -->
  <% try {
    const imgs = JSON.parse(article.ar_img || '[]');
    if(imgs.length > 1) { %>
    <div class="mb-5">
      <h5 class="fw-bold border-bottom pb-2 mb-3">üì∏ ‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h5>
      <div class="row g-2">
        <% imgs.forEach((img, i) => { if(i > 0){ %>
          <div class="col-6 col-md-3">
            <img src="/uploads/article/<%= img %>" 
                 class="img-fluid rounded shadow-sm preview-img"
                 style="height:140px;object-fit:cover;cursor:pointer;"
                 data-img="/uploads/article/<%= img %>" 
                 data-index="<%= i %>">
          </div>
        <% } }) %>
      </div>
    </div>
  <% } } catch(e) {} %>

  <!-- ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á -->
  <div class="mb-5">
    <h5 class="fw-bold border-bottom pb-2 mb-3">üîó ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</h5>
    <% if (article.ar_link && article.ar_link !== '-') { %>
      <a href="<%= article.ar_link %>" target="_blank" class="btn btn-outline-primary">
        <i class="bi bi-link-45deg"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå
      </a>
    <% } else { %>
      <span class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</span>
    <% } %>
  </div>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ä‡∏£‡πå -->
  <div class="mb-5">
    <h6 class="fw-bold mb-3">‡πÅ‡∏ä‡∏£‡πå‡∏Ç‡πà‡∏≤‡∏ß‡∏ô‡∏µ‡πâ</h6>
    <a href="https://www.facebook.com/sharer/sharer.php?u=<%= encodeURIComponent(req.protocol + '://' + req.get('host') + req.originalUrl) %>"
       target="_blank" class="btn btn-sm btn-primary me-2">
      <i class="bi bi-facebook"></i> Facebook
    </a>
    <a href="https://twitter.com/intent/tweet?url=<%= encodeURIComponent(req.protocol + '://' + req.get('host') + req.originalUrl) %>&text=<%= encodeURIComponent(article.ar_subject) %>"
       target="_blank" class="btn btn-sm btn-info text-white me-2">
      <i class="bi bi-twitter-x"></i> Twitter
    </a>
    <a href="https://line.me/R/msg/text/?<%= encodeURIComponent(article.ar_subject + ' ' + req.protocol + '://' + req.get('host') + req.originalUrl) %>"
       target="_blank" class="btn btn-sm btn-success">
      <i class="bi bi-line"></i> LINE
    </a>
  </div>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ -->
  <div class="d-flex justify-content-end gap-2">
    <% if(user && user.mClass === 'admin'){ %>
      <a href="/article/edit/<%= article.ar_id %>" class="btn btn-warning">
        <i class="bi bi-pencil"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      </a>
    <% } %>
    <a href="/article" class="btn btn-secondary">‡∏Å‡∏•‡∏±‡∏ö</a>
  </div>
</div>

<!-- Modal ‡∏î‡∏π‡∏†‡∏≤‡∏û -->
<div class="modal fade" id="imgModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow">
      <div class="modal-body text-center p-0">
        <img id="modalImg" src="" alt="img" 
             class="w-100 rounded-top" 
             style="max-height:75vh;object-fit:contain;">
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <button id="prevImg" class="btn btn-outline-secondary">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
        <button id="nextImg" class="btn btn-outline-secondary">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
      </div>
    </div>
  </div>
</div>

<script>
  const images = Array.from(document.querySelectorAll('.preview-img'));
  let currentIndex = 0;

  function showImage(index) {
    const img = images[index];
    if (img) {
      document.getElementById('modalImg').src = img.dataset.img;
      currentIndex = index;
    }
  }

  images.forEach((img, index) => {
    img.addEventListener('click', function() {
      showImage(index);
      new bootstrap.Modal(document.getElementById('imgModal')).show();
    });
  });

  document.getElementById('prevImg').addEventListener('click', () => {
    if (currentIndex > 0) showImage(currentIndex - 1);
  });
  document.getElementById('nextImg').addEventListener('click', () => {
    if (currentIndex < images.length - 1) showImage(currentIndex + 1);
  });

  document.addEventListener('keydown', (event) => {
    if (document.getElementById('imgModal').classList.contains('show')) {
      if (event.key === 'ArrowLeft' && currentIndex > 0) showImage(currentIndex - 1);
      else if (event.key === 'ArrowRight' && currentIndex < images.length - 1) showImage(currentIndex + 1);
    }
  });
</script>

<%- include('../partials/footer') %>
