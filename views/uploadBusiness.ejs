<%- include('./partials/header') %>

<form action="/business/upload" method="POST" enctype="multipart/form-data">
  <h3 class="mt-4">ЁЯУд р╕нр╕▒р╕Юр╣Вр╕лр╕ер╕Ф</h3>
  
  <div class="mb-3">
    <label for="c_group" class="form-label">р╕Бр╕ер╕╕р╣Ир╕бр╕кр╣Ир╕Зр╕кр╕лр╕Бр╕гр╕Ур╣М</label>
    <select id="c_group" class="form-select" required>
      <option value="">++ р╣Вр╕Ыр╕гр╕Фр╣Ар╕ер╕╖р╕нр╕Б ++</option>
      <option value="group1">р╕Бр╕ер╕╕р╣Ир╕бр╕кр╣Ир╕Зр╕кр╕лр╕Бр╕гр╕Ур╣М 1</option>
      <option value="group2">р╕Бр╕ер╕╕р╣Ир╕бр╕кр╣Ир╕Зр╕кр╕лр╕Бр╕гр╕Ур╣М 2</option>
      <option value="group3">р╕Бр╕ер╕╕р╣Ир╕бр╕кр╣Ир╕Зр╕кр╕лр╕Бр╕гр╕Ур╣М 3</option>
      <option value="group4">р╕Бр╕ер╕╕р╣Ир╕бр╕кр╣Ир╕Зр╕кр╕лр╕Бр╕гр╕Ур╣М 4</option>
      <option value="group5">р╕Бр╕ер╕╕р╣Ир╕бр╕кр╣Ир╕Зр╕кр╕лр╕Бр╕гр╕Ур╣М 5</option>
    </select>
  </div>
  
  <div class="mb-3">
    <label for="bu_code" class="form-label">р╕кр╕лр╕Бр╕гр╕Ур╣М/р╕Бр╕ер╕╕р╣Ир╕бр╣Ар╕Бр╕йр╕Хр╕гр╕Бр╕г</label>
    <select name="bu_code" id="bu_code" class="form-select" required>
      <option value="">++р╣Вр╕Ыр╕гр╕Фр╣Ар╕ер╕╖р╕нр╕Б++</option>
    </select>
  </div>
  <input type="hidden" name="bu_name" id="bu_name">
  
  <div class="mb-3">
    <label for="bu_endyear" class="form-label">р╕Ыр╕╡р╕Ър╕▒р╕Нр╕Кр╕╡</label>
    <%    const nowYear = new Date().getFullYear() %>
    <select name="bu_endyear" class="form-select">
      <option value="<%= nowYear + 542 %>"><%= nowYear + 542 %></option>
        <option value="<%= nowYear + 543 %>" selected><%= nowYear + 543 %></option>
        <option value="<%= nowYear + 544 %>"><%= nowYear + 544 %></option>
    </select>
  </div>
  
  <div class="mb-3">
    <label>р╣Др╕Яр╕ер╣М PDF</label>
    <input type="file" name="file" class="form-control" required>
  </div>
  
  <button type="submit" class="btn btn-success">р╣Вр╕лр╕ер╕Ф</button>
</form>

<hr>
<h5 class="mt-5">ЁЯУВ р╣Вр╕лр╕ер╕Фр╕ер╣Ир╕▓р╕кр╕╕р╕Ф</h5>
<table class="table table-bordered">
  <thead>
    <tr>
      <th>р╕кр╕лр╕Бр╕гр╕Ур╣М/р╕Бр╕ер╕╕р╣Ир╕бр╣Ар╕Бр╕йр╕Хр╕гр╕Бр╕г</th>
      <th>р╕Ыр╕ер╕▓р╕в</th>
      <th>р╣Др╕Яр╕ер╣М</th>
      <th>р╣Вр╕лр╕ер╕Фр╣Вр╕Фр╕в</th>
      <th>р╣Ар╕бр╕╖р╣Ир╕н</th>
      <% if(user && user.mClass=='admin'){ %>
      <th>р╕ер╕Ъ</th>
      <% } %>
    </tr>
  </thead>
  <tbody>
    <% recentUploads.slice(0, 5).forEach(file => { %>
      <tr>
        <td><%= file.bu_name %></td>
        <td><%= file.bu_endyear %></td>
        <td>
          <a href="/business/download/<%= file.bu_id %>" target="_blank" class="btn btn-sm btn-outline-primary">
            ЁЯУД р╣Др╕Яр╕ер╣М
          </a>
        </td>
        <td><%= file.bu_saveby %></td>
        <td>
          <%= new Date(file.bu_savedate).toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
          }) %>
        </td>
        <% if(user && user.mClass=='admin'){ %>
        <td>
          <a href="/business/delete/<%= file.bu_id %>" class="btn btn-sm btn-outline-danger" 
             onclick="return confirm('р╣Бр╕Щр╣Ир╣Гр╕Ир╣Др╕лр╕бр╕Ир╕░р╕ер╕Ър╣Др╕Яр╕ер╣М?')">
            <i class="bi bi-trash"></i>
          </a>
        </td>
        <% } %>
      </tr>
    <% }) %>
  </tbody>
</table>

<div class="mt-4 text-end">
    <a href="/business" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
    </a>
</div>

<script>
  const cGroupSelect = document.getElementById('c_group');
  const cCodeSelect = document.getElementById('bu_code');
  const cNameInput = document.getElementById('bu_name');

  cGroupSelect.addEventListener('change', async function () {
    const group = this.value;
    cCodeSelect.innerHTML = '<option value="">р╣Вр╕лр╕ер╕Ф...</option>';

    if (!group) {
      cCodeSelect.innerHTML = '<option value="">-- р╣Ар╕ер╕╖р╕нр╕Бр╕Бр╕ер╕╕р╣Ир╕бр╕Бр╣Ир╕нр╕Щ --</option>';
      return;
    }

    try {
      const response = await fetch(`/business/coops/${group}`);
      const data = await response.json();
      
      if (Array.isArray(data) && data.length > 0) {
        cCodeSelect.innerHTML = '<option value="">-- р╣Ар╕ер╕╖р╕нр╕Бр╕кр╕лр╕Бр╕гр╕Ур╣М --</option>';
        data.forEach(coop => {
          const option = document.createElement('option');
          option.value = coop.c_code;
          option.text = coop.c_name;
          cCodeSelect.appendChild(option);
        });
      } else {
        cCodeSelect.innerHTML = '<option value="">р╣Др╕бр╣Ир╕Юр╕Ър╕кр╕лр╕Бр╕гр╕Ур╣Мр╣Гр╕Щр╕Бр╕ер╕╕р╣Ир╕б</option>';
      }
    } catch (error) {
      console.error('р╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕лр╕Бр╕гр╕Ур╣Мр╕ер╣Йр╕бр╣Ар╕лр╕ер╕з:', error);
      cCodeSelect.innerHTML = '<option value="">р╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф</option>';
    }
  });

  cCodeSelect.addEventListener('change', function () {
    const selectedOption = this.options[this.selectedIndex];
    cNameInput.value = selectedOption.text !== '-- р╣Ар╕ер╕╖р╕нр╕Бр╕кр╕лр╕Бр╕гр╕Ур╣М --' ? selectedOption.text : '';
  });
</script>

<%- include('./partials/footer') %>
