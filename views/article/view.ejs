<%- include('../partials/header') %>

<div class="container my-5">
  <!-- ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏° -->
  <div class="text-center mb-4">
    <h1 class="fw-bold display-5"><%= article.ar_subject %></h1>
    <div class="text-muted small">
      üìÖ <%= new Date(article.ar_savedate).toLocaleDateString('th-TH') %> | ‚úçÔ∏è <%= article.ar_saveby %>
    </div>
  </div>

  <!-- Hero Image (‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å) -->
  <% try {
    const imgs = JSON.parse(article.ar_img || '[]');
    if(imgs.length > 0) { %>
      <div class="mb-4 text-center">
        <img src="/uploads/article/<%= imgs[0] %>" 
             class="img-fluid rounded shadow-sm" 
             alt="cover"
             style="max-height:400px;object-fit:cover;width:100%;">
      </div>
  <% } %> <% } catch(e) {} %>

  <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î -->
  <article class="mb-5 fs-5 lh-lg">
    <%- article.ar_detail.replace(/\n/g, '<br>') %>
  </article>

  <!-- ‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏£‡∏π‡∏õ) -->
  <% try {
    const imgs = JSON.parse(article.ar_img || '[]');
    if(imgs.length > 1) { %>
    <div class="mb-5">
      <h5 class="fw-bold mb-3">üì∑ ‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ</h5>
      <div class="d-flex flex-wrap gap-2">
        <% imgs.forEach((img, i) => { if(i > 0){ %>
          <img src="/uploads/article/<%= img %>" 
               class="rounded shadow-sm border preview-img"
               style="width:160px;height:120px;object-fit:cover;cursor:pointer;"
               data-img="/uploads/article/<%= img %>" 
               data-index="<%= i %>">
        <% } }) %>
      </div>
    </div>
  <% } } catch(e) {} %>

  <!-- ‡∏•‡∏¥‡∏á‡∏Å‡πå -->
  <div class="mb-5">
    <h5 class="fw-bold mb-2">üîó ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</h5>
    <% if (article.ar_link && article.ar_link !== '-') { %>
      <a href="<%= article.ar_link %>" target="_blank" class="btn btn-outline-primary">
        <i class="bi bi-link-45deg"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå
      </a>
    <% } else { %>
      <span class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ</span>
    <% } %>
  </div>

  <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ -->
  <div class="d-flex justify-content-end gap-2">
    <% if(user && user.mClass === 'admin'){ %>
      <a href="/article/edit/<%= article.ar_id %>" class="btn btn-warning">
        <i class="bi bi-pencil"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
      </a>
    <% } %>
    <a href="/article" class="btn btn-secondary">‡∏Å‡∏•‡∏±‡∏ö</a>
  </div>
</div>

<!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û -->
<div class="modal fade" id="imgModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow">
      <div class="modal-body text-center p-0">
        <img id="modalImg" src="" alt="img" 
             class="w-100 rounded-top" 
             style="max-height:75vh;object-fit:contain;">
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <button id="prevImg" class="btn btn-outline-secondary">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
        <button id="nextImg" class="btn btn-outline-secondary">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
      </div>
    </div>
  </div>
</div>

<script>
  const images = Array.from(document.querySelectorAll('.preview-img'));
  let currentIndex = 0;

  function showImage(index) {
    const img = images[index];
    if (img) {
      document.getElementById('modalImg').src = img.dataset.img;
      currentIndex = index;
    }
  }

  images.forEach((img, index) => {
    img.addEventListener('click', function() {
      showImage(index);
      new bootstrap.Modal(document.getElementById('imgModal')).show();
    });
  });

  document.getElementById('prevImg').addEventListener('click', () => {
    if (currentIndex > 0) showImage(currentIndex - 1);
  });
  document.getElementById('nextImg').addEventListener('click', () => {
    if (currentIndex < images.length - 1) showImage(currentIndex + 1);
  });

  document.addEventListener('keydown', (event) => {
    if (document.getElementById('imgModal').classList.contains('show')) {
      if (event.key === 'ArrowLeft' && currentIndex > 0) showImage(currentIndex - 1);
      else if (event.key === 'ArrowRight' && currentIndex < images.length - 1) showImage(currentIndex + 1);
    }
  });
</script>

<%- include('../partials/footer') %>
