<%- include('../partials/header') %>
<!-- ...existing code up to the title... -->
<div class="container py-4">
  <h2 class="mb-3"><i class="bi bi-plus-lg me-2"></i> เพิ่มรายการดาวน์โหลด</h2>

  <% if (typeof error !== 'undefined' && error) { %>
    <div class="alert alert-danger"><%= error %></div>
  <% } %>

  <form action="/down/create" method="post" enctype="multipart/form-data" class="card shadow-sm">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12">
          <label for="down_subject" class="form-label">เรื่อง (จำเป็น)</label>
          <input type="text" id="down_subject" name="down_subject" class="form-control" required>
        </div>

        <!-- Replace text inputs with selects -->
        <div class="col-md-4">
          <label for="down_group" class="form-label">หมวดหมู่</label>
          <select id="down_group" name="down_group" class="form-select">
            <option value="">-- เลือกหมวดหมู่ --</option>
            <option value="kts">kts</option>
            <option value="kjs">kjs</option>
            <option value="pbt">pbt</option>
            <option value="kbs">kbs</option>
            <option value="kps">kps</option>
            <option value="admin">admin</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="down_type" class="form-label">ประเภท</label>
          <select id="down_type" name="down_type" class="form-select">
            <option value="">-- เลือกประเภท --</option>
            <option value="O">O</option>
            <option value="M">M</option>
            <option value="R">R</option>
            <option value="T">T</option>
            <option value="P">P</option>
            <option value="K">K</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="down_for" class="form-label">สำหรับ</label>
          <select id="down_for" name="down_for" class="form-select">
            <option value="">-- เลือกกลุ่มผู้ใช้ --</option>
            <option value="cpd">cpd</option>
            <option value="coop">coop</option>
            <option value="all">all</option>
          </select>
        </div>

        <!-- Toggle between File or Link -->
        <div class="col-12">
          <label class="form-label">รูปแบบข้อมูล</label>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="source_type" id="source_file" value="file" checked>
            <label class="form-check-label" for="source_file">ไฟล์</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="source_type" id="source_link" value="link">
            <label class="form-check-label" for="source_link">ลิงก์</label>
          </div>
        </div>

        <!-- File input -->
        <div class="col-md-6" id="wrap_file">
          <label for="down_file" class="form-label">อัปโหลดไฟล์</label>
          <input type="file" id="down_file" name="down_file" class="form-control"
                 accept=".pdf,.doc,.docx,.xls,.xlsx,.zip,.rar">
          <div class="form-text">รองรับ PDF/Office/ZIP ขนาดไม่เกิน 20MB</div>
        </div>

        <!-- Link input -->
        <div class="col-md-6 d-none" id="wrap_link">
          <label for="down_link" class="form-label">ลิงก์</label>
          <input type="url" id="down_link" name="down_link" class="form-control" placeholder="https://...">
          <div class="form-text">กรอกลิงก์ภายนอก หากไม่มีไฟล์แนบ</div>
        </div>

        <div class="col-md-4">
          <label for="down_savedate" class="form-label">วันที่บันทึก</label>
          <input type="date" id="down_savedate" name="down_savedate" class="form-control"
                 value="<%= new Date().toISOString().slice(0,10) %>">
        </div>

        <!-- Hidden: save by (fallback '-') -->
        <input type="hidden" name="down_saveby"
               value="<%= (user && (user.username || user.mName || user.mFullname || user.mUser)) ? (user.username || user.mName || user.mFullname || user.mUser) : '-' %>">
      </div>

      <div class="alert alert-info mt-3 py-2">
        ต้องเลือกอย่างใดอย่างหนึ่ง: ไฟล์ หรือ ลิงก์
      </div>
    </div>
    <div class="card-footer d-flex gap-2">
      <a href="/down" class="btn btn-outline-secondary">ยกเลิก</a>
      <button type="submit" class="btn btn-primary">บันทึก</button>
    </div>
  </form>
</div>
<!-- ...existing code (script + footer) ... -->
<script>
  (function() {
    const srcFile = document.getElementById('source_file');
    const srcLink = document.getElementById('source_link');
    const wrapFile = document.getElementById('wrap_file');
    const wrapLink = document.getElementById('wrap_link');
    const inFile = document.getElementById('down_file');
    const inLink = document.getElementById('down_link');

    function syncMode() {
      const useFile = srcFile.checked;
      wrapFile.classList.toggle('d-none', !useFile);
      wrapLink.classList.toggle('d-none', useFile);
      inFile.disabled = !useFile;
      inLink.disabled = useFile;
      inFile.required = useFile;
      inLink.required = !useFile;
      if (useFile) inLink.value = '';
      else inFile.value = '';
    }
    srcFile.addEventListener('change', syncMode);
    srcLink.addEventListener('change', syncMode);
    syncMode();

    // Final guard before submit
    const form = document.querySelector('form[action="/down/create"]');
    if (form) {
      form.addEventListener('submit', function(e) {
        const hasFile = inFile.files.length > 0;
        const hasLink = inLink.value.trim() !== '';
        if ((srcFile.checked && !hasFile) || (srcLink.checked && !hasLink) || (hasFile && hasLink)) {
          e.preventDefault();
          alert('กรุณาเลือกอย่างใดอย่างหนึ่ง และกรอกข้อมูลให้ครบถ้วน');
        }
      });
    }
  })();
</script>
<%- include('../partials/footer') %>
