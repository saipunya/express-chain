<%- include('./partials/header') %>

<form action="/rule/upload" method="POST" enctype="multipart/form-data">
  <h3 class="mt-4">üì§ ‡∏Ç‡πâ‡∏≠‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå/‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</h3>
  
  <div class="mb-3">
    <label for="c_group" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå</label>
    <select id="c_group" class="form-select" required>
      <option value="">++ ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ++</option>
      <option value="group1">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå 1</option>
      <option value="group2">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå 2</option>
      <option value="group3">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå 3</option>
      <option value="group4">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå 4</option>
      <option value="group5">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå 5</option>
    </select>
  </div>
  
  <div class="mb-3">
    <label for="rule_name" class="form-label">‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå/‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</label>
    <select name="rule_name" id="rule_name" class="form-select" required>
      <option value="">++‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å++</option>
    </select>
    <input type="hidden" name="rule_code" id="rule_code">
  </div>

  <script>
    const cGroupSelect = document.getElementById('c_group');
    const ruleNameSelect = document.getElementById('rule_name');
    const ruleCodeInput = document.getElementById('rule_code');

    cGroupSelect.addEventListener('change', async function () {
      const group = this.value;
      ruleNameSelect.innerHTML = '<option value="">‡πÇ‡∏´‡∏•‡∏î...</option>';

      if (!group) {
        ruleNameSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô --</option>';
        return;
      }

      try {
        console.log('Fetching coops for group:', group);
        const response = await fetch(`/rule/coops/${group}`);
        const data = await response.json();
        
        console.log('Response data:', data);

        if (Array.isArray(data) && data.length > 0) {
          ruleNameSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå --</option>';
          data.forEach(coop => {
            const option = document.createElement('option');
            option.value = coop.c_code;
            option.text = coop.c_name;
            ruleNameSelect.appendChild(option);
          });
        } else {
          ruleNameSelect.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°</option>';
        }
      } catch (error) {
        console.error('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', error);
        ruleNameSelect.innerHTML = '<option value="">‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</option>';
      }
    });

    ruleNameSelect.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      const ruleCode = selectedOption.value;
      
      ruleCodeInput.value = ruleCode;
    });
  </script>
  
  <div class="mb-3">
    <label for="rule_type" class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
    <select name="rule_type" id="rule_type" class="form-select" required>
      <option value=""> ++ ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ++</option>
      <option value="MR">‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å</option>
      <option value="ER">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</option>
    </select>
  </div>

  <!-- ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ ER ‡πÄ‡∏ó‡πà‡∏≤<|im_start|>‡πâ‡∏ô -->
  <div class="mb-3" id="er_no_div" style="display: none;">
    <label for="er_no" class="form-label">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
    <select name="er_no" class="form-select">
      <option value="" selected> ++ ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ++</option>
      <% for (let i = 2; i <= 12; i++) { %>
      <option value="‡∏â‡∏ö‡∏±‡∏ö‡∏ó‡∏µ‡πà <%= i %>"> ‡∏â‡∏ö‡∏±‡∏ö‡∏ó‡∏µ‡πà <%= i %></option>
      <% } %>
      

     
    </select>
  </div>

  <script>
  document.getElementById('rule_type').addEventListener('change', function() {
    const erNoDiv = document.getElementById('er_no_div');
    
    if (this.value === 'ER') {
      erNoDiv.style.display = 'block';
    } else {
      erNoDiv.style.display = 'none';
    }
  });
  </script>
  
  <div class="mb-3">
    <label for="rule_year" class="form-label"> ‡∏û.‡∏®.</label>
    <!-- select now year+543 , now year+543 + 1, now year+543 -1  -->
     <%   
     const nowYear = new Date().getFullYear() 
     %>
     <select name="rule_year" class="form-select">
      <option value="<%= nowYear + 542 %>"><%= nowYear + 542 %></option>
      <option value="<%= nowYear + 543 %>" selected><%= nowYear + 543 %></option>
      <option value="<%= nowYear + 544 %>"><%= nowYear + 544 %></option>
    </select>
  </div>
  
  <div class="mb-3">
    <label>‡πÑ‡∏ü‡∏•‡πå</label>
    <input type="file" name="file" class="form-control" required>
  </div>
  
  <button type="submit" class="btn btn-success">upload</button>
</form>

<hr>
<h5 class="mt-5">üìÇ ‡πÑ‡∏ü‡∏•‡πå<lemma></lemma></h5>
<table class="table table-bordered">
  <thead>
    <tr>
      <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå/‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</th>
      <th> ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
      <th>‡πÇ‡∏î‡∏¢</th>
      <th>‡πÑ‡∏ü‡∏•‡πå</th>
      <% if(user && user.mClass=='kjs'){ %>
      <th>‡∏•‡∏ö</th>
      <% } %>
    </tr>
  </thead>
  <tbody>
    <% recentUploads.forEach(rule => { %>
      <tr>
        <td><%= rule.rule_name %></td>
        <td><%= rule.rule_type == 'ER' ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' + rule.er_no + ' ‡∏û.‡∏®.' : '‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å ‡∏û.‡∏®.'  %><%= rule.rule_year %></td>
        <td><%= rule.rule_saveby %></td>
        <td>
          <a href="/rule/<%= rule.rule_id %>" class="btn btn-sm btn-outline-primary" target="_blank">
            <lemma></lemma>‡πÑ‡∏ü‡∏•‡πå
          </a>
        </td>   
        <!-- delete button -->
        <% if(user && user.mClass=='kjs'){ %>
        <td>
       
           <a href="/rule/delete/<%= rule.rule_id %>" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure?')">
            <i class="bi bi-trash"></i>
          </a>
          
        </td>
        <% } %>
      </tr>
    <% }) %>
  </tbody>
</table>

<%- include('./partials/footer') %>
