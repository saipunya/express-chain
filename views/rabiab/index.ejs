<%- include('../partials/header') %>

<style>
  /* Modern enhancements specific to this page */
  .glass-card {background: rgba(255,255,255,0.85); backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 4px 16px rgba(0,0,0,0.08); border-radius: 18px;}
  .section-title {font-weight:600; letter-spacing:.5px; display:flex; align-items:center; gap:.6rem;}
  .section-title i {color:#0d6efd;}
  .search-wrapper .form-control {border-radius: 14px !important;}
  .search-wrapper .input-group > :not(:first-child):not(.dropdown-menu) {margin-left: .5rem;}
  .search-badge {font-size:.75rem; background:linear-gradient(135deg,#6366f1,#3b82f6);}
  .badge-new {background: linear-gradient(135deg,#ff7b39,#ffb347); color:#fff; font-size:.65rem; padding:.3rem .55rem; border-radius: 30px; font-weight:600; position:relative; top:-2px;}
  .table thead th {background:#f5f7fb; border-bottom:2px solid #e3e7ef; font-weight:600; text-transform:uppercase; font-size:.7rem; letter-spacing:.05em;}
  .table-hover tbody tr:hover {background:#f0f6ff;}
  .result-meta {font-size:.8rem; color:#6b7280;}
  .action-group .btn {border-radius: 30px; padding: .35rem .85rem;}
  .pagination .page-link {border:none; margin:0 .25rem; border-radius:10px !important; box-shadow:0 2px 4px rgba(0,0,0,0.05);}  
  .pagination .page-item.active .page-link {background:linear-gradient(135deg,#2563eb,#3b82f6); box-shadow:0 4px 10px -2px rgba(37,99,235,.4);} 
  .fade-in {animation: fadeIn .4s ease;}
  @keyframes fadeIn {from {opacity:0; transform: translateY(4px);} to {opacity:1; transform: translateY(0);} }
  .table td {vertical-align: middle;}
  .search-pill {background:#eef2ff; color:#4f46e5; font-size:.65rem; padding:.2rem .55rem; border-radius:20px; margin-right:.4rem;}

  /* Embed mode: hide global chrome and page controls when embedded */
  html.embedded body { background: transparent; }
  html.embedded body > header,
  html.embedded body > nav.navbar,
  html.embedded body > footer,
  html.embedded .site-footer,
  html.embedded .app-footer { display: none !important; }
  html.embedded .glass-card.p-4.mb-4,          /* top title card */
  html.embedded .search-wrapper,               /* search card */
  html.embedded nav[aria-label="Pagination"] { display: none !important; }
</style>

<div class="container py-4 fade-in">
  <div class="glass-card p-4 mb-4">
    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
      <div class="d-flex align-items-center gap-2">
        <h2 class="section-title m-0"><i class="fas fa-scroll"></i> ระเบียบสหกรณ์ / กลุ่มเกษตรกร</h2>
      </div>
      <% if(user && user.mClass === 'kjs') { %>
        <a href="/rabiab/upload" class="btn btn-primary d-flex align-items-center gap-2" style="border-radius:14px;">
          <i class="fas fa-cloud-upload-alt"></i>
          <span>อัปโหลดระเบียบ</span>
        </a>
      <% } %>
    </div>
  </div>

  <!-- Search / Filter Card -->
  <div class="glass-card p-3 p-md-4 mb-4 search-wrapper">
    <form class="row g-3 align-items-end" method="GET" action="">
      <div class="col-md-4">
        <label for="searchName" class="form-label small text-uppercase fw-semibold text-secondary">ชื่อระเบียบ</label>
        <div class="input-group">
          <span class="input-group-text bg-white border-0"><i class="fas fa-file-alt text-primary"></i></span>
          <input type="text" id="searchName" name="searchName" class="form-control shadow-sm" placeholder="พิมพ์ชื่อระเบียบ..." value="<%= searchName || '' %>">
        </div>
      </div>
      <div class="col-md-4">
        <label for="searchCoop" class="form-label small text-uppercase fw-semibold text-secondary">ชื่อสหกรณ์</label>
        <div class="input-group">
          <span class="input-group-text bg-white border-0"><i class="fas fa-warehouse text-primary"></i></span>
            <input type="text" id="searchCoop" name="searchCoop" class="form-control shadow-sm" placeholder="พิมพ์ชื่อสหกรณ์..." value="<%= searchCoop || '' %>">
        </div>
      </div>
      <div class="col-md-4 d-flex gap-2">
        <button class="btn btn-gradient btn-primary flex-grow-1" type="submit" style="border-radius:14px;">
          <i class="fas fa-search"></i> ค้นหา
        </button>
        <a class="btn btn-outline-secondary" style="border-radius:14px;" href="/rabiab"><i class="fas fa-undo"></i></a>
      </div>

      <% if (searchName || searchCoop) { %>
        <div class="col-12">
          <div class="d-flex flex-wrap align-items-center small">
            <span class="me-2 text-secondary">ตัวกรอง:</span>
            <% if (searchName) { %><span class="search-pill"><i class="fas fa-file-alt me-1"></i><%= searchName %></span><% } %>
            <% if (searchCoop) { %><span class="search-pill"><i class="fas fa-warehouse me-1"></i><%= searchCoop %></span><% } %>
            <a href="/rabiab" class="ms-auto small text-decoration-none text-danger"><i class="fas fa-times-circle"></i> ล้างตัวกรอง</a>
          </div>
        </div>
      <% } %>
    </form>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="result-meta">
      แสดง <strong><%= rabiabs.length %></strong> รายการ ในหน้านี้
      <% if (searchName || searchCoop) { %>
        (ผลการค้นหา)
      <% } %>
    </div>
  </div>

  <!-- Table -->
  <div class="table-responsive glass-card p-0 mb-4">
    <table class="table table-hover table-nowrap m-0">
      <thead>
        <tr>
          <th style="min-width:260px;">ชื่อระเบียบ</th>
          <th style="width:140px;">อนุมัติ</th>
          <% if(user) { %><th style="min-width:200px;" class="text-center">การจัดการ</th><% } %>
        </tr>
      </thead>
      <tbody id="rabiabTable">
        <% if (rabiabs.length === 0) { %>
          <tr>
            <td colspan="3" class="text-center py-5 text-muted">
              <i class="far fa-folder-open fa-2x mb-3 d-block"></i>
              ไม่พบข้อมูล
            </td>
          </tr>
        <% } %>
        <% rabiabs.forEach((rabiab) => { %>
          <tr>
            <td>
              <div class="fw-semibold text-dark"><%= rabiab.ra_name %></div>
              <div class="small text-secondary d-flex align-items-center gap-2 flex-wrap">
                <span><i class="fas fa-warehouse me-1 text-primary"></i><strong><%= rabiab.c_name %></strong></span>
                <% 
                  const rabiabSavedDate = new Date(rabiab.ra_savedate);
                  const currentDate = new Date();
                  const diffDays = Math.ceil((currentDate - rabiabSavedDate) / (1000 * 60 * 60 * 24));
                %>
                <% if (diffDays <= 7) { %>
                  <span class="badge-new"><i class="fas fa-star me-1"></i>NEW</span>
                <% } %>
              </div>
            </td>
            <td>
              <span class="badge bg-light text-dark border" style="font-weight:500;">
                <i class="far fa-calendar-check text-success me-1"></i>
                <%= new Date(rabiab.ra_approvedate).toLocaleDateString('th-TH') %>
              </span>
            </td>
            <% if(user) { %>
            <td class="text-center action-group">
              <div class="d-inline-flex gap-2">
                <a href="/rabiab/download/<%= rabiab.ra_id %>" class="btn btn-sm btn-outline-primary" target="_blank" data-bs-toggle="tooltip" title="ดาวน์โหลด">
                  <i class="fas fa-download"></i>
                </a>
                <% if(user && user.mClass === 'admin') { %>
                  <form method="POST" action="/rabiab/delete/<%= rabiab.ra_id %>" class="d-inline" onsubmit="return confirm('ต้องการลบระเบียบนี้ ? ไฟล์จะถูกลบออกจากระบบด้วย')">
                    <button type="submit" class="btn btn-sm btn-outline-danger" data-bs-toggle="tooltip" title="ลบ">
                      <i class="fas fa-trash"></i>
                    </button>
                  </form>
                <% } %>
              </div>
            </td>
            <% } else { %>
              <td class="text-center">
                <a href="/auth/login" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" title="เข้าสู่ระบบเพื่อดาวน์โหลด">
                  <i class="fas fa-lock"></i>
                </a>
              </td>
            <% } %>
          </tr>
        <% }); %>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <% if (totalPages > 1) { %>
    <nav aria-label="Pagination" class="mb-4">
      <ul class="pagination justify-content-center flex-wrap">
        <% for (let i = 1; i <= totalPages; i++) { %>
          <li class="page-item <%= currentPage === i ? 'active' : '' %>">
            <a class="page-link" href="?page=<%= i %><%= searchName ? '&searchName=' + encodeURIComponent(searchName) : '' %><%= searchCoop ? '&searchCoop=' + encodeURIComponent(searchCoop) : '' %>"><%= i %></a>
          </li>
        <% } %>
      </ul>
    </nav>
  <% } %>
</div>

<script>
  // Optional: initialize Bootstrap tooltips
  document.addEventListener('DOMContentLoaded', () => {
    if (window.bootstrap) {
      document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
    }
  });
</script>
<script src="/js/rabiab-search.js"></script>
<script>
// Embed mode for homepage preview
(function(){
  const params = new URLSearchParams(window.location.search);
  const isEmbed = params.get('embed') === '1';
  if(!isEmbed) return;

  document.documentElement.classList.add('embedded');
  const limit = Math.max(1, parseInt(params.get('limit') || '5', 10));

  // Trim table to latest N rows
  const tbody = document.getElementById('rabiabTable');
  if (tbody) {
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.slice(limit).forEach(tr => tr.remove());
  }

  // Add compact title and "ดูทั้งหมด" link
  const container = document.querySelector('.container');
  if (container) {
    const title = document.createElement('div');
    title.className = 'mb-3';
    title.innerHTML = '<h5 class="m-0"><i class="fas fa-scroll text-primary me-2"></i>ระเบียบล่าสุด</h5>';
    container.insertBefore(title, container.firstChild);

    const more = document.createElement('div');
    more.className = 'text-end mt-2';
    more.innerHTML = '<a href="/rabiab" class="small text-decoration-none">ดูทั้งหมด</a>';
    container.appendChild(more);
  }

  // Auto-resize iframe height
  const embedId = params.get('embedId') || 'rabiab';
  const postHeight = () => {
    const h = document.body.scrollHeight;
    try { window.parent.postMessage({ type: 'resize-embed', id: embedId, height: h }, '*'); } catch(_) {}
  };
  postHeight();
  if ('ResizeObserver' in window) new ResizeObserver(postHeight).observe(document.body);
  window.addEventListener('load', postHeight);
})();
</script>
<%- include('../partials/footer') %>

