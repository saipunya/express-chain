<%- include('../partials/header') %>
<div class="container py-4">
  <style>
    /* Responsive enhancements specific to this page */
    @media (max-width: 575.98px) {
      .quick-stats .card {border-radius: .85rem;}
      .quick-stats .card-body {padding:.65rem .65rem;}
      .quick-stats .stat-label {font-size:.62rem; letter-spacing:.5px; text-transform:uppercase;}
      .quick-stats .stat-value {font-size:1rem;}
      .table thead th.small-hide, .table tbody td.small-hide {display:none;} /* Hide less important columns */
      .table thead th, .table tbody td {font-size:.72rem;}
      .card-header h5 {font-size:.9rem;}
      .badge {font-size:.6rem;}
      .mobile-scroll {overflow-x:auto; -webkit-overflow-scrolling:touch;}
      .section-block {margin-top: 1rem;}
    }
    @media (min-width:576px) and (max-width: 767.98px) {
      .quick-stats .stat-label {font-size:.7rem;}
      .quick-stats .stat-value {font-size:1.05rem;}
    }

    /* Stacked section layout */
    .section-block {scroll-margin-top: 80px;}
    .section-title {display:flex; align-items:center; gap:.5rem; margin: .75rem 0; color: var(--bs-secondary-color);}    

    /* Subtle card hover */
    .quick-stats .card{transition: transform .15s ease, box-shadow .15s ease;}
    .quick-stats .card:hover{transform: translateY(-2px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.08)!important;}

    /* Responsive stacked tables */
    @media (max-width: 575.98px) {
      .responsive-table thead {display: none;}
      .responsive-table tbody tr {display: grid; grid-template-columns: 1fr 1fr; gap: .35rem .75rem; padding: .5rem .75rem;}
      .responsive-table tbody td {display: flex; justify-content: space-between; align-items: center; border: none !important; padding: .25rem 0;}
      .responsive-table tbody tr + tr {border-top: 1px solid var(--bs-border-color);}
      .responsive-table tbody td::before {content: attr(data-label); font-size: .72rem; color: var(--bs-secondary-color); margin-right: .75rem;}
      .responsive-table tbody td.row-actions {grid-column: 1 / -1; justify-content: flex-end;}
    }
  </style>
  <% if (!data || !data.coop) { %>
    <div class="alert alert-danger shadow-sm">ไม่พบข้อมูล</div>
  <% } else { %>
    <!-- Header Section -->
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-4">
      <div>
        <h1 class="h4 mb-0"><i class="bi bi-building me-2 text-secondary"></i><%= data.coop.c_name %> <small class="text-muted">(<%= data.coop.c_code %>)</small></h1>
      </div>
      <div class="text-md-end small">
        <span class="badge rounded-pill bg-info-subtle text-info-emphasis me-1"><i class="bi bi-diagram-3 me-1"></i><%= data.coop.c_group || 'ไม่ระบุ' %></span>
        <span class="badge rounded-pill bg-warning-subtle text-warning-emphasis me-1"><i class="bi bi-layers me-1"></i><%= data.coop.coop_group || data.coop.c_type || 'ไม่ระบุ' %></span>
        <span class="badge rounded-pill <%= (data.coop.c_status||'')==='ดำเนินการ' ? 'bg-success-subtle text-success-emphasis' : 'bg-secondary-subtle text-secondary-emphasis' %>"><i class="bi bi-activity me-1"></i><%= data.coop.c_status || 'ไม่ระบุ' %></span>
      </div>
    </div>

    <!-- Personnel and Fiscal Year Information Cards -->
    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex align-items-start gap-2">
              <i class="bi bi-person-badge fs-5 text-primary mt-1"></i>
              <div class="flex-grow-1">
                <p class="text-muted small mb-1">เจ้าหน้าที่ส่งเสริมสหกรณ์ (1)</p>
                <div class="fw-semibold"><%= data.coop.c_person || '-' %></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex align-items-start gap-2">
              <i class="bi bi-person-badge fs-5 text-info mt-1"></i>
              <div class="flex-grow-1">
                <p class="text-muted small mb-1">เจ้าหน้าที่ส่งเสริมสหกรณ์ (2)</p>
                <div class="fw-semibold"><%= data.coop.c_person2 || '-' %></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex align-items-start gap-2">
              <i class="bi bi-calendar-event fs-5 text-success mt-1"></i>
              <div class="flex-grow-1">
                <p class="text-muted small mb-1">วันสิ้นปีบัญชี</p>
                <div class="fw-semibold">
                    <% if (data.coop.end_date) { %>
                    <%= data.coop.end_date %>
                    <% } else { %>
                    ไม่ระบุ
                    <% } %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="row g-3 mb-4 quick-stats">
      <div class="col-6 col-sm-4 col-lg-2 active">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body py-3">
            <div class="stat-label text-muted mb-1">ผลความเข้มแข็ง (ปี)</div>
            <div class="fw-bold stat-value text-danger"><%= [...new Set((data.strength||[]).map(s=>s.st_year))].length %></div>
          </div>
        </div>
      </div>
      <div class="col-6 col-sm-4 col-lg-2">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body py-3">
            <div class="stat-label text-muted mb-1">รายงานกิจการประจำปี</div>
            <div class="fw-bold stat-value text-success"><%= (data.business||[]).length %></div>
          </div>
        </div>
      </div>
      <div class="col-6 col-sm-4 col-lg-2">
        <div class="card border-0 shadow-sm h-100 bg-gradient" style="--bs-bg-opacity:.08;">
          <div class="card-body py-3">
            <div class="stat-label text-muted mb-1">จำนวนไฟล์การเงิน</div>
            <div class="fw-bold stat-value text-primary"><%= (data.finance||[]).length %></div>
          </div>
        </div>
      </div>
      <div class="col-6 col-sm-4 col-lg-2">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body py-3">
            <div class="stat-label text-muted mb-1">ข้อบังคับ</div>
            <div class="fw-bold stat-value text-warning"><%= (data.rules||[]).length %></div>
          </div>
        </div>
      </div>
      <div class="col-6 col-sm-4 col-lg-2">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body py-3">
            <div class="stat-label text-muted mb-1">วงเงินกู้ยืม/ค้ำประกัน</div>
            <div class="fw-bold stat-value text-danger"><%= (data.vong||[]).length %></div>
          </div>
        </div>
      </div>
      <div class="col-6 col-sm-4 col-lg-2">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body py-3">
            <div class="stat-label text-muted mb-1">RQ2</div>
            <div class="fw-bold stat-value text-info"><%= (data.rq2||[]).length %></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Strength Section -->
    <section class="section-block" id="strength-section">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-transparent d-flex flex-wrap align-items-center justify-content-between py-2 gap-2">
          <h5 class="card-title mb-0 fw-semibold"><i class="bi bi-graph-up-arrow me-2 text-info"></i>ผลประเมินความเข้มแข็ง (Strength)</h5>
          <span class="badge bg-info-subtle text-info-emphasis">รวม <%= (data.strength||[]).length %> แถว</span>
        </div>
        <div class="card-body p-0 mobile-scroll">
          <% if (data.strength && data.strength.length) { %>
            <div class="table-responsive mb-0">
              <table class="table table-sm table-hover table-striped align-middle mb-0 text-nowrap responsive-table">
                <thead class="table-light">
                  <tr>
                    <th>ปี</th>
                    <th>สถาบัน</th>
                    <th class="small-hide">เกณฑ์ข้อที่ 1</th>
                    <th class="small-hide">เกณฑ์ข้อที่ 2</th>
                    <th class="small-hide">เกณฑ์ข้อที่ 3</th>
                    <th class="small-hide">เกณฑ์ข้อที่ 4</th>
                    <th>รวม</th>
                    <th>ระดับ</th>
                  </tr>
                </thead>
                <tbody>
                  <% data.strength.forEach(s => { %>
                    <tr>
                      <td class="fw-medium" data-label="ปี"><%= s.st_year || '-' %></td>
                      <td data-label="สถาบัน"><%= s.st_fullname || '-' %></td>
                      <% if(!user) { %>
                        <td colspan="5" class="text-muted small">ข้อมูลไม่สามารถแสดงได้ กรุณาเข้าสู่ระบบ</td>
                      <% } else { %>
                        <td class="small-hide" data-label="เกณฑ์ข้อที่ 1"><%= s.st_no1 || '-' %></td>
                        <td class="small-hide" data-label="เกณฑ์ข้อที่ 2"><%= s.st_no2 || '-' %></td>
                        <td class="small-hide" data-label="เกณฑ์ข้อที่ 3"><%= s.st_no3 || '-' %></td>
                        <td class="small-hide" data-label="เกณฑ์ข้อที่ 4"><%= s.st_no4 || '-' %></td>
                        <td data-label="รวม"><%= (s.st_point !== null && s.st_point !== undefined && !isNaN(Number(s.st_point))) ? Number(s.st_point).toLocaleString('th-TH',{minimumFractionDigits:2}) : '-' %></td>
                      <% } %>
                      <td data-label="ระดับ">
                        <% if (s.st_grade) { %>
                          <span class="p-2 badge bg-<%= s.st_grade==='ชั้น1' ? 'success' : (s.st_grade==='ชั้น2' ? 'warning' : (s.st_grade==='ชั้น3' ? 'danger text-white' : 'secondary')) %>"><%= s.st_grade %></span>
                        <% } else { %>-<% } %>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <div class="p-4 text-center text-muted">ไม่มีข้อมูล</div>
          <% } %>
        </div>
      </div>
    </section>

    <!-- Finance and Business Sections (2 columns) -->
    <div class="row my-2">
      <div class="col-md-6">
        <!-- Finance Section -->
        <section class="section-block" id="finance-section">
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-transparent d-flex flex-wrap align-items-center justify-content-between py-2 gap-2">
              <h5 class="card-title mb-0 fw-semibold"><i class="bi bi-cash-stack me-2 text-primary"></i>ข้อมูลการเงิน</h5>
              <span class="badge bg-primary-subtle text-primary-emphasis">รวม <%= (data.finance||[]).length %> รายการ</span>
            </div>
            <div class="card-body p-0">
              <% if (data.finance && data.finance.length) { %>
                <div class="table-responsive">
                  <table class="table table-sm table-hover table-striped align-middle mb-0 responsive-table">
                    <thead class="table-light">
                      <tr>
                        <th style="width:120px">ปี</th>
                        <th class="text-center" style="width:80px">ไฟล์</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% data.finance.forEach(f => { %>
                        <tr>
                          <td class="fw-medium" data-label="ปี"><%= f.end_year || '-' %></td>
                          <td class="text-center row-actions" data-label="ไฟล์">
                            <% if (user) { %>
                              <% if (f.id) { %>
                                <a class="btn btn-sm btn-outline-primary" href="/finance/download/<%= f.id %>" target="_blank" aria-label="ดาวน์โหลดไฟล์การเงินปี <%= f.end_year %>"><i class="bi bi-download"></i></a>
                              <% } else if (f.link_file) { %>
                                <a class="btn btn-sm btn-outline-secondary" href="<%= f.link_file %>" target="_blank" rel="noopener" aria-label="เปิดไฟล์ภายนอกการเงินปี <%= f.end_year %>"><i class="bi bi-box-arrow-up-right"></i></a>
                              <% } else { %>-<% } %>
                            <% } else { %>
                              <span class="text-muted" title="เข้าสู่ระบบเพื่อดาวน์โหลด"><i class="bi bi-lock-fill"></i></span>
                            <% } %>
                          </td>
                        </tr>
                      <% }) %>
                    </tbody>
                  </table>
                </div>
              <% } else { %>
                <div class="p-4 text-center text-muted">ไม่มีข้อมูล</div>
              <% } %>
            </div>
          </div>
        </section>
      </div>
      <div class="col-md-6">
        <!-- Business Section -->
        <section class="section-block" id="business-section">
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-transparent d-flex flex-wrap align-items-center justify-content-between py-2 gap-2">
              <h5 class="card-title mb-0 fw-semibold"><i class="bi bi-briefcase me-2 text-success"></i>ข้อมูลธุรกิจ</h5>
              <span class="badge bg-success-subtle text-success-emphasis">รวม <%= (data.business||[]).length %> รายการ</span>
            </div>
            <div class="card-body p-0">
              <% if (data.business && data.business.length) { %>
                <div class="table-responsive">
                  <table class="table table-sm table-hover table-striped align-middle mb-0 responsive-table">
                    <thead class="table-light">
                      <tr>
                        <th style="width:120px">ปี</th>
                        <th class="text-center" style="width:80px">ไฟล์</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% data.business.forEach(b => { %>
                        <tr>
                          <td class="fw-medium" data-label="ปี"><%= b.bu_endyear || '-' %></td>
                          <td class="text-center row-actions" data-label="ไฟล์">
                            <% if (user) { %>
                              <% if (b.bu_id) { %>
                                <a class="btn btn-sm btn-outline-success" href="/business/download/<%= b.bu_id %>" target="_blank" aria-label="ดาวน์โหลดไฟล์ธุรกิจปี <%= b.bu_endyear %>"><i class="bi bi-download"></i></a>
                              <% } else if (b.bu_filename) { %>
                                <a class="btn btn-sm btn-outline-secondary" href="/uploads/business/<%= b.bu_filename %>" target="_blank" rel="noopener" aria-label="เปิดไฟล์ภายนอกธุรกิจปี <%= b.bu_endyear %>"><i class="bi bi-box-arrow-up-right"></i></a>
                              <% } else { %>-<% } %>
                            <% } else { %>
                              <span class="text-muted" title="เข้าสู่ระบบเพื่อดาวน์โหลด"><i class="bi bi-lock-fill"></i></span>
                            <% } %>
                          </td>
                        </tr>
                      <% }) %>
                    </tbody>
                  </table>
                </div>
              <% } else { %>
                <div class="p-4 text-center text-muted">ไม่มีข้อมูล</div>
              <% } %>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- Rules Section -->
    <section class="section-block" id="rules-section">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-transparent d-flex flex-wrap align-items-center justify-content-between py-2 gap-2">
          <h5 class="card-title mb-0 fw-semibold"><i class="bi bi-journal-text me-2 text-warning"></i>ข้อบังคับ</h5>
          <span class="badge bg-warning-subtle text-warning-emphasis">รวม <%= (data.rules||[]).length %> รายการ</span>
        </div>
        <div class="card-body p-0">
          <% if (data.rules && data.rules.length) { %>
            <div class="table-responsive">
              <table class="table table-sm table-hover table-striped align-middle mb-0 responsive-table">
                <thead class="table-light">
                  <tr>
                    <th style="width:120px">ปี</th>
                    <th>ประเภท</th>
                    <th class="text-center" style="width:80px">ไฟล์</th>
                  </tr>
                </thead>
                <tbody>
                  <% data.rules.forEach(r => { %>
                    <tr>
                      <td class="fw-medium" data-label="ปี"><%= r.rule_year || '-' %></td>
                      <td data-label="ประเภท">
                        <% if (r.rule_type === 'MR') { %>
                          <span class="badge bg-primary-subtle text-primary-emphasis">ข้อบังคับหลัก</span>
                        <% } else if (r.rule_type === 'ER') { %>
                          <span class="badge bg-secondary-subtle text-secondary-emphasis">แก้ไขเพิ่มเติม <%= r.er_no || '' %></span>
                        <% } %>
                      </td>
                      <td class="text-center row-actions" data-label="ไฟล์">
                        <% if (user) { %>
                          <% if (r.rule_id) { %>
                            <a class="btn btn-sm btn-outline-warning" href="/rule/<%= r.rule_id %>" target="_blank" aria-label="ดาวน์โหลดข้อบังคับปี <%= r.rule_year %>"><i class="bi bi-download"></i></a>
                          <% } else if (r.rule_file) { %>
                            <a class="btn btn-sm btn-outline-secondary" href="/uploads/rule/<%= r.rule_file %>" target="_blank" rel="noopener" aria-label="เปิดไฟล์ข้อบังคับปี <%= r.rule_year %>"><i class="bi bi-box-arrow-up-right"></i></a>
                          <% } else { %>-<% } %>
                        <% } else { %>
                          <span class="text-muted" title="เข้าสู่ระบบเพื่อดาวน์โหลด"><i class="bi bi-lock-fill"></i></span>
                        <% } %>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <div class="p-4 text-center text-muted">ไม่มีข้อมูล</div>
          <% } %>
        </div>
      </div>
    </section>

    <!-- Rabiab Section -->
    <section class="section-block" id="rabiab-section">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-transparent d-flex flex-wrap align-items-center justify-content-between py-2 gap-2">
          <h5 class="card-title mb-0 fw-semibold"><i class="bi bi-file-earmark-medical me-2 text-secondary"></i>ระเบียบ (Rabiab)</h5>
          <span class="badge bg-secondary-subtle text-secondary-emphasis">รวม <%= (data.rabiab||[]).length %> รายการ</span>
        </div>
        <div class="card-body p-0">
          <% if (data.rabiab && data.rabiab.length) { %>
            <div class="table-responsive">
              <table class="table table-sm table-hover table-striped align-middle mb-0 responsive-table">
                <thead class="table-light">
                  <tr>
                    <th style="width:100px">ปี</th>
                    <th>ชื่อ</th>
                    <th>วันที่อนุมัติ</th>
                    <th class="text-center" style="width:80px">ไฟล์</th>
                  </tr>
                </thead>
                <tbody>
                  <% data.rabiab.forEach(r => { %>
                    <tr>
                      <td class="fw-medium" data-label="ปี"><%= r.ra_year || '-' %></td>
                      <td data-label="ชื่อ"><%= r.ra_name || '-' %></td>
                      <td data-label="วันที่อนุมัติ"><%= r.ra_approvedate ? new Date(r.ra_approvedate).toLocaleDateString('th-TH') : '-' %></td>
                      <td class="text-center row-actions" data-label="ไฟล์">
                        <% if (user) { %>
                          <% if (r.ra_id) { %>
                            <a class="btn btn-sm btn-outline-secondary" href="/rabiab/download/<%= r.ra_id %>" target="_blank" aria-label="ดาวน์โหลดระเบียบปี <%= r.ra_year %>"><i class="bi bi-download"></i></a>
                          <% } else if (r.ra_filename) { %>
                            <a class="btn btn-sm btn-outline-secondary" href="/uploads/rabiab/<%= r.ra_filename %>" target="_blank" rel="noopener" aria-label="เปิดไฟล์ระเบียบปี <%= r.ra_year %>"><i class="bi bi-box-arrow-up-right"></i></a>
                          <% } else { %>-<% } %>
                        <% } else { %>
                          <span class="text-muted" title="เข้าสู่ระบบเพื่อดาวน์โหลด"><i class="bi bi-lock-fill"></i></span>
                        <% } %>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <div class="p-4 text-center text-muted">ไม่มีข้อมูล</div>
          <% } %>
        </div>
      </div>
    </section>

    <!-- Vong Section -->
    <section class="section-block" id="vong-section">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-transparent d-flex flex-wrap align-items-center justify-content-between py-2 gap-2">
          <h5 class="card-title mb-0 fw-semibold"><i class="bi bi-piggy-bank me-2 text-danger"></i>วงเงินกู้ยืม/ค้ำประกัน</h5>
          <span class="badge bg-danger-subtle text-danger-emphasis">รวม <%= (data.vong||[]).length %> รายการ</span>
        </div>
        <div class="card-body p-0">
          <% if (data.vong && data.vong.length) { %>
            <div class="table-responsive">
              <table class="table table-sm table-hover table-striped align-middle mb-0 responsive-table">
                <thead class="table-light">
                  <tr>
                    <th style="width:100px">ปี</th>
                    <th>จำนวนเงิน</th>
                    <th class="small-hide">จำนวนเงิน (ข้อความ)</th>
                    <th class="text-center" style="width:80px">ไฟล์</th>
                  </tr>
                </thead>
                <tbody>
                  <% data.vong.forEach(v => { %>
                    <tr>
                      <td class="fw-medium" data-label="ปี"><%= v.vong_year || '-' %></td>
                      <td data-label="จำนวนเงิน">
                        <% if(!user) { %>
                          <span class="text-muted" title="เข้าสู่ระบบเพื่อดูจำนวนเงิน"><i class="bi bi-lock-fill"></i></span>
                        <% } else { %>
                          <%= (v.vong_money !== null && v.vong_money !== undefined && !isNaN(Number(v.vong_money))) ? Number(v.vong_money).toLocaleString('th-TH',{minimumFractionDigits:2}) : '-' %>
                        <% } %>
                      </td>
                      <td class="text-muted small-hide" data-label="จำนวนเงิน (ข้อความ)">
                        <% if(!user) { %>
                          <span class="text-muted" title="เข้าสู่ระบบเพื่อดูจำนวนเงิน"><i class="bi bi-lock-fill"></i></span>
                        <% } else { %>
                          <small><%= v.vong_money ? bahtText(v.vong_money) : '-' %></small>
                        <% } %>
                      </td>
                      <td class="text-center row-actions" data-label="ไฟล์">
                        <% if (user) { %>
                          <% if (v.vong_id) { %>
                            <a class="btn btn-sm btn-outline-danger" href="/vong/download/<%= v.vong_id %>" target="_blank" aria-label="ดาวน์โหลดวงเงินปี <%= v.vong_year %>"><i class="bi bi-download"></i></a>
                          <% } else if (v.vong_filename) { %>
                            <a class="btn btn-sm btn-outline-secondary" href="/uploads/vong/<%= v.vong_filename %>" target="_blank" rel="noopener" aria-label="เปิดไฟล์วงเงินปี <%= v.vong_year %>"><i class="bi bi-box-arrow-up-right"></i></a>
                          <% } else { %>-<% } %>
                        <% } else { %>
                          <span class="text-muted" title="เข้าสู่ระบบเพื่อดาวน์โหลด"><i class="bi bi-lock-fill"></i></span>
                        <% } %>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <div class="p-4 text-center text-muted">ไม่มีข้อมูล</div>
          <% } %>
        </div>
      </div>
    </section>

    <!-- RQ2 Section -->
    <section class="section-block" id="rq2-section">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-transparent d-flex flex-wrap align-items-center justify-content-between py-2 gap-2">
          <h5 class="card-title mb-0 fw-semibold"><i class="bi bi-collection me-2 text-info"></i>RQ2</h5>
          <span class="badge bg-info-subtle text-info-emphasis">รวม <%= (data.rq2||[]).length %> รายการ</span>
        </div>
        <div class="card-body p-0">
          <% if (data.rq2 && data.rq2.length) { %>
            <div class="table-responsive">
              <table class="table table-sm table-hover table-striped align-middle mb-0 text-nowrap responsive-table">
                <thead class="table-light">
                  <tr>
                    <th style="width:100px">ปี</th>
                    <th>ชื่อ</th>
                    <th class="text-center" style="width:80px">ไฟล์</th>
                  </tr>
                </thead>
                <tbody>
                  <% data.rq2.forEach(r => { %>
                    <tr>
                      <td class="fw-medium" data-label="ปี"><%= r.rq_year || '-' %></td>
                      <td data-label="ชื่อ"><%= r.rq_name || '-' %></td>
                      <td class="text-center row-actions" data-label="ไฟล์">
                        <% if (user) { %>
                          <% if (r.rq_id) { %>
                            <a class="btn btn-sm btn-outline-info" href="/rq2/download/<%= r.rq_id %>" target="_blank" aria-label="ดาวน์โหลด RQ2 ปี <%= r.rq_year %>"><i class="bi bi-download"></i></a>
                          <% } else if (r.rq_file) { %>
                            <a class="btn btn-sm btn-outline-secondary" href="/uploads/rq2/<%= r.rq_file %>" target="_blank" rel="noopener" aria-label="เปิดไฟล์ RQ2 ปี <%= r.rq_year %>"><i class="bi bi-box-arrow-up-right"></i></a>
                          <% } else { %>-<% } %>
                        <% } else { %>
                          <span class="text-muted" title="เข้าสู่ระบบเพื่อดาวน์โหลด"><i class="bi bi-lock-fill"></i></span>
                        <% } %>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <div class="p-4 text-center text-muted">ไม่มีข้อมูล</div>
          <% } %>
        </div>
      </div>
    </section>

    <!-- Assets Section -->
    <section class="section-block" id="assets-section">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-transparent d-flex flex-wrap align-items-center justify-content-between py-2 gap-2">
          <h5 class="card-title mb-0 fw-semibold"><i class="bi bi-gear-wide-connected me-2 text-secondary"></i>ทรัพย์สิน/ครุภัณฑ์ (cooperatives_assets)</h5>
          <span class="badge bg-secondary-subtle text-secondary-emphasis">รวม <%= (data.assets||[]).length %> รายการ</span>
        </div>
        <div class="card-body p-0">
          <% if (data.assets && data.assets.length) { %>
            <div class="table-responsive">
              <table class="table table-sm table-hover table-striped align-middle mb-0 text-nowrap responsive-table">
                <thead class="table-light">
                  <tr>
                    <th>หมวดหมู่</th>
                    <th>เครื่อง/อุปกรณ์</th>
                    <th style="width:140px">จำนวน</th>
                    <th class="small-hide" style="width:160px">สมรรถนะ</th>
                    <th style="width:120px">สถานะ</th>
                    <th style="width:120px">อัพเดต</th>
                    <th class="text-end" style="width:110px">ดูข้อมูล</th>
                  </tr>
                </thead>
                <tbody>
                  <% data.assets.forEach(a => { %>
                    <tr>
                      <td data-label="หมวดหมู่"><%= a.category || '-' %></td>
                      <td data-label="เครื่อง/อุปกรณ์"><%= a.machine_type || '-' %></td>
                      <td data-label="จำนวน">
                        <% if (a.quantity !== null && a.quantity !== undefined && !isNaN(Number(a.quantity))) { %>
                          <%= Number(a.quantity).toLocaleString('th-TH', { maximumFractionDigits: 2 }) %>
                        <% } else { %> - <% } %>
                        <span class="text-muted"><%= a.quantity_unit || '' %></span>
                      </td>
                      <td class="small-hide" data-label="สมรรถนะ">
                        <% if (a.capacity_value) { %>
                          <%= a.capacity_value %> <span class="text-muted"><%= a.capacity_unit || '' %></span>
                        <% } else { %> - <% } %>
                      </td>
                      <td data-label="สถานะ">
                        <span class="badge rounded-pill bg-<%= (a.status==='ใช้งานไม่ได้' ? 'danger' : 'success') %>"><%= a.status || '-' %></span>
                      </td>
                      <td data-label="อัพเดต">
                        <% if (a.updated_date) { %>
                          <%= new Date(a.updated_date).toLocaleDateString('th-TH') %>
                        <% } else { %> - <% } %>
                      </td>
                      <td class="text-end row-actions" data-label="ดูข้อมูล">
                        <button type="button" class="btn btn-sm btn-outline-secondary btn-view-asset" data-id="<%= a.id %>"><i class="bi bi-eye"></i> ดูข้อมูล</button>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <div class="p-4 text-center text-muted">ไม่มีข้อมูล</div>
          <% } %>
        </div>
      </div>
    </section>
  <% } %>
  <div class="mt-2">
    <a href="/allCoop/group" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-left"></i> ย้อนกลับ</a>
  </div>
</div>
<%- include('../partials/footer') %>

<!-- Asset Detail Modal -->
<div class="modal fade" id="assetModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-gear-wide-connected me-2 text-secondary"></i>รายละเอียดทรัพย์สิน/ครุภัณฑ์</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-2 mb-2 small text-muted">
          <div class="col-md-6"><strong>สถาบัน:</strong> <span id="am-coop_name" class="fs-6">-</span></div>
          <div class="col-md-6"><strong>หมวดหมู่:</strong> <span id="am-category">-</span></div>
        </div>
        <div class="row g-2 mb-2">
          <div class="col-md-6"><strong>เครื่อง/อุปกรณ์:</strong> <span id="am-machine_type" class="badge text-bg-pink-subtle" style="--bs-badge-font-size: .9rem; background:#fde3f2; color:#a60d64;">-</span></div>
          <div class="col-md-6"><strong>รายละเอียด:</strong> <span id="am-description">-</span></div>
        </div>
        <div class="row g-2 mb-2 small">
          <div class="col-md-4"><strong>จำนวน:</strong> <span id="am-quantity">-</span> <span class="text-muted" id="am-quantity_unit"></span></div>
          <div class="col-md-4"><strong>สมรรถนะ:</strong> <span id="am-capacity_value">-</span> <span class="text-muted" id="am-capacity_unit"></span></div>
          <div class="col-md-4"><strong>สถานะ:</strong> <span id="am-status">-</span></div>
        </div>
        <hr/>
        <div class="row g-2 mb-2 small">
          <div class="col-md-4"><strong>ปี (พ.ศ.):</strong> <span id="am-year_be">-</span></div>
          <div class="col-md-4"><strong>พืช/สินค้า:</strong> <span id="am-crop">-</span></div>
          <div class="col-md-4"><strong>สเปค:</strong> <span id="am-spec">-</span></div>
        </div>
        <div class="row g-2 mb-2 small">
          <div class="col-md-4"><strong>งบรวม:</strong> <span id="am-price_total">-</span></div>
          <div class="col-md-4"><strong>งบสนับสนุน:</strong> <span id="am-price_support">-</span></div>
          <div class="col-md-4"><strong>เงินสหกรณ์:</strong> <span id="am-price_coop">-</span></div>
        </div>
        <div class="mb-2 small"><strong>โครงการ:</strong> <span id="am-project">-</span></div>
        <div class="mb-2 small"><strong>หมายเหตุ:</strong> <span id="am-remark">-</span></div>
        <hr/>
        <div class="row g-2 mb-2 small text-muted">
          <div class="col-12"><strong>ที่อยู่:</strong> <span id="am-address">-</span></div>
          <div class="col-md-6"><strong>ผู้ติดต่อ:</strong> <span id="am-contact">-</span></div>
          <div class="col-md-6"><strong>พิกัด:</strong> <span id="am-geo">-</span> <a id="am-map" class="ms-1" target="_blank" rel="noopener"></a></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
      </div>
    </div>
  </div>
</div>

<!-- Server-rendered assets JSON for client-side use -->
<script id="assets-json" type="application/json"><%- JSON.stringify(data.assets || []) %></script>

<script>
  // Build asset map for quick lookup without EJS inside JS
  try {
    window.ASSETS = JSON.parse(document.getElementById('assets-json')?.textContent || '[]');
  } catch(e) { window.ASSETS = []; }
  window.ASSET_MAP = Object.fromEntries((window.ASSETS || []).map(function(a){ return [String(a.id), a]; }));
  function fmtNumber(n){
    const num = Number(n);
    return isNaN(num) ? '-' : num.toLocaleString('th-TH', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
  }
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.btn-view-asset');
    if(!btn) return;
    const id = btn.getAttribute('data-id');
    const a = ASSET_MAP[id];
    if(!a) return;
    const $ = (id)=>document.getElementById(id);
    // Basic fields
    $('am-coop_name').textContent = a.coop_name || '-';
    $('am-category').textContent = a.category || '-';
    $('am-machine_type').textContent = a.machine_type || '-';
    $('am-description').textContent = a.description || '-';
    // Quantities/capacity
    $('am-quantity').textContent = (a.quantity!==null && a.quantity!==undefined) ? fmtNumber(a.quantity) : '-';
    $('am-quantity_unit').textContent = a.quantity_unit || '';
    $('am-capacity_value').textContent = (a.capacity_value || a.capacity_value===0) ? a.capacity_value : '-';
    $('am-capacity_unit').textContent = a.capacity_unit || '';
    $('am-status').textContent = a.status || '-';
    // Other specs
    $('am-year_be').textContent = a.year_be || '-';
    $('am-crop').textContent = a.crop || '-';
    $('am-spec').textContent = a.spec_value ? (a.spec_value + ' ' + (a.spec_unit||'')) : '-';
    $('am-project').textContent = a.project || '-';
    $('am-remark').textContent = a.remark || '-';
    // Prices
    $('am-price_total').textContent = a.price_total ? Number(a.price_total).toLocaleString('th-TH',{minimumFractionDigits:2}) : '-';
    $('am-price_support').textContent = a.price_support ? Number(a.price_support).toLocaleString('th-TH',{minimumFractionDigits:2}) : '-';
    $('am-price_coop').textContent = a.price_coop ? Number(a.price_coop).toLocaleString('th-TH',{minimumFractionDigits:2}) : '-';
    // Coop and address
    const addr = [a.address, a.subdistrict, a.district, a.province, a.postcode].filter(Boolean).join(' ');
    $('am-address').textContent = addr || '-';
    $('am-contact').textContent = [a.contact_name, a.contact_phone].filter(Boolean).join(' / ') || '-';
    // Geolocation
    if (a.latitude && a.longitude) {
      $('am-geo').textContent = `${a.latitude}, ${a.longitude}`;
      const map = $('am-map');
      map.textContent = '(เปิดแผนที่)';
      map.href = `https://www.google.com/maps?q=${a.latitude},${a.longitude}`;
    } else {
      $('am-geo').textContent = '-';
      const map = $('am-map');
      map.textContent = '';
      map.removeAttribute('href');
    }
    // Show modal
    const modalEl = document.getElementById('assetModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
  });
</script>