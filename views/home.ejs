<%- include('partials/header',{title : 'ระบบสารสนเทศและเครือข่ายสหกรณ์ในจังหวัดภูมิ' }) %>

<!-- Added: Required Chart.js + plugin (fix graphs not showing) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<!-- ================= Modern Global Styles (Refactored) ================ -->
<style>
  :root {
    --color-bg: #f5f7fa;
    --color-surface: #ffffff;
    --color-border: #e2e8f0;
    --color-text: #1e293b;
    --color-muted: #64748b;
    --color-accent: #0d9488;
    --color-accent-grad: linear-gradient(135deg,#0f766e,#0d9488,#0ea5e9);
    --color-focus: #2563eb;
    --radius-sm: .5rem;
    --radius: 1rem;
    --radius-lg: 1.5rem;
    --shadow-sm: 0 4px 10px -2px rgba(0,0,0,.08);
    --shadow: 0 8px 24px -6px rgba(0,0,0,.16);
    --shadow-hover: 0 14px 38px -8px rgba(0,0,0,.28);
    --glass: rgba(255,255,255,0.68);
    --grad-accent: linear-gradient(90deg,#2563eb,#6366f1,#8b5cf6);
    --transition: .4s cubic-bezier(.4,.2,.2,1);
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --color-bg: #0f172a;
      --color-surface: #1e293b;
      --color-border: #334155;
      --color-text: #e2e8f0;
      --color-muted: #94a3b8;
      --glass: rgba(30,41,59,0.75);
      --shadow-sm: 0 4px 10px -2px rgba(0,0,0,.55);
      --shadow: 0 8px 28px -6px rgba(0,0,0,.65);
      --shadow-hover: 0 16px 44px -10px rgba(0,0,0,.85);
    }
    .modern-card, .hero-shell { border:1px solid var(--color-border); }
    .quick-nav a { color: var(--color-muted); }
    .quick-nav a.active { color: #fff; }
  }

  body { background: var(--color-bg); color: var(--color-text); }

  /* Hero */
  .hero-shell {
    background: var(--color-accent-grad);
    border-radius: var(--radius-lg);
    overflow: hidden;
    position: relative;
    box-shadow: var(--shadow);
    min-height: 360px;
  }
  .hero-shell:before {
    content:"";
    position:absolute; inset:0;
    background:
      radial-gradient(circle at 22% 30%,rgba(255,255,255,.35),transparent 60%),
      radial-gradient(circle at 75% 70%,rgba(255,255,255,.25),transparent 65%);
    mix-blend-mode: overlay;
    pointer-events:none;
  }
  .hero-img-wrap {
    position:relative;
    height:100%;
  }
  .hero-img-wrap img {
    object-fit:cover;
    width:100%; height:100%;
    aspect-ratio: 4/3;
  }
  @media (min-width: 992px){
    .hero-img-wrap img { aspect-ratio: unset; }
  }
  .glass-pane {
    background: #b0b5bd;
    backdrop-filter: blur(18px) saturate(160%);
    -webkit-backdrop-filter: blur(18px) saturate(160%);
  }

  /* Hero image full cover override (added) */
  .hero-img-wrap { min-height:360px; }
  .hero-img-wrap > img.hero-cover-img {
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
  }

  /* Cards / Sections */
  .modern-card {
    border:0;
    border-radius: var(--radius);
    background: var(--color-surface);
    box-shadow: var(--shadow-sm);
    transition: var(--transition);
    position:relative;
  }
  .modern-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-hover);
  }
  .card-gradient-bar {
    position:absolute; top:0; left:0; width:100%; height:4px;
    background:var(--grad-accent); opacity:.85;
    border-top-left-radius:inherit;
    border-top-right-radius:inherit;
  }

  /* Section layout */
  .section-block {
    padding-block: 2.2rem;
  }
  .section-block.compact { padding-block: 1.4rem; }
  .section-heading {
    font-weight:700;
    letter-spacing:.6px;
    display:inline-flex;
    align-items:center;
    gap:.55rem;
    position:relative;
    margin-bottom:1.25rem;
  }
  .section-heading:after {
    content:"";
    height:3px;
    width:60%;
    background: var(--grad-accent);
    position:absolute;
    left:50%; bottom:-6px;
    transform:translateX(-50%);
    border-radius:3px;
  }

  /* Lists */
  .list-group-item {
    border:0;
    border-bottom:1px solid var(--color-border);
    background:transparent;
  }
  .list-group-item:last-child { border-bottom:0; }

  /* Quick Nav */
  .quick-nav-wrapper {
    margin-top:-1rem;
    margin-bottom:1.5rem;
  }
  .quick-nav {
    display:flex;
    gap:.5rem;
    overflow-x:auto;
    scrollbar-width:none;
    padding:.75rem 1rem;
    background: var(--color-surface);
    border:1px solid var(--color-border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-sm);
  }
  .quick-nav::-webkit-scrollbar { display:none; }
  .quick-nav a {
    white-space:nowrap;
    font-size:.85rem;
    padding:.55rem .95rem;
    border-radius: 2rem;
    text-decoration:none;
    background:linear-gradient(135deg,#f1f5f9,#e2e8f0);
    color:#334155;
    border:1px solid #dbe1e7;
    transition:.25s;
    display:inline-flex;
    align-items:center;
    gap:.35rem;
  }
  .quick-nav a:hover { background:#e2e8f0; }
  .quick-nav a.active {
    background:var(--color-accent-grad);
    color:#fff;
    border-color:transparent;
    box-shadow:0 4px 14px -4px rgba(13,148,136,.5);
  }

  /* Animations */
  .reveal {
    opacity:0;
    transform:translateY(22px);
    transition: .85s cubic-bezier(.16,.8,.28,.96);
  }
  .reveal.in {
    opacity:1;
    transform:none;
  }

  .soft-badge {
    background:linear-gradient(135deg,#f1f5f9,#e2e8f0);
    color:#334155;
    border:1px solid #cbd5e1;
    font-weight:500;
  }

  .activity-list li {
    position:relative;
    padding-left:1.4rem;
  }
  .activity-list li:before {
    content:"";
    position:absolute;
    left:.35rem;
    top:1.05rem;
    width:7px; height:7px;
    border-radius:50%;
    background:var(--color-accent);
    box-shadow:0 0 0 4px rgba(13,148,136,.15);
  }

  /* Utility */
  .text-gradient {
    background:var(--grad-accent);
    background-clip:text; /* added standard property */
    -webkit-background-clip:text;
    color:transparent;
  }
  .shadow-focus:focus-visible {
    outline:2px solid var(--color-focus);
    outline-offset:2px;
  }
  .divider {
    height:1px;
    background:var(--color-border);
    margin:1.5rem 0;
  }

  @media (max-width: 575.98px) {
    .hero-shell { min-height: auto; }
    .section-heading { font-size:1.15rem; }
  }

  /* Extra polish */
  .table-hover tbody tr:hover { background:#f1f5f9; }
  .modern-card .card-header { border-top-left-radius:inherit; border-top-right-radius:inherit; }
  .section-title { position:relative; }
  .section-title:after { content:""; position:absolute; left:50%; transform:translateX(-50%); bottom:-10px; width:72px; height:4px; background:var(--grad-accent); border-radius:2px; opacity:.9; }
  .back-to-top { position:fixed; right:1.25rem; bottom:1.25rem; z-index:1040; width:46px; height:46px; display:flex; align-items:center; justify-content:center; border-radius:50%; background:var(--grad-accent); color:#fff; box-shadow:0 6px 20px -4px rgba(0,0,0,.35); border:0; opacity:0; visibility:hidden; transition:.4s; }
  .back-to-top.show { opacity:1; visibility:visible; }
  .back-to-top:focus-visible { outline:3px solid #fff; outline-offset:2px; }
  .badge { letter-spacing:.3px; }
  .hp-badge { font-size:.65rem; }
</style>

<!-- Added: Light theme & contrast fixes -->
<style>
  /* Force light theme to avoid unreadable dark auto-scheme */
  @media (prefers-color-scheme: dark) {
    :root {
      --color-bg:#ffffff !important;
      --color-surface:#ffffff !important;
      --color-text:#1e293b !important;
      --color-border:#e2e8f0 !important;
    }
    body { background:#ffffff !important; color:#1e293b !important; }
  }
  body { background:#ffffff !important; color:#1e293b !important; }

  /* Ensure primary containers stay light */
  .hero-shell,
  .modern-card,
  .quick-nav,
  .card,
  .table,
  .table thead th,
  .table tbody td {
    background:#ffffff !important;
  }

  /* Text visibility */
  .text-dark,
  .card .text-dark,
  .table,
  .table td,
  .table th { color:#1e293b !important; }

  /* Table borders / striping */
  .table-bordered> :not(caption)>* { border-color:#dbe3ea !important; }
  .table thead th { background:#f1f5f9 !important; font-weight:600; }
  .table-striped>tbody>tr:nth-of-type(odd){
    --bs-table-accent-bg:#f8fafc;
    background:#f8fafc;
  }

  /* Chamra status badges readability */
  .hp-badge { font-size:.7rem; letter-spacing:.3px; }

  /* Badges general contrast */
  .badge.bg-secondary { background:#64748b !important; }
  .badge.bg-success { background:#15803d !important; }
  .badge.bg-info { background:#0284c7 !important; }
  .badge.bg-warning { background:#d97706 !important; color:#fff !important; }

  /* Quick nav active clarity */
  .quick-nav a { color:#334155 !important; }
  .quick-nav a.active { color:#fff !important; }

  /* Remove any accidental dark backgrounds from Bootstrap utilities */
  [class*="bg-dark"] { background:#1e293b !important; }
</style>

<%
// Helper: map backend c_group codes to readable Thai names
function displayGroupName(code){
  switch(code){
    case 'group1': return 'กลุ่มส่งเสริมสหกรณ์ 1';
    case 'group2': return 'กลุ่มส่งเสริมสหกรณ์ 2';
    case 'group3': return 'กลุ่มส่งเสริมสหกรณ์ 3';
    case 'group4': return 'กลุ่มส่งเสริมสหกรณ์ 4';
    case 'group5': return 'กลุ่มส่งเสริมสหกรณ์ 5';
    default: return code || '-';
  }
}
%>

<!-- ================= Hero ================= -->
<div class="container my-5 reveal" id="top">
  <div class="hero-shell">
    <div class="row g-0 h-100">
       
      <div class="col-md-6 hero-img-wrap p-0 position-relative">
        <img
          src="https://cdn.pixabay.com/photo/2024/03/26/11/14/ai-generated-8656542_1280.jpg"
          alt="Coop Image"
          class="hero-cover-img"
          loading="lazy"
        />
      </div>
      <div class="col-md-6 glass-pane d-flex align-items-center p-md-4">
        <% if (!user) { %>
          <div class="w-100">
            <p class="lead mb-4 text-center">ระบบสารสนเทศและเครือข่ายสหกรณ์ฯ</p>

            <h5 class="text-center mb-3">🔐 เข้าระบบ</h5>
            <form action="/auth/login" method="POST">
              <div class="mb-3">
                <label for="username" class="form-label">ชื่อผู้ใช้งาน</label>
                <input type="text" class="form-control" id="username" name="username" required />
              </div>
              <div class="mb-3">
                <label for="password" class="form-label">รหัสผ่าน</label>
                <input type="password" class="form-control" id="password" name="password" required />
              </div>
              <button type="submit" class="btn btn-success w-100">เข้าระบบ</button>
            </form>

            <p class="text-center mt-2">
              <i class="bi bi-person-add"></i> ยังไม่มีบัญชี ?
              <a href="/auth/register" class="text-success">
                สมัครสมาชิก
              </a>
            </p>
          </div>
        <% } else { %>
          <div class="w-100 text-center">
            <h1 class="display-6 mb-3 text-success">ยินดีต้อนรับ!</h1>
            <img src="<%= user.m_img %>" alt="User Image" class="rounded-circle mb-3" width="100">
            <p class="lead mb-4">
              <%= user.fullname %>
            </p>
            <a href="/dashboard" class="btn btn-success me-2">แดชบอร์ด</a>
            <% if(user && (user.mClass==='kjs' || user.mClass==='admin')) { %>
              <a href="/account/list" class="btn btn-outline-secondary me-2">เงินกลุ่ม กจส.</a>
              <a href="/chamra" class="btn btn-outline-secondary me-2">ชำระบัญชี</a>
            <% } %>
            <a href="/auth/logout" class="btn btn-outline-secondary">ออกจากระบบ</a>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- ================= Quick Navigation ================= -->
<div class="container quick-nav-wrapper reveal" aria-label="Quick section navigation">
  <nav class="quick-nav" id="quickNav">
    <a href="#stats"><i class="bi bi-collection"></i>สถิติ</a>
    <a href="#charts"><i class="bi bi-bar-chart"></i>กราฟ</a>
    <a href="#groups"><i class="bi bi-diagram-3"></i>กลุ่ม</a>
    <a href="#members"><i class="bi bi-people"></i>สมาชิก</a>
    <a href="#activities"><i class="bi bi-calendar-event"></i>กิจกรรม</a>
    <a href="#finance"><i class="bi bi-cash-coin"></i>งบการเงิน</a>
    <a href="#business"><i class="bi bi-briefcase"></i>กิจการ</a>
    <a href="#rules"><i class="bi bi-file-earmark-text"></i>ข้อบังคับ</a>
    <a href="#rabiab"><i class="bi bi-file-earmark"></i>ระเบียบ</a>
    <a href="#projects"><i class="bi bi-file-earmark-pdf"></i>โครงการ</a>
    <a href="#commands"><i class="bi bi-megaphone"></i>คำสั่ง</a>
    <a href="#chamra"><i class="bi bi-activity"></i>ชำระบัญชี</a>
    <a href="#downloads"><i class="bi bi-download"></i>Top DL</a>
    <a href="#rq2"><i class="bi bi-file-earmark-ruled"></i>RQ2</a>
    <a href="#articles"><i class="bi bi-journal-text"></i>บทความ</a>
    <a href="#usecar"><i class="bi bi-car-front"></i>ใช้รถ</a>
    <a href="#online"><i class="bi bi-wifi"></i>ออนไลน์</a>
  </nav>
</div>

<!-- ================= Stats ================= -->
<section id="stats" class="section-block pt-0">
  <div class="container">
    <h2 class="my-3 text-center text-primary section-title">📊 ข้อมูลสหกรณ์</h2>
    <div class="row">
      <div class="col-md-4">
        <div class="card modern-card shadow-sm border-0">
          <div class="card-gradient-bar"></div>
          <div class="card-body text-center">
            <h5 class="card-title">จำนวนสหกรณ์</h5>
            <p class="card-text display-6 text-success">
              <%= stats.coop + ' แห่ง' %>
            </p>
            <span class="d-block">
              <a class="btn btn-sm btn-outline-success" data-bs-toggle="tooltip" data-bs-placement="top" href="/activeCoop/by-end-date" 
                title="สหกรณ์ที่จดทะเบียนกับกรมส่งเสริมสหกรณ์">
                <i class="bi bi-info-circle" style="cursor: pointer;"></i>
                รายละเอียด
              </a>
            </span>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card modern-card shadow-sm border-0">
          <div class="card-gradient-bar"></div>
          <div class="card-body text-center">
            <h5 class="card-title">จำนวนกลุ่มเกษตรกร</h5>
            <p class="card-text display-6 text-info">
              <%= stats.farmer + ' แห่ง' %>
            </p>
            <span class="d-block">
              <a class="btn btn-sm btn-outline-success" data-bs-toggle="tooltip" data-bs-placement="top" href="/activeCoop/by-end-date" 
                title="ข้อมูลเพิ่มเติมเกี่ยวกับกลุ่มเกษตรกร">
                <i class="bi bi-info-circle" style="cursor: pointer;"></i>
                รายละเอียด
              </a>
            </span>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card modern-card shadow-sm border-0">
          <div class="card-gradient-bar"></div>
          <div class="card-body text-center">
            <h5 class="card-title">อยู่ระหว่างชำระบัญชี</h5>
            <p class="card-text display-6 text-warning">
              <%= stats.closing + ' แห่ง' %>
            </p>
            <span class="d-block">
              <a href="/chamra"><button class="btn btn-sm btn-outline-warning" data-bs-toggle="tooltip" data-bs-placement="top"
                title="สหกรณ์/กลุ่มเกษตรกรที่อยู่ระหว่างการชำระบัญชี">
                <i class="bi bi-info-circle" style="cursor: pointer;"></i>
                รายละเอียด
              </button></a>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ================= Charts ================= -->
<section id="charts" class="section-block bg-white">
  <div class="container-lg">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="card modern-card shadow-sm border-0 mb-4">
          <div class="card-gradient-bar"></div>
          <div class="card-body">
            <h4 class="mb-4 text-center text-primary">
              <i class="bi bi-bar-chart-fill me-2"></i> กราฟแสดงจำนวนสหกรณ์/กลุ่มเกษตรกร
            </h4>
            <canvas id="coopChart" height="120"></canvas>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card modern-card shadow-sm border-0 mb-4">
          <div class="card-gradient-bar"></div>
          <div class="card-body">
            <h4 class="mb-4 text-center text-primary">
              <i class="bi bi-pie-chart-fill me-2"></i> สัดส่วนสหกรณ์/กลุ่มเกษตรกร
            </h4>
            <canvas id="coopPieChart" height="120"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ================= Coop Groups ================= -->
<section id="groups" class="section-block bg-white">
  <div class="container-lg">
    <div class="card modern-card mb-4">
      <div class="card-gradient-bar"></div>
      <div class="card-header bg-primary text-white">
        <i class="bi bi-diagram-3 me-2"></i> สรุปจำนวนสหกรณ์/กลุ่มเกษตรกรในแต่ละกลุ่ม
      </div>
      <div class="card-body">
        <div class="row">
          <% coopGroupStats.forEach(group => { %>
            <div class="col-md-4 mb-3">
              <div class="card h-100 modern-card shadow-sm border-0">
                <div class="card-gradient-bar"></div>
                <div class="card-body text-center">
                  <h5 class="fw-bold mb-2 text-primary"><%= displayGroupName(group.c_group) %></h5>
                  <div class="mb-2">
                    <button type="button" class="badge bg-success fs-6 border-0 js-show-group-items shadow-focus" data-group="<%= group.c_group %>" data-group-label="<%= displayGroupName(group.c_group) %>" data-type="สหกรณ์" aria-label="ดูรายชื่อสหกรณ์ใน <%= displayGroupName(group.c_group) %>">
                      สหกรณ์: <%= group.coop %>
                    </button>
                  </div>
                  <div>
                    <button type="button" class="badge bg-info fs-6 border-0 js-show-group-items shadow-focus" data-group="<%= group.c_group %>" data-group-label="<%= displayGroupName(group.c_group) %>" data-type="กลุ่มเกษตรกร" aria-label="ดูรายชื่อกลุ่มเกษตรกรใน <%= displayGroupName(group.c_group) %>">
                      กลุ่มเกษตรกร: <%= group.farmer %>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Modal แสดงรายชื่อสหกรณ์/กลุ่มเกษตรกร ตาม group -->
<div class="modal fade" id="groupItemsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="groupItemsModalLabel">...</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="groupItemsLoading" class="text-center text-muted py-3">กำลังโหลด...</div>
        <ul id="groupItemsList" class="list-group d-none"></ul>
        <div id="groupItemsError" class="alert alert-danger d-none mb-0"></div>
      </div>
    </div>
  </div>
</div>

<!-- ================= Member Summary ================= -->
<section id="members" class="section-block bg-light">
  <div class="container">
    <div class="mb-3 text-center">
      <h2 class="text-primary section-title">📊 สรุปจำนวนสมาชิก (สหกรณ์)</h2>
    </div>

    <% const hasSummary = (typeof summaryByYear !== 'undefined' && summaryByYear); %>
    <% const hasTop = (typeof top !== 'undefined' && Array.isArray(top)); %>
    <% const yearEntries = hasSummary ? Object.entries(summaryByYear).sort((a,b)=> Number(b[0]) - Number(a[0])) : []; %>

    <div class="row g-3">
      <div class="col-lg-4">
        <div class="card modern-card h-100">
          <div class="card-gradient-bar"></div>
          <div class="card-body">
            <h5 class="card-title text-success mb-3">
              <i class="bi bi-calendar3 me-2"></i> รวมสมาชิกตามปี
            </h5>
            <% if (yearEntries.length) { %>
              <ul class="list-group list-group-flush">
                <% yearEntries.forEach(([y,total]) => { %>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="fw-semibold"><%= y %></span>
                    <span class="badge bg-success rounded-pill"><%= Number(total).toLocaleString() %></span>
                  </li>
                <% }) %>
              </ul>
            <% } else { %>
              <div class="text-muted">ไม่มีข้อมูลสรุปตามปี</div>
            <% } %>
          </div>
          <div class="card-footer bg-light d-flex justify-content-end">
            <a href="/members" class="btn btn-sm btn-success">
              ดูข้อมูลเพิ่มเติม
            </a>
          </div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="card modern-card h-100">
          <div class="card-gradient-bar"></div>
          <div class="card-body">
            <h5 class="card-title text-primary mb-3">
              <i class="bi bi-trophy me-2"></i> Top สหกรณ์ (ตามจำนวนสมาชิกรวม)
            </h5>
            <% if (hasTop && top.length) { %>
              <div class="table-responsive">
                <table class="table table-sm table-bordered table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th class="text-center">อันดับ</th>
                      <th>ชื่อสหกรณ์</th>
                      <th>พ.ศ.</th>
                      <th>อำเภอ</th>
                      <th class="text-end">สมาชิกรวม(ราย)</th>
                      <th class="text-center">view</th>
                    </tr>
                  </thead>
                  <tbody>
                  <% top.forEach((t,i)=>{ %>
                    <tr>
                      <td class="text-center"><%= i+1 %></td>
                      <td><%= t.name %></td>
                      <td><%= t.year || 'N/A' %></td> <!-- insert พ.ศ. -->
                      <td><%= t.อำเภอ %></td>
                      <td class="text-end"><%= Number(t.total).toLocaleString() %></td>
                      <td class="text-center">
                        <a href="/members/<%= t.idx %>" class="btn btn-sm btn-outline-info">รายละเอียด</a>
                      </td>
                    </tr>
                  <% }) %>
                  </tbody>
                </table>
              </div>
            <% } else { %>
              <div class="text-muted">ไม่มีข้อมูลรายการ Top</div>
            <% } %>
          </div>
          <div class="card-footer bg-light d-flex justify-content-between">
            <a href="/" class="btn btn-sm btn-outline-secondary">หน้าแรก</a>
            <a href="/members" class="btn btn-sm btn-primary">รายการทั้งหมด / ค้นหา</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ================= Activities & Image ================= -->
<section id="activities" class="section-block">
  <div class="container-lg">
    <div class="row">
      <div class="col-md-8 text-center">
        <img src="/images/jk.jpg" alt="Description of the image" class="img-fluid shadow-sm rounded">
      </div>
      <div class="col-md-4">
        <div class="card modern-card shadow-sm border-0">
          <div class="card-gradient-bar"></div>
          <div class="card-body">
            <h5 class="text-primary"><i class="bi bi-calendar-event me-2 text-success"></i> กิจกรรมล่าสุด</h5>
            <ul class="list-group list-group-flush">
              <% activity.forEach(acti => { %>
                <li class="list-group-item">
                  <i class="bi bi-calendar-event me-2 text-success"></i>
                  <% const today = new Date(); %>
                  <% const actDate = new Date(acti.date_act); %>
                  <%= actDate.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' }) %> - 
                  <%= acti.activity %>
                  <% if (actDate.toDateString() === today.toDateString()) { %>
                    <span class="badge bg-danger ms-2"><i class="bi bi-stars"></i> วันนี้</span>
                  <% } %>
                </li>
              <% }) %>
            </ul>
          </div>
        </div>
        <div class="text-end mt-2">
          <a href="/activities" class="btn btn-primary btn-sm px-4 shadow-sm">
            ดูทั้งหมด
          </a>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ================= Finance & Business ================= -->
<section id="finance" class="section-block bg-white">
  <div class="container-lg">
    <div class="row">
      <div class="col-md-6 mb-4">
        <div class="p-4 rounded shadow-sm h-100 modern-card">
          <div class="card-gradient-bar"></div>
          <h2 class="mb-4 text-center text-success">📂 รายงานงบการเงิน</h2>
          <ul class="list-group list-group-flush">
            <% finances.slice(0, 10).forEach((file, index)=> { %>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>
                  <i class="fas fa-file-alt me-2 text-secondary"></i>
                  <strong>
                    <%= index + 1 %>.
                  </strong>
                  <%= file.c_name %>
                    <span>[ <%= file.end_date %>
                        <%= file.end_year %> ]</span>
                    <% const fileSavedDate=new Date(file.savedate); const currentDate=new Date(); const
                      diffDays=Math.ceil((currentDate - fileSavedDate) / (1000 * 60 * 60 * 24)); %>
                      <% if (diffDays <=7) { %>
                        <img src="/images/newpng.png" alt="New"
                          class="ms-2" style="width: 40px; height: 35px;" />
                      <% } %>
                </span>
                <% if(user){ %>
                  <a href="/finance/download/<%= file.id %>" class="btn btn-sm btn-outline-success" target="_blank"
                    rel="noopener noreferrer">
                    ดาวน์โหลด
                  </a>
                <% } %>
              </li>
            <% }); %>
          </ul>
          <div class="text-end mt-2">
            <a href="/finance" class="btn btn-danger btn-sm px-4 shadow-sm">
              📂 ดูทั้งหมด
            </a>
          </div>
        </div>
      </div>

      <div class="col-md-6 mb-4">
        <div class=" p-4 rounded shadow-sm h-100 modern-card">
          <div class="card-gradient-bar"></div>
          <h2 class="mb-4 text-center text-info">💼 รายงานกิจการ</h2>
          <ul class="list-group list-group-flush">
            <% businessFiles.slice(0, 10).forEach((business, index)=> { %>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>
                  <i class="fas fa-briefcase me-2 text-secondary"></i>
                  <strong>
                    <%= index + 1 %>.
                  </strong>
                  <%= business.bu_name %>
                    <span class="badge bg-info ms-2">
                      <%= business.end_date %>
                        <%= business.bu_endyear %>
                    </span>
                    <% const businessSavedDate=new Date(business.bu_savedate); const currentDate=new Date(); const
                      diffDays=Math.ceil((currentDate - businessSavedDate) / (1000 * 60 * 60 * 24)); %>
                      <% if (diffDays <=7) { %>
                        <img src="/images/newpng.png" alt="New"
                          class="ms-2" style="width: 40px; height: 35px;" />
                      <% } %>
                </span>
                <% if(user){ %>
                  <a href="/business/download/<%= business.bu_id %>" class="btn btn-sm btn-outline-info"
                    target="_blank" rel="noopener noreferrer">
                    ดาวน์โหลด
                  </a>
                <% } %>
              </li>
            <% }); %>
          </ul>
          <div class="text-end mt-2">
            <a href="/business" class="btn btn-info btn-sm px-4 shadow-sm">
              💼 ดูทั้งหมด
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section id="rules" class="section-block bg-white">
  <div class="container-lg">
    <div class="row">
      <div class="col-md-6 mb-4">
        <div class=" p-4 rounded shadow-sm h-100 modern-card">
          <div class="card-gradient-bar"></div>
          <h2 class="mb-4 text-center text-success">📋 ข้อบังคับสหกรณ์/กลุ่มเกษตรกร</h2>
          <ul class="list-group list-group-flush">
            <% ruleFiles.slice(0, 10).forEach((rule, index)=> { %>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>
                  <i class="fas fa-file-pdf me-2 text-secondary"></i>
                  <strong>
                    <%= index + 1 %>.
                  </strong>
                  <%= rule.rule_name %>
                    <span
                      class="badge ms-2 <% if (rule.rule_type === 'MR') { %>bg-dark<% } else { %>bg-primary<% } %>">
                      <% if (rule.rule_type==='MR' ) { %>
                        ข้อกำหนด พ.ศ.<%= rule.rule_year %>
                          <% } else if (rule.rule_type==='ER' ) { %>
                            แก้ไข <%= rule.er_no %> [พ.ศ. <%= rule.rule_year %>]
                                <% } %>
                    </span>
                    <% const ruleSavedDate = new Date(rule.rule_savedate); 
                    const currentDate = new Date(); const diffDays = Math.ceil((currentDate - ruleSavedDate) / (1000 * 60 * 60 * 24)); %>
                    <% if (diffDays <= 7) { %>
                      <img src="/images/newpng.png" alt="New"
                      class="ms-2" style="width: 40px; height: 35px;" />
                    <% } %>
                </span>
                <% if(user){ %>
                  <a href="/rule/<%= rule.rule_id %>" class="btn btn-sm btn-outline-success" target="_blank"
                    rel="noopener noreferrer">
                    ดาวน์โหลด
                  </a>
                <% } %>
              </li>
            <% }); %>
          </ul>
          <div class="text-end mt-2">
            <a href="/rule" class="btn btn-danger btn-sm px-4 shadow-sm">
              📋 ดูทั้งหมด
            </a>
          </div>
        </div>
      </div>
      <div class="col-md-6 mb-4">
        <div class=" p-4 rounded shadow-sm h-100 modern-card">
          <div class="card-gradient-bar"></div>
          <h2 class="mb-4 text-center text-warning">📄 ระเบียบสหกรณ์/กลุ่มเกษตรกร</h2>
          <ul class="list-group list-group-flush">
            <% rabiabFiles.slice(0, 10).forEach((rabiab, index)=> { %>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>
                  <i class="fas fa-file-alt me-2 text-secondary"></i>
                  <strong>
                    <%= index + 1 %>.
                  </strong>
                  <%= rabiab.ra_name %>
                    <% const rabiabSavedDate = new Date(rabiab.ra_savedate); const currentDate = new Date(); const diffDays = Math.ceil((currentDate - rabiabSavedDate) / (1000 * 60 * 60 * 24)); %>
                    <% if (diffDays <= 7) { %>
                      <img src="/images/newpng.png" alt="New"
                      class="ms-2" style="width: 40px; height: 35px;" />
                    <% } %>
                </span>
                <% if(user){ %>
                  <a href="/rabiab/download/<%= rabiab.ra_id %>" class="btn btn-sm btn-outline-warning"
                    target="_blank" rel="noopener noreferrer">
                    ดาวน์โหลด
                  </a>
                <% } %>
              </li>
            <% }); %>
          </ul>
          <div class="text-end mt-2">
            <a href="/rabiab" class="btn btn-warning btn-sm px-4 shadow-sm">
              📄 ดูทั้งหมด
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section id="projects" class="section-block bg-light">
  <div class="container-lg">
    <div class="row">
      <div class="col-md-6">
        <h2 class="mb-4 text-center text-primary section-title">
          <i class="bi bi-file-earmark-pdf me-2"></i> โครงการล่าสุด
        </h2>
        <div class="card modern-card shadow-sm border-0">
          <div class="card-gradient-bar"></div>
          <div class="card-body">
            <ul class="list-group list-group-flush">
              <% (lastProjects || []).forEach((p, idx)=> { %>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span>
                    <strong>
                      <%= idx + 1 %>.
                    </strong>
                    <%= p.pro_story %>
                      <span class="badge bg-secondary ms-2">
                        <%= p.pro_no %>
                      </span>
                  </span>
                  <% if(user){ %>
                    <a href="/project/download/<%= p.pro_id %>" class="btn btn-sm btn-outline-primary"
                      target="_blank">
                      <i class="bi bi-file-pdf-fill"></i>
                    </a>
                  <% } %>
                </li>
              <% }) %>
            </ul>
            <div class="text-end mt-2">
              <a href="/project" class="btn btn-primary btn-sm px-4 shadow-sm">ดูทั้งหมด</a>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <h2 class="mb-4 text-center text-primary section-title">
          <i class="bi bi-megaphone-fill me-2"></i> คำสั่งล่าสุด
        </h2>
        <div class="card modern-card shadow-sm border-0">
          <div class="card-gradient-bar"></div>
          <div class="card-body">
            <ul class="list-group list-group-flush">
              <% (lastCommands || []).forEach((c, idx)=> { %>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span>
                    <strong>
                      <%= idx + 1 %>.
                    </strong>
                    <%= c.com_story %>
                      <span class="badge bg-secondary ms-2">
                        <%= c.com_no %>
                      </span>
                  </span>
                  <% if(user){ %>
                    <a href="/command/download/<%= c.command_id %>" class="btn btn-sm btn-outline-primary"
                      target="_blank">
                      <i class="bi bi-file-earmark-arrow-down"></i>
                    </a>
                  <% } %>
                </li>
              <% }) %>
            </ul>
            <div class="text-end mt-2">
              <a href="/command" class="btn btn-primary btn-sm px-4 shadow-sm">ดูทั้งหมด</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section id="chamra" class="section-block">
  <div class="container">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h6 class="mb-0">
          <i class="bi bi-activity me-2"></i> สถานะการชำระบัญชีล่าสุด
        </h6>
        <% if(user) { %>
          <button id="exportChamraBtnHome" class="btn btn-secondary me-2">⬇️ Export Chamra</button>
        <% } else { %>
          <button id="exportChamraBtnHome" class="btn btn-secondary">⬇️ Export PDF</button>
        <% } %>
      </div>

      <% if ((homeProcesses || []).length) { %>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm table-bordered table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th class="ps-3">สถาบัน</th>
                  <th class="text-center">S1</th>
                  <th class="text-center">S2</th>
                  <th class="text-center">S3</th>
                  <th class="text-center">S4</th>
                  <th class="text-center">S5</th>
                  <th class="text-center">S6</th>
                  <th class="text-center">S7</th>
                  <th class="text-center">S8</th>
                  <th class="text-center">S9</th>
                  <th class="text-center">S10</th>
                </tr>
              </thead>
              <tbody>
                <%
                  const isEmptyDate = (v) => {
                    if (!v) return true;
                    if (typeof v === 'string') {
                      if (v === '0000-00-00') return true;
                      if (/^1899-11-30/.test(v)) return true;
                    }
                    const d = new Date(v);
                    return isNaN(d.getTime()) || d.getFullYear() < 1950;
                  };
                  const formatThai = (v) => {
                    const d = new Date(v);
                    if (isNaN(d.getTime())) return '-';
                    const m = ['ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.','ต.ค.','พ.ย.','ธ.ค.'][d.getMonth()];
                    return `${d.getDate()} ${m} ${d.getFullYear()+543}`;
                  };
                %>
                <% homeProcesses.forEach(p => { %>
                  <tr>
                    <td class="ps-3 small fw-semibold text-dark">
                      <i class="bi bi-building me-1 text-primary"></i>
                      <%= p.c_name || p.pr_code %>
                    </td>
                    <% for (let i=1;i<=10;i++){ const key='pr_s'+i; const raw=p[key]; %>
                      <td class="text-center">
                        <% if (isEmptyDate(raw)) { %>
                          <span class="badge rounded-pill bg-secondary hp-badge px-2">-</span>
                        <% } else { %>
                          <span class="badge rounded-pill bg-success hp-badge px-2"><%= formatThai(raw) %></span>
                        <% } %>
                      </td>
                    <% } %>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card-footer bg-light d-flex justify-content-between align-items-center">
          <small class="text-muted">
            <i class="bi bi-info-circle me-1"></i>
            สีเขียว = มีวันที่ | สีเทา = ยังไม่มีข้อมูล
          </small>
          <a href="/chamra/process" class="btn btn-primary btn-sm">
            ดูเพิ่มเติม
          </a>
        </div>
      <% } else { %>
        <div class="card-body">
          <div class="text-center text-muted py-3">
            <i class="bi bi-inbox fs-3 d-block mb-2"></i>
            ไม่มีข้อมูลสำหรับแสดง
          </div>
        </div>
      <% } %>
    </div>
  </div>
</section>

<%- include('home/vong-latest.ejs') %>


<section id="downloads" class="section-block bg-white">
  <div class="container-lg">
    <div class="card modern-card">
      <div class="card-gradient-bar"></div>
      <div class="card-header bg-success text-white">
        <i class="bi bi-trophy me-2"></i> Top 10 ดาวน์โหลดล่าสุด
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm table-bordered table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th style="width:56px;">#</th>
                <th>เรื่อง</th>
                <th class="text-nowrap">ไฟล์</th>
                <th class="text-center">ลิงก์</th>
                <th class="text-nowrap">วันที่</th>
              </tr>
            </thead>
            <tbody id="topDownloadsTbody">
              <tr><td colspan="5" class="text-muted">กำลังโหลด...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-footer bg-light text-end">
        <a href="/down" class="btn btn-sm btn-outline-secondary">ดูทั้งหมด</a>
      </div>
    </div>
  </div>
</section>

<section id="rq2" class="section-block">
  <div class="container-lg">
    <div class="row mt-2">
      <div class="col-12">
        <h2 class="mb-4 text-center text-primary section-title">
          <i class="bi bi-file-earmark-ruled me-2"></i> RQ2 ล่าสุด
        </h2>
        <div class="card modern-card shadow-sm border-0">
          <div class="card-gradient-bar"></div>
          <div class="card-body">
            <div class="row">
              <% (lastRq2 || []).forEach((r, idx)=> { %>
                <div class="col-md-6 mb-3">
                  <div class="list-group">
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                      <span>
                        <strong>
                          <%= idx + 1 %>.
                        </strong>
                        <%= r.rq_name %>
                          <span class="badge bg-secondary ms-2">
                            <%= r.rq_year %>
                          </span>
                          <% const rqSavedDate = new Date(r.rq_savedate); const currentDate = new Date(); const diffDays = Math.ceil((currentDate - rqSavedDate) / (1000 * 60 * 60 * 24)); %>
                          <% if (diffDays <= 7) { %>
                            <img src="/images/newpng.png" alt="New"
                            class="ms-2" style="width: 40px; height: 35px;" />
                          <% } %>
                      </span>
                      <% if(user){ %>
                        <a href="/rq2/download/<%= r.rq_id %>" class="btn btn-sm btn-outline-primary" target="_blank">
                          <i class="bi bi-file-pdf-fill"></i>
                        </a>
                      <% } %>
                    </div>
                  </div>
                </div>
              <% }) %>
            </div>
            <div class="text-end mt-2">
              <a href="/rq2" class="btn btn-primary btn-sm px-4 shadow-sm">ดูทั้งหมด</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section id="articles" class="section-block bg-light">
  <div class="container">
    <div class="card modern-card shadow-sm border-0">
      <div class="card-gradient-bar"></div>
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="bi bi-journal-text me-2"></i> บทความ (แสดงแบบรายการ)</h6>
        <a href="/article" class="btn btn-sm btn-outline-light">ดูทั้งหมด</a>
      </div>
      <div class="card-body">
        <%- include('article/partials/list-body.ejs', { articles: (lastArticles || []) }) %>
      </div>
    </div>
  </div>
</section>


<section id="usecar" class="section-block">
  <div class="container-lg">
    <div class="row mt-4" id="usecarSection">
      <div class="col-12">
        <h2 class="mb-4 text-center text-primary section-title">
          <i class="bi bi-car-front-fill me-2"></i> รายการใช้รถ
        </h2>
        <div class="card modern-card shadow-sm border-0">
          <div class="card-gradient-bar"></div>
          <div class="card-body">
            <div class="row">
              <% usecars.forEach((usecar)=> { %>
                <div class="col-12 col-md-6 mb-3">
                  <div class="list-group">
                    <div class="list-group-item">
                      <div class="d-flex justify-content-between align-items-start">
                        <div class="ms-2 me-auto">
                          <% const date=new Date(usecar.date_car); const options={ year: 'numeric' , month: 'long' ,
                            day: 'numeric' }; const thaiDate=date.toLocaleDateString('th-TH', options); const
                            today=new Date(); const
                            isToday=today.toLocaleDateString('th-TH')===date.toLocaleDateString('th-TH'); %>
                            <div class="fw-bold text-success mb-1">
                              <i class="bi bi-calendar-event me-1"></i>
                              <%= thaiDate %>
                                <span class="text-muted">(<i class="bi bi-clock"></i>
                                  <%= usecar.time_car + ' น.' %>)
                                </span>
                                <% if (isToday) { %>
                                  <span class="badge bg-danger ms-2"><i class="bi bi-stars"></i> วันนี้</span>
                                <% } %>
                            </div>
                            <div class="text-dark mb-1">
                              <i class="bi bi-geo-alt-fill text-danger me-1"></i>
                              <%= usecar.place_car %>
                            </div>
                            <small class="text-muted d-block mb-2">
                              <i class="bi bi-clipboard2-check me-1"></i>
                              <%= usecar.act_car %>
                            </small>

                            <button
                              type="button"
                              class="btn btn-outline-primary btn-sm js-open-usecar"
                              data-bs-toggle="modal"
                              data-bs-target="#usecarModal"
                              data-id="<%= usecar.id_usecar %>"
                              data-date="<%= thaiDate %>"
                              data-time="<%= usecar.time_car %>"
                              data-place="<%= usecar.place_car %>"
                              data-act="<%= usecar.act_car %>"
                            >
                              <i class="bi bi-info-circle me-1"></i> ดูข้อมูลเพิ่ม
                            </button>
                        </div>

                        <% if(user && user.mClass==='admin' ){ %>
                          <div class="d-flex align-items-center ms-3">
                            <a href="/usecar/edit/<%= usecar.id_usecar %>"
                              class="btn btn-outline-warning btn-sm me-2">
                              <i class="bi bi-pencil-square"></i>
                            </a>
                            <form action="/usecar/delete/<%= usecar.id_usecar %>" method="POST"
                              style="display: inline;">
                              <button type="submit" class="btn btn-outline-danger btn-sm">
                                <i class="bi bi-trash3"></i>
                              </button>
                            </form>
                          </div>
                        <% } %>
                      </div>
                    </div>
                  </div>
                </div>
              <% }); %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section id="online" class="section-block bg-light">
  <div class="container-lg">
    <div class="row">
      <div class="col-md-4">
        <div class="card modern-card shadow-sm border-0 h-100">
          <div class="card-gradient-bar"></div>
          <div class="card-body text-center">
            <h5 class="card-title">📈 ข้อมูลการใช้งาน</h5>
            <div class="mb-3">
              <div class="display-4 text-success">
                <%= onlineCount %>
              </div>
              <small class="text-muted">ผู้ใช้งานทั่วไปออนไลน์</small>
            </div>
            <hr>
            <div class="row text-center">
              <h4 class="col-12 text-center">จำนวน</h4>
              <div class="col-md-4">
                <div class="h4 text-primary">
                  <%= stats.coop %>
                </div>
                <small>สหกรณ์</small>
              </div>
              <div class="col-md-4">
                <div class="h4 text-success">
                  <%= stats.farmer %>
                </div>
                <small>กลุ่มเกษตรกร</small>
              </div>
              <div class="col-md-4">
                <div class="h4 text-warning">
                  <%= stats.closing %>
                </div>
                <small>ชำระบัญชี</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-8 mt-md-0">
        <h2 class="mb-4 text-center text-success section-title">🟢 Members Online</h2>

        <div class="card modern-card shadow-sm border-0">
          <div class="card-gradient-bar"></div>
          <div class="card-body">
            <div class="row">
              <% onlineUsers.forEach((user, index)=> { %>
                <div class="col-md-6 mb-3">
                  <div class="d-flex align-items-center">
                    <img src="<%= user.m_img || '/images/default-avatar.png' %>" alt="Avatar"
                      class="rounded-circle me-3" style="width: 40px; height: 40px; object-fit: cover;">
                    <div>
                      <div class="fw-bold text-success">
                        <%= user.on_name %>
                      </div>
                      <small class="text-muted">
                        <%= user.m_position || '32ใช้' %>
                      </small>
                      <div class="badge bg-success ms-2">
                        <i class="fas fa-circle" style="font-size: 8px;"></i> ออนไลน์
                      </div>
                    </div>
                  </div>
                </div>
              <% }); %>
            </div>

            <% if (onlineUsers.length===0) { %>
              <div class="text-center text-muted">
                <i class="fas fa-users fa-3x mb-3"></i>
                <p>ไม่มีสมาชิกออนไลน์ในขณะนี้</p>
              <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Data container to hold serialized JSON (avoid inline EJS in JS code) -->
<div id="template-data"
  data-stats='{"coop": <%= JSON.stringify(stats.coop) %>, "farmer": <%= JSON.stringify(stats.farmer) %>, "closing": <%= JSON.stringify(stats.closing) %>}'
  data-coop-group-stats='<%- JSON.stringify(coopGroupStats) %>'
  data-logged-in="<%= user ? 'true' : 'false' %>">
</div>

<!-- Back To Top Button -->
<button type="button" id="backToTop" aria-label="กลับขึ้นบน" class="back-to-top">
  <i class="bi bi-arrow-up"></i>
</button>

<!-- ================= SCRIPTS (Enhancements added before existing scripts end) ================= -->
<script>
  // Quick Nav Active State + Smooth Scroll
  (function(){
    const links=[...document.querySelectorAll('#quickNav a')];
    const sections=links.map(a=>document.querySelector(a.getAttribute('href'))).filter(Boolean);
    function activate(){
      const y=window.scrollY + 120;
      let cur=null;
      sections.forEach(sec=>{
        if(sec.offsetTop <= y) cur=sec;
      });
      if(!cur) return;
      links.forEach(l=>l.classList.toggle('active', l.getAttribute('href') === '#'+cur.id));
    }
    links.forEach(l=> {
      l.addEventListener('click', e=>{
        const target=document.querySelector(l.getAttribute('href'));
        if(target){
          e.preventDefault();
          window.scrollTo({ top: target.offsetTop - 70, behavior:'smooth' });
        }
      });
    });
    window.addEventListener('scroll', activate,{passive:true});
    activate();
  })();

  // Reveal on scroll
  (function(){
    const obs=new IntersectionObserver(entries=>{
      entries.forEach(e=>{
        if(e.isIntersecting){
          e.target.classList.add('in');
          obs.unobserve(e.target);
        }
      });
    },{threshold:.14});
    document.querySelectorAll('.reveal').forEach(el=>obs.observe(el));
    document.querySelectorAll('.section-block').forEach(el=>{
      el.classList.add('reveal');
      obs.observe(el);
    });
  })();
</script>

<script>
  const socket = io();

  socket.on('onlineUsers', (count) => {
    const onlineCountDiv = document.querySelector('.display-4.text-success');
    if (onlineCountDiv) {
      onlineCountDiv.textContent = count;
    }
  });
</script>
<script>
  // Retrieve template serialized data
  const _dataEl = document.getElementById('template-data');
  const statsData = JSON.parse(_dataEl.getAttribute('data-stats'));
  const coopGroupStatsData = JSON.parse(_dataEl.getAttribute('data-coop-group-stats'));

  const ctxBar = document.getElementById('coopChart').getContext('2d');
  const coopChart = new Chart(ctxBar, {
    type: 'bar',
    data: {
      labels: ['สหกรณ์', 'กลุ่มเกษตรกร', 'ชำระบัญชี'],
      datasets: [{
        label: 'จำนวน',
        data: [statsData.coop, statsData.farmer, statsData.closing],
        backgroundColor: [
          'rgba(25, 135, 84, 0.7)',
          'rgba(13, 202, 240, 0.7)',
          'rgba(255, 193, 7, 0.7)'
        ],
        borderColor: [
          'rgba(25, 135, 84, 1)',
          'rgba(13, 202, 240, 1)',
          'rgba(255, 193, 7, 1)'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        datalabels: {
          anchor: 'end',
          align: 'top',
          color: '#000',
          font: { weight: 'bold' },
          formatter: (value) => value
        }
      },
      scales: { y: { beginAtZero: true } }
    },
    plugins: [ChartDataLabels]
  });
</script>

<script>
  // Pie chart using coopGroupStatsData from data attributes
  const totalCoop = coopGroupStatsData.reduce((a,b)=> a + Number(b.coop||0),0);
  const totalFarmer = coopGroupStatsData.reduce((a,b)=> a + Number(b.farmer||0),0);
  const ctxPie = document.getElementById('coopPieChart').getContext('2d');
  const coopPieChart = new Chart(ctxPie, {
    type: 'pie',
    data: {
      labels: ['สหกรณ์', 'กลุ่มเกษตรกร'],
      datasets: [{
        data: [totalCoop, totalFarmer],
        backgroundColor: [
          'rgba(25, 135, 84, 0.7)',
          'rgba(13, 202, 240, 0.7)'
        ],
        borderColor: [
          'rgba(25, 135, 84, 1)',
          'rgba(13, 202, 240, 1)'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' },
        datalabels: {
          color: '#000',
          font: { weight: 'bold', size: 16 },
          formatter: (value, ctx) => ctx.chart.data.labels[ctx.dataIndex] + ': ' + value
        }
      }
    },
    plugins: [ChartDataLabels]
  });
  window.coopGroupStats = coopGroupStatsData;
</script>

<script>
  (function() {
    const btn = document.getElementById('exportChamraBtnHome');
    if (!btn) return;
    btn.addEventListener('click', async () => {
      btn.disabled = true;
      const originalText = btn.textContent;
      btn.textContent = 'กำลังส่งออก...';
      try {
        const resp = await fetch('/chamra/export/pdf', { method: 'POST' });
        if (!resp.ok) throw new Error('Export failed');
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
        setTimeout(() => URL.revokeObjectURL(url), 60000);
      } catch (e) {
        alert('ไม่สามารถส่งออกข้อมูลได้');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    });
  })();
</script>

<script>
  (function() {
    const loggedIn = document.getElementById('template-data').getAttribute('data-logged-in') === 'true';

    function escapeHtml(str) {
      return String(str ?? '').replace(/[&<>"']/g, s => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]
      ));
    }
    function fmtDate(d) {
      if (!d) return '-';
      const dt = new Date(d);
      if (isNaN(dt)) return escapeHtml(String(d));
      try {
        return dt.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' });
      } catch {
        const months = ['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'];
        return `${dt.getDate()} ${months[dt.getMonth()]} ${dt.getFullYear() + 543}`;
      }
    }

    fetch('/down/top10')
      .then(res => res.json())
      .then(data => {
        const tbody = document.getElementById('topDownloadsTbody');
        if (!Array.isArray(data) || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-muted">ไม่มีข้อมูล</td></tr>';
          return;
        }
        tbody.innerHTML = data.map((d, idx) => `
          <tr>
            <td>${idx + 1}</td>
            <td>${escapeHtml(d.down_subject || '-')}</td>
            <td class="text-nowrap">
              ${
                d.down_file && d.down_file !== '-' ? (
                  loggedIn
                    ? `<a href="/down/download/${d.down_id}" target="_blank" class="btn btn-sm btn-outline-success">
                         <i class="bi bi-file-earmark-arrow-down"></i> ไฟล์
                       </a>`
                    : `<a href="/auth/login" class="btn btn-sm btn-outline-secondary">
                         <i class="bi bi-lock"></i> เข้าสู่ระบบ
                       </a>`
                ) : '<span class="text-muted">-</span>'
              }
            </td>
            <td class="text-center">
              ${
                d.down_link && d.down_link !== '-'
                  ? `<a href="${escapeHtml(d.down_link)}" target="_blank" class="btn btn-sm btn-outline-info">
                       <i class="bi bi-link-45deg"></i> ลิงก์
                     </a>`
                  : '<span class="text-muted">-</span>'
              }
            </td>
            <td>${fmtDate(d.down_savedate)}</td>
          </tr>
        `).join('');
      })
      .catch(() => {
        const tbody = document.getElementById('topDownloadsTbody');
        tbody.innerHTML = '<tr><td colspan="5" class="text-danger">โหลดข้อมูลไม่สำเร็จ</td></tr>';
      });
  })();
</script>

<script>
  (function(){
    document.addEventListener('click', function(e){
      const btn = e.target.closest('.js-show-group-items');
      if(!btn) return;
      const group = btn.getAttribute('data-group');
      const type = btn.getAttribute('data-type');
      const label = btn.getAttribute('data-group-label');

      const modalEl = document.getElementById('groupItemsModal');
      const titleEl = document.getElementById('groupItemsModalLabel');
      const listEl = document.getElementById('groupItemsList');
      const loadingEl = document.getElementById('groupItemsLoading');
      const errorEl = document.getElementById('groupItemsError');

      titleEl.textContent = label + ' - ' + type;
      listEl.innerHTML = '';
      listEl.classList.add('d-none');
      errorEl.classList.add('d-none');
      loadingEl.classList.remove('d-none');

      fetch(`/activeCoop/group/${encodeURIComponent(group)}/items?type=${encodeURIComponent(type)}`)
        .then(r => { if(!r.ok) throw new Error('network'); return r.json(); })
        .then(data => {
          loadingEl.classList.add('d-none');
          if(!data.items || !data.items.length){
            errorEl.textContent = 'ไม่มีข้อมูล';
            errorEl.classList.remove('d-none');
            return;
          }
          listEl.innerHTML = data.items.map((it,i)=>`<li class="list-group-item d-flex justify-content-between align-items-start">
              <div>
                <span class="fw-semibold">${i+1}. ${it.c_name}</span>
                <small class="text-muted ms-1">(${it.c_code || '-'})</small>
              </div>
              <span class="badge bg-${it.coop_group==='สหกรณ์'?'success':'info'}">${it.coop_group}</span>
            </li>`).join('');
          listEl.classList.remove('d-none');
        })
        .catch(err => {
          loadingEl.classList.add('d-none');
          errorEl.textContent = 'เกิดข้อผิดพลาดในการโหลดข้อมูล';
          errorEl.classList.remove('d-none');
        });

      const bsModal = bootstrap && bootstrap.Modal ? new bootstrap.Modal(modalEl) : null;
      if(bsModal) bsModal.show();
    });
  })();
</script>

<%- include('partials/footer') %>