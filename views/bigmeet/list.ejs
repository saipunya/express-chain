<%- include('../partials/header') %>
<% const canEditServer = (user && (user.mClass === 'kbs' || user.mClass === 'admin')); %>

<div class="container-fluid mt-4">
  <!-- Toast Notification -->
  <div id="toast" class="toast position-fixed top-0 end-0 m-3" style="z-index: 1050; display: none;">
    <div class="toast-body bg-success text-white">
      <span id="toastMessage"></span>
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-header bg-white">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h5 class="m-0 fw-bold text-primary">
            <i class="fas fa-users me-2"></i>การประชุมใหญ่สหกรณ์และกลุ่มเกษตรกร
          </h5>
        </div>
        <div class="col-md-6 text-end">
          <a href="/dashboard" class="btn btn-secondary btn-sm me-2">
            <i class="fas fa-arrow-left me-1"></i>กลับหน้าหลัก
          </a>
          <a href="/bigmeet/new" class="btn btn-success btn-sm">
            <i class="fas fa-plus me-1"></i>เพิ่มข้อมูล
          </a>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <div class="d-flex flex-wrap align-items-center gap-3">
            <div>
              <label class="form-label small text-muted mb-1">ปีงบประมาณ</label>
              <select id="fySelect" class="form-select form-select-sm"></select>
            </div>
            <div class="small text-muted">
              สรุปสถานะจากปีงบฯ ที่เลือก
            </div>
          </div>
          <div class="border rounded p-3 bg-light mt-2">
            <div class="row text-center g-2">
              <div class="col-12 col-md-4">
                <div class="text-muted small">จำนวนทั้งหมด (ในรายการนี้)</div>
                <div class="fw-bold" id="sumTotal">-</div>
              </div>
              <div class="col-12 col-md-4">
                <div class="text-muted small">ประชุมใหญ่แล้ว</div>
                <div class="fw-bold text-success" id="sumMet">-</div>
              </div>
              <div class="col-12 col-md-4">
                <div class="text-muted small">ยังไม่ได้ประชุมใหญ่</div>
                <div class="fw-bold text-danger" id="sumNotMet">-</div>
              </div>
            </div>
            <div class="text-center small text-muted mt-1" id="sumRange">-</div>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="row g-2 align-items-end">
            <div class="col-12 col-md-6">
              <label class="form-label small text-muted mb-1">ค้นหา</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" id="searchInput" class="form-control" placeholder="ค้นหาชื่อสหกรณ์หรือรหัส...">
              </div>
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label small text-muted mb-1">ปีสิ้นสุด</label>
              <select id="yearFilter" class="form-select">
                <option value="">ทุกปี</option>
              </select>
            </div>
            <div class="col-6 col-md-3">
              <label class="form-label small text-muted mb-1">ประเภท</label>
              <select id="typeFilter" class="form-select">
                <option value="">ทุกประเภท</option>
                <option value="มีงบการเงิน">มีงบการเงิน</option>
                <option value="ไม่มีงบการเงิน">ไม่มีงบการเงิน</option>
              </select>
            </div>
            <div class="col-12">
              <button id="clearFilters" class="btn btn-outline-secondary btn-sm w-100">
                <i class="fas fa-times me-1"></i>ล้างตัวกรอง
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div id="loadingSpinner" class="text-center py-4" style="display: none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover table-striped align-middle mb-0" width="100%" cellspacing="0">
          <thead class="table-light">
            <tr>
              <th class="text-center" style="width: 70px;">#</th>
              <th>ชื่อสหกรณ์</th>
              <th class="text-center" style="width: 140px;">ปีสิ้นสุด</th>
              <th class="text-center" style="width: 140px;">ประเภท</th>
              <th class="text-center" style="width: 160px;">วันที่ประชุม</th>
              <th class="text-center" style="width: 140px;">วันที่บันทึก</th>
              <% if (canEditServer) { %>
                <th class="text-center" style="width: 90px;">แก้ไข</th>
                <th class="text-center" style="width: 90px;">ลบ</th>
              <% } %>
            </tr>
          </thead>
          <tbody id="dataTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <nav aria-label="Page navigation" class="mt-3">
    <ul class="pagination justify-content-center" id="pagination"></ul>
  </nav>
</div>

<script>
  // Data management
  let currentPage = 1;
  const itemsPerPage = 10;
  let allItems = <%- JSON.stringify(items || []) %>;
  let filteredItems = [...allItems];

  // User permission
  const userClass = '<%= user ? user.mClass : "" %>';
  const canEdit = (userClass === 'kbs' || userClass === 'admin');

  document.addEventListener('DOMContentLoaded', function() {
    populateYearFilter();
    setupEventListeners();
    filterAndRender();
    initFiscalYearSummary();

    const urlParams = new URLSearchParams(window.location.search);
    const successMessage = urlParams.get('success');
    if (successMessage) {
      showToast(successMessage || 'ดำเนินการสำเร็จ');
    }
  });

  function escapeHtml(value) {
    return String(value || '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function populateYearFilter() {
    const years = [...new Set(allItems.map(item => item.big_endyear).filter(Boolean))]
      .sort()
      .reverse();
    const yearFilter = document.getElementById('yearFilter');
    years.forEach(year => {
      const option = document.createElement('option');
      option.value = year;
      option.textContent = year;
      yearFilter.appendChild(option);
    });
  }

  function setupEventListeners() {
    document.getElementById('searchInput').addEventListener('input', filterAndRender);
    document.getElementById('yearFilter').addEventListener('change', filterAndRender);
    document.getElementById('typeFilter').addEventListener('change', filterAndRender);

    document.getElementById('clearFilters').addEventListener('click', function() {
      document.getElementById('searchInput').value = '';
      document.getElementById('yearFilter').value = '';
      document.getElementById('typeFilter').value = '';
      filterAndRender();
    });
  }

  function filterAndRender() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const yearFilter = document.getElementById('yearFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;

    filteredItems = allItems.filter(item => {
      const name = String(item.c_name || '').toLowerCase();
      const code = String(item.big_code || '').toLowerCase();
      const matchesSearch = !searchTerm || name.includes(searchTerm) || code.includes(searchTerm);
      const matchesYear = !yearFilter || String(item.big_endyear || '') === yearFilter;
      const matchesType = !typeFilter || item.big_type === typeFilter;
      return matchesSearch && matchesYear && matchesType;
    });

    currentPage = 1;
    renderTable();
  }

  function formatLocalDate(dateValue) {
    if (!dateValue) return '-';
    const d = new Date(dateValue);
    return isNaN(d.getTime()) ? '-' : d.toLocaleDateString('th-TH');
  }

  function formatEndDate(item) {
    let displayEndDateBE = item.big_endyear || '-';
    const endDayVal = item.end_day ? String(item.end_day).trim() : '';

    if (item.big_endyear && endDayVal && endDayVal.includes('-')) {
      try {
        const ceYear = parseInt(item.big_endyear, 10) - 543;
        const isoStr = ceYear + '-' + endDayVal;
        const dateObj = new Date(isoStr + 'T00:00:00');
        if (!isNaN(dateObj.getTime())) {
          displayEndDateBE = dateObj.toLocaleDateString('th-TH', {
            day: 'numeric', month: 'long', year: 'numeric'
          });
        }
      } catch (e) {
        displayEndDateBE = item.big_endyear || '-';
      }
    }

    return displayEndDateBE;
  }

  function renderTable() {
    const tbody = document.getElementById('dataTable');
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageItems = filteredItems.slice(startIndex, endIndex);
    const colCount = canEdit ? 8 : 6;

    if (pageItems.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="${colCount}" class="text-center py-5">
            <div class="text-muted">
              <i class="fas fa-search fa-3x mb-3"></i>
              <div class="h5">ไม่พบข้อมูลที่ตรงกับเงื่อนไข</div>
              <div>ลองปรับเปลี่ยนตัวกรองหรือคำค้นหา</div>
            </div>
          </td>
        </tr>
      `;
      renderPagination();
      return;
    }

    tbody.innerHTML = pageItems.map((item, index) => {
      const globalIndex = startIndex + index + 1;
      const name = escapeHtml(item.c_name || item.big_code || '-');
      const code = escapeHtml(item.big_code || '-');
      const typeText = escapeHtml(item.big_type || '-');
      const displayEndDateBE = formatEndDate(item);
      const meetingDate = formatLocalDate(item.big_date);
      const savedDate = formatLocalDate(item.big_savedate);
      const saveBy = escapeHtml(item.big_saveby || '');

      return `
        <tr data-id="${item.big_id}">
          <td class="text-center">
            <span class="badge bg-primary rounded-pill">${globalIndex}</span>
          </td>
          <td>
            <div class="fw-bold">${name}</div>
            <small class="text-muted">รหัส: ${code}</small>
          </td>
          <td class="text-center">
            <div class="text-nowrap">${displayEndDateBE}</div>
          </td>
          <td class="text-center">
            ${item.big_type === 'มีงบการเงิน'
              ? '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>' + typeText + '</span>'
              : '<span class="badge bg-warning"><i class="fas fa-times-circle me-1"></i>' + typeText + '</span>'}
          </td>
          <td class="text-center">
            <div>${meetingDate}</div>
            <small class="text-muted">${saveBy}</small>
          </td>
          <td class="text-center">${savedDate}</td>
          ${canEdit ? `
            <td class="text-center">
              <a href="/bigmeet/edit/${item.big_id}" class="btn btn-outline-warning btn-sm" title="แก้ไข">
                <i class="fas fa-edit"></i>แก้ไข
              </a>
            </td>
            <td class="text-center">
              <button class="btn btn-outline-danger btn-sm" onclick="confirmDelete(${item.big_id})" title="ลบ">
                <i class="fas fa-trash"></i>ลบ
              </button>
            </td>
          ` : ''}
        </tr>
      `;
    }).join('');

    renderPagination();
  }

  function renderPagination() {
    const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
    const pagination = document.getElementById('pagination');

    if (totalPages <= 1) {
      pagination.innerHTML = '';
      return;
    }

    let html = '';
    html += `
      <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">ก่อนหน้า</a>
      </li>
    `;

    for (let i = 1; i <= totalPages; i++) {
      if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
        html += `
          <li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
          </li>
        `;
      } else if (i === currentPage - 3 || i === currentPage + 3) {
        html += '<li class="page-item disabled"><a class="page-link">...</a></li>';
      }
    }

    html += `
      <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">ถัดไป</a>
      </li>
    `;

    pagination.innerHTML = html;
  }

  function changePage(page) {
    const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    renderTable();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function confirmDelete(id) {
    if (confirm('คุณต้องการลบข้อมูลนี้ใช่หรือไม่?')) {
      deleteItem(id);
    }
  }

  async function deleteItem(id) {
    showLoading(true);
    try {
      const response = await fetch(`/bigmeet/delete/${id}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      if (response.ok) {
        allItems = allItems.filter(item => item.big_id !== id);
        filteredItems = filteredItems.filter(item => item.big_id !== id);
        renderTable();
        showToast('ลบข้อมูลสำเร็จ');
      } else {
        throw new Error('Delete failed');
      }
    } catch (error) {
      console.error('Delete error:', error);
      showToast('ลบข้อมูลไม่สำเร็จ กรุณาลองใหม่', 'error');
    } finally {
      showLoading(false);
    }
  }

  function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    const toastBody = toast.querySelector('.toast-body');
    toastMessage.textContent = message;
    toastBody.className = `toast-body ${type === 'success' ? 'bg-success' : 'bg-danger'} text-white`;
    toast.style.display = 'block';
    toast.classList.add('show');

    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        toast.style.display = 'none';
      }, 300);
    }, 3000);
  }

  function showLoading(show) {
    const spinner = document.getElementById('loadingSpinner');
    const table = document.querySelector('.table-responsive');
    if (show) {
      spinner.style.display = 'block';
      table.style.opacity = '0.5';
    } else {
      spinner.style.display = 'none';
      table.style.opacity = '1';
    }
  }

  function initFiscalYearSummary() {
    const fySelect = document.getElementById('fySelect');
    if (!fySelect) return;

    const now = new Date();
    const nowBE = now.getFullYear() + 543;
    const guessFY = (now.getMonth() + 1) >= 9 ? nowBE + 1 : nowBE;
    const fys = [guessFY - 1, guessFY, guessFY + 1].filter((v, i, a) => a.indexOf(v) === i);

    fySelect.innerHTML = fys.map(fy => `<option value="${fy}">${fy}</option>`).join('');
    fySelect.value = String(guessFY);

    fySelect.addEventListener('change', () => loadFiscalYearSummary(fySelect.value));
    loadFiscalYearSummary(fySelect.value);
  }

  async function loadFiscalYearSummary(fy) {
    try {
      const res = await fetch(`/bigmeet/summary?fy=${encodeURIComponent(fy)}`);
      const json = await res.json();
      if (!json || !json.success) throw new Error(json && json.error ? json.error : 'Failed');

      const d = json.data;
      document.getElementById('sumTotal').textContent = d.totalCoopsInList;
      document.getElementById('sumMet').textContent = d.metInFiscalYear;
      document.getElementById('sumNotMet').textContent = d.notMetInFiscalYear;

      const fmt = (iso) => {
        if (!iso) return '-';
        const dt = new Date(iso + 'T00:00:00');
        return isNaN(dt.getTime()) ? iso : dt.toLocaleDateString('th-TH');
      };
      const rangeText = d.range
        ? `ช่วงวันที่: ${fmt(d.range.start)} - ${fmt(d.range.end)}`
        : '-';
      document.getElementById('sumRange').textContent = rangeText;
    } catch (e) {
      console.error('loadFiscalYearSummary:', e);
      document.getElementById('sumTotal').textContent = allItems.length;
      document.getElementById('sumMet').textContent = '-';
      document.getElementById('sumNotMet').textContent = '-';
      document.getElementById('sumRange').textContent = 'โหลดสรุปไม่สำเร็จ';
    }
  }
</script>

<%- include('../partials/footer') %>