<%- include('partials/header') %>

<style>
/* Page specific modern styling */
.rule-page-header h3 { font-weight:600; }
.rule-search-wrapper { position:relative; }
.rule-search-wrapper .bi-search { position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#6c757d; }
.rule-search-wrapper input { padding-left:38px; }
.rule-stats { background:linear-gradient(135deg,#f8f9fa,#eef4ff); border:1px solid #e1e7ef; border-radius:12px; }
.rule-stats .stat { text-align:center; padding:8px 0; }
.rule-stats .stat h4 { margin:0; font-size:1.4rem; font-weight:600; }
.rule-stats .stat small { color:#6c757d; letter-spacing:.5px; }
.accordion-button:not(.collapsed){ background:#f0f6ff; color:#0d6efd; }
.accordion-button:focus { box-shadow:none; }
.rule-item { transition:background .15s; }
.rule-item:hover { background:#f8fbff; }
.badge-main { background:#0d6efd; }
.badge-er { background:#6610f2; }
.rule-year { font-weight:500; color:#0d6efd; }
.rule-actions a { margin-left:4px; }
.highlight { background: #ffe69c; padding:0 2px; border-radius:4px; }
@media (max-width:576px){ .rule-actions{ margin-top:6px; } }

/* Embed mode: hide global chrome and page controls when embedded */
html.embedded body { background: transparent; }
html.embedded body > header,
html.embedded body > nav.navbar,
html.embedded body > footer,
html.embedded .site-footer,
html.embedded .app-footer { display: none !important; }
html.embedded #rulePage .rule-stats,
html.embedded #rulePage form,
html.embedded #rulePage nav,
html.embedded #rulePage .rule-page-header a { display: none !important; }
</style>

<div class="container mt-4" id="rulePage" data-search="<%= safeSearch %>" data-rules='<%- JSON.stringify(safeAlls) %>'>
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center rule-page-header gap-3">
    <h3 class="mb-0">üìã ‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå/‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</h3>
    <% if(user && user.mClass=='kjs'){ %> 
      <a href="/rule/upload" class="btn btn-primary shadow-sm">
        <i class="bi bi-cloud-upload"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö
      </a>
    <% } %>
  </div>

  <!-- Stats -->
  <% 
    // Defensive fallbacks
    const safeAlls = Array.isArray(alls) ? alls : [];
    const safeSearch = typeof search === 'string' ? search : '';
    const safeTotalPages = Number.isFinite(totalPages) ? totalPages : 1;
    const safeCurrentPage = Number.isFinite(currentPage) ? currentPage : 1;

    const totalRules = safeAlls.length; 
    const institutionSet = new Set(safeAlls.map(r=> (r && r.c_name) || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô'));
    const totalInstitutions = institutionSet.size;
  %>
  <div class="rule-stats mt-4 p-3 row g-3">
    <div class="col-6 col-md-4 stat">
      <h4><%= totalInstitutions %></h4>
      <small>‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô</small>
    </div>
    <div class="col-6 col-md-4 stat">
      <h4><%= totalRules %></h4>
      <small>‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö</small>
    </div>
    <div class="col-12 col-md-4 stat">
      <h4><%= totalPages %></h4>
      <small>‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
    </div>
  </div>

  <!-- Search -->
  <form method="get" action="/rule" class="mt-4" autocomplete="off">
    <div class="input-group rule-search-wrapper shadow-sm">
      <i class="bi bi-search"></i>
      <input type="text" name="search" id="searchInput" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô..." value="<%= safeSearch %>">
      <button class="btn btn-outline-primary" type="submit"><i class="bi bi-filter"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      <button class="btn btn-outline-secondary" type="button" onclick="window.location='/rule'">‡∏•‡πâ‡∏≤‡∏á</button>
    </div>
    <% if(safeSearch){ %>
      <div class="small text-muted mt-1">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: "<%= safeSearch %>"</div>
    <% } %>
  </form>

  <!-- Grouping & Accordion -->
  <% 
    // Group by c_name with safeAlls
    const grouped = {};
    safeAlls.forEach(item => {
      const name = (item && item.c_name) || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô';
      (grouped[name] ||= []).push(item);
    });

    // Sort groups by max rule_id DESC
    const sortedGroups = Object.entries(grouped).sort((a, b) => {
      const maxIdA = Math.max(...a[1].map(r => r.rule_id || 0));
      const maxIdB = Math.max(...b[1].map(r => r.rule_id || 0));
      return maxIdB - maxIdA;
    });
  %>

  <div class="accordion mt-4" id="ruleAccordion">
    <% sortedGroups.forEach(([cName, rules], idx) => { %>
      <div class="accordion-item shadow-sm mb-3 border-0">
        <h2 class="accordion-header" id="heading-<%= idx %>">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-<%= idx %>" aria-expanded="false" aria-controls="collapse-<%= idx %>">
            <span class="me-2 text-primary"><i class="bi bi-building"></i></span>
            <strong class="me-2 institution-name"><%= cName %></strong>
            <span class="badge bg-secondary rounded-pill"><%= rules.length %> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
          </button>
        </h2>
        <div id="collapse-<%= idx %>" class="accordion-collapse collapse" aria-labelledby="heading-<%= idx %>" data-bs-parent="#ruleAccordion">
          <div class="accordion-body p-0">
            <ul class="list-group list-group-flush">
              <% rules
                .sort((a, b) => {
                  // Safeguard rule_type and rule_year
                  const typeA = a.rule_type || '';
                  const typeB = b.rule_type || '';
                  if (typeA !== typeB) return typeA === 'ER' ? 1 : -1;
                  const yearA = Number.isFinite(a.rule_year) ? a.rule_year : 0;
                  const yearB = Number.isFinite(b.rule_year) ? b.rule_year : 0;
                  return yearA - yearB;
                })
                .forEach(rule => { 
              %>
                <li class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-md-center rule-item">
                  <div class="d-flex flex-column flex-md-row align-items-md-center gap-2">
                    <% if(rule.rule_type === 'ER'){ %>
                      <span class="badge badge-er">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</span>
                      <span>‡∏â‡∏ö‡∏±‡∏ö‡∏ó‡∏µ‡πà <strong><%= rule.er_no %></strong> ‡∏û.‡∏®. <span class="rule-year"><%= rule.rule_year %></span></span>
                    <% } else { %>
                      <span class="badge badge-main">‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å</span>
                      <span>‡∏õ‡∏µ ‡∏û.‡∏®. <span class="rule-year"><%= rule.rule_year %></span></span>
                    <% } %>
                  </div>
                  <div class="rule-actions mt-2 mt-md-0">
                    <% if(!user){ %>
                      <a href="/auth/login" class="btn btn-sm btn-outline-primary"><i class="bi bi-box-arrow-in-right"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</a>
                    <% } else { %>
                      <a href="/rule/<%= rule.rule_id %>" class="btn btn-sm btn-outline-primary" target="_blank" title="‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î"><i class="bi bi-download"></i></a>
                      <% if(user && user.mClass=='admin'){ %>
                        <a href="/rule/delete/<%= rule.rule_id %>" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure?')" title="‡∏•‡∏ö"><i class="bi bi-trash"></i></a>
                      <% } %>
                    <% } %>
                  </div>
                </li>
              <% }) %>
            </ul>
          </div>
        </div>
      </div>
    <% }) %>
  </div>

  <!-- Pagination -->
  <nav class="mt-4">
    <ul class="pagination justify-content-center mb-0">
      <% for (let i = 1; i <= safeTotalPages; i++) { %>
        <li class="page-item <%= safeCurrentPage === i ? 'active' : '' %>">
          <a class="page-link" href="/rule?page=<%= i %><%= safeSearch ? '&search=' + encodeURIComponent(safeSearch) : '' %>"><%= i %></a>
        </li>
      <% } %>
    </ul>
  </nav>
</div>

<script>
// Highlight search keyword inside institution names (defensive)
try {
  (function(){
    const kw = (() => {
      try {
      const v = document.getElementById('rulePage').dataset.search || '';
      if (typeof v !== 'string') return '';
      const cleaned = v.normalize('NFC').trim().replace(/\s+/g,' ');
      return cleaned.length > 100 ? cleaned.slice(0,100) : cleaned;
      } catch(e) { return ''; }
    })();
    if(!kw) return;
    const safe = kw.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&');
    const pattern = new RegExp('(' + safe + ')','gi');
    document.querySelectorAll('#ruleAccordion .institution-name').forEach(el=>{
      el.innerHTML = el.textContent.replace(pattern,'<span class="highlight">$1</span>');
    });
  })();
} catch(e) { console.warn('Highlight error', e); }
</script>
<script>
// Embed mode with escaping and defensive data
(function(){
  const params = new URLSearchParams(window.location.search);
  const isEmbed = params.get('embed') === '1';
  if(!isEmbed) return;

  document.documentElement.classList.add('embedded');
  const limit = Math.max(1, parseInt(params.get('limit') || '5', 10));

  // Use server-side data if present, otherwise empty array
    const allRules = JSON.parse(document.getElementById('rulePage')?.dataset.rules || '[]');
    // Sort by latest rule_id desc and take top N
  allRules.sort((a,b) => ((b && b.rule_id) || 0) - ((a && a.rule_id) || 0));
  const items = allRules.slice(0, limit);

  const escapeHtml = s => String(s || '')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');

  const container = document.getElementById('rulePage');
  if(!container) return;

  container.innerHTML = `
    <div class="p-0">
      <h5 class="mb-3"><i class="bi bi-journal-text text-primary me-2"></i>‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h5>
      <ul class="list-group list-group-flush">
        ${items.map(item => {
          const type = item && item.rule_type === 'ER' ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°' : '‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å';
          const badgeClass = item && item.rule_type === 'ER' ? 'badge-er' : 'badge-main';
          return `
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2">
              <span class="badge ${badgeClass}">${type}</span>
              <strong>${escapeHtml(item && item.c_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô')}</strong>
              <small class="text-muted ms-2">‡∏û.‡∏®. ${escapeHtml(item && item.rule_year || '-')}</small>
            </div>
            <div>
              <a href="/rule/${item && item.rule_id}" class="btn btn-sm btn-outline-primary" target="_blank" title="‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î">
                <i class="bi bi-download"></i>
              </a>
            </div>
          </li>`;
        }).join('')}
      </ul>
      <div class="text-end mt-2">
        <a href="/rule" class="small text-decoration-none">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
      </div>
    </div>
  `;

  // Auto-resize iframe height
  const embedId = params.get('embedId') || 'rule';
  const postHeight = () => {
    const h = document.body.scrollHeight;
    try { window.parent.postMessage({ type: 'resize-embed', id: embedId, height: h }, '*'); } catch(_) {}
  };
  postHeight();
  if ('ResizeObserver' in window) new ResizeObserver(postHeight).observe(document.body);
  window.addEventListener('load', postHeight);
})();
</script>

<%- include('partials/footer') %>
