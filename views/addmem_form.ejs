<%- include('partials/header') %>

<div class="container mt-4">
  <h3 class="mb-4">
    <% if (action === 'edit') { %>
      ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
    <% } else { %>
      ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
    <% } %>
  </h3>

  <div class="row">
    <div class="col-md-8">
      <div class="card">
        <div class="card-body">
          <form action="<% if (action === 'edit') { %>/addmem/update/<%= record.addmem_id %><% } else { %>/addmem/save<% } %>" method="POST">
            
            <!-- Select Cooperative -->
            <div class="mb-3">
              <label for="addmem_code" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå/‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ <span class="text-danger">*</span></label>
              <select class="form-select" id="addmem_code" name="addmem_code" required>
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô --</option>
                <% (coops || []).forEach(coop => { %>
                  <option value="<%= coop.c_code %>" 
                    <% if (record && record.addmem_code === coop.c_code) { %>selected<% } %>>
                    <%= coop.c_name %> (<%= coop.c_code %>)
                  </option>
                <% }); %>
              </select>
              <div class="form-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>
            </div>

            <div class="mb-3">
              <label for="addmem_year" class="form-label">‡∏õ‡∏µ <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="addmem_year" name="addmem_year" 
                     value="<%= record.addmem_year || '' %>" required 
                     placeholder="‡πÄ‡∏ä‡πà‡∏ô 2026, 2569" autofocus>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="addmem_saman" class="form-label">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å <span class="text-danger">*</span></label>
                  <input type="number" class="form-control" id="addmem_saman" name="addmem_saman" 
                         value="<%= record.addmem_saman || '' %>" required 
                         placeholder="0" min="0">
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="addmem_somtob" class="form-label">‡∏™‡∏°‡∏ó‡∏ö <span class="text-danger">*</span></label>
                  <input type="number" class="form-control" id="addmem_somtob" name="addmem_somtob" 
                         value="<%= record.addmem_somtob || '' %>" required 
                         placeholder="0" min="0">
                </div>
              </div>
            </div>

            <!-- Hidden meta fields -->
            <input type="hidden" name="addmem_saveby" value="<%= (user && user.fullname) ? user.fullname : 'guest' %>" />
            <input type="hidden" name="addmem_savedate" value="<%= new Date().toISOString().slice(0,10) %>" />

            <div class="d-flex gap-2 mt-4">
              <button type="submit" class="btn btn-success">
                <% if (action === 'edit') { %>
                  üíæ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                <% } else { %>
                  üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                <% } %>
              </button>
              <a href="/addmem/list" class="btn btn-secondary">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</a>
              <% if (action === 'edit') { %>
                <a href="/addmem/add" class="btn btn-primary">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</a>
              <% } %>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î -->
      <% if (recentData && recentData.length > 0) { %>
      <div class="card">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (<%= recentData.length %> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0 table-sm">
              <thead class="table-light">
                <tr>
                  <th>‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô</th>
                  <th>‡∏õ‡∏µ</th>
                  <th>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
                  <% if(user && user.mClass=='kjs'){ %>
                  <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                  <% } %>
                </tr>
              </thead>
              <tbody>
                <% recentData.forEach(item => { %>
                  <tr>
                    <td class="fw-bold small"><%= item.c_name || item.addmem_code %></td>
                    <td class="small"><%= item.addmem_year %></td>
                    <td class="small"><%= item.addmem_saman %></td>
                    <% if(user && user.mClass=='kjs'){ %>
                    <td class="text-center text-nowrap">
                      <div class="btn-group btn-group-sm" role="group">
                        <a href="/addmem/edit/<%= item.addmem_id %>" class="btn btn-outline-warning btn-sm" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                          <i class="bi bi-pencil"></i>
                        </a>
                        <a href="/addmem/delete/<%= item.addmem_id %>" class="btn btn-outline-danger btn-sm" title="‡∏•‡∏ö" onclick="return confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?')">
                          <i class="bi bi-trash"></i>
                        </a>
                      </div>
                    </td>
                    <% } %>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>
        <div class="card-footer">
          <a href="/addmem/list" class="btn btn-outline-primary btn-sm">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
        </div>
      </div>
      <% } %>

      <!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ -->
      <div class="card mt-3">
        <div class="card-header bg-secondary text-white">
          <h6 class="mb-0">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</h6>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6">
              <div class="border-end">
                <h4 class="text-primary mb-1">
                  <%= recentData ? recentData.reduce((sum, item) => sum + parseInt(item.addmem_saman || 0), 0) : 0 %>
                </h4>
                <small class="text-muted">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
              </div>
            </div>
            <div class="col-6">
              <h4 class="text-success mb-1">
                <%= recentData ? recentData.reduce((sum, item) => sum + parseInt(item.addmem_somtob || 0), 0) : 0 %>
              </h4>
              <small class="text-muted">‡∏™‡∏°‡∏ó‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%- include('partials/footer') %>
