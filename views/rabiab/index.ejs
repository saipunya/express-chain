<%- include('../partials/header') %>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üìã ‡∏£‡∏∞‡∏ö‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå/‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</h2>
    <% if(user && user.mClass === 'kjs') { %>
      <a href="/rabiab/upload" class="btn btn-success">
        <i class="fas fa-plus"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
      </a>
    <% } %>
  </div>

  <!-- ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
  <div class="row mb-3">
    <div class="col-md-6">
      <div class="input-group">
        <input type="text" id="searchInput" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô/‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö" value="<%= search %>">
        <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">‡∏•‡πâ‡∏≤‡∏á</button>
      </div>
    </div>
  </div>

  <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏∞‡∏ö -->
  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö</th>
          <th>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th>
      
          <% if(user) { %>
            <th>Actions</th>
          <% } %>
        </tr>
      </thead>
      <tbody id="rabiabTable">
        <% rabiabs.forEach((rabiab, index) => { %>
          <tr>
            <td>
              <%= rabiab.ra_name %> <br/>
              [<strong><%= rabiab.c_name %></strong>]
              <% 
                const rabiabSavedDate = new Date(rabiab.ra_savedate);
                const currentDate = new Date();
                const diffDays = Math.ceil((currentDate - rabiabSavedDate) / (1000 * 60 * 60 * 24));
              %>
              <% if (diffDays <= 7) { %>
                <img src="https://websitearchive2020.nepa.gov.jm/new/images/gif/new-star.gif" alt="New" class="ms-2" style="width: 45px; height: 32px;" />
              <% } %>
            </td>
           
            <td>
              <%= new Date(rabiab.ra_approvedate).toLocaleDateString('th-TH') %>
              
            </td>
            
            <td class="text-nowrap">
              <% if(user) { %>
                <a href="/rabiab/download/<%= rabiab.ra_id %>" class="btn btn-sm btn-outline-primary" target="_blank">
                  <i class="fas fa-download"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                </a>
                <% }else{ %>
                <a href="/auth/login" class="btn btn-sm btn-outline-primary">
                  <i class="fas fa-download"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                </a>
                <% } %>
                <% if(user && user.mClass === 'admin') { %>
                  <form method="POST" action="/rabiab/delete/<%= rabiab.ra_id %>" class="d-inline" 
                        onsubmit="return confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ ? ‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢')">
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                      <i class="fas fa-trash"></i> ‡∏•‡∏ö
                    </button>
                  </form>
                  <% } %>
               
            </td>
          </tr>
        <% }); %>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <% if (totalPages > 1) { %>
    <nav>
      <ul class="pagination justify-content-center">
        <% for (let i = 1; i <= totalPages; i++) { %>
          <li class="page-item <%= currentPage === i ? 'active' : '' %>">
            <a class="page-link" href="?page=<%= i %><%= search ? '&search=' + search : '' %>"><%= i %></a>
          </li>
        <% } %>
      </ul>
    </nav>
  <% } %>
</div>

<%- include('../partials/footer') %>

<script>
  const searchInput = document.getElementById('searchInput');
  const rabiabTable = document.getElementById('rabiabTable');
  let searchTimeout;

  searchInput.addEventListener('keyup', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      const keyword = searchInput.value.toLowerCase();
      const rows = rabiabTable.querySelectorAll('tr');

      rows.forEach(row => {
        const rabiabName = row.children[0].innerText.toLowerCase();
        const instituteName = row.children[2].innerText.toLowerCase();
        const shouldShow = rabiabName.includes(keyword) || instituteName.includes(keyword);
        row.style.display = shouldShow ? '' : 'none';
      });
    }, 300); // ‡∏£‡∏≠ 300ms
  });

  function clearSearch() {
    searchInput.value = '';
    const rows = rabiabTable.querySelectorAll('tr');
    rows.forEach(row => {
      row.style.display = '';
    });
  }
</script>
