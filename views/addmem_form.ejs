<%- include('partials/header') %>

<div class="container mt-4">
  <h3 class="mb-4">
    <% if (action === 'edit') { %>
      ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
    <% } else { %>
      ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
    <% } %>
  </h3>

  <div class="row">
    <div class="col-md-7">
      <div class="card">
        <div class="card-body">
          <form action="<% if (action === 'edit') { %>/addmem/update/<%= record.addmem_id %><% } else { %>/addmem/save<% } %>" method="POST">
            
            <!-- Select Group First -->
            <div class="mb-3">
              <label for="c_group_filter" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° <span class="text-danger">*</span></label>
              <select class="form-select" id="c_group_filter" required>
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° --</option>
                <% 
                  // Use groups array from controller (DISTINCT)
                  const groupsList = groups || [];
                %>
                <% if (groupsList.length > 0) { %>
                  <% groupsList.forEach(item => { %>
                    <option value="<%= item.c_group %>">
                      <%= item.c_group.replace(/group(\d+)/, '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå $1') %>
                    </option>
                  <% }); %>
                <% } else { %>
                  <option value="">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</option>
                <% } %>
              </select>
              <div class="form-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå ‡πÄ‡∏ä‡πà‡∏ô group1</div>
            </div>

            <!-- Select Cooperative (filtered by group) -->
            <div class="mb-3">
              <label for="addmem_code" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå/‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ <span class="text-danger">*</span></label>
              <select class="form-select" id="addmem_code" name="addmem_code" required disabled>
                <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô --</option>
              </select>
              <div class="form-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>
            </div>

            <div class="mb-3">
              <label for="addmem_year" class="form-label">‡∏õ‡∏µ <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="addmem_year" name="addmem_year" 
                     value="<%= record.addmem_year || '' %>" required 
                     placeholder="‡πÄ‡∏ä‡πà‡∏ô 2026, 2569" autofocus>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="addmem_saman" class="form-label">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å <span class="text-danger">*</span></label>
                  <input type="number" class="form-control" id="addmem_saman" name="addmem_saman" 
                         value="<%= record.addmem_saman || '' %>" required 
                         placeholder="0" min="0">
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="addmem_somtob" class="form-label">‡∏™‡∏°‡∏ó‡∏ö <span class="text-danger">*</span></label>
                  <input type="number" class="form-control" id="addmem_somtob" name="addmem_somtob" 
                         value="<%= record.addmem_somtob || '' %>" required 
                         placeholder="0" min="0">
                </div>
              </div>
            </div>

            <!-- Hidden meta fields -->
            <input type="hidden" name="addmem_saveby" value="<%= (user && user.fullname) ? user.fullname : 'guest' %>" />
            <input type="hidden" name="addmem_savedate" value="<%= new Date().toISOString().slice(0,10) %>" />

            <div class="d-flex gap-2 mt-4">
              <button type="submit" class="btn btn-success">
                <% if (action === 'edit') { %>
                  üíæ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                <% } else { %>
                  üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                <% } %>
              </button>
              <a href="/addmem/list" class="btn btn-secondary">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</a>
              <% if (action === 'edit') { %>
                <a href="/addmem/add" class="btn btn-primary">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</a>
              <% } %>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-md-5">
      <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î -->
      <% if (recentData && recentData.length > 0) { %>
      <div class="card">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (<%= recentData.length %> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0 table-sm">
              <thead class="table-light">
                <tr>
                  <th>‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô</th>
                  <th>‡∏õ‡∏µ</th>
                  <th>‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
                  <% if (user && (user.mClass=='pbt' || user.mClass=='admin')) { %>
                  <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                  <% } %>
                </tr>
              </thead>
              <tbody>
                <% recentData.forEach(item => { %>
                  <tr>
                    <td class="fw-bold small"><%= item.c_name || item.addmem_code %></td>
                    <td class="small"><%= item.end_date %> (<%= item.addmem_year %>)</td>
                    <td class="small"><%= item.addmem_saman %></td>
                    <% if (user && (user.mClass=='pbt' || user.mClass=='admin')) { %>
                    <td class="text-center text-nowrap">
                      <div class="btn-group btn-group-sm" role="group">
                        <a href="/addmem/edit/<%= item.addmem_id %>" class="btn btn-outline-warning btn-sm" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                          <i class="bi bi-pencil"></i>
                        </a>
                        <a href="/addmem/delete/<%= item.addmem_id %>" class="btn btn-outline-danger btn-sm" title="‡∏•‡∏ö" onclick="return confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?')">
                          <i class="bi bi-trash"></i>
                        </a>
                      </div>
                    </td>
                    <% } %>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>
        <div class="card-footer">
          <a href="/addmem/list" class="btn btn-outline-primary btn-sm">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
        </div>
      </div>
      <% } %>

      <!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ -->
      <div class="card mt-3">
        <div class="card-header bg-secondary text-white">
          <h6 class="mb-0">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</h6>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6">
              <div class="border-end">
                <h4 class="text-primary mb-1">
                  <%= recentData ? recentData.reduce((sum, item) => sum + parseInt(item.addmem_saman || 0), 0) : 0 %>
                </h4>
                <small class="text-muted">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
              </div>
            </div>
            <div class="col-6">
              <h4 class="text-success mb-1">
                <%= recentData ? recentData.reduce((sum, item) => sum + parseInt(item.addmem_somtob || 0), 0) : 0 %>
              </h4>
              <small class="text-muted">‡∏™‡∏°‡∏ó‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Store all coops data from server
const allCoops = <%- JSON.stringify(coops || []) %>;
const recordCode = '<%= record && record.addmem_code ? record.addmem_code : "" %>';

console.log('üìä All Coops Data:', allCoops);
console.log('üîç Record Code:', recordCode);

// Function to format group name
function formatGroupName(groupCode) {
  if (!groupCode) return '';
  return groupCode.replace(/group(\d+)/, '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå $1');
}

// Function to filter cooperatives by selected group
function filterCoopsByGroup(selectedGroup) {
  const coopSelect = document.getElementById('addmem_code');
  
  console.log('üîÑ Filtering by group:', selectedGroup);
  
  // Clear existing options
  coopSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô --</option>';
  
  if (!selectedGroup) {
    coopSelect.disabled = true;
    console.log('‚ö†Ô∏è No group selected');
    return;
  }
  
  // Filter and add options
  const filteredCoops = allCoops.filter(coop => coop.c_group === selectedGroup);
  
  console.log('‚úÖ Filtered coops:', filteredCoops);
  
  if (filteredCoops.length === 0) {
    coopSelect.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ --</option>';
    coopSelect.disabled = true;
    console.log('‚ùå No coops found for this group');
    return;
  }
  
  filteredCoops.forEach(coop => {
    const option = document.createElement('option');
    option.value = coop.c_code;
    option.textContent = `${coop.c_name} (${coop.c_code})`;
    
    // Select if editing and matches record
    if (recordCode && coop.c_code === recordCode) {
      option.selected = true;
      console.log('‚ú® Selected option:', coop.c_name);
    }
    
    coopSelect.appendChild(option);
  });
  
  coopSelect.disabled = false;
  console.log('‚úÖ Dropdown populated with', filteredCoops.length, 'items');
}

// Event listener for group selection
document.getElementById('c_group_filter').addEventListener('change', function() {
  console.log('üëÅÔ∏è Group changed to:', this.value);
  filterCoopsByGroup(this.value);
});

// Initialize on page load (for edit mode)
document.addEventListener('DOMContentLoaded', function() {
  console.log('üìÑ Page loaded');
  console.log('üìã Total coops:', allCoops.length);
  
  <% if (action === 'edit' && record && record.addmem_code) { %>
    // Find the group of the current record
    const currentCoop = allCoops.find(c => c.c_code === recordCode);
    console.log('üéØ Current coop:', currentCoop);
    
    if (currentCoop && currentCoop.c_group) {
      const groupSelect = document.getElementById('c_group_filter');
      groupSelect.value = currentCoop.c_group;
      console.log('üîó Set group to:', currentCoop.c_group);
      filterCoopsByGroup(currentCoop.c_group);
    }
  <% } %>
});
</script>

<%- include('partials/footer') %>
