<%- include('../partials/header') %>

<div class="container mt-4">
  <h3>ЁЯУд р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╕гр╕░р╣Ар╕Ър╕╡р╕вр╕Ър╕кр╕лр╕Бр╕гр╕Ур╣М/р╕Бр╕ер╕╕р╣Ир╕бр╣Ар╕Бр╕йр╕Хр╕гр╕Бр╕г</h3>
  
  <form action="/rabiab/upload" method="POST" enctype="multipart/form-data">
    <div class="mb-3">
      <label for="c_group" class="form-label">р╕Бр╕ер╕╕р╣Ир╕бр╕кр╣Ир╕Зр╣Ар╕кр╕гр╕┤р╕бр╕кр╕лр╕Бр╕гр╕Ур╣М</label>
      <select id="c_group" class="form-select" required>
        <option value="">++ р╣Вр╕Ыр╕гр╕Фр╣Ар╕ер╕╖р╕нр╕Б ++</option>
        <option value="group1">р╕Бр╕ер╕╕р╣Ир╕бр╕кр╣Ир╕Зр╣Ар╕кр╕гр╕┤р╕бр╕кр╕лр╕Бр╕гр╕Ур╣М 1</option>
        <option value="group2">р╕Бр╕ер╕╕р╣Ир╕бр╕кр╣Ир╕Зр╣Ар╕кр╕гр╕┤р╕бр╕кр╕лр╕Бр╕гр╕Ур╣М 2</option>
        <option value="group3">р╕Бр╕ер╕╕р╣Ир╕бр╕кр╣Ир╕Зр╣Ар╕кр╕гр╕┤р╕бр╕кр╕лр╕Бр╕гр╕Ур╣М 3</option>
        <option value="group4">р╕Бр╕ер╕╕р╣Ир╕бр╕кр╣Ир╕Зр╣Ар╕кр╕гр╕┤р╕бр╕кр╕лр╕Бр╕гр╕Ур╣М 4</option>
        <option value="group5">р╕Бр╕ер╕╕р╣Ир╕бр╕кр╣Ир╕Зр╣Ар╕кр╕гр╕┤р╕бр╕кр╕лр╕Бр╕гр╕Ур╣М 5</option>
      </select>
    </div>
    
    <div class="mb-3">
      <label for="ra_code" class="form-label">р╕кр╕лр╕Бр╕гр╕Ур╣М/р╕Бр╕ер╕╕р╣Ир╕бр╣Ар╕Бр╕йр╕Хр╕гр╕Бр╕г</label>
      <select name="ra_code" id="ra_code" class="form-select" required>
        <option value="">-- р╣Ар╕ер╕╖р╕нр╕Бр╕Бр╕ер╕╕р╣Ир╕бр╕Бр╣Ир╕нр╕Щ --</option>
      </select>
    </div>

    <script>
      const cGroupSelect = document.getElementById('c_group');
      const raCodeSelect = document.getElementById('ra_code');

      cGroupSelect.addEventListener('change', async function () {
        const group = this.value;
        raCodeSelect.innerHTML = '<option value="">р╣Вр╕лр╕ер╕Ф...</option>';

        if (!group) {
          raCodeSelect.innerHTML = '<option value="">-- р╣Ар╕ер╕╖р╕нр╕Бр╕Бр╕ер╕╕р╣Ир╕бр╕Бр╣Ир╕нр╕Щ --</option>';
          return;
        }

        try {
          const response = await fetch(`/rabiab/coops/${group}`);
          const data = await response.json();

          if (Array.isArray(data) && data.length > 0) {
            raCodeSelect.innerHTML = '<option value="">-- р╣Ар╕ер╕╖р╕нр╕Бр╕кр╕лр╕Бр╕гр╕Ур╣М --</option>';
            data.forEach(coop => {
              const option = document.createElement('option');
              option.value = coop.c_code;
              option.text = coop.c_name;
              raCodeSelect.appendChild(option);
            });
          } else {
            raCodeSelect.innerHTML = '<option value="">р╣Др╕бр╣Ир╕Юр╕Ър╕кр╕лр╕Бр╕гр╕Ур╣Мр╣Гр╕Щр╕Бр╕ер╕╕р╣Ир╕б</option>';
          }
        } catch (error) {
          console.error('р╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕лр╕Бр╕гр╕Ур╣Мр╕ер╣Йр╕бр╣Ар╕лр╕ер╕з:', error);
          raCodeSelect.innerHTML = '<option value="">р╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф</option>';
        }
      });
    </script>

    <div class="mb-3">
      <label for="ra_name" class="form-label">р╕Кр╕╖р╣Ир╕нр╕гр╕░р╣Ар╕Ър╕╡р╕вр╕Ъ</label>
      <input type="text" name="ra_name" id="ra_name" class="form-control" required>
    </div>

    <div class="mb-3">
      <label for="ra_year" class="form-label"> р╕Ю.р╕и.</label>
      <!-- select now year+543 , now year+543 + 1, now year+543 -1  -->
       <%   
        const nowYear = new Date().getFullYear() 
       %>
       <select name="ra_year" class="form-select">
        <option value="<%= nowYear + 542 %>"><%= nowYear + 542 %></option>
        <option value="<%= nowYear + 543 %>" selected><%= nowYear + 543 %></option>
        <option value="<%= nowYear + 544 %>"><%= nowYear + 544 %></option>
      </select>
    </div>

    <div class="mb-3">
      <label for="ra_approvedate" class="form-label">р╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╕нр╕Щр╕╕р╕бр╕▒р╕Хр╕┤</label>
      <input type="date" name="ra_approvedate" id="ra_approvedate" class="form-control" required>
    </div>

    <div class="mb-3">
      <label for="file" class="form-label">р╣Др╕Яр╕ер╣М PDF</label>
      <input type="file" name="file" id="file" class="form-control" accept=".pdf" required>
    </div>

    <button type="submit" class="btn btn-success">р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Ф</button>
    <a href="/rabiab" class="btn btn-secondary">р╕вр╕Бр╣Ар╕ер╕┤р╕Б</a>
  </form>

  <hr>
  <h5 class="mt-5">ЁЯУВ р╣Др╕Яр╕ер╣Мр╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╕ер╣Ир╕▓р╕кр╕╕р╕Ф</h5>
  <table class="table table-bordered">
    <thead>
      <tr>
        
        <th>р╕Кр╕╖р╣Ир╕нр╕гр╕░р╣Ар╕Ър╕╡р╕вр╕Ъ</th>
        <th>р╕Ю.р╕и.</th>
        <th>р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╣Вр╕Фр╕в</th>
        <th>р╣Ар╕бр╕╖р╣Ир╕н</th>
        <th>р╣Др╕Яр╕ер╣М</th>
      </tr>
    </thead>
    <tbody>
      <% recentUploads.forEach(rabiab => { %>
        <tr>
          <td>
            <%= rabiab.ra_name %>
            <% 
              const rabiabSavedDate = new Date(rabiab.ra_savedate);
              const currentDate = new Date();
              const diffDays = Math.ceil((currentDate - rabiabSavedDate) / (1000 * 60 * 60 * 24));
            %>
            <% if (diffDays <= 7) { %>
              <img src="https://websitearchive2020.nepa.gov.jm/new/images/gif/new-star.gif" alt="New" class="ms-2" style="width: 45px; height: 32px;" />
            <% } %>
          </td>
          <td><%= rabiab.ra_year %></td>
          <td><%= rabiab.ra_saveby %></td>
          <td>
            <%= new Date(rabiab.ra_savedate).toLocaleDateString('th-TH') %>
          </td>
          <td>
            <a href="/rabiab/download/<%= rabiab.ra_id %>" class="btn btn-sm btn-outline-primary" target="_blank">
              ЁЯУД р╣Др╕Яр╕ер╣М
            </a>
          </td>
        </tr>
      <% }); %>
    </tbody>
  </table>
</div>

<%- include('../partials/footer') %>
