<%- include('partials/header',{title : '‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏†‡∏π‡∏°‡∏¥' }) %>

<!-- Added: Required Chart.js + plugin (fix graphs not showing) -->
<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<!-- Added: FullCalendar (for Activities calendar) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css" />
<script defer src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/locales-all.global.min.js"></script>

<!-- ================= Modern Global Styles (Refactored) ================ -->
<style>
  :root {
    --color-bg: #f1f3f5;
    --color-surface: #ffffff;
    --color-border: #dee2e6;
    --color-text: #1f2937;
    --color-muted: #6b7280;
    --color-accent: #0d6efd;
    --color-accent-grad: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
    --color-focus: #0d6efd;
    --color-primary: #0d6efd;
    --color-success: #198754;
    --color-warning: #ffc107;
    --color-danger: #dc3545;
    --radius-sm: .375rem;
    --radius: .5rem;
    --radius-lg: .75rem;
    --radius-xl: 1rem;
    --shadow-xs: 0 1px 2px rgba(0,0,0,.04);
    --shadow-sm: 0 1px 2px rgba(0,0,0,.05);
    --shadow: 0 1px 3px rgba(0,0,0,.08);
    --shadow-lg: 0 2px 6px rgba(0,0,0,.12);
    --shadow-hover: 0 2px 8px rgba(0,0,0,.12);
    --glass: rgba(255,255,255,0.95);
    --glass-blur: blur(6px) saturate(130%);
    --grad-accent: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
    --grad-success: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
    --grad-warm: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
    --transition: .2s ease;
    --transition-fast: .15s ease;
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --color-bg: #0f172a;
      --color-surface: #1e293b;
      --color-border: #334155;
      --color-text: #e2e8f0;
      --color-muted: #94a3b8;
      --glass: rgba(30,41,59,0.75);
      --shadow-sm: 0 4px 10px -2px rgba(0,0,0,.55);
      --shadow: 0 8px 28px -6px rgba(0,0,0,.65);
      --shadow-hover: 0 16px 44px -10px rgba(0,0,0,.85);
    }
    .modern-card, .hero-shell { border:1px solid var(--color-border); }
    .quick-nav a { color: var(--color-muted); }
    .quick-nav a.active { color: #fff; }
  }

  * { box-sizing: border-box; }
  
  body { 
    background: var(--color-bg); 
    color: var(--color-text);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  
  h1, h2, h3, h4, h5, h6 {
    font-weight: 600;
    letter-spacing: 0.2px;
  }
  
  a {
    color: var(--color-primary);
    text-decoration: none;
    transition: var(--transition-fast);
  }
  a:hover {
    color: #1d4ed8;
  }
  
  .container, .container-lg {
    max-width: 1200px;
  }

  /* Hero */
  .hero-shell {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    overflow: hidden;
    position: relative;
    box-shadow: var(--shadow-sm);
    min-height: 320px;
  }
  .hero-shell:before {
    display: none;
    content: none;
  }
  @keyframes heroGlow {
    0% { opacity: 0.7; }
    100% { opacity: 1; }
  }
  .hero-img-wrap {
    position:relative;
    height:100%;
  }
  .hero-img-wrap img {
    object-fit:cover;
    width:100%; height:100%;
    aspect-ratio: 4/3;
  }
  @media (min-width: 992px){
    .hero-img-wrap img { aspect-ratio: unset; }
  }
  .glass-pane {
    background: var(--glass);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    border-left: 1px solid rgba(255,255,255,0.3);
  }

  /* Hero image full cover override (added) */
  .hero-img-wrap { 
    min-height: 380px;
    position: relative;
    overflow: hidden;
  }
  .hero-img-wrap::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, transparent 50%, rgba(0,0,0,0.1) 100%);
    pointer-events: none;
  }
  .hero-img-wrap > img.hero-cover-img,
  .hero-img-wrap > img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }
  .hero-shell:hover .hero-img-wrap > img {
    transform: none;
  }

  /* Cards / Sections */
  .card {
    border-radius: var(--radius);
    overflow: hidden;
  }
  .modern-card {
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    background: var(--color-surface);
    box-shadow: none;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
  }
  .modern-card:hover {
    transform: none;
    box-shadow: var(--shadow-xs);
  }
  .modern-card::before {
    display: none;
    content: none;
  }
  .card-gradient-bar {
    display: none;
  }
  .modern-card .card-body {
    padding: 1.5rem;
  }
  .modern-card .card-header {
    background: transparent;
    border-bottom: 1px solid var(--color-border);
    padding: 1rem 1.5rem;
    font-weight: 600;
  }
  .modern-card .card-footer {
    background: #f8fafc;
    border-top: 1px solid var(--color-border);
    padding: 1rem 1.5rem;
  }
  
  .table-responsive {
    border-radius: var(--radius);
    background: #fff;
    border: 1px solid var(--color-border);
  }

  /* Section layout */
  .section-block {
    padding-block: 3rem;
    content-visibility: auto;
    contain-intrinsic-size: 800px;
  }
  .section-block.compact { padding-block: 2rem; }
  .section-block.bg-light { background: #f8fafc; }
  .section-block.bg-white { background: #ffffff; }
  
  .section-heading {
    font-weight: 700;
    letter-spacing: 0.5px;
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    position: relative;
    margin-bottom: 1.5rem;
    font-size: 1.25rem;
  }
  .section-heading:after {
    content: "";
    height: 4px;
    width: 50%;
    background: var(--grad-accent);
    position: absolute;
    left: 50%;
    bottom: -8px;
    transform: translateX(-50%);
    border-radius: 4px;
  }
  
  .section-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-primary);
    margin-bottom: 2rem;
    position: relative;
    display: inline-block;
  }
  .section-title i {
    margin-right: 0.5rem;
  }

  /* Lists */
  .list-group-item {
    border:0;
    border-bottom:1px solid var(--color-border);
    background:transparent;
  }
  .list-group-item:last-child { border-bottom:0; }

  /* Quick Nav */
  .quick-nav-wrapper {
    margin-top: -1.5rem;
    margin-bottom: 2rem;
    position: sticky;
    top: 70px;
    z-index: 1029;
  }
  .quick-nav {
    display: flex;
    gap: 0.5rem;
    overflow-x: auto;
    scrollbar-width: none;
    padding: 0.75rem 1rem;
    background: #ffffff;
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    box-shadow: none;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
  }
  .quick-nav::-webkit-scrollbar { display: none; }
  .quick-nav a {
    white-space: nowrap;
    font-size: 0.875rem;
    font-weight: 500;
    padding: 0.45rem 0.9rem;
    border-radius: 0.5rem;
    text-decoration: none;
    background: #f8f9fa;
    color: #495057;
    border: 1px solid #dee2e6;
    transition: var(--transition-fast);
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    animation: none;
  }
  
  @keyframes navSlideIn {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
  }

  /* Staggered Animation Delay for Quick Nav Items */
  .quick-nav a:nth-child(1) { animation-delay: 0.05s; }
  .quick-nav a:nth-child(2) { animation-delay: 0.1s; }
  .quick-nav a:nth-child(3) { animation-delay: 0.15s; }
  .quick-nav a:nth-child(4) { animation-delay: 0.2s; }
  .quick-nav a:nth-child(5) { animation-delay: 0.25s; }
  .quick-nav a:nth-child(6) { animation-delay: 0.3s; }
  .quick-nav a:nth-child(7) { animation-delay: 0.35s; }
  .quick-nav a:nth-child(8) { animation-delay: 0.4s; }
  .quick-nav a:nth-child(9) { animation-delay: 0.45s; }
  .quick-nav a:nth-child(10) { animation-delay: 0.5s; }
  .quick-nav a:nth-child(11) { animation-delay: 0.55s; }
  .quick-nav a:nth-child(12) { animation-delay: 0.6s; }
  .quick-nav a:nth-child(13) { animation-delay: 0.65s; }
  .quick-nav a:nth-child(14) { animation-delay: 0.7s; }
  .quick-nav a:nth-child(15) { animation-delay: 0.75s; }
  .quick-nav a:nth-child(16) { animation-delay: 0.8s; }
  .quick-nav a:nth-child(17) { animation-delay: 0.85s; }
  .quick-nav a:nth-child(18) { animation-delay: 0.9s; }
  .quick-nav a:nth-child(19) { animation-delay: 0.95s; }
  .quick-nav a:nth-child(20) { animation-delay: 1.0s; }
  .quick-nav a i {
    font-size: 0.9rem;
    opacity: 0.8;
  }
  .quick-nav a:hover {
    background: #e9ecef;
    transform: none;
    box-shadow: none;
  }
  .quick-nav a.active {
    background: #0d6efd;
    color: #fff;
    border-color: #0d6efd;
    box-shadow: none;
  }
  .quick-nav a.active i {
    opacity: 1;
  }

  /* Animations */
  .reveal {
    opacity: 1;
    transform: none;
    transition: none;
  }
  .reveal.in {
    opacity: 1;
    transform: none;
  }
  
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  
  @keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
  }

  .soft-badge {
    background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    color: #334155;
    border: 1px solid #cbd5e1;
    font-weight: 500;
    padding: 0.35rem 0.75rem;
    border-radius: 2rem;
    font-size: 0.8rem;
  }

  .activity-list li {
    position: relative;
    padding-left: 1.75rem;
    padding-bottom: 0.75rem;
    border-left: 2px solid #e2e8f0;
    margin-left: 0.5rem;
  }
  .activity-list li:last-child {
    border-left-color: transparent;
  }
  .activity-list li:before {
    content: "";
    position: absolute;
    left: -6px;
    top: 0.5rem;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--grad-success);
    box-shadow: 0 0 0 4px rgba(5,150,105,0.15);
  }

  /* Utility */
  .text-gradient {
    background: var(--grad-accent);
    background-clip: text;
    -webkit-background-clip: text;
    color: transparent;
  }
  .text-success { color: #059669 !important; }
  .text-primary { color: #2563eb !important; }
  .text-warning { color: #d97706 !important; }
  .text-danger { color: #dc2626 !important; }
  
  .shadow-focus:focus-visible {
    outline: 2px solid var(--color-focus);
    outline-offset: 3px;
  }
  .divider {
    height: 1px;
    background: linear-gradient(90deg, transparent 0%, var(--color-border) 50%, transparent 100%);
    margin: 2rem 0;
  }
  
  /* Buttons Enhancement */
  .btn {
    font-weight: 500;
    border-radius: 0.5rem;
    transition: var(--transition-fast);
  }
  .btn:hover {
    transform: none;
  }
  .btn-primary {
    background: #0d6efd;
    border-color: #0d6efd;
    box-shadow: none;
  }
  .btn-primary:hover {
    background: #0b5ed7;
    border-color: #0a58ca;
    box-shadow: none;
  }
  .btn-success {
    background: #198754;
    border-color: #198754;
    box-shadow: none;
  }
  .btn-success:hover {
    background: #157347;
    border-color: #146c43;
  }
  .btn-outline-primary {
    border: 1px solid #0d6efd;
    color: #0d6efd;
  }
  .btn-outline-primary:hover {
    background: #0d6efd;
    color: #fff;
  }
  .btn-outline-success {
    border: 1px solid #198754;
    color: #198754;
  }
  .btn-outline-success:hover {
    background: #198754;
    color: #fff;
  }

  @media (max-width: 575.98px) {
    .hero-shell { min-height: auto; }
    .section-heading { font-size:1.15rem; }
  }

  /* ================= Mobile Responsive Enhancements ================= */
  @media (max-width: 767.98px) {
    body {
      padding: 0;
      font-size: 14px;
    }
    
    .container, .container-lg {
      padding-left: 12px;
      padding-right: 12px;
    }
    
    /* Hero Section Mobile */
    .hero-shell {
      min-height: auto;
      border-radius: var(--radius);
    }
    
    .hero-shell .row {
      flex-direction: column;
    }
    
    .hero-img-wrap {
      min-height: 180px !important;
      max-height: 220px;
    }
    
    .glass-pane {
      padding: 16px !important;
      border-left: none;
      border-top: 1px solid var(--color-border);
    }
    
    .glass-pane h1.display-6 {
      font-size: 1.25rem;
    }
    
    .glass-pane .lead {
      font-size: 0.95rem;
    }
    
    .glass-pane .btn {
      padding: 8px 12px;
      font-size: 0.85rem;
      margin-bottom: 8px;
    }
    
    /* Quick Nav Mobile */
    .quick-nav-wrapper {
      margin-top: -0.5rem;
      margin-bottom: 1rem;
      top: 56px;
    }
    
    .quick-nav {
      padding: 8px 10px;
      gap: 6px;
    }
    
    .quick-nav a {
      padding: 6px 10px;
      font-size: 0.75rem;
    }
    
    /* Section Blocks Mobile */
    .section-block {
      padding-block: 1.25rem;
    }
    
    .section-title {
      font-size: 1.1rem !important;
    }
    
    .section-title:after {
      width: 50px;
      height: 3px;
    }
    
    /* Cards Mobile */
    .modern-card {
      border-radius: 12px;
    }
    
    .modern-card .card-body {
      padding: 12px;
    }
    
    .modern-card .card-header {
      padding: 10px 12px;
      font-size: 0.9rem;
    }
    
    .card-title {
      font-size: 0.95rem;
    }
    
    .display-6 {
      font-size: 1.5rem !important;
    }
    
    /* Stats Cards Mobile */
    #stats .col-md-4 {
      margin-bottom: 12px;
    }
    
    #stats .card-body {
      padding: 12px;
    }
    
    #stats .card-title {
      font-size: 0.85rem;
      margin-bottom: 4px;
    }
    
    #stats .card-text.display-6 {
      font-size: 1.4rem !important;
      margin-bottom: 8px;
    }
    
    /* Charts Mobile */
    .chart-container {
      height: 200px !important;
    }
    
    .chart-container--sm {
      height: 180px !important;
    }
    
    #charts .col-md-8,
    #charts .col-md-4 {
      padding: 0 8px;
    }
    
    /* Tables Mobile */
    .table {
      font-size: 0.8rem;
    }
    
    .table thead th {
      padding: 8px 6px;
      font-size: 0.75rem;
    }
    
    .table tbody td {
      padding: 8px 6px;
    }
    
    .table-responsive {
      margin: 0 -12px;
      padding: 0 12px;
    }
    
    /* Chamra Table Mobile - Horizontal Scroll */
    #chamra .table thead th,
    #chamra .table tbody td {
      min-width: 60px;
      font-size: 0.7rem;
      padding: 6px 4px;
    }
    
    #chamra .table thead th:first-child,
    #chamra .table tbody td:first-child {
      min-width: 120px;
      position: sticky;
      left: 0;
      background: #fff;
      z-index: 2;
    }
    
    .hp-badge {
      font-size: 0.6rem !important;
      padding: 2px 4px !important;
    }
    
    /* Groups Section Mobile */
    #groups .col-md-4 {
      margin-bottom: 10px;
    }
    
    #groups .badge {
      font-size: 0.75rem;
      padding: 6px 10px;
    }
    
    /* Featured Coops Mobile */
    #featured-coops .col-lg-4 {
      margin-bottom: 10px;
    }
    
    #featured-coops h6 {
      font-size: 0.85rem;
    }
    
    /* Members Section Mobile */
    #members .table {
      font-size: 0.75rem;
    }
    
    #members .table th,
    #members .table td {
      padding: 6px 8px;
    }
    
    /* Activities Section Mobile */
    #activitiesCalendar {
      min-height: 350px !important;
      font-size: 0.75rem;
    }
    
    #activitiesCalendar .fc-toolbar-title {
      font-size: 1rem !important;
    }
    
    #activitiesCalendar .fc-daygrid-day-number {
      font-size: 0.8rem;
    }
    
    /* Projects & Commands Mobile */
    #projects .col-md-6 {
      margin-bottom: 16px;
    }
    
    #projects .list-group-item {
      padding: 10px 8px;
      font-size: 0.85rem;
      flex-wrap: wrap;
    }
    
    #projects .badge {
      font-size: 0.7rem;
      margin-top: 4px;
    }
    
    /* Usecar Section Mobile */
    #usecar .col-md-6 {
      margin-bottom: 8px;
    }
    
    #usecar .list-group-item {
      padding: 10px;
    }
    
    #usecar .fw-bold {
      font-size: 0.9rem;
    }
    
    /* Online Section Mobile */
    #online .col-md-4,
    #online .col-md-8 {
      margin-bottom: 16px;
    }
    
    #online .display-4 {
      font-size: 2rem;
    }
    
    #online .col-md-4 .h4 {
      font-size: 1.1rem;
    }
    
    #online .col-md-6 img {
      width: 32px !important;
      height: 32px !important;
    }
    
    /* Modal Mobile */
    .modal-dialog {
      margin: 10px;
    }
    
    .modal-content {
      border-radius: 16px;
    }
    
    .modal-header {
      padding: 12px 16px;
    }
    
    .modal-body {
      padding: 16px;
    }
    
    .modal-title {
      font-size: 1rem;
    }
    
    /* Back to Top Mobile */
    .back-to-top {
      right: 12px;
      bottom: 12px;
      width: 40px;
      height: 40px;
    }
    
    /* Buttons Mobile */
    .btn {
      padding: 6px 12px;
      font-size: 0.85rem;
    }
    
    .btn-sm {
      padding: 4px 8px;
      font-size: 0.75rem;
    }
    
    /* Badge Mobile */
    .badge {
      font-size: 0.7rem;
    }
    
    /* Downloads Section Mobile */
    #downloads .table {
      font-size: 0.75rem;
    }
    
    /* Articles Section Mobile */
    #articles .card-body {
      padding: 10px;
    }
    
    /* Login Form Mobile */
    #loginFormCollapsible .form-label {
      font-size: 0.85rem;
    }
    
    #loginFormCollapsible .form-control {
      padding: 8px 12px;
      font-size: 0.9rem;
    }
    
    /* Row Gutters Mobile */
    .row.g-3 {
      --bs-gutter-x: 0.75rem;
      --bs-gutter-y: 0.75rem;
    }
    
    /* List Group Mobile */
    .list-group-item {
      padding: 10px 12px;
      font-size: 0.85rem;
    }
    
    /* Divider Mobile */
    .divider {
      margin: 1rem 0;
    }
  }

  /* Extra Small Devices (max-width: 375px) */
  @media (max-width: 375px) {
    body {
      font-size: 13px;
    }
    
    .hero-img-wrap {
      min-height: 150px !important;
    }
    
    .glass-pane {
      padding: 12px !important;
    }
    
    .quick-nav a {
      padding: 5px 8px;
      font-size: 0.7rem;
    }
    
    .display-6 {
      font-size: 1.25rem !important;
    }
    
    #stats .card-text.display-6 {
      font-size: 1.2rem !important;
    }
    
    .section-title {
      font-size: 1rem !important;
    }
    
    .chart-container {
      height: 180px !important;
    }
    
    .table {
      font-size: 0.7rem;
    }
    
    #activitiesCalendar {
      min-height: 300px !important;
    }
  }

  /* Extra polish */
  .table-hover tbody tr:hover { background: #f1f5f9; transition: .2s; }
  .modern-card .card-header { border-top-left-radius: inherit; border-top-right-radius: inherit; }
  
  .section-title { 
    position: relative; 
    padding-bottom: 1rem;
  }
  .section-title:after { 
    content: ""; 
    position: absolute; 
    left: 50%; 
    transform: translateX(-50%); 
    bottom: 0; 
    width: 80px; 
    height: 4px; 
    background: var(--grad-accent); 
    border-radius: 4px;
  }
  
  /* Back to Top Button */
  .back-to-top { 
    position: fixed; 
    right: 1.5rem; 
    bottom: 1.5rem; 
    z-index: 1040; 
    width: 50px; 
    height: 50px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    border-radius: 50%; 
    background: var(--grad-accent); 
    color: #fff; 
    box-shadow: 0 8px 24px -6px rgba(37,99,235,.4); 
    border: 0; 
    opacity: 0; 
    visibility: hidden; 
    transition: var(--transition);
    cursor: pointer;
  }
  .back-to-top:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: 0 12px 32px -8px rgba(37,99,235,.5);
  }
  .back-to-top.show { opacity: 1; visibility: visible; }
  .back-to-top:focus-visible { outline: 3px solid #fff; outline-offset: 3px; }
  .back-to-top i { font-size: 1.25rem; }
  
  /* Badges */
  .badge { 
    letter-spacing: 0.3px; 
    font-weight: 500;
    padding: 0.4rem 0.75rem;
    border-radius: 2rem;
  }
  .hp-badge { 
    font-size: 0.7rem; 
    padding: 0.25rem 0.5rem;
  }
  
  /* === Enhanced Modal Styling === */
  .modal-elevated .modal-content { 
    border: 0; 
    border-radius: 1.5rem; 
    box-shadow: 0 25px 60px -15px rgba(0,0,0,.35); 
    overflow: hidden; 
  }
  .modal-gradient { 
    background: var(--grad-accent); 
    color: #fff;
    padding: 1.25rem 1.5rem;
  }
  .modal-gradient .modal-title {
    font-weight: 600;
    font-size: 1.1rem;
  }
  .modal-gradient .btn-close { filter: invert(1) contrast(200%); opacity: 0.85; }
  .modal-gradient .btn-close:hover { opacity: 1; }
  .modal-body { background: #f8fafc; padding: 1.5rem; }
  .modal-section-divider { height: 1px; background: rgba(255,255,255,.15); margin: .35rem 0 0; }
  
  /* Tables */
  .table-modern thead th { 
    position: sticky; 
    top: 0; 
    background: #fff; 
    z-index: 5; 
    font-weight: 600; 
    box-shadow: 0 2px 0 0 #e2e8f0;
    padding: 1rem 0.75rem;
  }
  .table-modern tbody tr { transition: .25s; }
  .table-modern tbody tr:hover { background: #f1f5f9; }
  
  /* Loading */
  .loading-fade { animation: fadePulse 1.6s ease-in-out infinite; }
  @keyframes fadePulse { 0%,100% { opacity: .35;} 50% { opacity: 1;} }
  
  .badge-soft { 
    background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%); 
    color: #0369a1; 
    border: 1px solid #bae6fd; 
  }
  .modal-search-bar { 
    border-radius: 50px; 
    padding: 0.65rem 1.25rem; 
    border: 2px solid #e2e8f0; 
    background: #fff;
    transition: var(--transition-fast);
  }
  .modal-search-bar:focus {
    border-color: #2563eb;
    box-shadow: 0 0 0 4px rgba(37,99,235,0.1);
    outline: none;
  }
  .fade-in-row { animation: fadeInUp .45s cubic-bezier(.4,.8,.2,1); }
  
  /* List Group Enhancement */
  .list-group-item {
    border: 0;
    border-bottom: 1px solid #f1f5f9;
    padding: 1rem 1.25rem;
    transition: var(--transition-fast);
  }
  .list-group-item:last-child { border-bottom: 0; }
  .list-group-item:hover {
    background: #f8fafc;
  }

  /* Chart sizing to prevent stretching */
  .chart-container { position: relative; height: 300px; }
  .chart-container--sm { height: 250px; }
  @media (max-width: 575.98px) {
    .chart-container { height: 240px; }
    .chart-container--sm { height: 200px; }
  }

  /* Calendar sizing */
  #activitiesCalendar { 
    min-height: 520px;
    border-radius: var(--radius);
    overflow: hidden;
  }
  
  /* Stats Cards */
  #stats .card {
    text-align: center;
    transition: var(--transition);
  }
  #stats .card:hover {
    transform: translateY(-8px);
  }
  #stats .card-title {
    color: #64748b;
    font-size: 0.9rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
  }
  #stats .display-6 {
    font-weight: 700;
    margin-bottom: 0.75rem;
  }
  
  /* Form Controls */
  .form-control {
    border-radius: 0.75rem;
    border: 2px solid #e2e8f0;
    padding: 0.75rem 1rem;
    transition: var(--transition-fast);
  }
  .form-control:focus {
    border-color: #059669;
    box-shadow: 0 0 0 4px rgba(5,150,105,0.1);
  }
  .form-label {
    font-weight: 500;
    color: #475569;
    margin-bottom: 0.5rem;
  }
  
  /* Login Form */
  .login-form-wrapper {
    padding: 1rem;
  }
  .login-form-wrapper h5 {
    color: #1e293b;
    font-weight: 600;
    margin-bottom: 1.5rem;
  }

  /* Meeting room today */
  .meeting-today-card {
    background: linear-gradient(135deg, rgba(255,255,255,.92), rgba(255,255,255,.82));
    border: 1px solid rgba(15, 23, 42, 0.08);
    border-radius: 18px;
    box-shadow: 0 16px 40px rgba(15, 23, 42, 0.10);
    overflow: hidden;
  }
  .meeting-today-head {
    padding: 14px 16px;
    border-bottom: 1px solid rgba(15, 23, 42, 0.06);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    background:
      radial-gradient(1200px 200px at 10% 0%, rgba(99,102,241,.18), transparent 55%),
      radial-gradient(900px 260px at 100% 20%, rgba(16,185,129,.12), transparent 55%);
  }
  .meeting-today-title {
    font-weight: 800;
    letter-spacing: .2px;
    margin: 0;
    color: #0f172a;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .meeting-today-title .badge {
    font-weight: 700;
    border-radius: 999px;
    padding: 6px 10px;
    background: rgba(99,102,241,.12);
    color: #3730a3;
    border: 1px solid rgba(99,102,241,.18);
  }
  .meeting-today-body { padding: 12px 16px 14px; }
  .meeting-today-empty {
    padding: 12px 14px;
    background: rgba(15, 23, 42, 0.03);
    border: 1px dashed rgba(15, 23, 42, 0.18);
    border-radius: 14px;
    color: #334155;
  }
  .meeting-today-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 10px;
  }
  .meeting-today-item {
    display: grid;
    grid-template-columns: 120px 1fr;
    gap: 12px;
    align-items: start;
    padding: 12px;
    border: 1px solid rgba(15, 23, 42, 0.08);
    border-radius: 14px;
    background: rgba(255,255,255,.86);
  }
  .meeting-meta {
    display: grid;
    gap: 8px;
    font-size: .92rem;
    color: #334155;
  }
  .meeting-meta .pill {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 999px;
    padding: 6px 10px;
    font-weight: 800;
    background: rgba(16,185,129,.10);
    border: 1px solid rgba(16,185,129,.16);
    color: #065f46;
    width: fit-content;
  }
  .meeting-meta .time {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: #0f172a;
    font-weight: 800;
  }
  .meeting-subject {
    font-weight: 900;
    color: #0f172a;
    line-height: 1.25;
    margin: 0;
  }
  .meeting-subline { margin-top: 6px; color: #475569; font-size: .92rem; }
  @media (max-width: 767.98px) {
    .meeting-today-item { grid-template-columns: 1fr; }
    .meeting-meta { grid-auto-flow: column; grid-auto-columns: max-content; align-items: center; }
  }

  /* Meeting deadlines */
  .deadline-card {
    border: 1px solid var(--color-border);
  }
  .deadline-group {
    border-top: 1px solid var(--color-border);
    padding: 0.75rem 1rem 0.25rem;
    background: #f8f9fa;
  }
  .deadline-group:first-of-type { border-top: 0; }
  .deadline-group .badge {
    font-weight: 600;
    padding: 0.35rem 0.6rem;
    border-radius: 999px;
  }
  .deadline-table thead th {
    font-weight: 600;
    color: #495057;
  }
  .deadline-name {
    font-weight: 600;
  }
  .deadline-code {
    color: #6c757d;
    font-size: 0.85rem;
  }
  .deadline-date {
    font-weight: 600;
    color: #0d6efd;
  }
</style>

<!-- Added: Light theme & contrast fixes -->
<style>
  /* Force light theme to avoid unreadable dark auto-scheme */
  @media (prefers-color-scheme: dark) {
    :root {
      --color-bg: #f8fafc !important;
      --color-surface: #ffffff !important;
      --color-text: #1e293b !important;
      --color-border: #e2e8f0 !important;
    }
    body { background: #f8fafc !important; color: #1e293b !important; }
  }
  body { background: #f8fafc !important; color: #1e293b !important; }

  /* Ensure primary containers stay light */
  .hero-shell {
    background: var(--color-accent-grad) !important;
  }
  .modern-card,
  .quick-nav,
  .card,
  .table thead th,
  .table tbody td {
    background: #ffffff !important;
  }

  /* Text visibility */
  .text-dark,
  .card .text-dark,
  .table,
  .table td,
  .table th { color: #1e293b !important; }

  /* Table borders / striping */
  .table-bordered > :not(caption) > * { border-color: #e2e8f0 !important; }
  .table thead th { 
    background: #f8fafc !important; 
    font-weight: 600;
    color: #475569 !important;
  }
  .table-striped > tbody > tr:nth-of-type(odd) {
    --bs-table-accent-bg: #f8fafc;
    background: #f8fafc;
  }

  /* Chamra status badges readability */
  .hp-badge { font-size: 0.7rem; letter-spacing: 0.3px; }

  /* Badges general contrast */
  .badge.bg-secondary { background: #64748b !important; }
  .badge.bg-success { background: #059669 !important; }
  .badge.bg-info { background: #0284c7 !important; }
  .badge.bg-warning { background: #d97706 !important; color: #fff !important; }
  .badge.bg-danger { background: #dc2626 !important; }
  .badge.bg-primary { background: #2563eb !important; }

  /* Quick nav active clarity */
  .quick-nav a { color: #475569 !important; }
  .quick-nav a.active { color: #fff !important; }

  /* Remove any accidental dark backgrounds from Bootstrap utilities */
  [class*="bg-dark"] { background: #1e293b !important; }
</style>

<%
// Helper: map backend c_group codes to readable Thai names
function displayGroupName(code){
  switch(code){
    case 'group1': return '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå 1';
    case 'group2': return '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå 2';
    case 'group3': return '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå 3';
    case 'group4': return '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå 4';
    case 'group5': return '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå 5';
    default: return code || '-';
  }
}

// Meeting room locals (safe defaults in case some controller doesn't pass them)
const _meetingsToday = (typeof meetingsToday !== 'undefined' && Array.isArray(meetingsToday)) ? meetingsToday : [];
const _meetingroomTodayDate = (typeof meetingroomTodayDate !== 'undefined' && meetingroomTodayDate) ? meetingroomTodayDate : '';
%>

<!-- ================= Hero ================= -->
<div class="container my-3 mb-4 reveal in" id="top">
  <div class="hero-shell">
    <div class="row g-0 h-100 align-items-stretch">
       
      <div class="col-md-6 hero-img-wrap p-0 position-relative h-100">
        <img
          src="/images/banner.png"
          alt="Coop Image"
          class="w-100 h-100 object-fit-cover d-block"
          decoding="async"
          fetchpriority="high"
        />
      </div>
      <div class="col-md-6 glass-pane d-flex align-items-center p-4 h-100">
        <% if (!user) { %>
          <div class="w-100">

            <!-- Small screen toggle button (hidden on sm and up) -->
            <button type="button" id="showLoginBtn" class="btn btn-success w-100 d-sm-none py-3" aria-expanded="false" aria-controls="loginFormCollapsible">
              <i class="bi bi-box-arrow-in-right me-2"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
            </button>

            <!-- Wrapper gains d-none only on extra-small; visible on sm+ -->
            <div id="loginFormCollapsible" class="login-form-wrapper d-none d-sm-block">
              <h5 class="text-center mb-4 d-none d-sm-block">
                <i class="bi bi-shield-lock me-2 text-success"></i>‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
              </h5>
              <form action="/auth/login" method="POST">
                <div class="mb-3">
                  <label for="username" class="form-label">
                    <i class="bi bi-person me-1"></i> ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                  </label>
                  <input type="text" class="form-control" id="username" name="username" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" required />
                </div>
                <div class="mb-3">
                  <label for="password" class="form-label">
                    <i class="bi bi-key me-1"></i> ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
                  </label>
                  <input type="password" class="form-control" id="password" name="password" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required />
                </div>
                <div class="mb-3 form-check">
                  <input type="checkbox" class="form-check-input" id="rememberMe" name="rememberMe">
                  <label for="rememberMe" class="form-check-label">‡∏à‡∏î‡∏à‡∏≥‡∏â‡∏±‡∏ô</label>
                </div>
                <div class="d-grid mb-3">
                  <button type="submit" class="btn btn-success btn-lg">
                    <i class="bi bi-box-arrow-in-right me-2"></i>‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
                  </button>
                </div>
              </form>

              <p class="text-center text-muted mb-0">
                <i class="bi bi-person-plus me-1"></i> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ?
                <a href="/auth/register" class="text-success fw-semibold">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</a>
              </p>
            </div>
          </div>
          <script>
            (function(){
              const btn = document.getElementById('showLoginBtn');
              const wrap = document.getElementById('loginFormCollapsible');
              if(!btn || !wrap) return;
              function toggle(){
                const isHidden = wrap.classList.contains('d-none');
                if(isHidden){
                  wrap.classList.remove('d-none');
                  btn.setAttribute('aria-expanded','true');
                  btn.innerHTML = '<i class="bi bi-chevron-up me-2"></i> ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°';
                } else {
                  wrap.classList.add('d-none');
                  btn.setAttribute('aria-expanded','false');
                  btn.innerHTML = '<i class="bi bi-box-arrow-in-right me-2"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö';
                }
              }
              btn.addEventListener('click', toggle);
            })();
          </script>
        <% } else { %>
          <div class="w-100 text-center py-3">
            <h1 class="display-6 mb-3 text-success fw-bold">
              <i class="bi bi-emoji-smile me-2"></i>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö!
            </h1>
            <img src="<%= user.m_img %>" alt="User Image" class="rounded-circle mb-3 shadow" width="100" height="100" style="object-fit: cover; border: 4px solid rgba(255,255,255,0.8);" loading="lazy" decoding="async">
            <p class="lead mb-4 fw-semibold">
              <%= user.fullname %>
            </p>
            <div class="d-flex flex-wrap justify-content-center gap-2">
              <a href="/dashboard" class="btn btn-success">
                <i class="bi bi-speedometer2 me-1"></i> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
              </a>
              <% if(user && (user.mClass==='kjs' || user.mClass==='admin')) { %>
                
                <a href="/chamra" class="btn btn-outline-secondary">
                  <i class="bi bi-file-earmark-check me-1"></i> ‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
                </a>
              <% } %>
              <a href="/auth/logout" class="btn btn-outline-danger">
                <i class="bi bi-box-arrow-right me-1"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
              </a>
            </div>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- vong_coop link -->
<div class="container mb-4 reveal in">
  <div class="row my-2">
    <div class="col-md-6">
      <a href="/uploads/pdf/vong_coop.pdf" target="_blank" rel="noopener" class="d-inline-flex align-items-center gap-2 btn btn-primary btn-lg w-100" style="font-size:16px;">
      <i class="bi bi-globe2"></i>
      ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏¢‡∏∑‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô[‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£]
      </a>
    </div>
    <div class="col-md-6">
    <a href="/uploads/pdf/vong_group.pdf" target="_blank" rel="noopener" class="d-inline-flex align-items-center gap-2 btn btn-secondary btn-lg w-100" style="font-size:16px;">
    <i class="bi bi-globe2"></i>
    ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£[‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£]
    </a>
    </div>  
  </div>
</div>

<!-- ================= Meeting Room Today With Link ================= -->
<div class="container mb-4 reveal in">
  <div class="meeting-today-card">
    <div class="meeting-today-head">
      <h3 class="meeting-today-title">
        <span class="badge">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
        ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°
      </h3>
      <div class="d-flex align-items-center gap-3">
        <div class="text-muted small d-none d-sm-block">
          <% 
            let _thMeetingDate = _meetingroomTodayDate;
            if (_thMeetingDate) {
              const parts = _thMeetingDate.split('-');
              if (parts.length === 3) {
                const thMonths = [
                  "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô",
                  "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"
                ];
                const y = parseInt(parts[0]) + 543;
                const m = parseInt(parts[1]) - 1;
                const d = parseInt(parts[2]);
                if (!isNaN(y) && !isNaN(m) && !isNaN(d) && thMonths[m]) {
                   _thMeetingDate = `${d} ${thMonths[m]} ${y}`;
                }
              }
            }
          %>
          <%= _thMeetingDate %>
        </div>
        <a href="/meetingroom" class="btn btn-sm btn-outline-primary rounded-pill d-inline-flex align-items-center gap-1" style="font-weight: 600; font-size: 0.85rem;">
          <i class="bi bi-calendar-event"></i>
          ‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        </a>
      </div>
    </div>
    <div class="meeting-today-body">
      <% if (_meetingsToday.length) { %>
        <ul class="meeting-today-list">
          <% _meetingsToday.forEach(function(m){ %>
            <li class="meeting-today-item">
              <div class="meeting-meta">
                <div class="pill"><%= m.mee_room || '-' %></div>
                <div class="time">‚è± <%= m.mee_time || '-' %></div>
              </div>
              <div>
                <p class="meeting-subject"><%= m.mee_subject || '-' %></p>
                <% if (m.mee_respon) { %>
                  <div class="meeting-subline">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö: <%= m.mee_respon %></div>
                <% } %>
              </div>
            </li>
          <% }); %>
        </ul>
      <% } else { %>
        <div class="meeting-today-empty">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</div>
      <% } %>
    </div>
  </div>
</div>


<!-- ================= Meeting Deadlines ================= -->
<div class="container mb-4 reveal in">
  <div class="card modern-card shadow-sm border-0 deadline-card">
    <div class="card-header bg-white d-flex justify-content-between align-items-center flex-wrap gap-2">
      <h5 class="mb-0">
        <i class="bi bi-calendar2-week me-2 text-primary"></i>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô
      </h5>
      <span class="small text-muted">‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô <%= (typeof meetingDeadlineMonthLabel !== 'undefined' && meetingDeadlineMonthLabel) ? meetingDeadlineMonthLabel : '-' %></span>
    </div>
    <div class="card-body p-0">
      <% if ((meetingDeadlineGroups || []).length) { %>
        <% meetingDeadlineGroups.forEach((group) => { %>
          <div class="deadline-group d-flex justify-content-between align-items-center">
            <div class="fw-semibold text-primary"><%= displayGroupName(group.groupName) %></div>
            <span class="badge bg-primary-subtle text-primary">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <%= group.rows.length %> ‡πÅ‡∏´‡πà‡∏á</span>
          </div>
          <div class="table-responsive">
            <table class="table table-sm table-hover mb-0 deadline-table">
              <thead class="table-light">
                <tr>
                  <th>‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô</th>
                  <th class="text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÉ‡∏´‡∏ç‡πà</th>
                  <th class="text-center">‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏£‡∏≠‡∏ö‡∏õ‡∏µ</th>
                  <th class="text-center">‡∏ß‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÉ‡∏´‡∏ç‡πà</th>
                </tr>
              </thead>
              <tbody>
                <% group.rows.forEach((row) => { %>
                  <tr>
                    <td>
                      <div class="deadline-name"><%= row.c_name || '-' %></div>
                      <div class="deadline-code"><%= row.c_code || '' %></div>
                    </td>
                    <td class="text-center">
                      <% if (row.meetingDateThai) { %>
                        <span class="fw-semibold text-success"><%= row.meetingDateThai %></span>
                      <% } else { %>
                        <i class="bi bi-x-circle-fill text-danger" title="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 150 ‡∏ß‡∏±‡∏ô"></i>
                      <% } %>
                    </td>
                    <td class="text-center"><%= row.endDateThai %></td>
                    <td class="text-center deadline-date"><%= row.deadlineThai %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        <% }) %>
      <% } else { %>
        <div class="text-center text-muted py-3">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏£‡∏≠‡∏ö‡∏õ‡∏µ‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
      <% } %>
    </div>
  </div>
</div>

<!-- ================= Stats ================= -->
<section id="stats" class="section-block pt-4">
  <div class="container">
    <h2 class="my-4 text-center text-primary section-title">
      <i class="bi bi-bar-chart-line-fill me-2"></i> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå
    </h2>
    <div class="row g-4 mt-2">
      <div class="col-md-4">
        <div class="card modern-card shadow-sm border-0 h-100">
          <div class="card-gradient-bar" style="background: var(--grad-success);"></div>
          <div class="card-body text-center py-4">
            <div class="mb-3">
              <span class="d-inline-flex align-items-center justify-content-center rounded-circle bg-success bg-opacity-10" style="width: 60px; height: 60px;">
                <i class="bi bi-building text-success" style="font-size: 1.75rem;"></i>
              </span>
            </div>
            <h5 class="card-title text-muted mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå</h5>
            <p class="card-text display-5 text-success fw-bold mb-3">
              <%= stats.coop %>
            </p>
            <span class="badge bg-success bg-opacity-10 text-white mb-3">‡πÅ‡∏´‡πà‡∏á</span>
            <div class="mt-2">
              <a class="btn btn-sm btn-outline-success rounded-pill px-3" href="/allCoop/group">
                <i class="bi bi-arrow-right-circle me-1"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
              </a>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card modern-card shadow-sm border-0 h-100">
          <div class="card-gradient-bar" style="background: linear-gradient(135deg, #0284c7 0%, #06b6d4 100%);"></div>
          <div class="card-body text-center py-4">
            <div class="mb-3">
              <span class="d-inline-flex align-items-center justify-content-center rounded-circle bg-info bg-opacity-10" style="width: 60px; height: 60px;">
                <i class="bi bi-people-fill text-info" style="font-size: 1.75rem;"></i>
              </span>
            </div>
            <h5 class="card-title text-muted mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</h5>
            <p class="card-text display-5 text-info fw-bold mb-3">
              <%= stats.farmer %>
            </p>
            <span class="badge bg-info bg-opacity-10 text-info mb-3">‡πÅ‡∏´‡πà‡∏á</span>
            <div class="mt-2">
              <a class="btn btn-sm btn-outline-info rounded-pill px-3" href="/allCoop/group">
                <i class="bi bi-arrow-right-circle me-1"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
              </a>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card modern-card shadow-sm border-0 h-100">
          <div class="card-gradient-bar" style="background: var(--grad-warm);"></div>
          <div class="card-body text-center py-4">
            <div class="mb-3">
              <span class="d-inline-flex align-items-center justify-content-center rounded-circle bg-warning bg-opacity-10" style="width: 60px; height: 60px;">
                <i class="bi bi-hourglass-split text-warning" style="font-size: 1.75rem;"></i>
              </span>
            </div>
            <h5 class="card-title text-muted mb-2">‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h5>
            <p class="card-text display-5 text-warning fw-bold mb-3">
              <%= stats.closing %>
            </p>
            <span class="badge bg-warning bg-opacity-10 text-warning mb-3">‡πÅ‡∏´‡πà‡∏á</span>
            <div class="mt-2">
              <a class="btn btn-sm btn-outline-warning rounded-pill px-3" href="/chamra">
                <i class="bi bi-arrow-right-circle me-1"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>



<!-- ================= Charts ================= -->
<section id="charts" class="section-block bg-white">
  <div class="container-lg">
    <div class="row g-4 justify-content-center">
      <div class="col-lg-8">
        <div class="card modern-card shadow-sm border-0">
          <div class="card-gradient-bar"></div>
          <div class="card-body p-4">
            <h4 class="mb-4 text-center text-primary fw-semibold">
              <i class="bi bi-bar-chart-fill me-2"></i> ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå/‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£
            </h4>
            <div class="chart-container">
              <canvas id="coopChart" height="120"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card modern-card shadow-sm border-0 h-100">
          <div class="card-gradient-bar"></div>
          <div class="card-body p-4">
            <h4 class="mb-4 text-center text-primary fw-semibold">
              <i class="bi bi-pie-chart-fill me-2"></i> ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô
            </h4>
            <div class="chart-container chart-container--sm d-flex justify-content-center" >
              <canvas id="coopPieChart" height="120" ></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<% // Precompute chamra stage counts once (S1..S10)
  let __chamraCounts = null;
  if ((chamraAllProcesses||[]).length) {
    __chamraCounts = {};
    for (let i=1;i<=10;i++) __chamraCounts['S'+i] = 0;
    const __isEmptyChamra = (v) => {
      if (!v) return true;
      if (typeof v === 'string') {
        if (v === '0000-00-00') return true;
        if (/^1899-11-30/.test(v)) return true;
      }
      const d = new Date(v);
      return isNaN(d.getTime()) || d.getFullYear() < 1950;
    };
    // Count by highest achieved stage only, using all records from chamra_process
    (chamraAllProcesses||[]).forEach(p => {
      for (let i=10;i>=1;i--) {
        const raw = p['pr_s'+i];
        if (!__isEmptyChamra(raw)) { __chamraCounts['S'+i]++; break; }
      }
    });
  }
%>


<!--  -->


<!-- Modal ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå/‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£ ‡∏ï‡∏≤‡∏° group -->
<div class="modal fade modal-elevated" id="groupItemsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header modal-gradient py-2">
        <h5 class="modal-title mb-0 d-flex align-items-center gap-2" id="groupItemsModalLabel"><i class="bi bi-diagram-3"></i> ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="groupItemsLoading" class="text-center py-5">
          <div class="spinner-border text-light mb-3" role="status"></div>
          <div class="small text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        </div>
        <div id="groupItemsError" class="alert alert-danger d-none"></div>
        <ul id="groupItemsList" class="list-group d-none"></ul>
      </div>
    </div>
  </div>
</div>

<!-- ================= Featured Coops (New) ================= -->
<section id="featured-coops" class="section-block bg-light">
  <div class="container">
    <h2 class="text-center text-primary section-title mb-4">üè¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô</h2>
    <% if ((homeCoops||[]).length) { %>
      <% const _featuredCoops = (homeCoops||[]).slice().sort(()=> Math.random() - 0.5).slice(0,6); %>
      <div class="row g-3">
        <% _featuredCoops.forEach(c => { %>
          <div class="col-12 col-sm-6 col-lg-4">
            <div class="card modern-card h-100 shadow-sm border-0">
              <div class="card-gradient-bar"></div>
              <div class="card-body d-flex flex-column">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <span class="badge <%= c.coop_group==='‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå' ? 'bg-success' : 'bg-info' %>"><%= c.coop_group %></span>
                  <span class="badge bg-secondary"><%= c.c_group || '-' %></span>
                </div>
                <h6 class="fw-semibold mb-1 text-truncate" title="<%= c.c_name %>"><i class="bi bi-building me-1 text-primary"></i><%= c.c_name %></h6>
                <div class="text-muted small mb-3">‡∏£‡∏´‡∏±‡∏™: <%= c.c_code %></div>
                <div class="mt-auto d-grid">
                  <!-- Changed: link -> button triggers modal -->
                  <a href="/allCoop/profile/<%= c.c_code %>" data-code="<%= c.c_code %>" class="btn btn-sm btn-outline-primary js-coop-detail" role="button" aria-label="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î <%= c.c_name %>">
                    <i class="bi bi-box-arrow-up-right me-1"></i>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                  </a>
                </div>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
      <div class="text-center mt-4">
        <a href="/allCoop/group" class="btn btn-primary px-4"><i class="bi bi-grid-3x3-gap me-1"></i> ‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
      <% } else { %>
      <div class="alert alert-light border text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
    <% } %>
  </div>
</section>

<!-- Modal for Coop Detail (added) -->
<div class="modal fade modal-elevated" id="coopDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header modal-gradient py-2">
        <h5 class="modal-title d-flex align-items-center gap-2 mb-0" id="coopDetailModalLabel"><i class="bi bi-building"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <div id="coopDetailLoading" class="text-center py-5">
          <div class="spinner-border text-primary mb-3" role="status"></div>
          <div class="small text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        </div>
        <div id="coopDetailError" class="alert alert-danger m-3 d-none"></div>
        <div id="coopDetailContent" class="p-3 d-none"></div>
      </div>
    </div>
  </div>
</div>

<!-- chamra section -->
<section id="chamra" class="section-block">
  <% if ((chamraAllProcesses || []).length) { %>
    <!-- Chamra stages chart -->
    <div class="card modern-card shadow-sm border-0 mt-3">
      <div class="card-gradient-bar"></div>
      <div class="card-body">
        <h6 class="mb-3 text-primary">
          <i class="bi bi-graph-up-arrow me-2"></i> ‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô (S1‚ÄìS10)
        </h6>
        <div class="chart-container chart-container--sm">
          <canvas id="chamraStageChart" height="120" aria-label="Chamra stages chart"></canvas>
        </div>
        <small class="text-muted d-block mt-2">‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô‡∏ï‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô chamra_process)</small>
      </div>
    </div>

    <!-- Use precomputed __chamraCounts -->
    <div id="chamra-stage-data" data-stages='<%- JSON.stringify(__chamraCounts) %>' hidden></div>
  <% } %>
  <div class="container">
    <div class="card shadow-sm border-0">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h6 class="mb-0">
          <i class="bi bi-activity me-2"></i> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        </h6>
        
      </div>

      <% if ((homeProcesses || []).length) { %>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm table-bordered table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th class="ps-3">‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô</th>
                  <th class="text-center">S1</th>
                  <th class="text-center">S2</th>
                  <th class="text-center">S3</th>
                  <th class="text-center">S4</th>
                  <th class="text-center">S5</th>
                  <th class="text-center">S6</th>
                  <th class="text-center">S7</th>
                  <th class="text-center">S8</th>
                  <th class="text-center">S9</th>
                  <th class="text-center">S10</th>
                </tr>
              </thead>
              <tbody>
                <%
                  const isEmptyDate = (v) => {
                    if (!v) return true;
                    if (typeof v === 'string') {
                      if (v === '0000-00-00') return true;
                      if (/^1899-11-30/.test(v)) return true;
                    }
                    const d = new Date(v);
                    return isNaN(d.getTime()) || d.getFullYear() < 1950;
                  };
                  const formatThai = (v) => {
                    const d = new Date(v);
                    if (isNaN(d.getTime())) return '-';
                    const m = ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'][d.getMonth()];
                    return `${d.getDate()} ${m} ${d.getFullYear()+543}`;
                  };
                %>
                <% homeProcesses.forEach(p => { %>
                  <tr>
                    <td class="ps-3 small fw-semibold text-dark">
                      <i class="bi bi-building me-1 text-primary"></i>
                      <%= p.c_name || p.pr_code %>
                    </td>
                    <% for (let i=1;i<=10;i++){ const key='pr_s'+i; const raw=p[key]; %>
                      <td class="text-center">
                        <% if (isEmptyDate(raw)) { %>
                          <span class="badge rounded-pill bg-secondary hp-badge px-2">-</span>
                        <% } else { %>
                          <span class="badge rounded-pill bg-success hp-badge px-2"><%= formatThai(raw) %></span>
                        <% } %>
                      </td>
                    <% } %>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card-footer bg-light d-flex justify-content-between align-items-center">
          <small class="text-muted">
            <i class="bi bi-info-circle me-1"></i>
            ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß = ‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà | ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤ = ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          </small>
          <a href="/chamra" class="btn btn-primary btn-sm">
            ‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
          </a>
        </div>
      <% } else { %>
        <div class="card-body">
          <div class="text-center text-muted py-3">
            <i class="bi bi-inbox fs-3 d-block mb-2"></i>
            ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á
          </div>
        </div>
      <% } %>
    </div>

   
  </div>
</section>



<!-- ================= Activities & Image (replaced image with calendar) ================= -->
<section id="activities" class="section-block">
  <div class="container-lg">
    <div class="row">
      <div class="col-12 mb-3 mb-md-0">
        <div class="card modern-card shadow-sm border-0 h-100">
          <div class="card-gradient-bar"></div>
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="text-primary mb-0"><i class="bi bi-calendar-event me-2 text-success"></i> ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h5>
              <button id="openActivityListBtn" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-list-ul me-1"></i> ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
              </button>
            </div>
            <div id="activitiesCalendar"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<!-- List of activity -->
<section>
  <div class="container">
    <div class="col-12">
      <div class="card modern-card shadow-sm border-0">
        <div class="card-gradient-bar"></div>
        <div class="card-body">
          <h5 class="text-primary"><i class="bi bi-calendar-event me-2 text-success"></i> ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h5>
          <% 
            const now = new Date(); 
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          %>
          <ul class="list-group list-group-flush">
            <% activity
              .filter(acti => { 
                const d = new Date(acti.date_act); 
                const actDateOnly = new Date(d.getFullYear(), d.getMonth(), d.getDate());
                return actDateOnly >= today && actDateOnly <= lastDayOfMonth; 
              })
              .forEach(acti => { %>
              <li class="list-group-item">
                <i class="bi bi-calendar-event me-2 text-success"></i>
                <% const actDate = new Date(acti.date_act); %>
                <%= actDate.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' }) %> - 
                <%= acti.activity %>
                <% if (actDate.toDateString() === now.toDateString()) { %>
                  <span class="badge bg-danger ms-2"><i class="bi bi-stars"></i> ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
                <% } %>
              </li>
            <% }) %>
          </ul>
        </div>
      </div>
      <div class="text-end mt-2">
        <a href="/gitgum/list" class="btn btn-primary btn-sm px-4 shadow-sm">
          ‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        </a>
      </div>
    </div>
  </div>
</section>

<!-- Activity single detail modal -->
<div class="modal fade modal-elevated" id="activityModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header modal-gradient py-2">
        <h5 class="modal-title mb-0"><i class="bi bi-info-circle me-1"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <dl class="row mb-0">
          <dt class="col-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</dt><dd class="col-8" id="acDate">-</dd>
          <dt class="col-4">‡πÄ‡∏ß‡∏•‡∏≤</dt><dd class="col-8" id="acTime">-</dd>
          <dt class="col-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</dt><dd class="col-8" id="acPlace">-</dd>
          <dt class="col-4">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</dt><dd class="col-8" id="acTitle">-</dd>
          <!-- Added: show participants / co_person -->
          <dt class="col-4">‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</dt><dd class="col-8" id="acParticipants">-</dd>
        </dl>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>

<!-- Activity list modal -->
<div class="modal fade modal-elevated" id="activityListModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header modal-gradient py-2">
        <h5 class="modal-title mb-0"><i class="bi bi-list-ul me-1"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <input type="text" class="modal-search-bar" id="activityFilter" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°..."/>
          <div class="small text-muted" id="activityCount"></div>
        </div>
        <div class="table-responsive">
          <table class="table table-sm table-modern table-bordered table-hover align-middle mb-0">
            <thead>
              <tr class="text-center">
                <th style="width:56px;">#</th>
                <th class="text-start">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                <th class="text-start">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
              </tr>
            </thead>
            <tbody id="activityTbody">
              <% (activity||[]).forEach((a,i)=>{ const d=new Date(a.date_act); %>
                <tr data-name="<%= (a.activity||'').toLowerCase() %> <%= d.toISOString().slice(0,10) %>">
                  <td class="text-center"><%= i+1 %></td>
                  <td><%= d.toLocaleDateString('th-TH', { year:'numeric', month:'long', day:'numeric'}) %></td>
                  <td><%= a.activity %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>
</div>

<!-- ================= Latest Projects & Commands ================= -->
<section id="projects" class="section-block bg-light">
  <div class="container-lg">
    <div class="row">
      <div class="col-md-6">
        <h2 class="mb-4 text-center text-primary section-title">
          <i class="bi bi-file-earmark-pdf me-2"></i> ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        </h2>
        <div class="card modern-card shadow-sm border-0">
          <div class="card-gradient-bar"></div>
          <div class="card-body">
            <ul class="list-group list-group-flush">
              <% (lastProjects || []).forEach((p, idx)=> { %>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span>
                    <strong>
                      <%= idx + 1 %>.
                    </strong>
                    <%= p.pro_story %>
                      <span class="badge bg-secondary ms-2">
                        <%= p.pro_no %>
                      </span>
                  </span>
                  <% if(user){ %>
                    <a href="/project/download/<%= p.pro_id %>" class="btn btn-sm btn-outline-primary"
                      target="_blank">
                      <i class="bi bi-file-pdf-fill"></i>
                    </a>
                  <% } %>
                </li>
              <% }) %>
            </ul>
            <div class="text-end mt-2">
              <a href="/project" class="btn btn-primary btn-sm px-4 shadow-sm">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <h2 class="mb-4 text-center text-primary section-title">
          <i class="bi bi-megaphone-fill me-2"></i> ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        </h2>
        <div class="card modern-card shadow-sm border-0">
          <div class="card-gradient-bar"></div>
          <div class="card-body">
            <ul class="list-group list-group-flush">
              <% (lastCommands || []).forEach((c, idx)=> { %>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <span>
                    <strong>
                      <%= idx + 1 %>.
                    </strong>
                    <%= c.com_story %>
                      <span class="badge bg-secondary ms-2">
                        <%= c.com_no %>
                      </span>
                  </span>
                  <% if(user){ %>
                    <a href="/command/download/<%= c.command_id %>" class="btn btn-sm btn-outline-primary"
                      target="_blank">
                      <i class="bi bi-file-earmark-arrow-down"></i>
                    </a>
                  <% } %>
                </li>
              <% }) %>
            </ul>
            <div class="text-end mt-2">
              <a href="/command" class="btn btn-primary btn-sm px-4 shadow-sm">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section id="rules" class="section-block bg-white">
  <div class="container-lg">
    <div class="card modern-card mb-4">
      <div class="card-gradient-bar"></div>
      <div class="card-header bg-success text-white">
        <i class="bi bi-file-earmark-text me-2"></i> ‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
      </div>
      <div class="card-body">
        <% 
          // Helper: return true when date is within last N days (defaults to 3)
          function isRecentDate(dstr, days=3){
            if(!dstr) return false;
            if(typeof dstr === 'string'){
              if(dstr === '0000-00-00') return false;
              if(/^1899-11-30/.test(dstr)) return false;
            }
            const d = new Date(dstr);
            if(isNaN(d.getTime())) return false;
            const now = Date.now();
            const diff = now - d.getTime();
            return diff >= 0 && diff <= (days * 24 * 60 * 60 * 1000);
          }
        %>
        <div class="table-responsive">
          <table class="table table-sm table-bordered table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö</th>
                <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                <th>‡∏õ‡∏µ</th>
                <th>‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå</th>
              </tr>
            </thead>
            <tbody>
              <% (ruleFiles || []).forEach(rule => { 
                   // try common date fields if present
                   const dateField = rule.rule_savedate || rule.savedate || rule.created_at || rule.rule_date;
                   const isNew = isRecentDate(dateField, 3);
              %>
                <tr>
                  <td>
                    <%= rule.rule_name %>
                    <% if(isNew) { %>
                      <span class="badge bg-danger ms-2">new</span>
                    <% } %>
                  </td>
                  <td>
                    <% if(rule.rule_type === 'ER') { %>
                      ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° <%= rule.er_no %>
                    <% } else { %>
                      ‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å
                    <% } %>
                  </td>
                  <td><%= rule.rule_year %></td>
                  <td>
                    <% if(rule.rule_id) { %>
                      <a href="/rule/file/<%= rule.rule_id %>" target="_blank" class="btn btn-sm btn-outline-primary">
                        ‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå
                      </a>
                    <% } else { %>
                      <span class="text-muted">-</span>
                    <% } %>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
        <div class="text-end mt-2">
          <a href="/rule" class="btn btn-success btn-sm px-4 shadow-sm">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
        </div>
      </div>
    </div>
  </div>
</section>

<%- include('home/vong-latest.ejs') %>


<section id="downloads" class="section-block bg-white">
  <div class="container-lg">
    <div class="card modern-card">
      <div class="card-gradient-bar"></div>
      <div class="card-header bg-success text-white">
        <i class="bi bi-trophy me-2"></i> Top 10 ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm table-bordered table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th style="width:56px;" class="d-none d-sm-table-cell">#</th>
                <th>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
                <th class="text-nowrap">‡πÑ‡∏ü‡∏•‡πå</th>
                <th class="text-center">‡∏•‡∏¥‡∏á‡∏Å‡πå</th>
                <th class="text-nowrap">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
              </tr>
            </thead>
            <tbody id="topDownloadsTbody">
              <tr><td colspan="5" class="text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-footer bg-light text-end">
        <a href="/down" class="btn btn-sm btn-outline-secondary">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
      </div>
    </div>
  </div>
</section>
<!-- ================= Articles (List View) ================= -->


<section id="usecar" class="section-block">
  <div class="container-lg">
    <div class="row mt-4" id="usecarSection">
      <div class="col-12">
        <h2 class="mb-4 text-center text-primary section-title">
          <i class="bi bi-car-front-fill me-2"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ
        </h2>
        <div class="card modern-card shadow-sm border-0">
          <div class="card-gradient-bar"></div>
          <div class="card-body">
            <div class="row">
              <% usecars.slice(0, 5).forEach((usecar)=> { %>
                <div class="col-12 col-md-6 mb-3">
                  <div class="list-group">
                    <div class="list-group-item">
                      <div class="d-flex justify-content-between align-items-start">
                        <div class="ms-2 me-auto">
                          <% const date=new Date(usecar.date_car); const options={ year: 'numeric' , month: 'long' ,
                            day: 'numeric' }; const thaiDate=date.toLocaleDateString('th-TH', options); const
                            today=new Date(); const
                            isToday=today.toLocaleDateString('th-TH')===date.toLocaleDateString('th-TH'); %>
                            <div class="fw-bold text-success mb-1">
                              <i class="bi bi-calendar-event me-1"></i>
                              <%= thaiDate %>
                                <span class="text-muted">(<i class="bi bi-clock"></i>
                                  <%= usecar.time_car + ' ‡∏ô.' %>)
                                </span>
                                <% if (isToday) { %>
                                  <span class="badge bg-danger ms-2"><i class="bi bi-stars"></i> ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>
                                <% } %>
                            </div>
                            <div class="text-dark mb-1">
                              <i class="bi bi-geo-alt-fill text-danger me-1"></i>
                              <%= usecar.place_car %>
                            </div>
                            <small class="text-muted d-block mb-2">
                              <i class="bi bi-clipboard2-check me-1"></i>
                              <%= usecar.act_car %>
                            </small>

                            <button
                              type="button"
                              class="btn btn-outline-primary btn-sm js-open-usecar"
                              data-bs-toggle="modal"
                              data-bs-target="#usecarModal"
                              data-id="<%= usecar.id_usecar %>"
                              data-date="<%= thaiDate %>"
                              data-time="<%= usecar.time_car %>"
                              data-place="<%= usecar.place_car %>"
                              data-act="<%= usecar.act_car %>"
                            >
                              <i class="bi bi-info-circle me-1"></i> ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°
                            </button>
                        </div>

                        <% if(user && user.mClass==='admin' ){ %>
                          <div class="d-flex align-items-center ms-3">
                            <a href="/usecar/edit/<%= usecar.id_usecar %>"
                              class="btn btn-outline-warning btn-sm me-2">
                              <i class="bi bi-pencil-square"></i>
                            </a>
                            <form action="/usecar/delete/<%= usecar.id_usecar %>" method="POST"
                              style="display: inline;">
                              <button type="submit" class="btn btn-outline-danger btn-sm">
                                <i class="bi bi-trash3"></i>
                              </button>
                            </form>
                          </div>
                        <% } %>
                      </div>
                    </div>
                  </div>
                </div>
              <% }); %>
            </div>
            
            <div class="row mt-2">
              <div class="col-12 text-center">
                <a href="/usecar" class="btn btn-primary rounded-pill px-4">
                  <i class="bi bi-car-front me-2"></i> ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </a>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Added: Usecar Detail Modal -->
<div class="modal fade" id="usecarModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header modal-gradient py-2">
        <h5 class="modal-title mb-0"><i class="bi bi-car-front-fill me-1"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="usecarModalLoading" class="text-center d-none">
          <div class="spinner-border text-primary mb-3" role="status"></div>
          <div class="small text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        </div>
        <div id="usecarModalError" class="alert alert-danger d-none"></div>
        <dl class="row mb-0" id="usecarModalContent">
          <dt class="col-4">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</dt><dd class="col-8" id="ucDate">-</dd>
          <dt class="col-4">‡πÄ‡∏ß‡∏•‡∏≤</dt><dd class="col-8" id="ucTime">-</dd>
            <dt class="col-4">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</dt><dd class="col-8" id="ucPlace">-</dd>
          <dt class="col-4">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</dt><dd class="col-8" id="ucAct">-</dd>
        </dl>
      </div>
    </div>
  </div>
</div>

<script>
// Usecar modal populate (client-side only using data-* attributes)
(function(){
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.js-open-usecar');
    if(!btn) return;
    const date = btn.getAttribute('data-date') || '-';
    const time = btn.getAttribute('data-time') || '-';
    const place = btn.getAttribute('data-place') || '-';
    const act = btn.getAttribute('data-act') || '-';
    document.getElementById('ucDate').textContent = date;
    document.getElementById('ucTime').textContent = time + ' ‡∏ô.';
    document.getElementById('ucPlace').textContent = place;
    document.getElementById('ucAct').textContent = act;
    // If Bootstrap auto trigger fails for some reason, ensure show programmatically
    const modalEl = document.getElementById('usecarModal');
    if(modalEl){
      const instance = bootstrap && bootstrap.Modal ? bootstrap.Modal.getOrCreateInstance(modalEl) : null;
      if(instance) instance.show();
    }
  });
})();
</script>

<section id="online" class="section-block bg-light">
  <div class="container-lg">
    <div class="row">
      <div class="col-md-4">
        <div class="card modern-card shadow-sm border-0 h-100">
          <div class="card-gradient-bar"></div>
          <div class="card-body text-center">
            <h5 class="card-title">üìà ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h5>
            <div class="mb-3">
              <div class="display-4 text-success" id="onlineCountValue" aria-live="polite" aria-label="‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå">
                <%= onlineCount %>
              </div>
              <small class="text-muted">‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</small>
            </div>
            <hr>
            <div class="row text-center">
              <h4 class="col-12 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</h4>
              <div class="col-md-4">
                <div class="h4 text-primary">
                  <%= stats.coop %>
                </div>
                <small>‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå</small>
              </div>
              <div class="col-md-4">
                <div class="h4 text-success">
                  <%= stats.farmer %>
                </div>
                <small>‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</small>
              </div>
              <div class="col-md-4">
                <div class="h4 text-warning">
                  <%= stats.closing %>
                </div>
                <small>‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-8 mt-md-0">
        <h2 class="mb-4 text-center text-success section-title">üü¢ Members Online</h2>

        <div class="card modern-card shadow-sm border-0">
          <div class="card-gradient-bar"></div>
          <div class="card-body">
            <div class="row">
              <% onlineUsers.forEach((user, index)=> { %>
                <div class="col-md-6 mb-3">
                  <div class="d-flex align-items-center">
                    <img src="<%= user.m_img || '/images/default-avatar.png' %>" alt="Avatar"
                      class="rounded-circle me-3" style="width: 40px; height: 40px; object-fit: cover;" loading="lazy" decoding="async">
                    <div>
                      <div class="fw-bold text-success">
                        <%= user.on_name %>
                      </div>
                      <small class="text-muted">
                        <%= user.m_position || '32‡πÉ‡∏ä‡πâ' %>
                      </small>
                      <div class="badge bg-success ms-2">
                        <i class="bi bi-circle-fill" style="font-size: 8px;"></i> ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
                      </div>
                    </div>
                  </div>
                </div>
              <% }); %>
            </div>

            <% if (onlineUsers.length===0) { %>
              <div class="text-center text-muted">
                <i class="bi bi-people-fill" style="font-size: 2rem;"></i>
                <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>


<div id="template-data"
  data-stats='{"coop": <%= JSON.stringify(stats.coop) %>, "farmer": <%= JSON.stringify(stats.farmer) %>, "closing": <%= JSON.stringify(stats.closing) %>}'
  data-coop-group-stats='<%- JSON.stringify(coopGroupStats) %>'
  data-online-count="<%= typeof onlineCount !== 'undefined' ? onlineCount : 0 %>"
  data-logged-in="<%= user ? 'true' : 'false' %>"
  <% if ((chamraAllProcesses||[]).length) { %> data-chamra-stages='<%- JSON.stringify(__chamraCounts) %>' <% } %>
  data-activities='<%- JSON.stringify(activity || []) %>'
>
</div>

<!-- Back To Top Button -->
<button type="button" id="backToTop" aria-label="‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô" class="back-to-top">
  <i class="bi bi-arrow-up"></i>
</button>

<!-- ================= SCRIPTS (Enhancements added before existing scripts end) ================= -->
<!-- Load socket.io client for realtime online counter -->
<script src="/socket.io/socket.io.js"></script>

<script>
  // Socket: update onlineCount (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ + ‡∏°‡∏µ fallback)
  (function(){
    const el = document.getElementById('onlineCountValue');
    if(!el) return;
    let last = Number(el.textContent.trim()) || 0;
    let updated = false;

    try {
      const socket = io(); // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ default; ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î path ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö server
      socket.on('onlineUsers', (count) => {
        if(typeof count === 'number') {
          el.textContent = count;
          last = count;
          updated = true;
        }
      });
      socket.on('disconnect', () => {
        // ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤ ‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
      });
    } catch(e){
      console.warn('Socket init failed:', e);
    }

    // Fallback: ‡∏ñ‡πâ‡∏≤ 15s ‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö UX)
    setTimeout(()=> {
      if(!updated) {
        el.textContent = last;
      }
    }, 15000);
  })();
</script>

<script>
  // Quick Nav Active State + Smooth Scroll
  (function(){
    const links=[...document.querySelectorAll('#quickNav a')];
    const sections=links.map(a=>document.querySelector(a.getAttribute('href'))).filter(Boolean);
    function activate(){
      const y=window.scrollY + 120;
      let cur=null;
      sections.forEach(sec=>{
        if(sec.offsetTop <= y) cur=sec;
      });
      if(!cur) return;
      links.forEach(l=>l.classList.toggle('active', l.getAttribute('href') === '#'+cur.id));
    }
    links.forEach(l=> {
      l.addEventListener('click', e=>{
        const target=document.querySelector(l.getAttribute('href'));
        if(target){
          e.preventDefault();
          window.scrollTo({ top: target.offsetTop - 70, behavior:'smooth' });
        }
      });
    });
    window.addEventListener('scroll', activate,{passive:true});
    activate();
  })();

  // Reveal on scroll (with fallback when IntersectionObserver is unavailable)
  (function(){
    const revealEls = document.querySelectorAll('.reveal');
    if (!('IntersectionObserver' in window)) {
      revealEls.forEach(el=> el.classList.add('in'));
      return;
    }
    const obs=new IntersectionObserver(entries=>{
      entries.forEach(e=>{
        if(e.isIntersecting){
          e.target.classList.add('in');
          obs.unobserve(e.target);
        }
      });
    },{threshold:.14});
    revealEls.forEach(el=>obs.observe(el));
    document.querySelectorAll('.section-block').forEach(el=>{
      el.classList.add('reveal');
      obs.observe(el);
    });
  })();
</script>

<script>
  (function() {
    const loggedIn = document.getElementById('template-data').getAttribute('data-logged-in') === 'true';

    function escapeHtml(str) {
      return String(str ?? '').replace(/[&<>"']/g, s => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]
      ));
    }
    function fmtDate(d) {
      if (!d) return '-';
      const dt = new Date(d);
      if (isNaN(dt)) return escapeHtml(String(d));
      try {
        return dt.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' });
      } catch {
        const months = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
        return `${dt.getDate()} ${months[dt.getMonth()]} ${dt.getFullYear() + 543}`;
      }
    }

    const run = () => {
      fetch('/down/top10')
        .then(res => res.json())
        .then(data => {
          const tbody = document.getElementById('topDownloadsTbody');
          if (!Array.isArray(data) || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
            return;
          }
          tbody.innerHTML = data.map((d, idx) => {
            const isNew = d.down_savedate && (Date.now() < new Date(d.down_savedate).getTime() + 7*24*60*60*1000);
            const newBadge = isNew ? `<span class="badge bg-danger ms-2 p-2" title="‡πÉ‡∏´‡∏°‡πà">new</span>` : '';
            return `
          <tr>
            <td class="d-none d-sm-table-cell">${idx + 1}</td>
            <td>${escapeHtml(d.down_subject || '-')} ${newBadge}</td>
            <td class="text-nowrap">
              ${
                d.down_file && d.down_file !== '-' ? (
                  loggedIn
                    ? `<a href="/down/download/${d.down_id}" target="_blank" class="btn btn-sm btn-outline-success">
                         <i class="bi bi-file-earmark-arrow-down"></i> ‡πÑ‡∏ü‡∏•‡πå
                       </a>`
                    : `<a href="/auth/login" class="btn btn-sm btn-outline-secondary">
                         <i class="bi bi-lock"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                       </a>`
                ) : '<span class="text-muted">-</span>'
              }
            </td>
            <td class="text-center">
              ${
                d.down_link && d.down_link !== '-'
                  ? `<a href="${escapeHtml(d.down_link)}" target="_blank" class="btn btn-sm btn-outline-info">
                       <i class="bi bi-link-45deg"></i> ‡∏•‡∏¥‡∏á‡∏Å‡πå
                     </a>`
                  : '<span class="text-muted">-</span>'
              }
            </td>
            <td class="text-nowrap">${fmtDate(d.down_savedate)}</td>
          </tr>
        `;
          }).join('');
        })
        .catch(() => {
          const tbody = document.getElementById('topDownloadsTbody');
          tbody.innerHTML = '<tr><td colspan="5" class="text-danger">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</td></tr>';
        });
    };

    const downloadsSection = document.getElementById('downloads');
    if ('IntersectionObserver' in window && downloadsSection) {
      let done = false;
      const io = new IntersectionObserver((entries) => {
        if (done) return;
        if (entries.some(e => e.isIntersecting)) {
          done = true;
          io.disconnect();
          run();
        }
      }, { rootMargin: '200px' });
      io.observe(downloadsSection);
    } else {
      // Fallback
      window.addEventListener('load', run);
    }
  })();
</script>

<script>
  (function(){
    document.addEventListener('click', function(e){
      const btn = e.target.closest('.js-show-group-items');
      if(!btn) return;
      const group = btn.getAttribute('data-group');
      const type = btn.getAttribute('data-type');
      const label = btn.getAttribute('data-group-label');

      const modalEl = document.getElementById('groupItemsModal');
      const titleEl = document.getElementById('groupItemsModalLabel');
      const listEl = document.getElementById('groupItemsList');
      const loadingEl = document.getElementById('groupItemsLoading');
      const errorEl = document.getElementById('groupItemsError');

      titleEl.textContent = label + ' - ' + type;
      listEl.innerHTML = '';
      listEl.classList.add('d-none');
      errorEl.classList.add('d-none');
      loadingEl.classList.remove('d-none');

      fetch(`/activeCoop/group/${encodeURIComponent(group)}/items?type=${encodeURIComponent(type)}`)
        .then(r => { if(!r.ok) throw new Error('network'); return r.json(); })
        .then(data => {
          loadingEl.classList.add('d-none');
          if(!data.items || !data.items.length){
            errorEl.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            errorEl.classList.remove('d-none');
            return;
          }
          listEl.innerHTML = data.items.map((it,i)=>`<li class="list-group-item d-flex justify-content-between align-items-start">
              <div>
                <span class="fw-semibold">${i+1}. ${it.c_name}</span>
                <small class="text-muted ms-1">(${it.c_code || '-'})</small>
              </div>
              <span class="badge bg-${it.coop_group==='‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå'?'success':'info'}">${it.coop_group}</span>
            </li>`).join('');
          listEl.classList.remove('d-none');
        })
        .catch(err => {
          loadingEl.classList.add('d-none');
          errorEl.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
          errorEl.classList.remove('d-none');
        });

      const bsModal = bootstrap && bootstrap.Modal ? new bootstrap.Modal(modalEl) : null;
      if(bsModal) bsModal.show();
    });
  })();
</script>


<script>
(function(){
  document.addEventListener('click', function(e){
    const link = e.target.closest('.js-coop-detail');
    if(!link) return;
    e.preventDefault();
    const code = link.getAttribute('data-code');
    const modalEl = document.getElementById('coopDetailModal');
    const labelEl = document.getElementById('coopDetailModalLabel');
    const loadingEl = document.getElementById('coopDetailLoading');
    const errorEl = document.getElementById('coopDetailError');
    const contentEl = document.getElementById('coopDetailContent');
    if(!modalEl) return;
    labelEl.innerHTML = '<i class="bi bi-building me-1"></i> ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô ('+ code +')';
    loadingEl.classList.remove('d-none');
    errorEl.classList.add('d-none');
    contentEl.classList.add('d-none');
    contentEl.innerHTML = '';

    fetch('/allCoop/profile/' + encodeURIComponent(code))
      .then(r=>{ if(!r.ok) throw new Error('network'); return r.text(); })
      .then(html=>{
        loadingEl.classList.add('d-none');
        try {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html,'text/html');
          let container = doc.querySelector('main') || doc.querySelector('.container') || doc.body;
          container.querySelectorAll('a, button').forEach(el=>{
            if(/‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö/.test(el.textContent)) el.remove();
          });
          let extracted = container.innerHTML;
          extracted = extracted.replace(/<script[\s\S]*?<\/script>/gi,'');
          contentEl.innerHTML = '<div class="coop-modal-inner">' + extracted + '</div>';
        } catch(err){
          console.error('coop detail parse error', err);
          contentEl.innerHTML = '<div class="alert alert-warning">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÑ‡∏î‡πâ</div>';
        }
        contentEl.classList.remove('d-none');
      })
      .catch(err=>{
        loadingEl.classList.add('d-none');
        errorEl.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        errorEl.classList.remove('d-none');
        console.error('coop detail fetch error', err);
      });

    const bsModal = (window.bootstrap && bootstrap.Modal) ? new bootstrap.Modal(modalEl) : null;
    if(bsModal) bsModal.show();
  });
})();
</script>

<!-- Back To Top behavior -->
<script>
  (function(){
    const btn = document.getElementById('backToTop');
    if(!btn) return;
    const onScroll = ()=> {
      btn.classList.toggle('show', window.scrollY > 300);
    };
    window.addEventListener('scroll', onScroll, { passive: true });
    onScroll();
    btn.addEventListener('click', ()=> window.scrollTo({ top: 0, behavior: 'smooth' }));
  })();
</script>

<script>
  // Init Charts lazily when charts section becomes visible
  (function(){
    const chartsSection = document.getElementById('charts');
    if (!chartsSection) return;
    let inited = false;
    const start = () => {
      if (inited) return; inited = true;
      const barEl = document.getElementById('coopChart');
      const pieEl = document.getElementById('coopPieChart');
      const dataEl = document.getElementById('template-data');
      if(!barEl && !pieEl) return;
      if(!dataEl) return;
      let stats = { coop: 0, farmer: 0, closing: 0 };
      try {
        const raw = dataEl.getAttribute('data-stats');
        stats = typeof raw === 'string' ? JSON.parse(raw) : (raw || stats);
      } catch(e) {}
      const coop = Number(stats.coop) || 0;
      const farmer = Number(stats.farmer) || 0;
      const closing = Number(stats.closing) || 0;
      if (typeof Chart === 'undefined') return; // library not ready
      // Global font to match site
      try { Chart.defaults.font.family = 'Sarabun, system-ui, -apple-system, Segoe UI, Roboto, sans-serif'; } catch {}

      if (barEl) {
        const ctx = barEl.getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå','‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£','‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ'],
            datasets: [{
              label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡πÅ‡∏´‡πà‡∏á)',
              data: [coop, farmer, closing],
              backgroundColor: ['#16a34a','#0ea5e9','#f59e0b'],
              borderWidth: 0,
              borderRadius: 8,
              maxBarThickness: 46
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 350, easing: 'easeOutQuart' },
            plugins: { legend: { display: false }, tooltip: { enabled: true } },
            scales: {
              y: { beginAtZero: true, ticks: { precision: 0 } },
              x: { grid: { display: false } }
            }
          }
        });
      }

      if (pieEl) {
        const ctxPie = pieEl.getContext('2d');
        new Chart(ctxPie, {
          type: 'doughnut',
          data: {
            labels: ['‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå','‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£'],
            datasets: [{ data: [coop, farmer], backgroundColor: ['#16a34a','#0ea5e9'], borderWidth: 0 }]
          },
          options: {
            cutout: '58%',
            animation: { duration: 350, easing: 'easeOutQuart' },
            plugins: { legend: { position: 'bottom' }, tooltip: { enabled: true } }
          }
        });
      }
    };

    if ('IntersectionObserver' in window) {
      const io = new IntersectionObserver((entries, obs)=>{
        if (entries.some(e=>e.isIntersecting)) { obs.disconnect(); start(); }
      }, { rootMargin: '200px' });
      io.observe(chartsSection);
    } else {
      window.addEventListener('load', start);
    }
  })();
</script>

<!-- Init Chamra stages chart -->
<script>
  window.addEventListener('load', function(){
    const tdata = document.getElementById('template-data');
    const canvas = document.getElementById('chamraStageChart');
    if (!tdata || !canvas || typeof Chart === 'undefined') return;

    let stages = null;
    try {
      const raw = tdata.getAttribute('data-chamra-stages');
      stages = raw ? JSON.parse(raw) : null;
    } catch {}
    if (!stages) return;

    const labels = Array.from({length:10}, (_,i)=> 'S'+(i+1));
    const values = labels.map(k => Number(stages[k]||0));

    const ctx = canvas.getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô (‡πÅ‡∏´‡πà‡∏á)',
          data: values,
          backgroundColor: '#6366f1',
          borderWidth: 0,
          borderRadius: 8,
          maxBarThickness: 40
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 350, easing: 'easeOutQuart' },
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true }
        },
        scales: {
          y: { beginAtZero: true, ticks: { precision: 0 } },
          x: { grid: { display:false } }
        }
      }
    });
  });
</script>

<!-- Init Activities calendar lazily when visible -->
<script>
  (function(){
    const calEl = document.getElementById('activitiesCalendar');
    if (!calEl) return;
    let inited = false;
    const start = () => {
      if (inited) return; inited = true;
      if (typeof FullCalendar === 'undefined') return; // library not ready
      function formatThaiDate(d){
        try { return d.toLocaleDateString('th-TH', { year:'numeric', month:'long', day:'numeric' }); }
        catch { return d.toISOString().slice(0,10); }
      }
      const tDataEl = document.getElementById('template-data');
      let activities = [];
      try { const raw = tDataEl ? tDataEl.getAttribute('data-activities') : '[]'; activities = raw ? JSON.parse(raw) : []; } catch { activities = []; }
      const events = (activities || []).map((a, idx) => ({ id: String(idx+1), title: a.activity || '-', start: a.date_act, allDay: true, extendedProps: { raw: a } }));
      const calendar = new FullCalendar.Calendar(calEl, { 
        initialView:'dayGridMonth',
        initialDate: new Date(), // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        locale:'th',
        height:'auto',
        headerToolbar:{ left:'', center:'title', right:'' }, // ‡∏ï‡∏±‡∏î‡∏õ‡∏∏‡πà‡∏° prev/next/today
        navLinks: false,
        editable: false,
        fixedWeekCount: false,
        showNonCurrentDates: false, // ‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏à‡∏≤‡∏á ‡πÜ
        events,
        eventClick(info){ const ev=info.event; const raw=ev.extendedProps?.raw||{}; const d=ev.start?new Date(ev.start):null; const modalEl=document.getElementById('activityModal'); if(!modalEl) return; document.getElementById('acDate').textContent=d?formatThaiDate(d):'-'; document.getElementById('acTitle').textContent=raw.activity||ev.title||'-'; document.getElementById('acTime').textContent=raw.act_time?(raw.act_time+' ‡∏ô.'):'-'; document.getElementById('acPlace').textContent=raw.place||'-'; document.getElementById('acParticipants').textContent = raw.co_person || '-'; const modal=bootstrap&&bootstrap.Modal?new bootstrap.Modal(modalEl):null; if(modal) modal.show(); } });
      calendar.render();

      // List modal open button (unchanged)
      const btnList = document.getElementById('openActivityListBtn');
      if (btnList) {
        btnList.addEventListener('click', function(){
          const el = document.getElementById('activityListModal');
          const m = bootstrap && bootstrap.Modal ? new bootstrap.Modal(el) : null;
          if (m) m.show();
          const countEl = document.getElementById('activityCount');
          const rows = document.querySelectorAll('#activityTbody tr');
          if (countEl) countEl.textContent = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ' + rows.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
        });
      }
    };
    if ('IntersectionObserver' in window) {
      const io = new IntersectionObserver((entries, obs)=>{
        if (entries.some(e=>e.isIntersecting)) { obs.disconnect(); start(); }
      }, { rootMargin: '200px' });
      io.observe(calEl);
    } else {
      window.addEventListener('load', start);
    }
  })();
</script>

<%- include('partials/footer') %>