<%- include('./partials/header') %>
<div class="container my-4">
  <div class="row g-4">
    <div class="col-lg-7">
      <div class="card shadow-sm">
        <div class="card-header bg-light border-0 d-flex align-items-center justify-content-between">
          <h4 class="mb-0">üì§ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå/‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</h4>
        </div>
        <div class="card-body">
          <form action="/rule/upload" method="POST" enctype="multipart/form-data">
            <div class="mb-3">
              <label for="c_group" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå</label>
              <select id="c_group" class="form-select" required>
                <option value="">++ ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ++</option>
                <option value="group1">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå 1</option>
                <option value="group2">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå 2</option>
                <option value="group3">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå 3</option>
                <option value="group4">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå 4</option>
                <option value="group5">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå 5</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="rule_name" class="form-label">‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå/‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-building"></i></span>
                <select name="rule_name" id="rule_name" class="form-select" required>
                  <option value="">++ ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ++</option>
                </select>
              </div>
              <input type="hidden" name="rule_code" id="rule_code">
            </div>

            <div class="mb-3">
              <label for="rule_type" class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
              <select name="rule_type" id="rule_type" class="form-select" required>
                <option value=""> ++ ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ++</option>
                <option value="MR">‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å</option>
                <option value="ER">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</option>
              </select>
            </div>

            <div class="mb-3" id="er_no_div" style="display: none;">
              <label for="er_no" class="form-label">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
              <select name="er_no" id="er_no" class="form-select">
                <option value="" selected> ++ ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ++</option>
                <% for (let i = 2; i <= 12; i++) { %>
                  <option value="‡∏â‡∏ö‡∏±‡∏ö‡∏ó‡∏µ‡πà <%= i %>">‡∏â‡∏ö‡∏±‡∏ö‡∏ó‡∏µ‡πà <%= i %></option>
                <% } %>
              </select>
            </div>

            <div class="mb-3">
              <label for="rule_year" class="form-label">‡∏û.‡∏®.</label>
              <% const nowYear = new Date().getFullYear(); %>
              <select name="rule_year" id="rule_year" class="form-select">
                <option value="<%= nowYear + 542 %>"><%= nowYear + 542 %></option>
                <option value="<%= nowYear + 543 %>" selected><%= nowYear + 543 %></option>
                <option value="<%= nowYear + 544 %>"><%= nowYear + 544 %></option>
              </select>
            </div>

            <div class="mb-3">
              <label for="file" class="form-label">‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå</label>
              <input type="file" id="file" name="file" class="form-control" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" required>
              <div class="form-text">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå: PDF, DOC, DOCX, JPG, JPEG, PNG (‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10MB)</div>
            </div>

            <div class="d-flex justify-content-end gap-2">
              <a href="/" class="btn btn-outline-secondary"><i class="bi bi-arrow-left me-1"></i> ‡∏Å‡∏•‡∏±‡∏ö</a>
              <button type="submit" class="btn btn-success"><i class="bi bi-cloud-upload me-1"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light border-0">
          <h5 class="mb-0">üìÇ ‡πÑ‡∏ü‡∏•‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå/‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
                  <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                  <th>‡πÇ‡∏î‡∏¢</th>
                  <th>‡πÑ‡∏ü‡∏•‡πå</th>
                  <% if(user && user.mClass=='kjs'){ %>
                    <th>‡∏•‡∏ö</th>
                  <% } %>
                </tr>
              </thead>
              <tbody>
                <% if (recentUploads && recentUploads.length) { %>
                  <% recentUploads.forEach(rule => { %>
                    <tr>
                      <td class="text-truncate" style="max-width:220px" title="<%= rule.rule_name %>"><%= rule.rule_name %></td>
                      <td>
                        <%= rule.rule_type == 'ER' ? ('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' + (rule.er_no || '') + ' ‡∏û.‡∏®.') : '‡∏Ç‡πâ‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å ‡∏û.‡∏®.'  %><%= rule.rule_year %>
                      </td>
                      <td><%= rule.rule_saveby %></td>
                      <td>
                        <a href="/rule/<%= rule.rule_id %>" class="btn btn-sm btn-outline-primary" target="_blank" data-bs-toggle="tooltip" title="‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå">
                          <i class="bi bi-file-earmark-arrow-down"></i>
                        </a>
                      </td>
                      <% if(user && user.mClass=='kjs'){ %>
                        <td>
                          <a href="/rule/delete/<%= rule.rule_id %>" class="btn btn-sm btn-outline-danger" onclick="return confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')" data-bs-toggle="tooltip" title="‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå">
                            <i class="bi bi-trash"></i>
                          </a>
                        </td>
                      <% } %>
                    </tr>
                  <% }) %>
                <% } else { %>
                  <tr>
                    <td colspan="<%= (user && user.mClass=='kjs') ? 5 : 4 %>">
                      <div class="text-center py-4 text-muted">
                        <i class="bi bi-inbox fs-3 d-block mb-2"></i>
                        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                      </div>
                    </td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Load coops by group
  (function(){
    const cGroupSelect = document.getElementById('c_group');
    const ruleNameSelect = document.getElementById('rule_name');
    const ruleCodeInput = document.getElementById('rule_code');

    cGroupSelect.addEventListener('change', async function () {
      const group = this.value;
      ruleNameSelect.innerHTML = '<option value="">‡πÇ‡∏´‡∏•‡∏î...</option>';
      if (!group) {
        ruleNameSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô --</option>';
        return;
      }
      try {
        const response = await fetch(`/rule/coops/${group}`);
        const data = await response.json();
        if (Array.isArray(data) && data.length > 0) {
          ruleNameSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå --</option>';
          data.forEach(coop => {
            const option = document.createElement('option');
            option.value = coop.c_code;
            option.text = coop.c_name;
            ruleNameSelect.appendChild(option);
          });
        } else {
          ruleNameSelect.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°</option>';
        }
      } catch (error) {
        ruleNameSelect.innerHTML = '<option value="">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î</option>';
      }
    });

    ruleNameSelect.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      ruleCodeInput.value = selectedOption ? selectedOption.value : '';
    });
  })();

  // Toggle ER number by type
  (function(){
    var typeEl = document.getElementById('rule_type');
    var erDiv = document.getElementById('er_no_div');
    typeEl.addEventListener('change', function(){
      erDiv.style.display = this.value === 'ER' ? 'block' : 'none';
    });
  })();
</script>
<%- include('./partials/footer') %>