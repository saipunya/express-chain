<%- include('../partials/header') %>

<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="fas fa-users me-2"></i><%= (item && item.big_id) ? 'แก้ไขข้อมูลการประชุมใหญ่' : 'บันทึกการประชุมใหญ่' %>
          </h5>
        </div>
        <div class="card-body">
          <% 
            const _coops = (typeof coops === 'undefined' || !Array.isArray(coops)) ? [] : coops;
            const _groups = (typeof groups === 'undefined' || !Array.isArray(groups)) ? [] : groups;
          %>

          <% if (Array.isArray(errors) && errors.length) { %>
            <div class="alert alert-danger" role="alert">
              <h6 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>กรุณาตรวจสอบข้อมูล:</h6>
              <ul class="mb-0">
                <% errors.forEach(err => { %> <li><%= err %></li> <% }) %>
              </ul>
            </div>
          <% } %>

          <form action="<%= (item && item.big_id) ? '/bigmeet/update/' + item.big_id : '/bigmeet' %>" method="post" id="bigmeetForm">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="coop_group" class="form-label">กลุ่มสถาบัน <span class="text-danger">*</span></label>
                  <select class="form-select" id="coop_group" name="coop_group" required>
                    <option value="">-- เลือกกลุ่ม --</option>
                    <% _groups.forEach(function(g){ %>
                      <option value="<%= g %>" <%= (item && item.c_group === g) ? 'selected' : '' %>><%= g %></option>
                    <% }) %>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="coop_code" class="form-label">ชื่อสถาบัน <span class="text-danger">*</span></label>
                  <select class="form-select" id="coop_code" name="coop_code" required>
                    <option value="">-- เลือกสถาบัน --</option>
                  </select>
                </div>
              </div>
            </div>

            <input type="hidden" id="big_code" name="big_code" value="<%= (item && item.big_code) || '' %>">

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="big_endyear" class="form-label">ปีที่สิ้นสุดรอบบัญชี (พ.ศ.) <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="big_endyear" name="big_endyear" maxlength="4" placeholder="เช่น 2566" pattern="\d{4}" value="<%= (item && item.big_endyear) || '' %>" required>
                  <div class="form-text">ระบุปี พ.ศ. 4 หลัก (เช่น 2566)</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="big_type" class="form-label">มีงบการเงินหรือไม่ <span class="text-danger">*</span></label>
                  <select class="form-select" name="big_type" id="big_type" required>
                    <option value="">-- เลือก --</option>
                    <option value="มีงบการเงิน" <%= (item && item.big_type === 'มีงบการเงิน') ? 'selected' : '' %>>มีงบการเงิน</option>
                    <option value="ไม่มีงบการเงิน" <%= (item && item.big_type === 'ไม่มีงบการเงิน') ? 'selected' : '' %>>ไม่มีงบการเงิน</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="big_date" class="form-label">วันที่ประชุม <span class="text-danger">*</span></label>
                  <% 
                    let formattedBigDate = '';
                    if (item && item.big_date) {
                      const d = new Date(item.big_date);
                      formattedBigDate = [
                        d.getFullYear(),
                        ('0' + (d.getMonth() + 1)).slice(-2),
                        ('0' + d.getDate()).slice(-2)
                      ].join('-');
                    }
                  %>
                  <input type="date" class="form-control" id="big_date" name="big_date" value="<%= formattedBigDate %>" required>
                </div>
              </div>
            </div>

            <!-- Hidden fields for audit trail -->
            <input type="hidden" name="big_saveby" value="<%= locals.user ? (locals.user.username || locals.user.name) : '' %>">
            <% 
              const now = new Date();
              const todayLocal = [
                now.getFullYear(),
                ('0' + (now.getMonth() + 1)).slice(-2),
                ('0' + now.getDate()).slice(-2)
              ].join('-');
            %>
            <input type="hidden" name="big_savedate" value="<%= todayLocal %>">

            <div class="d-flex justify-content-between mt-4">
              <a href="/bigmeet" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>กลับ
              </a>
              <button type="submit" class="btn btn-primary" id="submitBtn">
                <i class="fas fa-save me-2"></i>บันทึกข้อมูล
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ข้อมูลสหกรณ์ทั้งหมดจาก server
const COOPS = <%- JSON.stringify(_coops) %>;

const groupSelect = document.getElementById('coop_group');
const coopSelect = document.getElementById('coop_code');
const bigCodeInput = document.getElementById('big_code');
const form = document.getElementById('bigmeetForm');
const submitBtn = document.getElementById('submitBtn');

function renderCoopsForGroup(group) {
  // ล้างรายการเดิม
  coopSelect.innerHTML = '<option value="">-- เลือกสถาบัน --</option>';
  if (!group) return;

  const items = COOPS.filter(c => c.c_group === group);
  items.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.c_code;           // เก็บค่า c_code
    opt.textContent = c.c_name;     // แสดงชื่อสถาบัน
    coopSelect.appendChild(opt);
  });

  // ถ้ามีค่าเดิมใน big_code ให้เลือกตรงกับนั้น
  if (bigCodeInput.value) {
    coopSelect.value = bigCodeInput.value;
  }
}

groupSelect.addEventListener('change', (e) => {
  renderCoopsForGroup(e.target.value);
  // เมื่อเปลี่ยนกลุ่ม ล้างค่า big_code และ coop_code
  bigCodeInput.value = '';
});

coopSelect.addEventListener('change', (e) => {
  // ตั้งค่า big_code จาก c_code ที่เลือก
  bigCodeInput.value = e.target.value || '';
});

// Form validation and submission
form.addEventListener('submit', async function(e) {
  e.preventDefault();
  
  // Basic validation
  if (!groupSelect.value || !coopSelect.value || !document.getElementById('big_endyear').value || 
      !document.getElementById('big_type').value || !document.getElementById('big_date').value) {
    alert('กรุณากรอกข้อมูลให้ครบถ้วน');
    return;
  }
  
  // Show loading state
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>กำลังบันทึก...';
  
  try {
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    const isEdit = <%= (item && item.big_id) ? 'true' : 'false' %>;
    const url = isEdit ? '/bigmeet/update/<%= (item && item.big_id) %>' : '/bigmeet';
    
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'Accept': 'application/json',
      },
      body: new URLSearchParams(data)
    });
    
    if (response.ok) {
      // Check if response is JSON (AJAX) or HTML redirect
      const contentType = response.headers.get('content-type');
      if (contentType && contentType.includes('application/json')) {
        const result = await response.json();
        if (result.success) {
          alert(result.message);
          window.location.href = '/bigmeet';
        } else {
          alert(result.error || 'เกิดข้อผิดพลาด');
        }
      } else {
        // HTML response - redirect
        window.location.href = '/bigmeet';
      }
    } else {
      alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล');
    }
  } catch (error) {
    console.error('Submit error:', error);
    alert('เกิดข้อผิดพลาดในการเชื่อมต่อ');
  } finally {
    // Reset button state
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>บันทึกข้อมูล';
  }
});

// เติมค่าเริ่มต้นกรณีกลับมาจาก error พร้อม item.big_code
(function init() {
  const currentCode = bigCodeInput.value;
  if (currentCode) {
    const found = COOPS.find(c => c.c_code === currentCode);
    if (found) {
      groupSelect.value = found.c_group;
      renderCoopsForGroup(found.c_group);
      coopSelect.value = currentCode;
    }
  }
})();
</script>

<%- include('../partials/footer') %>
